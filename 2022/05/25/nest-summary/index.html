<!DOCTYPE html>


  <html class="dark page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Nestjs学习总结 | 前端进阶之旅</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Node,Nest,">
  

  <meta name="description" content="Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的开发框架。它利用 JavaScript 的渐进增强的能力，使用并完全支持 TypeScript （仍然允许开发者使用纯 JavaScript 进行开发），并结合了 OOP （面向对象编程）、FP （函数式编程）和 FRP （函数响应式编程）。   在底层，Nest 构建在强大的 HTTP 服务器框架上，例">
<meta name="keywords" content="Node,Nest">
<meta property="og:type" content="article">
<meta property="og:title" content="Nestjs学习总结">
<meta property="og:url" content="http://blog.poetries.top/2022/05/25/nest-summary/index.html">
<meta property="og:site_name" content="前端进阶之旅">
<meta property="og:description" content="Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的开发框架。它利用 JavaScript 的渐进增强的能力，使用并完全支持 TypeScript （仍然允许开发者使用纯 JavaScript 进行开发），并结合了 OOP （面向对象编程）、FP （函数式编程）和 FRP （函数响应式编程）。   在底层，Nest 构建在强大的 HTTP 服务器框架上，例">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/8b2fcd207249cb37.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/1c412ef436a4a04d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/1c607b98268d7707.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/fcc23bae4de7fa32.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/f63b444ed1c1d481.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/1670837aa99d6cb8.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/8bb8d3e0e2bdaebe.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/6b74e9b59b24a0fd.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/b0bafbf19bde075f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/7985e11265cdecc2.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/976e8bcbe31b38ce.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/8d262c4c5dcad632.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/099d67812f591bc5.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/9b73303097ddcf73.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/ea2ed3388b228548.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/d9c2b21c632c9baa.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/0263be3b963d942b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/21f5a8f9dbfad1f0.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/38a1ae106ec9638c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/58d3d8e7ca89835f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/154d26405e7a471a.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/df5b0726d1260958.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/58f62ca515da28df.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/ea6301b6c0da9373.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/dd04126877af210f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/98f40271e2f2ed11.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/e14c1f5173139807.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/fe6da80fe7b316ce.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/e0c55c5a0e22af66.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/648cf1e9823e51c1.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/24be5e00069ab400.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/f9afb65f660699e8.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/05/f134cb6419f34607.png">
<meta property="og:updated_time" content="2025-03-30T13:54:29.488Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nestjs学习总结">
<meta name="twitter:description" content="Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的开发框架。它利用 JavaScript 的渐进增强的能力，使用并完全支持 TypeScript （仍然允许开发者使用纯 JavaScript 进行开发），并结合了 OOP （面向对象编程）、FP （函数式编程）和 FRP （函数响应式编程）。   在底层，Nest 构建在强大的 HTTP 服务器框架上，例">
<meta name="twitter:image" content="https://s.poetries.work/uploads/2022/05/8b2fcd207249cb37.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">
<link href="/css/other.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5081f3afc8d94338e79d319c8b632b31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  <!-- 聊天系统 -->
  
    
   <link type="text/css" rel="stylesheet" href="/renxi/default.css">
   <style>
      #modal {
        position: static !important;
      }
      .filter {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: #fe5757;
        animation: colorChange 30s ease-in-out infinite;
        animation-fill-mode: both;
        mix-blend-mode: overlay;
      }
  
      @keyframes colorChange {
        0%, 100% {
            opacity: 0;
        }
        50% {
            opacity: .9;
        }
      }
   </style>
</head>
</html>
<body>
  
  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/categories/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tags/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录<i class="iconfont toc-title" style="display:inline-block;color:#87998d;width:20px;height:20px;">&#xf004b;</i></strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基础"><span class="toc-text">基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建项目"><span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest控制器"><span class="toc-text">Nest控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nest配置路由请求数据"><span class="toc-text">nest配置路由请求数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest服务"><span class="toc-text">Nest服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nest模块"><span class="toc-text">Nest模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置静态资源"><span class="toc-text">配置静态资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置模板引擎"><span class="toc-text">配置模板引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookie的使用"><span class="toc-text">Cookie的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session的使用"><span class="toc-text">Session的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跨域，前缀路径、网站安全、请求限速"><span class="toc-text">跨域，前缀路径、网站安全、请求限速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管道、守卫、拦截器、过滤器、中间件"><span class="toc-text">管道、守卫、拦截器、过滤器、中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#管道"><span class="toc-text">管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#守卫"><span class="toc-text">守卫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#装饰器"><span class="toc-text">装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拦截器"><span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过滤器"><span class="toc-text">过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中间件"><span class="toc-text">中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一例看懂中间件、守卫、管道、异常过滤器、拦截器"><span class="toc-text">一例看懂中间件、守卫、管道、异常过滤器、拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#中间件是请求的第一道关卡"><span class="toc-text">中间件是请求的第一道关卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#守卫是第二道关卡"><span class="toc-text">守卫是第二道关卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拦截器是第三道关卡"><span class="toc-text">拦截器是第三道关卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#管道是第四道关卡"><span class="toc-text">管道是第四道关卡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据验证"><span class="toc-text">数据验证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#进阶"><span class="toc-text">进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置抽离"><span class="toc-text">配置抽离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境配置"><span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传与下载"><span class="toc-text">文件上传与下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现图片随机验证码"><span class="toc-text">实现图片随机验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#邮件服务"><span class="toc-text">邮件服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nest基于possport-jwt做登陆验证"><span class="toc-text">nest基于possport + jwt做登陆验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对数据库的密码加密：md5和bcryptjs"><span class="toc-text">对数据库的密码加密：md5和bcryptjs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#角色权限"><span class="toc-text">角色权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC"><span class="toc-text">RBAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于RBAC的设计"><span class="toc-text">基于RBAC的设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库实体设计"><span class="toc-text">数据库实体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口实现"><span class="toc-text">接口实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后端的权限访问"><span class="toc-text">后端的权限访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时任务"><span class="toc-text">定时任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接入Swagger接口文档"><span class="toc-text">接入Swagger接口文档</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#数据库"><span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nest连接Mongodb"><span class="toc-text">nest连接Mongodb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeORM操作Mysql数据库"><span class="toc-text">typeORM操作Mysql数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nest统一处理数据库操作的查询结果"><span class="toc-text">nest统一处理数据库操作的查询结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库实体设计与操作"><span class="toc-text">数据库实体设计与操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实体设计"><span class="toc-text">实体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽离部分重复的字段：使用继承"><span class="toc-text">抽离部分重复的字段：使用继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实体监听装饰器"><span class="toc-text">实体监听装饰器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeorm增删改查操作"><span class="toc-text">typeorm增删改查操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#多种访问数据库的方式"><span class="toc-text">多种访问数据库的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#增删改查的三种方式"><span class="toc-text">增删改查的三种方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeorm使用事务的3种方式"><span class="toc-text">typeorm使用事务的3种方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeorm-一对一关系设计与增删改查"><span class="toc-text">typeorm 一对一关系设计与增删改查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeorm-一对多和多对一关系设计与增删改查"><span class="toc-text">typeorm 一对多和多对一关系设计与增删改查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeorm-多对多关系设计与增删改查"><span class="toc-text">typeorm 多对多关系设计与增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实体设计-1"><span class="toc-text">实体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多对多增删改查"><span class="toc-text">多对多增删改查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nest连接Redis"><span class="toc-text">nest连接Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集成redis实现单点登录"><span class="toc-text">集成redis实现单点登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#QA"><span class="toc-text">QA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Q：nestJS注入其他依赖时为什么还需要导入其module"><span class="toc-text">Q：nestJS注入其他依赖时为什么还需要导入其module</span></a></li></ol></li></ol></li></ol>
  </div>
  




<div class="content content-post CENTER">
   <!-- canvas 彩带 -->
<canvas id="evanyou" width="1302" height="678" style="position: fixed;width: 100%;height: 100%;top: 0;left:0;z-index:-1;"></canvas>

<div class="qrcode_container">
  <div class="tencent_code">
    <h4>关注作者公众号</h4> 
    <p>和万千小伙伴一起学习</p> 
    <img src="https://interview.poetries.top/qrcode.jpg" alt="公众号：前端进价之旅">
  </div> 
</div>

<article id="post-nest-summary" class="article article-type-post" itemprop="blogPost">
  <header class="article-header" style="position:relative;">
    <h1 class="post-title">Nestjs学习总结</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2022.05.25</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Poetry</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/Front-End/">Front-End</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
       
          <span class="post-count">
            <i class="fa fa-file-word-o"></i>&nbsp
            <span>字数统计 31.1k字</span>
          </span>

          <span class="post-count">
            <i class="fa fa-columns"></i>&nbsp
            <span>阅读时长 147分</span>
          </span>
      
      
    </div>

    <i class="iconfont" id="toc-eye" style="display:inline-block;color:#b36619;position:absolute;top:20px;right:-11px;cursor:pointer;
    font-size: 24px;">&#xe61c;</i>

  </header>

  <div class="article-content">
    
      <div id="container">
        <blockquote>
<p>Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的开发框架。它利用 JavaScript 的渐进增强的能力，使用并完全支持 TypeScript （仍然允许开发者使用纯 JavaScript 进行开发），并结合了 OOP （面向对象编程）、FP （函数式编程）和 FRP （函数响应式编程）。</p>
</blockquote>
<ul>
<li>在底层，Nest 构建在强大的 HTTP 服务器框架上，例如 Express （默认），并且还可以通过配置从而使用 Fastify ！</li>
<li>Nest 在这些常见的 Node.js 框架 (Express/Fastify) 之上提高了一个抽象级别，但仍然向开发者直接暴露了底层框架的 API。这使得开发者可以自由地使用适用于底层平台的无数的第三方模块。</li>
</ul>
<p>本文基于nest8演示</p>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm i -g @nestjs/cli</span><br></pre></td></tr></table></figure>
<p><code>nest new project-name</code> 创建一个项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── nest-cli.json</span><br><span class="line">├── package.json</span><br><span class="line">├── src</span><br><span class="line">│   ├── app.controller.spec.ts</span><br><span class="line">│   ├── app.controller.ts</span><br><span class="line">│   ├── app.module.ts</span><br><span class="line">│   ├── app.service.ts</span><br><span class="line">│   └── main.ts</span><br><span class="line">├── test</span><br><span class="line">│   ├── app.e2e-spec.ts</span><br><span class="line">│   └── jest-e2e.json</span><br><span class="line">├── tsconfig.build.json</span><br><span class="line">└── tsconfig.json</span><br><span class="line"></span><br><span class="line">2 directories, 12 files</span><br></pre></td></tr></table></figure>
<p><strong>以下是这些核心文件的简要概述</strong>：</p>
<ul>
<li><code>app.controller.ts</code>   带有单个路由的基本控制器示例。</li>
<li><code>app.module.ts</code>   应用程序的根模块。</li>
<li><code>main.ts</code> 应用程序入口文件。它使用 NestFactory 用来创建 Nest 应用实例。</li>
</ul>
<blockquote>
<p><code>main.ts</code> 包含一个异步函数，它负责引导我们的应用程序：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApplicationModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(ApplicationModule);</span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>NestFactory</code> 暴露了一些静态方法用于创建应用实例</li>
<li><code>create()</code> 方法返回一个实现 <code>INestApplication</code> 接口的对象, 并提供一组可用的方法</li>
</ul>
<blockquote>
<p><code>nest</code>有两个支持开箱即用的 HTTP 平台：<code>express</code> 和 <code>fastify</code>。 您可以选择最适合您需求的产品</p>
</blockquote>
<ul>
<li><code>platform-express</code> Express 是一个众所周知的 node.js 简约 Web 框架。 这是一个经过实战考验，适用于生产的库，拥有大量社区资源。 默认情况下使用 <code>@nestjs/platform-express</code> 包。 许多用户都可以使用 <code>Express</code> ，并且无需采取任何操作即可启用它。</li>
<li><code>platform-fastify</code> <code>Fastify</code> 是一个高性能，低开销的框架，专注于提供最高的效率和速度。 </li>
</ul>
<h2 id="Nest控制器"><a href="#Nest控制器" class="headerlink" title="Nest控制器"></a>Nest控制器</h2><p>Nest中的控制器层负责处理传入的请求, 并返回对客户端的响应。</p>
<p><img src="https://s.poetries.work/uploads/2022/05/8b2fcd207249cb37.png" alt></p>
<blockquote>
<p>控制器的目的是接收应用的特定请求。路由机制控制哪个控制器接收哪些请求。通常，每个控制器有多个路由，不同的路由可以执行不同的操作</p>
</blockquote>
<p><strong>通过NestCLi创建控制器：</strong></p>
<p><code>nest -h</code> 可以看到<code>nest</code>支持的命令</p>
<p><strong>常用命令：</strong></p>
<ul>
<li>创建控制器：<code>nest g co user module</code></li>
<li>创建服务：<code>nest g s user module</code></li>
<li>创建模块：<code>nest g mo user module</code></li>
<li>默认以src为根路径生成</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/1c412ef436a4a04d.png" alt></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nest g controller posts</span><br></pre></td></tr></table></figure>
<p>表示创建posts的控制器,这个时候会在src目录下面生成一个posts的文件夹，这个里面就是posts的控制器，代码如下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'posts'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建好控制器后，<code>nestjs</code>会自动的在 <code>app.module.ts</code> 中引入<code>PostsController</code>，代码如下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">'./app.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">'./app.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsController &#125; <span class="keyword">from</span> <span class="string">'./posts/posts.controller'</span></span><br><span class="line">    </span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [],</span><br><span class="line">    controllers: [AppController, PostsController],</span><br><span class="line">    providers: [AppService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nest配置路由请求数据"><a href="#nest配置路由请求数据" class="headerlink" title="nest配置路由请求数据"></a>nest配置路由请求数据</h2><blockquote>
<p>Nestjs提供了其他HTTP请求方法的装饰器 <code>@Get()</code> <code>@Post()</code> <code>@Put()</code> 、 <code>@Delete()</code>、 <code>@Patch()</code>、 <code>@Options()</code>、 <code>@Head()</code>和 <code>@All()</code></p>
</blockquote>
<p>在Nestjs中获取<code>Get</code>传值或者<code>Post提</code>交的数据的话我们可以使用Nestjs中的装饰器来获取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Request()  req</span><br><span class="line">@Response() res</span><br><span class="line">@Next() next</span><br><span class="line">@Session()  req.session</span><br><span class="line">@Param(key?: string)    req.params / req.params[key]</span><br><span class="line">@Body(key?: string) req.body / req.body[key]</span><br><span class="line">@Query(key?: string)    req.query / req.query[key]</span><br><span class="line">@Headers(name?: string) req.headers / req.headers[name]</span><br></pre></td></tr></table></figure>
<p><strong>示例</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@Controller(<span class="string">'posts'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly postsService: PostsService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">'create'</span>)</span><br><span class="line">  create(@Body() createPostDto: CreatePostDto) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postsService.create(createPostDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'list'</span>)</span><br><span class="line">  findAll(@Query() query) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postsService.findAll(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  findById(@Param(<span class="string">'id'</span>) id: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postsService.findById(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Put(<span class="string">':id'</span>)</span><br><span class="line">  update(</span><br><span class="line">    @Param(<span class="string">'id'</span>) id: string,</span><br><span class="line">    @Body() updatePostDto: UpdatePostDto,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postsService.update(id, updatePostDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  remove(@Param(<span class="string">'id'</span>) id: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postsService.remove(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<ul>
<li><code>关于nest的return</code>： 当请求处理程序返回 JavaScript 对象或数组时，它将自动序列化为 JSON。但是，当它返回一个字符串时，Nest 将只发送一个字符串而不是序列化它</li>
</ul>
<h2 id="Nest服务"><a href="#Nest服务" class="headerlink" title="Nest服务"></a>Nest服务</h2><blockquote>
<p>Nestjs中的服务可以是<code>service</code> 也可以是<code>provider</code>。他们都可以<code>通过 constructor 注入依赖关系</code>。服务本质上就是通过<code>@Injectable()</code> 装饰器注解的类。在Nestjs中服务相当于<code>MVC</code>的<code>Model</code></p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/05/1c607b98268d7707.png" alt></p>
<p><strong>创建服务</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nest g service posts</span><br></pre></td></tr></table></figure>
<p>创建好服务后就可以在服务中定义对应的方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpException, HttpStatus, Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, Not, Between, Equal, Like, In &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dayjs <span class="keyword">from</span> <span class="string">'dayjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreatePostDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-post.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UpdatePostDto &#125; <span class="keyword">from</span> <span class="string">'./dto/update-post.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/post.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsRo &#125; <span class="keyword">from</span> <span class="string">'./interfaces/posts.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(PostsEntity)</span><br><span class="line">    private readonly postsRepository: Repository&lt;PostsEntity&gt;,</span><br><span class="line">  ) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(post: CreatePostDto) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; title &#125; = post;</span><br><span class="line">    <span class="keyword">const</span> doc = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; title &#125; &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'doc'</span>, doc);</span><br><span class="line">    <span class="keyword">if</span> (doc) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">'文章标题已存在'</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.save(post),</span><br><span class="line">      message: <span class="string">'创建成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分页查询列表</span></span><br><span class="line">  <span class="keyword">async</span> findAll(query = &#123;&#125; <span class="keyword">as</span> any) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; pageSize, pageNum, orderBy, sort, ...params &#125; = query;</span><br><span class="line">    orderBy = query.orderBy || <span class="string">'create_time'</span>;</span><br><span class="line">    sort = query.sort || <span class="string">'DESC'</span>;</span><br><span class="line">    pageSize = <span class="built_in">Number</span>(query.pageSize || <span class="number">10</span>);</span><br><span class="line">    pageNum = <span class="built_in">Number</span>(query.pageNum || <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'query'</span>, query);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> queryParams = &#123;&#125; <span class="keyword">as</span> any;</span><br><span class="line">    <span class="built_in">Object</span>.keys(params).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (params[key]) &#123;</span><br><span class="line">        queryParams[key] = Like(<span class="string">`%<span class="subst">$&#123;params[key]&#125;</span>%`</span>); <span class="comment">// 所有字段支持模糊查询、%%之间不能有空格</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> qb = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.createQueryBuilder(<span class="string">'post'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// qb.where(&#123; status: In([2, 3]) &#125;);</span></span><br><span class="line">    qb.where(queryParams);</span><br><span class="line">    <span class="comment">// qb.select(['post.title', 'post.content']); // 查询部分字段返回</span></span><br><span class="line">    qb.orderBy(<span class="string">`post.<span class="subst">$&#123;orderBy&#125;</span>`</span>, sort);</span><br><span class="line">    qb.skip(pageSize * (pageNum - <span class="number">1</span>));</span><br><span class="line">    qb.take(pageSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list: <span class="keyword">await</span> qb.getMany(),</span><br><span class="line">      totalNum: <span class="keyword">await</span> qb.getCount(), <span class="comment">// 按条件查询的数量</span></span><br><span class="line">      total: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.count(), <span class="comment">// 总的数量</span></span><br><span class="line">      pageSize,</span><br><span class="line">      pageNum,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据ID查询详情</span></span><br><span class="line">  <span class="keyword">async</span> findById(id: string): <span class="built_in">Promise</span>&lt;PostsEntity&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新</span></span><br><span class="line">  <span class="keyword">async</span> update(id: string, <span class="attr">updatePostDto</span>: UpdatePostDto) &#123;</span><br><span class="line">    <span class="keyword">const</span> existRecord = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!existRecord) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">`id为<span class="subst">$&#123;id&#125;</span>的文章不存在`</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// updatePostDto覆盖existRecord 合并，可以更新单个字段</span></span><br><span class="line">    <span class="keyword">const</span> updatePost = <span class="keyword">this</span>.postsRepository.merge(existRecord, &#123;</span><br><span class="line">      ...updatePostDto,</span><br><span class="line">      update_time: dayjs().format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.save(updatePost),</span><br><span class="line">      message: <span class="string">'更新成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除</span></span><br><span class="line">  <span class="keyword">async</span> remove(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> existPost = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!existPost) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">`文章ID <span class="subst">$&#123;id&#125;</span> 不存在`</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.remove(existPost);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: &#123; id &#125;,</span><br><span class="line">      message: <span class="string">'删除成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nest模块"><a href="#Nest模块" class="headerlink" title="Nest模块"></a>Nest模块</h2><blockquote>
<p>模块是具有 <code>@Module()</code> 装饰器的类。 <code>@Module()</code> 装饰器提供了元数据，Nest 用它来组织应用程序结构</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/05/fcc23bae4de7fa32.png" alt></p>
<blockquote>
<p>每个 Nest 应用程序至少有一个模块，即根模块。根模块是 Nest 开始安排应用程序树的地方。事实上，根模块可能是应用程序中唯一的模块，特别是当应用程序很小时，但是对于大型程序来说这是没有意义的。在大多数情况下，您将拥有多个模块，每个模块都有一组紧密相关的功能。</p>
</blockquote>
<p><strong>@module() 装饰器接受一个描述模块属性的对象：</strong></p>
<ul>
<li><code>providers</code> 由 Nest 注入器实例化的提供者，并且可以至少在整个模块中共享</li>
<li><code>controllers</code> 必须创建的一组控制器</li>
<li><code>imports</code> 导入模块的列表，这些模块导出了此模块中所需提供者</li>
<li><code>exports</code> 由本模块提供并应在其他模块中可用的提供者的子集</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建模块 posts</span></span><br><span class="line">nest g <span class="built_in">module</span> posts</span><br></pre></td></tr></table></figure>
<p><strong>Nestjs中的共享模块</strong></p>
<p>每个模块都是一个共享模块。一旦创建就能被任意模块重复使用。假设我们将在几个模块之间共享 PostsService 实例。 我们需要把 PostsService 放到 exports 数组中：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// posts.modules.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsController &#125; <span class="keyword">from</span> <span class="string">'./posts.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsService &#125; <span class="keyword">from</span> <span class="string">'./posts.service'</span>;</span><br><span class="line">@Module(&#123;</span><br><span class="line">  controllers: [PostsController],</span><br><span class="line">  providers: [PostsService],</span><br><span class="line">  exports: [PostsService] <span class="comment">// 共享模块导出</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以使用 <code>nest g res posts</code> 一键创建以上需要的各个模块</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/05/f63b444ed1c1d481.png" alt></p>
<h2 id="配置静态资源"><a href="#配置静态资源" class="headerlink" title="配置静态资源"></a>配置静态资源</h2><p>NestJS中配置静态资源目录完整代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i @nestjs/platform-express -S</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestExpressApplication &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建实例</span></span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">//使用方式一</span></span><br><span class="line">  app.useStaticAssets(<span class="string">'public'</span>)  <span class="comment">//配置静态资源目录</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用方式二：配置前缀目录 设置静态资源目录</span></span><br><span class="line">  app.useStaticAssets(join(__dirname, <span class="string">'../public'</span>), &#123;</span><br><span class="line">    <span class="comment">// 配置虚拟目录，比如我们想通过 http://localhost:3000/static/1.jpg 来访问public目录里面的文件</span></span><br><span class="line">    prefix: <span class="string">'/static/'</span>, <span class="comment">// 设置虚拟路径</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 启动端口</span></span><br><span class="line">  <span class="keyword">const</span> PORT = process.env.PORT || <span class="number">9000</span>;</span><br><span class="line">  <span class="keyword">await</span> app.listen(PORT, () =&gt;</span><br><span class="line">    Logger.log(<span class="string">`服务已经启动 http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<h2 id="配置模板引擎"><a href="#配置模板引擎" class="headerlink" title="配置模板引擎"></a>配置模板引擎</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i ejs --save</span><br></pre></td></tr></table></figure>
<p>配置模板引擎</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;join&#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line"></span><br><span class="line">  app.setBaseViewsDir(join(__dirname, <span class="string">'..'</span>, <span class="string">'views'</span>)) <span class="comment">// 放视图的文件</span></span><br><span class="line">  app.setViewEngine(<span class="string">'ejs'</span>); <span class="comment">//模板渲染引擎</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">9000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p>项目根目录新建<code>views</code>目录然后新建<code>根目录 -&gt; views -&gt; default -&gt; index.ejs</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h3</span>&gt;</span>模板引擎<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%=message%</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>渲染页面</strong></p>
<p>Nestjs中 <code>Render</code>装饰器可以渲染模板，<strong>使用路由匹配渲染引擎</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mport &#123; Controller, Get, Render &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">'./app.service'</span>;</span><br><span class="line"></span><br><span class="line">@Controller()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppController</span> </span>&#123;</span><br><span class="line">  @Get()</span><br><span class="line">  @Render(<span class="string">'default/index'</span>)  <span class="comment">//使用render渲染模板引擎，参数就是文件路径：default文件夹下的index.ejs</span></span><br><span class="line">  getUser(): any &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">message</span>: <span class="string">"hello word"</span>&#125;   <span class="comment">//只有返回参数在模板才能获取，如果不传递参数，必须返回一个空对象</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Cookie的使用"><a href="#Cookie的使用" class="headerlink" title="Cookie的使用"></a>Cookie的使用</h2><blockquote>
<p>cookie和session的使用<strong>依赖</strong>于当前使用的平台，如：express和fastify<br>两种的使用方式不同，这里主要记录基于<strong>express</strong>平台的用法</p>
</blockquote>
<p>cookie可以用来存储用户信息，存储购物车等信息，在实际项目中用的非常多</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm instlal cookie-parser --save </span><br><span class="line">npm i -D @types/cookie-parser --save</span><br></pre></td></tr></table></figure>
<p>引入注册</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NestExpressApplication &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cookieParser <span class="keyword">from</span> <span class="string">'cookie-parser'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//注册cookie</span></span><br><span class="line">  app.use(cookieParser(<span class="string">'dafgafa'</span>));  <span class="comment">//加密密码</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p><strong>接口中设置cookie 使用response</strong></p>
<p>请求该接口，响应一个cookie</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@Get()</span><br><span class="line">index(@Response() res)&#123;</span><br><span class="line">    <span class="comment">//设置cookie, signed:true加密</span></span><br><span class="line">    <span class="comment">//参数：1：key, 2:value, 3:配置</span></span><br><span class="line">    res.cookie(<span class="string">'username'</span>, <span class="string">'poetry'</span>, &#123;<span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">10</span>, <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">signed</span>:<span class="literal">true</span>&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注意：</span></span><br><span class="line">    <span class="comment">//使用res后，返回数据必须使用res</span></span><br><span class="line">    <span class="comment">//如果是用了render模板渲染，还是使用return</span></span><br><span class="line">    res.send(&#123;xxx&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>cookie相关配置参数</strong></p>
<ul>
<li><code>domain</code>    String    指定域名下有效</li>
<li><code>expires</code>      Date        过期时间(秒),设置在某个时间点后会在该<code>cookoe</code>后失效</li>
<li><code>httpOnly</code>  Boolean    默认为<code>false</code> 如果为<code>true</code>表示不允许客户端(通过<code>js</code>来获取<code>cookie</code>)</li>
<li><code>maxAge</code>  String    最大失效时间(毫秒),设置在多少时间后失效</li>
<li><code>path</code>        String    表示<code>cookie</code>影响到的路径,如:<code>path=/</code>如果路径不能匹配的时候,浏览器则不发送这个<code>cookie</code></li>
<li><code>secure</code>     Boolean    当 <code>secure</code> 值为 <code>true</code> 时,<code>cookie</code> 在 HTTP 中是无效,在 <code>HTTPS</code> 中才有效</li>
<li><code>signed</code>     Boolean    表示是否签名<code>cookie</code>,如果设置为<code>true</code>的时候表示对这个<code>cookie</code>签名了,这样就需要用<code>res.signedCookies()</code>获取值<code>cookie</code>不是使用<code>res.cookies()</code>了</li>
</ul>
<p><strong>获取cookie</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@Get()</span><br><span class="line">index(@Request() req)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(req.cookies.username)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//加密的cookie获取方式</span></span><br><span class="line">      <span class="built_in">console</span>.log(req.signedCookies.username)  </span><br><span class="line">      <span class="keyword">return</span> req.cookies.username</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Cookie加密</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 配置中间件的时候需要传参</span></span><br><span class="line">app.use(cookieParser(<span class="string">'123456'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置cookie的时候配置signed属性</span></span><br><span class="line">res.cookie(<span class="string">'userinfo'</span>,<span class="string">'hahaha'</span>,&#123;<span class="attr">domain</span>:<span class="string">'.ccc.com'</span>,<span class="attr">maxAge</span>:<span class="number">900000</span>,<span class="attr">httpOnly</span>:<span class="literal">true</span>,<span class="attr">signed</span>:<span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// signedCookies调用设置的cookie</span></span><br><span class="line"><span class="built_in">console</span>.log(req.signedCookies);</span><br></pre></td></tr></table></figure>
<h2 id="Session的使用"><a href="#Session的使用" class="headerlink" title="Session的使用"></a>Session的使用</h2><ul>
<li><code>session</code>是另一种记录客户状态的机制，不同的是Cookie保存在客户端浏览器中，而<code>session</code>保存在服务器上</li>
<li>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个session对象，生成一个类似于key,value的键值对， 然后将key(cookie)返回到浏览器(客户)端，浏览器下次再访问时，携带key(cookie)，找到对应的session(value)。 客户的信息都保存在session中</li>
</ul>
<p><strong>安装 express-session</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm i express-session --save</span><br><span class="line">npm i -D @types/express-session --save</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NestExpressApplication &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> session <span class="keyword">from</span> <span class="string">'express-seesion'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//配置session</span></span><br><span class="line">  app.use(session(&#123;</span><br><span class="line">      secret: <span class="string">'dmyxs'</span>,</span><br><span class="line">      cookie: &#123; <span class="attr">maxAge</span>: <span class="number">10000</span>, <span class="attr">httpOnly</span>: <span class="literal">true</span> &#125;,  <span class="comment">//以cookie存储到客户端</span></span><br><span class="line">      rolling: <span class="literal">true</span> <span class="comment">//每次重新请求时，重新设置cookie</span></span><br><span class="line">  &#125;))</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p><strong>session相关配置参数</strong></p>
<ul>
<li><code>secret</code>               String   生成<code>session</code>签名的密钥</li>
<li><code>name</code>               String   客户端的<code>cookie</code>的名称，默认为<code>connect.sid</code>, 可自己设置</li>
<li><code>resave</code>               Boolean    强制保存 <code>session</code> 即使它并没有变化, 默认为<code>true</code>, 建议设置成<code>false</code></li>
<li><code>saveUninitalized</code>   Boolean    强制将未初始化的 <code>session</code> 存储。当新建了一个 <code>session</code> 且未设定属性或值时，它就处于 未初始化状态。在设定一个 <code>cookie</code> 前，这对于登陆验证，减轻服务端存储压力，权限控制是有帮助的。默认:<code>true</code>, 建议手动添加</li>
<li><code>cookie</code>               Object   设置返回到前端<code>cookie</code>属性，默认值为<code>{ path: ‘/’, httpOnly: true, secure: false, maxAge: null }</code>。</li>
<li><code>rolling</code>               Boolean    在每次请求时强行设置 <code>cookie</code>，这将重置 <code>cookie</code> 过期时间, 默认为<code>false</code></li>
</ul>
<p><strong>接口中设置session</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@Get()</span><br><span class="line">  index(@Request() req)&#123;</span><br><span class="line">    <span class="comment">//设置session</span></span><br><span class="line">    req.session.username = <span class="string">'poetry'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>获取session</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@Get(<span class="string">'/session'</span>)</span><br><span class="line">  session(@Request() req, @Session() session )&#123;</span><br><span class="line">    <span class="comment">//获取session：两种方式</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.session.username)</span><br><span class="line">    <span class="built_in">console</span>.log(session.username)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello session'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="跨域，前缀路径、网站安全、请求限速"><a href="#跨域，前缀路径、网站安全、请求限速" class="headerlink" title="跨域，前缀路径、网站安全、请求限速"></a>跨域，前缀路径、网站安全、请求限速</h2><p><strong>跨域，路径前缀，网络安全</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add helmet csurf</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Logger, ValidationPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> helmet <span class="keyword">from</span> <span class="string">'helmet'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> csurf <span class="keyword">from</span> <span class="string">'csurf'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = process.env.PORT || <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路径前缀：如：http://www.test.com/api/v1/user</span></span><br><span class="line">  app.setGlobalPrefix(<span class="string">'api/v1'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//cors：跨域资源共享，方式一：允许跨站访问</span></span><br><span class="line">  app.enableCors();</span><br><span class="line">  <span class="comment">// 方式二：const app = await NestFactory.create(AppModule, &#123; cors: true &#125;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//防止跨站脚本攻击</span></span><br><span class="line">  app.use(helmet());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//CSRF保护：跨站点请求伪造</span></span><br><span class="line">  app.use(csurf());</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> app.listen(PORT, () =&gt; &#123;</span><br><span class="line">    Logger.log(</span><br><span class="line">      <span class="string">`服务已经启动,接口请访问:localhost:<span class="subst">$&#123;PORT&#125;</span><span class="subst">$&#123;PREFIX&#125;</span>`</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p><strong>限速：限制客户端在一定时间内的请求次数</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add @nestjs/throttler</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在需要使用的模块引入使用，这里是<strong>全局</strong>使用，在<code>app.module.ts</code>中引入。这里设置的是：<strong>1分钟内只能请求10次，超过则报status为429的错误</strong></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.module.ts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; APP_GUARD &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">'./modules/user/user.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; ThrottlerModule, ThrottlerGuard &#125; <span class="keyword">from</span> <span class="string">'@nestjs/throttler'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">  	UserModule,</span><br><span class="line">    ThrottlerModule.forRoot(&#123;</span><br><span class="line">      ttl: <span class="number">60</span>,  <span class="comment">//1分钟</span></span><br><span class="line">      limit: <span class="number">10</span>, <span class="comment">//请求10次</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  providers: [ <span class="comment">//全局使用</span></span><br><span class="line">    &#123;</span><br><span class="line">      provide: APP_GUARD,</span><br><span class="line">      useClass: ThrottlerGuard,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="管道、守卫、拦截器、过滤器、中间件"><a href="#管道、守卫、拦截器、过滤器、中间件" class="headerlink" title="管道、守卫、拦截器、过滤器、中间件"></a>管道、守卫、拦截器、过滤器、中间件</h2><ul>
<li><strong>管道</strong>：数据处理与转换，数据验证</li>
<li><strong>守卫</strong>：验证用户登陆，保护路由</li>
<li><strong>拦截器</strong>：对请求响应进行拦截，统一响应内容</li>
<li><strong>过滤器</strong>：异常捕获</li>
<li><strong>中间件</strong>：日志打印</li>
</ul>
<blockquote>
<p>执行顺序（时机）</p>
</blockquote>
<p>从客户端发送一个post请求，路径为：<code>/user/login</code>，请求参数为：<code>{userinfo: ‘xx’,password: ‘xx’}</code>，到服务器接收请求内容，触发绑定的函数并且执行相关逻辑完毕，然后返回内容给客户端的整个过程大体上要经过如下几个步骤：</p>
<p><img src="https://s.poetries.work/uploads/2022/05/1670837aa99d6cb8.png" alt></p>
<blockquote>
<p>全局使用: 管道 - 守卫 - 拦截器 - 过滤器 - 中间件。统一在main.ts文件中使用，全局生效</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ParseIntPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HttpExceptionFilter &#125; <span class="keyword">from</span> <span class="string">'./common/filters/http-exception.filter'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggerMiddleware &#125; <span class="keyword">from</span> <span class="string">'./common/middleware/logger.middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'./common/guard/auth.guard'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthInterceptor &#125; <span class="keyword">from</span> <span class="string">'./common/interceptors/auth.interceptor'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//全局使用管道：这里使用的是内置，也可以使用自定义管道，在下文</span></span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ParseIntPipe());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//全局使用中间件</span></span><br><span class="line">  app.use(LoggerMiddleware)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//全局使用过滤器</span></span><br><span class="line">  <span class="comment">//这里使用的是自定义过滤器，先别管，先学会怎么在全局使用</span></span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> HttpExceptionFilter());  </span><br><span class="line"></span><br><span class="line">  <span class="comment">//全局使用守卫</span></span><br><span class="line">  app.useGlobalGuards(<span class="keyword">new</span> AuthGuard());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//全局使用拦截器</span></span><br><span class="line">  app.useGlobalInterceptors(<span class="keyword">new</span> AuthInterceptor());</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>常用内置管道，从<code>@nestjs/common</code>导出</p>
<ul>
<li><code>ParseIntPipe</code>：将字符串数字转数字</li>
<li><code>ValidationPipe</code>：验证管道</li>
</ul>
<blockquote>
<p>局部使用管道</p>
</blockquote>
<ul>
<li><p>匹配整个路径，使用UsePipes</p>
</li>
<li><p>只匹配某个接口，使用UsePipes</p>
</li>
<li><p>在获取参数时匹配，一般使用内置管道</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Put,</span><br><span class="line">  Body,</span><br><span class="line">  Param,</span><br><span class="line">  UsePipes,</span><br><span class="line">  ParseIntPipe</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; myPipe &#125; <span class="keyword">from</span> <span class="string">'../../common/pipes/user.pipe'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line">@UsePipes(<span class="keyword">new</span> myPipe())  <span class="comment">//局部方式1：匹配整个/user， get请求和put请求都会命中</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  getUserById(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id) &#123; <span class="comment">//局部方式3：只匹配/user的get请求，使用的是内置管道</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'user'</span>, <span class="keyword">typeof</span> id);</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Put(<span class="string">':id'</span>)</span><br><span class="line">  @UsePipes(<span class="keyword">new</span> myPipe())  <span class="comment">//局部方式2：只匹配/user的put请求</span></span><br><span class="line">  updateUser(@Body() user, @Param(<span class="string">'id'</span>) id) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      user,</span><br><span class="line">      id,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>自定义管道</p>
</blockquote>
<p>使用快捷命令生成：<code>nest g pi myPipe common/pipes</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ArgumentMetadata,</span><br><span class="line">  Injectable,</span><br><span class="line">  PipeTransform,</span><br><span class="line">  BadRequestException,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义管道必须实现自PipeTransform，固定写法，该接口有一个transform方法</span></span><br><span class="line"><span class="comment">//transform参数：</span></span><br><span class="line"><span class="comment">//value：使用myPipe时所传递的值，可以是param传递的的查询路径参数，可以是body的请求体</span></span><br><span class="line"><span class="comment">//metadata：元数据，可以用它判断是来自param或body或query</span></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">myPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span>&lt;<span class="title">string</span>&gt; </span>&#123;</span><br><span class="line">  transform(value: string, <span class="attr">metadata</span>: ArgumentMetadata) &#123;</span><br><span class="line">    <span class="keyword">if</span> (metadata.type === <span class="string">'body'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'来自请求体'</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (metadata.type === <span class="string">'param'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'来自查询路径'</span>, value);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> val = <span class="built_in">parseInt</span>(value, <span class="number">10</span>);</span><br><span class="line">      <span class="comment">//如果不是传递一个数字，抛出错误</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">isNaN</span>(val)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">'Validation failed'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="守卫"><a href="#守卫" class="headerlink" title="守卫"></a>守卫</h3><blockquote>
<p>自定义守卫</p>
</blockquote>
<p>使用快捷命令生成：<code>nest g gu myGuard common/guards</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CanActivate, ExecutionContext, Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>; <span class="comment">//反射器，作用与自定义装饰器桥接，获取数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义守卫必须CanActivate，固定写法，该接口只有一个canActivate方法</span></span><br><span class="line"><span class="comment">//canActivate参数：</span></span><br><span class="line"><span class="comment">//context：请求的(Response/Request)的引用</span></span><br><span class="line"><span class="comment">//通过守卫返回true，否则返回false，返回403状态码</span></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly reflector: Reflector) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 白名单数组</span></span><br><span class="line">  private whiteUrlList: string[] = [<span class="string">'/user'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证该次请求是否为白名单内的路由</span></span><br><span class="line">  private isWhiteUrl(urlList: string[], <span class="attr">url</span>: string): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (urlList.includes(url)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  canActivate(context: ExecutionContext): boolean &#123;</span><br><span class="line">    <span class="comment">// 获取请求对象</span></span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="comment">//console.log('request', request.headers);</span></span><br><span class="line">    <span class="comment">//console.log('request', request.params);</span></span><br><span class="line">    <span class="comment">//console.log('request', request.query);</span></span><br><span class="line">    <span class="comment">//console.log('request', request.url);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用法一：验证是否是白名单内的路由</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isWhiteUrl(<span class="keyword">this</span>.whiteUrlList, request.url)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用法二：使用反射器，配合装饰器使用，获取装饰器传递过来的数据</span></span><br><span class="line">    <span class="keyword">const</span> roles = <span class="keyword">this</span>.reflector.get&lt;string[]&gt;(<span class="string">'roles'</span>, context.getHandler());</span><br><span class="line">    <span class="comment">//console.log(roles); // [ 'admin' ]</span></span><br><span class="line">    <span class="comment">//http://localhost:3000/user/9?user=admin，如果与装饰器传递过来的值匹配则通过，否则不通过</span></span><br><span class="line">    <span class="comment">//真实开发中可能从cookie或token中获取值</span></span><br><span class="line">    <span class="keyword">const</span> &#123; user &#125; = request.query;</span><br><span class="line">    <span class="keyword">if</span> (roles.includes(user)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他用法</span></span><br><span class="line">    <span class="comment">// 获取请求头中的token字段</span></span><br><span class="line">    <span class="keyword">const</span> token = context.switchToRpc().getData().headers.token;</span><br><span class="line">    <span class="comment">// console.log('token', token);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取session</span></span><br><span class="line">    <span class="keyword">const</span> userinfo = context.switchToHttp().getRequest().session;</span><br><span class="line">    <span class="comment">// console.log('session', userinfo);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>局部使用守卫</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Delete,</span><br><span class="line">  Param,</span><br><span class="line">  UsePipes,</span><br><span class="line">  UseGuards,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'../../common/guard/auth.guard'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Role &#125; <span class="keyword">from</span> <span class="string">'../../common/decorator/role.decorator'</span>; <span class="comment">//自定义装饰器</span></span><br><span class="line"></span><br><span class="line">@UseGuards(AuthGuard) <span class="comment">//局部使用守卫，守卫整个user路径</span></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  getUserById(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'user'</span>, <span class="keyword">typeof</span> id);</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  @Role(<span class="string">'admin'</span>)  <span class="comment">//使用自定义装饰器，传入角色，必须是admin才能删除</span></span><br><span class="line">  removeUser(@Param(<span class="string">'id'</span>) id) &#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>自定义守卫中使用到了自定义装饰器</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">nest g d role common/decorator</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这是快捷生成的代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; SetMetadata &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SetMetadata作用：将获取到的值，设置到元数据中，然后守卫通过反射器才能获取到值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Roles = <span class="function">(<span class="params">...roles: string[]</span>) =&gt;</span> SetMetadata(<span class="string">'roles'</span>, roles);</span><br></pre></td></tr></table></figure>
<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>使用快捷命令生成：<code>nest g in auth common/intercepters</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  CallHandler,</span><br><span class="line">  ExecutionContext,</span><br><span class="line">  Injectable,</span><br><span class="line">  NestInterceptor,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义拦截器必须实现自NestInterceptor，固定写法，该接口只有一个intercept方法</span></span><br><span class="line"><span class="comment">//intercept参数：</span></span><br><span class="line"><span class="comment">//context：请求上下文，可以拿到的Response和Request</span></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">  intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'拦截器'</span>, request.url);</span><br><span class="line">    <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">      map(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'全局响应拦截器方法返回内容后...'</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          status: <span class="number">200</span>,</span><br><span class="line">          timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</span><br><span class="line">          path: request.url,</span><br><span class="line">          message: <span class="string">'请求成功'</span>,</span><br><span class="line">          data: data,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><blockquote>
<p>局部使用过滤器</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  UseFilters,</span><br><span class="line">  HttpException,</span><br><span class="line">  HttpStatus,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpExceptionFilter &#125; <span class="keyword">from</span> <span class="string">'../../common/filters/http-exception.filter'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//局部使用过滤器</span></span><br><span class="line">@UseFilters(<span class="keyword">new</span> HttpExceptionFilter())</span><br><span class="line">@Controller(<span class="string">'/user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line">  @Get()</span><br><span class="line">  getUserById(@Query() &#123; id &#125;): string &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        &#123;</span><br><span class="line">          status: HttpStatus.BAD_REQUEST,</span><br><span class="line">          message: <span class="string">'请求参数id 必传'</span>,</span><br><span class="line">          error: <span class="string">'id is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        HttpStatus.BAD_REQUEST,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello error'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>自定义过滤器</strong></p>
<p>使用快捷命令生成：<code>nest g f myFilter common/filters</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ArgumentsHost,</span><br><span class="line">  Catch,</span><br><span class="line">  ExceptionFilter,</span><br><span class="line">  HttpException,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//必须实现至ExceptionFilter，固定写法，该接口只有一个catch方法</span></span><br><span class="line"><span class="comment">//catch方法参数：</span></span><br><span class="line"><span class="comment">//exception：当前正在处理的异常对象</span></span><br><span class="line"><span class="comment">//host：传递给原始处理程序的参数的一个包装(Response/Request)的引用</span></span><br><span class="line">@Catch(HttpException)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpExceptionFilter</span> <span class="title">implements</span> <span class="title">ExceptionFilter</span>&lt;<span class="title">HttpException</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">catch</span>(exception: HttpException, <span class="attr">host</span>: ArgumentsHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.switchToHttp();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.getResponse();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = exception.getStatus(); <span class="comment">//获取状态码</span></span><br><span class="line">    <span class="keyword">const</span> exceptionRes: any = exception.getResponse(); <span class="comment">//获取响应对象</span></span><br><span class="line">    <span class="keyword">const</span> &#123; error, message &#125; = exceptionRes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义的异常响应内容</span></span><br><span class="line">    <span class="keyword">const</span> msgLog = &#123;</span><br><span class="line">      status,</span><br><span class="line">      timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</span><br><span class="line">      path: request.url,</span><br><span class="line">      error,</span><br><span class="line">      message,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    response.status(status).json(msgLog);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><blockquote>
<p>局部使用中间件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module, MiddlewareConsumer, RequestMethod &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggerMiddleware &#125; <span class="keyword">from</span> <span class="string">'./common/middleware/logger.middlerware'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">'./modules/user/user.module'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">	imports:[ UserModule ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line">  configure(consumer: MiddlewareConsumer) &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(LoggerMiddleware) <span class="comment">//应用中间件</span></span><br><span class="line">      .exclude(&#123; <span class="attr">path</span>: <span class="string">'user'</span>, <span class="attr">method</span>: RequestMethod.POST &#125;)  <span class="comment">//排除user的post方法</span></span><br><span class="line">      .forRoutes(<span class="string">'user'</span>); <span class="comment">//监听路径  参数：路径名或*，*是匹配所以的路由</span></span><br><span class="line">      <span class="comment">// .forRoutes(&#123; path: 'user', method: RequestMethod.POST &#125;, &#123; path: 'album', method: RequestMethod.ALL &#125;); //多个</span></span><br><span class="line">     <span class="comment">// .apply(UserMiddleware) //支持多个中间件</span></span><br><span class="line">     <span class="comment">// .forRoutes('user')</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>自定义中间件</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">nest g mi logger common/middleware</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, NestMiddleware &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerMiddleware</span> <span class="title">implements</span> <span class="title">NestMiddleware</span> </span>&#123;</span><br><span class="line">  <span class="comment">//req：请求参数</span></span><br><span class="line">  <span class="comment">//res：响应参数</span></span><br><span class="line">  <span class="comment">//next：执行下一个中件间</span></span><br><span class="line">  use(req: Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; method, path &#125; = req;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;method&#125;</span> <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>函数式中间件</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 函数式中间件-应用于全局</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建实例</span></span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置全局日志函数中间件</span></span><br><span class="line">  app.use(logger);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<h2 id="一例看懂中间件、守卫、管道、异常过滤器、拦截器"><a href="#一例看懂中间件、守卫、管道、异常过滤器、拦截器" class="headerlink" title="一例看懂中间件、守卫、管道、异常过滤器、拦截器"></a>一例看懂中间件、守卫、管道、异常过滤器、拦截器</h2><blockquote>
<p>从客户端发送一个post请求，路径为：<code>/user/login</code>，请求参数为：<code>{userinfo: ‘xx’,password: ‘xx’}</code>，到服务器接收请求内容，触发绑定的函数并且执行相关逻辑完毕，然后返回内容给客户端的整个过程大体上要经过如下几个步骤：`</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/05/8bb8d3e0e2bdaebe.png" alt></p>
<p>项目需要包支持：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install --save rxjs xml2js class-validator class-transformer</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>rxjs</code> 针对JavaScript的反应式扩展,支持更多的转换运算</p>
</li>
<li><p><code>xml2js</code> 转换xml内容变成json格式</p>
</li>
<li><code>class-validator</code>、<code>class-transformer</code> 管道验证包和转换器</li>
</ul>
<p>建立user模块：模块内容结构：</p>
<p><code>nest g res user</code></p>
<p><img src="https://s.poetries.work/uploads/2022/05/6b74e9b59b24a0fd.png" alt></p>
<p>user.controller.ts文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Post,</span><br><span class="line">  Body</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserLoginDTO &#125; <span class="keyword">from</span> <span class="string">'./dto/user.login.dto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">'test'</span>)</span><br><span class="line">  loginIn(@Body() userlogindto: UserLoginDTO) &#123;</span><br><span class="line">    <span class="keyword">return</span> userlogindto;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>user.module.ts文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserController &#125; <span class="keyword">from</span> <span class="string">'./user.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  controllers: [UserController],</span><br><span class="line">  providers: [UserService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>user.service.ts文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>user.login.dto.ts文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user / dto / user.login.dto.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; IsNotIn, MinLength &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLoginDTO</span></span>&#123;</span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">  * 账号</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  @IsNotIn([<span class="string">''</span>,<span class="literal">undefined</span>,<span class="literal">null</span>],&#123;<span class="attr">message</span>: <span class="string">'账号不能为空'</span>&#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">  * 密码</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  @MinLength(<span class="number">6</span>,&#123;</span><br><span class="line">    message: <span class="string">'密码长度不能小于6位数'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>app.module.ts文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子模块加载</span></span><br><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">'./user/user.module'</span></span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    UserModule</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建common文件夹里面分别建立对应的文件夹以及文件：<br>中间件(middleware) — xml.middleware.ts<br>守卫(guard) — auth.guard.ts<br>管道(pipe) — validation.pipe.ts<br>异常过滤器(filters) — http-exception.filter.ts<br>拦截器(interceptor) — response.interceptor.ts</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/05/b0bafbf19bde075f.png" alt></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ValidationPipe &#125; <span class="keyword">from</span> <span class="string">'./common/pipe/validation.pipe'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpExceptionFilter &#125; <span class="keyword">from</span> <span class="string">'./common/filters/http-exception.filter'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; XMLMiddleware &#125; <span class="keyword">from</span> <span class="string">'./common/middleware/xml.middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'./common/guard/auth.guard'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ResponseInterceptor &#125; <span class="keyword">from</span> <span class="string">'./common/interceptor/response.interceptor'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局注册通用验证管道ValidationPipe</span></span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局注册通用异常过滤器HttpExceptionFilter</span></span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> HttpExceptionFilter());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局注册xml支持中间件(这里必须调用.use才能够注册)</span></span><br><span class="line">  app.use(<span class="keyword">new</span> XMLMiddleware().use);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局注册权限验证守卫</span></span><br><span class="line">  app.useGlobalGuards(<span class="keyword">new</span> AuthGuard());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局注册响应拦截器</span></span><br><span class="line">  app.useGlobalInterceptors(<span class="keyword">new</span> ResponseInterceptor());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3001</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<h3 id="中间件是请求的第一道关卡"><a href="#中间件是请求的第一道关卡" class="headerlink" title="中间件是请求的第一道关卡"></a>中间件是请求的第一道关卡</h3><ol>
<li>执行任何代码。</li>
<li>对请求和响应对象进行更改。</li>
<li>结束请求-响应周期。</li>
<li>调用堆栈中的下一个中间件函数。</li>
<li>如果当前的中间件函数没有结束请求-响应周期, 它必须调用 next() 将控制传递给下一个中间件函数。否则, 请求将被挂起</li>
</ol>
<p>本例中：使用中间件让express支持xml请求并且将xml内容转换为json数组</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common/middleware/xml.middleware.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, NestMiddleware &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">const</span> xml2js = <span class="built_in">require</span>(<span class="string">'xml2js'</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="keyword">new</span> xml2js.Parser();</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMiddleware</span> <span class="title">implements</span> <span class="title">NestMiddleware</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 参数是固定的Request/Response/next,</span></span><br><span class="line">  <span class="comment">// Request/Response/next对应请求体和响应体和下一步函数</span></span><br><span class="line">  use(req: Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'进入全局xml中间件...'</span>);</span><br><span class="line">    <span class="comment">// 获取express原生请求对象req,找到其请求头内容，如果包含application/xml，则执行转换</span></span><br><span class="line">    <span class="keyword">if</span>(req.headers[<span class="string">'content-type'</span>] &amp;&amp; req.headers[<span class="string">'content-type'</span>].includes(<span class="string">'application/xml'</span>))&#123;</span><br><span class="line">      <span class="comment">// 监听data方法获取到对应的参数数据(这里的方法是express的原生方法)</span></span><br><span class="line">      req.on(<span class="string">'data'</span>, mreq =&gt; &#123;</span><br><span class="line">        <span class="comment">// 使用xml2js对xml数据进行转换</span></span><br><span class="line">        parser.parseString(mreq,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</span><br><span class="line">          <span class="comment">// 将转换后的数据放入到请求对象的req中</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'parseString转换后的数据'</span>,result);</span><br><span class="line">          <span class="comment">// 这里之后可以根据需要对result做一些补充完善</span></span><br><span class="line">          req[<span class="string">'body'</span>]= result;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用next方法进入到下一个中间件或者路由</span></span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注册方式</strong></p>
<ul>
<li><p>全局注册：在<code>main.ts</code>中导入需要的中间件模块如：XMLMiddleware然后使用 <code>app.use(new XMLMiddleware().use)</code>即可</p>
</li>
<li><p>模块注册：在对应的模块中注册如：<code>user.module.ts</code></p>
</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/7985e11265cdecc2.png" alt></p>
<blockquote>
<p>同一路由注册多个中间件的执行顺序为，先是全局中间件执行，然后是模块中间件执行，模块中的中间件顺序按照<code>.apply</code>中注册的顺序执行</p>
</blockquote>
<h3 id="守卫是第二道关卡"><a href="#守卫是第二道关卡" class="headerlink" title="守卫是第二道关卡"></a>守卫是第二道关卡</h3><blockquote>
<p>守卫控制一些权限内容，如：一些接口需要带上token标记，才能够调用，守卫则是对这个标记进行验证操作的。<br>本例中代码如下：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common/guard/auth.guard.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;Injectable,CanActivate,HttpException,HttpStatus,ExecutionContext,&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  <span class="comment">// context 请求的(Response/Request)的引用</span></span><br><span class="line">  <span class="keyword">async</span> canActivate(context: ExecutionContext): <span class="built_in">Promise</span>&lt;boolean&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'进入全局权限守卫...'</span>);</span><br><span class="line">    <span class="comment">// 获取请求对象</span></span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="comment">// 获取请求头中的token字段</span></span><br><span class="line">    <span class="keyword">const</span> token = context.switchToRpc().getData().headers.token;</span><br><span class="line">    <span class="comment">// 如果白名单内的路由就不拦截直接通过</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasUrl(<span class="keyword">this</span>.urlList, request.url)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验证token的合理性以及根据token做出相应的操作</span></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这里可以添加验证逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">          <span class="string">'没有授权访问,请先登录'</span>,</span><br><span class="line">          HttpStatus.UNAUTHORIZED,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        <span class="string">'没有授权访问,请先登录'</span>,</span><br><span class="line">        HttpStatus.UNAUTHORIZED,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 白名单数组</span></span><br><span class="line">  private urlList: string[] = [</span><br><span class="line">    <span class="string">'/user/login'</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证该次请求是否为白名单内的路由</span></span><br><span class="line">  private hasUrl(urlList: string[], <span class="attr">url</span>: string): boolean &#123;</span><br><span class="line">    <span class="keyword">let</span> flag: boolean = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (urlList.indexOf(url) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的守卫模块如：<code>AuthGuard</code>。然后使用 <code>app.useGlobalGuards(new AuthGuard())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>AuthGuard</code>。然后从<code>@nestjs/common</code>中导<code>UseGuards</code>装饰器。最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/976e8bcbe31b38ce.png" alt></p>
<blockquote>
<p>同一路由注册多个守卫的执行顺序为，先是全局守卫执行，然后是模块中守卫执行</p>
</blockquote>
<h3 id="拦截器是第三道关卡"><a href="#拦截器是第三道关卡" class="headerlink" title="拦截器是第三道关卡"></a>拦截器是第三道关卡</h3><p>想到自定义返回内容如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;statusCode&quot;: 400,</span><br><span class="line">    &quot;timestamp&quot;: &quot;2022-05-14T08:06:45.265Z&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/user/login&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;请求失败&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;isNotIn&quot;: &quot;账号不能为空&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候就可以使用拦截器来做一下处理了。<br><strong>拦截器作用：</strong></p>
<ol>
<li>在函数执行之前/之后绑定额外的逻辑</li>
<li>转换从函数返回的结果</li>
<li>转换从函数抛出的异常</li>
<li>扩展基本函数行为</li>
<li>根据所选条件完全重写函数 (例如, 缓存目的)</li>
</ol>
<p><strong>拦截器的执行顺序分为两个部分：</strong></p>
<ul>
<li>第一个部分在管道和自定义逻辑(next.handle()方法)之前。</li>
<li>第二个部分在管道和自定义逻辑(next.handle()方法)之后。</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common/interceptor/response.interceptor.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 全局响应拦截器，统一返回体内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Injectable,</span><br><span class="line">  NestInterceptor,</span><br><span class="line">  CallHandler,</span><br><span class="line">  ExecutionContext,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"><span class="comment">// 返回体结构</span></span><br><span class="line">interface Response&lt;T&gt; &#123;</span><br><span class="line">  data: T;</span><br><span class="line">&#125;</span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseInterceptor</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">NestInterceptor</span>&lt;<span class="title">T</span>, <span class="title">Response</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">  intercept(</span><br><span class="line">    context: ExecutionContext,</span><br><span class="line">    next: CallHandler&lt;T&gt;,</span><br><span class="line">  ): Observable&lt;Response&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// 解析ExecutionContext的数据内容获取到请求体</span></span><br><span class="line">    <span class="keyword">const</span> ctx = context.switchToHttp();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest();</span><br><span class="line">    <span class="comment">// 实现数据的遍历与转变</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'进入全局响应拦截器...'</span>);</span><br><span class="line">    <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">      map(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'全局响应拦截器方法返回内容后...'</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          statusCode: <span class="number">0</span>,</span><br><span class="line">          timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</span><br><span class="line">          path: request.url,</span><br><span class="line">          message: <span class="string">'请求成功'</span>,</span><br><span class="line">          data:data</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/05/8d262c4c5dcad632.png" alt></p>
<blockquote>
<p>中间多了个全局管道以及自定义逻辑，即只有路由绑定的函数有正确的返回值之后才会有<code>next.handle()</code>之后的内容</p>
</blockquote>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>ResponseInterceptor</code>。然后使用 <code>app.useGlobalInterceptors(new ResponseInterceptor())</code>即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>ResponseInterceptor</code>。然后从<code>@nestjs/common</code>中导入<code>UseInterceptors</code>装饰器。最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get</code>…等装饰器之下即可</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/099d67812f591bc5.png" alt></p>
<blockquote>
<p>同一路由注册多个拦截器时候，优先执行模块中绑定的拦截器，然后其拦截器转换的内容将作为全局拦截器的内容，即包裹两次返回内容如：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123; // 全局拦截器效果</span><br><span class="line">    &quot;statusCode&quot;: 0,</span><br><span class="line">    &quot;timestamp&quot;: &quot;2022-05-14T08:20:06.159Z&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/user/login&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;请求成功&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">    	&quot;pagenum&quot;: 1, // 模块中拦截器包裹效果</span><br><span class="line">    	“pageSize&quot;: 10</span><br><span class="line">        &quot;list&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="管道是第四道关卡"><a href="#管道是第四道关卡" class="headerlink" title="管道是第四道关卡"></a>管道是第四道关卡</h3><ul>
<li><p>管道是请求过程中的第四个内容，主要用于对请求参数的验证和转换操作。</p>
</li>
<li><p>项目中使用<code>class-validator</code> <code>class-transformer</code>进行配合验证相关的输入操作内容</p>
</li>
</ul>
<p><strong>认识官方的三个内置管道</strong></p>
<ol>
<li><code>ValidationPipe</code>：基于<code>class-validator</code>和<code>class-transformer</code>这两个npm包编写的一个常规的验证管道，可以从<code>class-validator</code>导入配置规则，然后直接使用验证(当前不需要了解<code>ValidationPipe</code>的原理，只需要知道从<code>class-validator</code>引规则，设定到对应字段，然后使用<code>ValidationPipe</code>即可)</li>
<li><code>ParseIntPipe</code>：转换传入的参数为数字</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/05/9b73303097ddcf73.png" alt></p>
<p>如：传递过来的是/test?id=‘123’”这里会将字符串‘123’转换成数字123</p>
<ol start="3">
<li><strong>ParseUUIDPipe</strong>：验证字符串是否是 UUID(通用唯一识别码)</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/05/ea2ed3388b228548.png" alt></p>
<p>如：传递过来的是/test?id=‘xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx’”这里会验证格式是否正确，不正确则抛出错误，否则调用findOne方法</p>
<p>本例中管道使用如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common/pipe/validation.pipe.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 全局dto验证管道</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; validate &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; plainToClass &#125; <span class="keyword">from</span> <span class="string">'class-transformer'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PipeTransform, Injectable, ArgumentMetadata, BadRequestException &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span>&lt;<span class="title">any</span>&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// value 是当前处理的参数，而 metatype 是属性的元类型</span></span><br><span class="line">  <span class="keyword">async</span> transform(value: any, &#123; metatype &#125;: ArgumentMetadata) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'进入全局管道...'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!metatype || !<span class="keyword">this</span>.toValidate(metatype)) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// plainToClass方法将普通的javascript对象转换为特定类的实例</span></span><br><span class="line">    <span class="keyword">const</span> object = plainToClass(metatype, value);</span><br><span class="line">    <span class="comment">// 验证该对象返回出错的数组</span></span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">await</span> validate(object);</span><br><span class="line">    <span class="keyword">if</span> (errors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 将错误信息数组中的第一个内容返回给异常过滤器</span></span><br><span class="line">      <span class="keyword">let</span> errormsg = errors.shift().constraints;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(errormsg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 验证属性值的元类型是否是String, Boolean, Number, Array, Object中的一种</span></span><br><span class="line">  private toValidate(metatype: any): boolean &#123;</span><br><span class="line">    <span class="keyword">const</span> types: <span class="built_in">Function</span>[] = [<span class="built_in">String</span>, <span class="built_in">Boolean</span>, <span class="built_in">Number</span>, <span class="built_in">Array</span>, <span class="built_in">Object</span>];</span><br><span class="line">    <span class="keyword">return</span> !types.includes(metatype);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>ValidationPipe</code>；然后使用 <code>app.useGlobalPipes(new ValidationPipe())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>ValidationPipe</code>；然后从<code>@nestjs/common</code>中导入<code>UsePipes</code>装饰器；最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可，管道还允许注册在相关的参数上如：<code>@Body/@Query…</code>等</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/d9c2b21c632c9baa.png" alt></p>
<blockquote>
<p><strong>注意：</strong>同一路由注册多个管道的时候，优先执行全局管道，然后再执行模块管道：</p>
</blockquote>
<ul>
<li>异常过滤器是所有抛出的异常的统一处理方案</li>
<li>简单来讲就是捕获系统抛出的所有异常，然后自定义修改异常内容，抛出友好的提示。</li>
</ul>
<p><strong>内置异常类</strong></p>
<blockquote>
<p>系统提供了不少内置的系统异常类，需要的时候直接使用throw new XXX(描述,状态)这样的方式即可抛出对应的异常,一旦抛出异常，当前请求将会终止。</p>
</blockquote>
<p><strong>注意每个异常抛出的状态码有所不同</strong>。如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">BadRequestException — <span class="number">400</span></span><br><span class="line">UnauthorizedException — <span class="number">401</span></span><br><span class="line">ForbiddenException — <span class="number">403</span></span><br><span class="line">NotFoundException — <span class="number">404</span></span><br><span class="line">NotAcceptableException — <span class="number">406</span></span><br><span class="line">RequestTimeoutException — <span class="number">408</span></span><br><span class="line">ConflictException — <span class="number">409</span></span><br><span class="line">GoneException — <span class="number">410</span></span><br><span class="line">PayloadTooLargeException — <span class="number">413</span></span><br><span class="line">UnsupportedMediaTypeException — <span class="number">415</span></span><br><span class="line">UnprocessableEntityException — <span class="number">422</span></span><br><span class="line">InternalServerErrorException — <span class="number">500</span></span><br><span class="line">NotImplementedException — <span class="number">501</span></span><br><span class="line">BadGatewayException — <span class="number">502</span></span><br><span class="line">ServiceUnavailableException — <span class="number">503</span></span><br><span class="line">GatewayTimeoutException — <span class="number">504</span></span><br></pre></td></tr></table></figure>
<p>本例中使用的是自定义的异常类，代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// common/filters/http-exception.filter.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; ExceptionFilter, Catch, ArgumentsHost, HttpException,Logger,HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"></span><br><span class="line">@Catch()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpExceptionFilter</span> <span class="title">implements</span> <span class="title">ExceptionFilter</span> </span>&#123;</span><br><span class="line">  <span class="comment">// exception 当前正在处理的异常对象</span></span><br><span class="line">  <span class="comment">// host 是传递给原始处理程序的参数的一个包装(Response/Request)的引用</span></span><br><span class="line">  <span class="keyword">catch</span>(exception: HttpException, <span class="attr">host</span>: ArgumentsHost) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'进入全局异常过滤器...'</span>);</span><br><span class="line">    <span class="keyword">const</span> ctx = host.switchToHttp();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.getResponse&lt;Response&gt;();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest&lt;Request&gt;();</span><br><span class="line">    <span class="comment">// HttpException 属于基础异常类，可自定义内容</span></span><br><span class="line">    <span class="comment">// 如果是自定义的异常类则抛出自定义的status </span></span><br><span class="line">    <span class="comment">// 否则就是内置HTTP异常类，然后抛出其对应的内置Status内容</span></span><br><span class="line">    <span class="keyword">const</span> status =</span><br><span class="line">      exception <span class="keyword">instanceof</span> HttpException</span><br><span class="line">        ? exception.getStatus()</span><br><span class="line">        : HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">    <span class="comment">// 抛出错误信息</span></span><br><span class="line">    <span class="keyword">const</span> message =</span><br><span class="line">      exception.message ||</span><br><span class="line">      exception.message.message ||</span><br><span class="line">      exception.message.error ||</span><br><span class="line">      <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> msgLog = &#123;</span><br><span class="line">      statusCode: status, <span class="comment">// 系统错误状态</span></span><br><span class="line">      timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(), <span class="comment">// 错误日期</span></span><br><span class="line">      path: request.url, <span class="comment">// 错误路由</span></span><br><span class="line">      message: <span class="string">'请求失败'</span>, </span><br><span class="line">      data: message <span class="comment">// 错误消息内容体(争取和拦截器中定义的响应体一样)</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 打印错误综合日志</span></span><br><span class="line">     Logger.error(</span><br><span class="line">      <span class="string">'错误信息'</span>,</span><br><span class="line">      <span class="built_in">JSON</span>.stringify(msgLog),</span><br><span class="line">      <span class="string">'HttpExceptionFilter'</span>,</span><br><span class="line">    );</span><br><span class="line">    response</span><br><span class="line">      .status(status)</span><br><span class="line">      .json(msgLog);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注册方式</strong></p>
<ul>
<li>全局注册：在<code>main.ts</code>中导入需要的模块如：<code>HttpExceptionFilter</code> 然后使用 <code>app.useGlobalFilters(new HttpExceptionFilter())</code> 即可</li>
<li>模块注册：在需要注册的<code>controller</code>控制器中导入<code>HttpExceptionFilter</code>然后从<code>@nestjs/common</code>中导入<code>UseFilters</code>装饰器；最后直接放置在对应的<code>@Controller()</code>或者<code>@Post/@Get…</code>等装饰器之下即可</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/0263be3b963d942b.png" alt></p>
<blockquote>
<p><strong>注意：</strong> 同一路由注册多个管道的时候，只会执行一个异常过滤器，优先执行模块中绑定的异常过滤器，如果模块中无绑定异常过滤则执行全局异常过滤器</p>
</blockquote>
<h2 id="数据验证"><a href="#数据验证" class="headerlink" title="数据验证"></a>数据验证</h2><p>如何 限制 和 验证 前端传递过来的数据？</p>
<p>常用：<code>dto</code>（data transfer object数据传输对象） + <code>class-validator</code>，自定义提示内容，还能集成swagger</p>
<p><strong>class-validator的验证项装饰器</strong></p>
<p><a href="https://github.com/typestack/class-validator#usage" target="_blank" rel="noopener">https://github.com/typestack/class-validator#usage</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@IsOptional() //可选的</span><br><span class="line">@IsNotEmpty(&#123; message: ‘不能为空’ &#125;)</span><br><span class="line">@MinLength(6, &#123;message: ‘密码长度不能小于6位’&#125;)</span><br><span class="line">@MaxLength(20, &#123;message: ‘密码长度不能超过20位’&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@IsEmail(&#123;&#125;, &#123; message: ‘邮箱格式错误’ &#125;) //邮箱</span><br><span class="line">@IsMobilePhone(‘zh-CN’, &#123;&#125;, &#123; message: ‘手机号码格式错误’ &#125;) //手机号码</span><br><span class="line">@IsEnum([0, 1], &#123;message: ‘只能传入数字0或1’&#125;) //枚举</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ValidateIf(o =&gt; o.username === ‘admin’) //条件判断，条件满足才验证，如：这里是传入的username是admin才验证</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add class-validator class-transformer</span><br></pre></td></tr></table></figure>
<p>全局使用内置管道<code>ValidationPipe</code> ，不然会报错，无法起作用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Logger, ValidationPipe &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">  app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe()); <span class="comment">//全局内置管道</span></span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p>编写<code>dto</code>，使用<code>class-validator</code>的校验项验证</p>
<p>创建DTO：只需要用户名，密码即可，两种都不能为空</p>
<blockquote>
<p>可以使用<code>nest g res user</code>一键创建带有dto的接口模块</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, MinLength, MaxLength &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateUserDto</span> </span>&#123;</span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'用户名不能为空'</span> &#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'密码不能为空'</span> &#125;)</span><br><span class="line">  @MinLength(<span class="number">6</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能小于6位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @MaxLength(<span class="number">20</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能超过20位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改DTO：用户名，密码，手机号码，邮箱，性别，状态，都是<strong>可选的</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  IsEnum,</span><br><span class="line">  MinLength,</span><br><span class="line">  MaxLength,</span><br><span class="line">  IsOptional,</span><br><span class="line">  IsEmail,</span><br><span class="line">  IsMobilePhone,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Type &#125; <span class="keyword">from</span> <span class="string">'class-transformer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateUserDto</span> </span>&#123;</span><br><span class="line">  @IsOptional()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @IsOptional()</span><br><span class="line">  @MinLength(<span class="number">6</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能小于6位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @MaxLength(<span class="number">20</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能超过20位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEmail(&#123;&#125;, &#123; <span class="attr">message</span>: <span class="string">'邮箱格式错误'</span> &#125;)</span><br><span class="line">  email: string;</span><br><span class="line"></span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsMobilePhone(<span class="string">'zh-CN'</span>, &#123;&#125;, &#123; <span class="attr">message</span>: <span class="string">'手机号码格式错误'</span> &#125;)</span><br><span class="line">  mobile: string;</span><br><span class="line"></span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEnum([<span class="string">'male'</span>, <span class="string">'female'</span>], &#123;</span><br><span class="line">    message: <span class="string">'gender只能传入字符串male或female'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  gender: string;</span><br><span class="line"></span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEnum(&#123; 禁用: <span class="number">0</span>, 可用: <span class="number">1</span> &#125;,&#123;</span><br><span class="line">    message: <span class="string">'status只能传入数字0或1'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @Type(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Number</span>) <span class="comment">//如果传递的是string类型，不报错，自动转成number类型</span></span><br><span class="line">  status: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>controller</code>和<code>service</code>一起使用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.controller.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-user.dto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line">  </span><br><span class="line">  @Post()</span><br><span class="line">  @HttpCode(HttpStatus.OK)</span><br><span class="line">  <span class="keyword">async</span> create(@Body() user: CreateUserDto) &#123; <span class="comment">//使用创建dto</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(user);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @Patch(<span class="string">':id'</span>)</span><br><span class="line">    <span class="keyword">async</span> update(@Param(<span class="string">'id'</span>) id: string, @Body() user: UpdateUserDto) &#123;  <span class="comment">//使用更新dto</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.update(id, user);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-user.dto'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(user: CreateUserDto) &#123; <span class="comment">//使用dto</span></span><br><span class="line">    <span class="keyword">do</span> some thing....</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/05/21f5a8f9dbfad1f0.png" alt><br><img src="https://s.poetries.work/uploads/2022/05/38a1ae106ec9638c.png" alt></p>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="配置抽离"><a href="#配置抽离" class="headerlink" title="配置抽离"></a>配置抽离</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add nestjs-config</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.module.ts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据库</span></span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//全局配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; ConfigModule, ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">//1.配置config目录</span></span><br><span class="line">    ConfigModule.load(path.resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.读取配置，这里读取的是数据库配置</span></span><br><span class="line">	TypeOrmModule.forRootAsync(&#123;</span><br><span class="line">      useFactory: <span class="function">(<span class="params">config: ConfigService</span>) =&gt;</span> config.get(<span class="string">'database'</span>), </span><br><span class="line">      inject: [ConfigService],  <span class="comment">// 获取服务注入</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [AppService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置数据库</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">src -&gt; config -&gt; database</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  type: <span class="string">'mysql'</span>,</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  port: <span class="number">3306</span>,</span><br><span class="line">  username: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">'your password'</span>,</span><br><span class="line">  database: <span class="string">'test'</span>,</span><br><span class="line">  entities: [join(__dirname, <span class="string">'../'</span>, <span class="string">'**/**.entity&#123;.ts,.js&#125;'</span>)],</span><br><span class="line">  synchronize: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add cross-env</span><br></pre></td></tr></table></figure>
<p>cross-env的作用是兼容window系统和mac系统来设置环境变量</p>
<p><strong>在package.json中配置</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start:dev&quot;: &quot;cross-env NODE_ENV=development nest start --watch&quot;,</span><br><span class="line">    &quot;start:debug&quot;: &quot;nest start --debug --watch&quot;,</span><br><span class="line">    &quot;start:prod&quot;: &quot;cross-env NODE_ENV=production node dist/main&quot;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p><strong>dotenv的使用</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add dotenv</span><br></pre></td></tr></table></figure>
<p><strong>根目录创建 env.parse.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dotenv <span class="keyword">from</span> <span class="string">'dotenv'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isProd = process.env.NODE_ENV === <span class="string">'production'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> localEnv = path.resolve(<span class="string">'.env.local'</span>);</span><br><span class="line"><span class="keyword">const</span> prodEnv = path.resolve(<span class="string">'.env.prod'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> filePath = isProd &amp;&amp; fs.existsSync(prodEnv) ? prodEnv : localEnv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置 通过process.env.xx读取变量</span></span><br><span class="line">dotenv.config(&#123; <span class="attr">path</span>: filePath &#125;);</span><br></pre></td></tr></table></figure>
<p>导入环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// main.ts</span><br><span class="line">import &apos;../env.parse&apos;; // 导入环境变量</span><br></pre></td></tr></table></figure>
<p><code>.env.local</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PORT=9000</span><br><span class="line">MYSQL_HOST=127.0.0.1</span><br><span class="line">MYSQL_PORT=3306</span><br><span class="line">MYSQL_USER=root</span><br><span class="line">MYSQL_PASSWORD=123</span><br><span class="line">MYSQL_DATABASE=test</span><br></pre></td></tr></table></figure>
<p><code>.env.prod</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PORT=9000</span><br><span class="line">MYSQL_HOST=127.0.0.1</span><br><span class="line">MYSQL_PORT=3306</span><br><span class="line">MYSQL_USER=root</span><br><span class="line">MYSQL_PASSWORD=1234</span><br><span class="line">MYSQL_DATABASE=test</span><br></pre></td></tr></table></figure>
<p>读取环境变量 <code>process.env.MYSQL_HOST</code>形式</p>
<h2 id="文件上传与下载"><a href="#文件上传与下载" class="headerlink" title="文件上传与下载"></a>文件上传与下载</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add @nestjs/platform-express compressing</span><br><span class="line"></span><br><span class="line">compressing 文件下载依赖，提供流的方式</span><br></pre></td></tr></table></figure>
<p>配置文件的目录地址，以及文件的名字格式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/config/file.ts 上传文件配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; diskStorage &#125; <span class="keyword">from</span> <span class="string">'multer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  root: join(__dirname, <span class="string">'../../assets/uploads'</span>),</span><br><span class="line">  storage: diskStorage(&#123;</span><br><span class="line">    destination: join(</span><br><span class="line">      __dirname,</span><br><span class="line">      <span class="string">`../../assets/uploads/<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleDateString()&#125;</span>`</span>,</span><br><span class="line">    ),</span><br><span class="line">    filename: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> filename = <span class="string">`<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>.<span class="subst">$&#123;file.mimetype.split(<span class="string">'/'</span>)[<span class="number">1</span>]&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">return</span> cb(<span class="literal">null</span>, filename);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; ConfigModule, ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// 加载配置文件目录 src/config</span></span><br><span class="line">    ConfigModule.load(resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [],</span><br><span class="line">  providers: [],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// upload.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  UseInterceptors,</span><br><span class="line">  UploadedFile,</span><br><span class="line">  UploadedFiles,</span><br><span class="line">  Body,</span><br><span class="line">  Res,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FileInterceptor, FilesInterceptor &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FileUploadDto &#125; <span class="keyword">from</span> <span class="string">'./dto/upload-file.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UploadService &#125; <span class="keyword">from</span> <span class="string">'./upload.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Response &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'common'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly uploadService: UploadService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">'upload'</span>)</span><br><span class="line">  @UseInterceptors(FileInterceptor(<span class="string">'file'</span>))</span><br><span class="line">  uploadFile(@UploadedFile() file) &#123;</span><br><span class="line">    <span class="keyword">this</span>.uploadService.uploadSingleFile(file);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 多文件上传</span></span><br><span class="line">  @Post(<span class="string">'uploads'</span>)</span><br><span class="line">  @UseInterceptors(FilesInterceptor(<span class="string">'file'</span>))</span><br><span class="line">  uploadMuliFile(@UploadedFiles() files, @Body() body) &#123;</span><br><span class="line">    <span class="keyword">this</span>.uploadService.UploadMuliFile(files, body);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'export'</span>)</span><br><span class="line">  <span class="keyword">async</span> downloadAll(@Res() res: Response) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; filename, tarStream &#125; = <span class="keyword">await</span> <span class="keyword">this</span>.uploadService.downloadAll();</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/octet-stream'</span>);</span><br><span class="line">    res.setHeader(<span class="string">'Content-Disposition'</span>, <span class="string">`attachment; filename=<span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">    tarStream.pipe(res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// upload.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createWriteStream &#125; <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tar &#125; <span class="keyword">from</span> <span class="string">'compressing'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly configService: ConfigService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  uploadSingleFile(file: any) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'file'</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">  UploadMuliFile(files: any, <span class="attr">body</span>: any) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'files'</span>, files);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> downloadAll() &#123;</span><br><span class="line">    <span class="keyword">const</span> uploadDir = <span class="keyword">this</span>.configService.get(<span class="string">'file'</span>).root;</span><br><span class="line">    <span class="keyword">const</span> tarStream = <span class="keyword">new</span> tar.Stream();</span><br><span class="line">    <span class="keyword">await</span> tarStream.addEntry(uploadDir);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">filename</span>: <span class="string">'download.tar'</span>, tarStream &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// upload.module.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MulterModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UploadService &#125; <span class="keyword">from</span> <span class="string">'./upload.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UploadController &#125; <span class="keyword">from</span> <span class="string">'./upload.controller'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    MulterModule.registerAsync(&#123;</span><br><span class="line">      useFactory: <span class="function">(<span class="params">config: ConfigService</span>) =&gt;</span> config.get(<span class="string">'file'</span>),</span><br><span class="line">      inject: [ConfigService],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [UploadController],</span><br><span class="line">  providers: [UploadService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现图片随机验证码"><a href="#实现图片随机验证码" class="headerlink" title="实现图片随机验证码"></a>实现图片随机验证码</h2><p>nest如何实现图片随机验证码？</p>
<p><img src="https://s.poetries.work/uploads/2022/05/58d3d8e7ca89835f.png" alt></p>
<p>这里使用的是<strong>svg-captcha</strong>这个库，你也可以使用其他的库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add svg-captcha</span><br></pre></td></tr></table></figure>
<p><strong>封装，以便多次调用</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">src -&gt; utils -&gt; tools.service.ts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> svgCaptcha <span class="keyword">from</span> <span class="string">'svg-captcha'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ToolsService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> captche(size = <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> captcha = svgCaptcha.create(&#123;  <span class="comment">//可配置返回的图片信息</span></span><br><span class="line">      size, <span class="comment">//生成几个验证码</span></span><br><span class="line">      fontSize: <span class="number">50</span>, <span class="comment">//文字大小</span></span><br><span class="line">      width: <span class="number">100</span>,  <span class="comment">//宽度</span></span><br><span class="line">      height: <span class="number">34</span>,  <span class="comment">//高度</span></span><br><span class="line">      background: <span class="string">'#cc9966'</span>,  <span class="comment">//背景颜色</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> captcha;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在使用的module中引入</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserController &#125; <span class="keyword">from</span> <span class="string">'./user.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  controllers: [UserController],</span><br><span class="line">  providers: [UserService, ToolsService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post，Body &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EmailService &#125; <span class="keyword">from</span> <span class="string">'./email.service'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly toolsService: ToolsService,) &#123;&#125;  <span class="comment">//注入服务</span></span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'authcode'</span>)  <span class="comment">//当请求该接口时，返回一张随机图片验证码</span></span><br><span class="line">  <span class="keyword">async</span> getCode(@Req() req, @Res() res) &#123;</span><br><span class="line">    <span class="keyword">const</span> svgCaptcha = <span class="keyword">await</span> <span class="keyword">this</span>.toolsService.captche(); <span class="comment">//创建验证码</span></span><br><span class="line">    req.session.code = svgCaptcha.text; <span class="comment">//使用session保存验证，用于登陆时验证</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.session.code);</span><br><span class="line">    res.type(<span class="string">'image/svg+xml'</span>); <span class="comment">//指定返回的类型</span></span><br><span class="line">    res.send(svgCaptcha.data); <span class="comment">//给页面返回一张图片</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">'/login'</span>)</span><br><span class="line">  login(@Body() body, @Session() session) &#123;</span><br><span class="line">  	<span class="comment">//验证验证码，由前端传递过来</span></span><br><span class="line">  	<span class="keyword">const</span> &#123; code &#125; = body;</span><br><span class="line">  	<span class="keyword">if</span>(code?.toUpperCase() === session.code?.toUpperCase())&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(‘验证码通过’)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello authcode'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>前端简单代码</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        form &#123;</span><br><span class="line">            display: flex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.input</span> &#123;</span></span><br><span class="line">            width: 80px;</span><br><span class="line">            height: 32px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.verify_img</span> &#123;</span></span><br><span class="line">            margin: 0px 5px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>随机验证码<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/user/login"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"application/x-www-form-urlencoded"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">'code'</span> <span class="attr">class</span>=<span class="string">"input"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"verify_img"</span> <span class="attr">src</span>=<span class="string">"/user/code"</span> <span class="attr">title</span>=<span class="string">"看不清？点击刷新"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">onclick</span>=<span class="string">"javascript:this.src='/user/code?t='+Math.random()"</span>&gt;</span> //点击再次生成新的验证码</span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="邮件服务"><a href="#邮件服务" class="headerlink" title="邮件服务"></a>邮件服务</h2><blockquote>
<p>邮件服务使用文档 <a href="https://nest-modules.github.io/mailer/docs/mailer" target="_blank" rel="noopener">https://nest-modules.github.io/mailer/docs/mailer</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 邮件服务配置</span></span><br><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; MailerModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs-modules/mailer'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; resolve, join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigModule, ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// 加载配置文件目录 src/config</span></span><br><span class="line">    ConfigModule.load(resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line">    <span class="comment">// 邮件服务配置</span></span><br><span class="line">    MailerModule.forRootAsync(&#123;</span><br><span class="line">      useFactory: <span class="function">(<span class="params">config: ConfigService</span>) =&gt;</span> config.get(<span class="string">'email'</span>),</span><br><span class="line">      inject: [ConfigService],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [],</span><br><span class="line">  providers: [],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// src/config/email.ts 邮件服务配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="comment">// npm i ejs -S</span></span><br><span class="line"><span class="keyword">import</span> &#123; EjsAdapter &#125; <span class="keyword">from</span> <span class="string">'@nestjs-modules/mailer/dist/adapters/ejs.adapter'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  transport: &#123;</span><br><span class="line">    host: <span class="string">'smtp.qq.com'</span>,</span><br><span class="line">    secureConnection: <span class="literal">true</span>, <span class="comment">// use SSL</span></span><br><span class="line">    secure: <span class="literal">true</span>,</span><br><span class="line">    port: <span class="number">465</span>,</span><br><span class="line">    ignoreTLS: <span class="literal">false</span>,</span><br><span class="line">    auth: &#123;</span><br><span class="line">      user: <span class="string">'123@test.com'</span>,</span><br><span class="line">      pass: <span class="string">'dfafew1'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  defaults: &#123;</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">'"nestjs" &lt;123@test.com&gt;'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// preview: true, // 发送邮件前预览</span></span><br><span class="line">  template: &#123;</span><br><span class="line">    dir: join(__dirname, <span class="string">'../templates/email'</span>), <span class="comment">// 邮件模板</span></span><br><span class="line">    adapter: <span class="keyword">new</span> EjsAdapter(),</span><br><span class="line">    options: &#123;</span><br><span class="line">      strict: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>邮件服务使用</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// email.services.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MailerService &#125; <span class="keyword">from</span> <span class="string">'@nestjs-modules/mailer'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailService</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 邮件服务注入</span></span><br><span class="line">  <span class="keyword">constructor</span>(private mailerService: MailerService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendEmail() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'发送邮件'</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.mailerService.sendMail(&#123;</span><br><span class="line">      to: <span class="string">'test@qq.com'</span>, <span class="comment">// 收件人</span></span><br><span class="line">      <span class="keyword">from</span>: <span class="string">'123@test.com'</span>, <span class="comment">// 发件人</span></span><br><span class="line">      <span class="comment">// subject: '副标题',</span></span><br><span class="line">      text: <span class="string">'welcome'</span>, <span class="comment">// plaintext body</span></span><br><span class="line">      html: <span class="string">'&lt;h1&gt;hello&lt;/h1&gt;'</span>, <span class="comment">// HTML body content</span></span><br><span class="line">      <span class="comment">// template: 'email', // 邮件模板</span></span><br><span class="line">      <span class="comment">// context: &#123; // 传入邮件模板的data</span></span><br><span class="line">      <span class="comment">//   email: 'test@qq.com',</span></span><br><span class="line">      <span class="comment">// &#125;,</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'发送成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nest基于possport-jwt做登陆验证"><a href="#nest基于possport-jwt做登陆验证" class="headerlink" title="nest基于possport + jwt做登陆验证"></a>nest基于possport + jwt做登陆验证</h2><p><strong>方式与逻辑</strong></p>
<ul>
<li>基于possport的本地策略和jwt策略</li>
<li><strong>本地策略</strong>主要是验证账号和密码是否存在，如果存在就登陆，返回<strong>token</strong></li>
<li><strong>jwt策略</strong>则是验证用户<strong>登陆时附带的token</strong>是否匹配和有效，如果不匹配和无效则返回<strong>401状态码</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add @nestjs/jwt @nestjs/passport passport-jwt passport-local passport</span><br><span class="line">yarn add -D @types/passport @types/passport-jwt @types/passport-local</span><br></pre></td></tr></table></figure>
<p><strong>jwt策略 jwt.strategy.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/jwt.strategy.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Strategy, ExtractJwt, StrategyOptions &#125; <span class="keyword">from</span> <span class="string">'passport-jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">'./constants'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtStrategy</span> <span class="keyword">extends</span> <span class="title">PassportStrategy</span>(<span class="title">Strategy</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      jwtFromRequest: ExtractJwt.fromHeader(<span class="string">'token'</span>),</span><br><span class="line">      ignoreExpiration: <span class="literal">false</span>,</span><br><span class="line">      secretOrKey: jwtConstants.secret, <span class="comment">// 使用密钥解析</span></span><br><span class="line">    &#125; <span class="keyword">as</span> StrategyOptions);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//token验证, payload是super中已经解析好的token信息</span></span><br><span class="line">  <span class="keyword">async</span> validate(payload: any) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">userId</span>: payload.userId, <span class="attr">username</span>: payload.username &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>本地策略 local.strategy.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/local.strategy.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Strategy, IStrategyOptions &#125; <span class="keyword">from</span> <span class="string">'passport-local'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本地策略</span></span><br><span class="line"><span class="comment">//PassportStrategy接受两个参数：</span></span><br><span class="line"><span class="comment">//第一个：Strategy，你要用的策略，这里是passport-local，本地策略</span></span><br><span class="line"><span class="comment">//第二个：别名，可选，默认是passport-local的local，用于接口时传递的字符串</span></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalStrategy</span> <span class="keyword">extends</span> <span class="title">PassportStrategy</span>(<span class="title">Strategy</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private authService: AuthService) &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      usernameField: <span class="string">'username'</span>,</span><br><span class="line">      passwordField: <span class="string">'password'</span>,</span><br><span class="line">    &#125; <span class="keyword">as</span> IStrategyOptions);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate是LocalStrategy的内置方法</span></span><br><span class="line">  <span class="keyword">async</span> validate(username: string, <span class="attr">password</span>: string): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="comment">//查询数据库，验证账号密码，并最终返回用户</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.authService.validateUser(&#123; username, password &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>constants.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/constants.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> jwtConstants = &#123;</span><br><span class="line">  secret: <span class="string">'secretKey'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>使用守卫 auth.controller.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/auth.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post, Request, UseGuards &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'auth'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly authService: AuthService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 登录测试 无需token</span></span><br><span class="line">  @UseGuards(AuthGuard(<span class="string">'local'</span>)) <span class="comment">//本地策略，传递local，执行local里面的validate方法</span></span><br><span class="line">  @Post(<span class="string">'login'</span>)</span><br><span class="line">  <span class="keyword">async</span> login(@Request() req) &#123; <span class="comment">//通过req可以获取到validate方法返回的user，传递给login，登陆</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.authService.login(req.user);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在需要的地方使用守卫，需要带token才可访问</span></span><br><span class="line">  @UseGuards(AuthGuard(<span class="string">'jwt'</span>))<span class="comment">//jwt策略，身份鉴权</span></span><br><span class="line">  @Get(<span class="string">'userInfo'</span>)</span><br><span class="line">  getUserInfo(@Request() req) &#123;<span class="comment">//通过req获取到被验证后的user，也可以使用装饰器</span></span><br><span class="line">    <span class="keyword">return</span> req.user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在module引入jwt配置和数据库查询的实体 auth.module.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/auth.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; LocalStrategy &#125; <span class="keyword">from</span> <span class="string">'./local.strategy'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">'./constants'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthController &#125; <span class="keyword">from</span> <span class="string">'./auth.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtStrategy &#125; <span class="keyword">from</span> <span class="string">'./jwt.strategy'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'../user/entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    TypeOrmModule.forFeature([UsersEntity]),</span><br><span class="line">    PassportModule,</span><br><span class="line">    JwtModule.register(&#123;</span><br><span class="line">      secret: jwtConstants.secret,</span><br><span class="line">      signOptions: &#123; <span class="attr">expiresIn</span>: <span class="string">'10d'</span> &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [AuthController],</span><br><span class="line">  providers: [AuthService, LocalStrategy, JwtStrategy],</span><br><span class="line">  exports: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>auth.service.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/modules/auth/auth.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; compareSync &#125; <span class="keyword">from</span> <span class="string">'bcryptjs'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">  	@InjectRepository(UsersEntity),</span><br><span class="line">       private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  	private jwtService: JwtService</span><br><span class="line">    ) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  validateUser(username: string, <span class="attr">password</span>: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123;</span><br><span class="line">      where: &#123; username &#125;,</span><br><span class="line">      select: [<span class="string">'username'</span>, <span class="string">'password'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户名或密码不正确'</span>);</span><br><span class="line">    <span class="comment">//使用bcryptjs验证密码</span></span><br><span class="line">    <span class="keyword">if</span> (!compareSync(password, user.password)) &#123;</span><br><span class="line">      ToolsService.fail(<span class="string">'用户名或密码不正确'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">  login(user: any) &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123; <span class="attr">username</span>: user.username &#125;;  <span class="comment">// 把信息存在token</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      token: <span class="keyword">this</span>.jwtService.sign(payload),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在app.module.ts中导入即可测试</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.modules.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; AuthModule &#125; <span class="keyword">from</span> <span class="string">'./modules/auth/auth.module'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    ...</span><br><span class="line">    AuthModule, <span class="comment">// 导入模块</span></span><br><span class="line">  ],</span><br><span class="line">  controllers: [AppController],</span><br><span class="line">  providers: [],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用postman测试</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/05/154d26405e7a471a.png" alt></p>
<h2 id="对数据库的密码加密：md5和bcryptjs"><a href="#对数据库的密码加密：md5和bcryptjs" class="headerlink" title="对数据库的密码加密：md5和bcryptjs"></a>对数据库的密码加密：md5和bcryptjs</h2><p><strong>密码加密</strong></p>
<blockquote>
<p>一般开发中，是不会有人直接将密码明文直接放到数据库当中的。因为这种做法是非常不安全的，需要对密码进行加密处理。<br>好处：</p>
<ul>
<li>预防内部网站运营人员知道用户的密码</li>
<li>预防外部的攻击，尽可能保护用户的隐私</li>
</ul>
</blockquote>
<p><strong>加密方式</strong></p>
<ul>
<li>使用<code>md5</code>：每次生成的值是一样的，一些网站可以破解，因为每次存储的都是一样的值</li>
<li>使用<code>bcryptjs</code>：每次生成的值是不一样的</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add md5</span><br></pre></td></tr></table></figure>
<p>加密</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> md5 <span class="keyword">from</span> <span class="string">'md5'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> passwrod = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">const</span> transP = md5(passwrod);  <span class="comment">// 固定值：e10adc3949ba59abbe56e057f20f883e</span></span><br></pre></td></tr></table></figure>
<p>给密码加点”盐”：目的是混淆密码，其实还是得到固定的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> passwrod = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">const</span> salt = <span class="string">'dmxys'</span></span><br><span class="line"><span class="keyword">const</span> transP = md5(passwrod + salt);  <span class="comment">// 固定值：4e6a2881e83262a72f6c70f48f3e8022</span></span><br></pre></td></tr></table></figure>
<p>验证密码：先加密，再验证</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> passwrod = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">const</span> databasePassword = <span class="string">'e10adc3949ba59abbe56e057f20f883e'</span></span><br><span class="line"><span class="keyword">if</span> (md5(passwrod) === databasePassword ) &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'密码通过'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用bcryptjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add bcryptjs</span><br><span class="line">yarn add -D @types/bcryptjs</span><br></pre></td></tr></table></figure>
<p>同一密码，每次生成不一样的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; compareSync, hashSync &#125; <span class="keyword">from</span> <span class="string">'bcryptjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> passwrod = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">const</span> transformPass = hashSync(passwrod);  $<span class="number">2</span>a$<span class="number">10</span>$HgTA1GX8uxbocSQlbQ42/.Y2XnIL7FyfKzn6IC69IXveD6F9LiULS</span><br><span class="line"><span class="keyword">const</span> transformPass2 = hashSync(passwrod); $<span class="number">2</span>a$<span class="number">10</span>$mynd130vI1vkz4OQ3C<span class="number">.6</span>FeYXGEq24KLUt1CsKN2WZqVsv0tPrtOcW</span><br><span class="line"><span class="keyword">const</span> transformPass3 = hashSync(passwrod); $<span class="number">2</span>a$<span class="number">10</span>$bOHdFQ4TKBrtcNgmduzD8esds04BoXc0JcrLme68rTeik7U96KBvu</span><br></pre></td></tr></table></figure>
<p>验证密码：使用不同的值 匹配 密码123456，都能通过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> password = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">const</span> databasePassword1 = <span class="string">'$2a$10$HgTA1GX8uxbocSQlbQ42/.Y2XnIL7FyfKzn6IC69IXveD6F9LiULS'</span></span><br><span class="line"><span class="keyword">const</span> databasePassword2 = <span class="string">'$2a$10$mynd130vI1vkz4OQ3C.6FeYXGEq24KLUt1CsKN2WZqVsv0tPrtOcW'</span></span><br><span class="line"><span class="keyword">const</span> databasePassword3 = <span class="string">'$2a$10$bOHdFQ4TKBrtcNgmduzD8esds04BoXc0JcrLme68rTeik7U96KBvu'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (compareSync(password, databasePassword3)) &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'密码通过'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>推荐使用<code>bcryptjs</code>，算法要比<code>md5</code>高级</p>
<h2 id="角色权限"><a href="#角色权限" class="headerlink" title="角色权限"></a>角色权限</h2><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><ul>
<li><blockquote>
<ul>
<li><p>RBAC是基于角色的权限访问控制（Role-Based Access Control）一种数据库设计思想，根据设计数据库设计方案，完成项目的权限管理</p>
</li>
<li><p>在RBAC中，有3个基础组成部分，分别是：<code>用户</code>、<code>角色</code>和<code>权限</code>，权限与角色相关联，用户通过成为适当角色而得到这些角色的权限</p>
</li>
</ul>
</blockquote>
</li>
<li><p>权限：具备操作某个事务的能力</p>
</li>
<li>角色：一系列权限的集合</li>
</ul>
<blockquote>
<p>如：一般的管理系统中：<br>销售人员：仅仅可以查看商品信息<br>运营人员：可以查看，修改商品信息<br>管理人员：可以查看，修改，删除，以及修改员工权限等等<br>管理人员只要为每个员工账号分配对应的角色，登陆操作时就只能执行对应的权限或看到对应的页面</p>
</blockquote>
<p><strong>权限类型</strong></p>
<ul>
<li>展示（菜单），如：显示用户列表，显示删除按钮等等…</li>
<li>操作（功能），如：增删改查，上传下载，发布公告，发起活动等等…</li>
</ul>
<p><strong>数据库设计</strong></p>
<blockquote>
<p>数据库设计：可简单，可复杂，几个人使用的系统和几千人使用的系统是不一样的<br>小型项目：用户表，权限表<br>中型项目：用户表，角色表，权限表<br>大型项目：用户表，用户分组表，角色表，权限表，菜单表…</p>
</blockquote>
<p><strong>没有角色的设计</strong></p>
<p>只有用户表，菜单表，两者是多对多关系，有一个关联表</p>
<p><strong>缺点：</strong></p>
<ul>
<li>新建一个用户时，在用户表中添加一条数据</li>
<li>新建一个用户时，在关联表中添加N条数据</li>
<li>每次新建一个用户需要添加1+N(关联几个)条数据</li>
<li>如果有100个用户，每个用户100个权限，那需要添加10000条数据</li>
</ul>
<h3 id="基于RBAC的设计"><a href="#基于RBAC的设计" class="headerlink" title="基于RBAC的设计"></a>基于RBAC的设计</h3><p>用户表和角色表的关系设计：</p>
<blockquote>
<p>如果你希望一个用户可以有多个角色，如：一个人即是销售总监，也是人事管理，就设计多对多关系<br>如果你希望一个用户只能有一个角色，就设计一对多，多对一关系</p>
</blockquote>
<p>角色表和权限表的关系设计：</p>
<blockquote>
<p>一个角色可以拥有多个权限，一个权限被多个角色使用，设计多对多关系</p>
</blockquote>
<p><strong>多对多关系设计</strong></p>
<p>用户表与角色表是多对多关系，角色表与菜单表是多对多关系</p>
<p><img src="https://s.poetries.work/uploads/2022/05/df5b0726d1260958.png" alt></p>
<p><strong>更加复杂的设计</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/05/58f62ca515da28df.png" alt></p>
<p><strong>实现流程</strong></p>
<ol>
<li>数据表设计</li>
<li>实现角色的增删改查</li>
<li>实现用户的增删改查，增加和修改用户的时候需要选择角色</li>
<li>实现权限的增删改查</li>
<li>实现角色与授权的关联</li>
<li>判断当前登录的用户是否有访问菜单的权限</li>
<li>根据当前登录账户的角色信息动态显示左侧菜单（前端）</li>
</ol>
<p><strong>代码实现</strong></p>
<blockquote>
<p>这里将实现一个用户，部门，角色，权限的例子：<br>用户通过成为部门的一员，则拥有部门普通角色的权限，还可以单独给用户设置角色，通过角色，获取权限。<br>权限模块包括，模块，菜单，操作，通过type区分类型，这里就不再拆分。</p>
</blockquote>
<p><strong>关系总览：</strong></p>
<ul>
<li>用户 - 部门：一对多关系，这里设计用户只能加入一个部门，如果设计可以加入多个部门，设计为多对多关系</li>
<li>用户 - 角色：多对多关系，可以给用户设置多个角色</li>
<li>角色 - 部门：多对多关系，一个部门多个角色</li>
<li>角色 - 权限：多对多关系，一个角色拥有多个权限，一个权限被多个角色使用</li>
</ul>
<h3 id="数据库实体设计"><a href="#数据库实体设计" class="headerlink" title="数据库实体设计"></a>数据库实体设计</h3><p><strong>用户</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  ManyToMany,</span><br><span class="line">  ManyToOne,</span><br><span class="line">  JoinColumn,</span><br><span class="line">  JoinTable,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RoleEntity &#125; <span class="keyword">from</span> <span class="string">'../../role/entities/role.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DepartmentEntity &#125; <span class="keyword">from</span> <span class="string">'../../department/entities/department.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'user'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">30</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    unique: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    name: <span class="string">'password'</span>,</span><br><span class="line">    length: <span class="number">100</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    comment: <span class="string">'密码'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> RoleEntity, (role) =&gt; role.users)</span><br><span class="line">  @JoinTable(&#123; <span class="attr">name</span>: <span class="string">'user_role'</span> &#125;)</span><br><span class="line">  roles: RoleEntity[];</span><br><span class="line"></span><br><span class="line">  @ManyToOne(<span class="function"><span class="params">()</span> =&gt;</span> DepartmentEntity, (department) =&gt; department.users)</span><br><span class="line">  @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">'department_id'</span> &#125;)</span><br><span class="line">  department: DepartmentEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>角色</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  Column,</span><br><span class="line">  ManyToMany,</span><br><span class="line">  JoinTable,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'../../user/entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DepartmentEntity &#125; <span class="keyword">from</span> <span class="string">'../../department/entities/department.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AccessEntity &#125; <span class="keyword">from</span> <span class="string">'../../access/entities/access.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'role'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span>, <span class="attr">length</span>: <span class="number">30</span> &#125;)</span><br><span class="line">  rolename: string;</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> UsersEntity, (user) =&gt; user.roles)</span><br><span class="line">  users: UsersEntity[];</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> DepartmentEntity, (department) =&gt; department.roles)</span><br><span class="line">  department: DepartmentEntity[];</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> AccessEntity, (access) =&gt; access.roles)</span><br><span class="line">  @JoinTable(&#123; <span class="attr">name</span>: <span class="string">'role_access'</span> &#125;)</span><br><span class="line">  access: AccessEntity[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>部门</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  Column,</span><br><span class="line">  ManyToMany,</span><br><span class="line">  OneToMany,</span><br><span class="line">  JoinTable,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'../../user/entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RoleEntity &#125; <span class="keyword">from</span> <span class="string">'../../role/entities/role.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'department'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">DepartmentEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span>, <span class="attr">length</span>: <span class="number">30</span> &#125;)</span><br><span class="line">  departmentname: string;</span><br><span class="line"></span><br><span class="line">  @OneToMany(<span class="function"><span class="params">()</span> =&gt;</span> UsersEntity, (user) =&gt; user.department)</span><br><span class="line">  users: UsersEntity[];</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> RoleEntity, (role) =&gt; role.department)</span><br><span class="line">  @JoinTable(&#123; <span class="attr">name</span>: <span class="string">'department_role'</span> &#125;)</span><br><span class="line">  roles: RoleEntity[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>权限</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  Column,</span><br><span class="line">  Tree,</span><br><span class="line">  TreeChildren,</span><br><span class="line">  TreeParent,</span><br><span class="line">  ManyToMany,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RoleEntity &#125; <span class="keyword">from</span> <span class="string">'../../role/entities/role.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'access'</span> &#125;)</span><br><span class="line">@Tree(<span class="string">'closure-table'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span>, <span class="attr">length</span>: <span class="number">30</span>, <span class="attr">comment</span>: <span class="string">'模块'</span> &#125;)</span><br><span class="line">  module_name: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span>, <span class="attr">length</span>: <span class="number">30</span>, <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">comment</span>: <span class="string">'操作'</span> &#125;)</span><br><span class="line">  action_name: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'tinyint'</span>, <span class="attr">comment</span>: <span class="string">'类型：1:模块，2：菜单，3：操作'</span> &#125;)</span><br><span class="line">  type: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'text'</span>, <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">comment</span>: <span class="string">'操作地址'</span> &#125;)</span><br><span class="line">  url: string;</span><br><span class="line"></span><br><span class="line">  @TreeParent()</span><br><span class="line">  parentCategory: AccessEntity;</span><br><span class="line"></span><br><span class="line">  @TreeChildren()</span><br><span class="line">  childCategorys: AccessEntity[];</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> RoleEntity, (role) =&gt; role.access)</span><br><span class="line">  roles: RoleEntity[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h3><p>由于要实现很多接口，这里只说明一部分，其实都是数据库的操作，所有接口如下：</p>
<p><img src="https://s.poetries.work/uploads/2022/05/ea6301b6c0da9373.png" alt></p>
<p><strong>根据用户的id获取信息</strong>：id，用户名，部门名，角色，这些信息在做用户登陆时传递到token中。</p>
<blockquote>
<p>这里设计的是：创建用户时，添加部门，就会成为部门的普通角色，也可单独设置角色，但不是每个用户都有单独的角色。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> getUserinfoByUid(uid: number) &#123;</span><br><span class="line">	获取用户</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(</span><br><span class="line">      &#123; <span class="attr">id</span>: uid &#125;,</span><br><span class="line">      &#123; <span class="attr">relations</span>: [<span class="string">'roles'</span>] &#125;,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户ID不存在'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sql = <span class="string">`</span></span><br><span class="line"><span class="string">    select </span></span><br><span class="line"><span class="string">    user.id as user_id, user.username, user.department_id, department.departmentname, role.id as role_id, rolename</span></span><br><span class="line"><span class="string">    from</span></span><br><span class="line"><span class="string">    user, department, role, department_role as dr</span></span><br><span class="line"><span class="string">    where </span></span><br><span class="line"><span class="string">    user.department_id = department.id</span></span><br><span class="line"><span class="string">    and department.id = dr.departmentId</span></span><br><span class="line"><span class="string">    and role.id = dr.roleId</span></span><br><span class="line"><span class="string">    and user.id = <span class="subst">$&#123;uid&#125;</span>`</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.query(sql);</span><br><span class="line">    <span class="keyword">const</span> userinfo = result[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> userObj = &#123;</span><br><span class="line">      user_id: userinfo.user_id,</span><br><span class="line">      username: userinfo.username,</span><br><span class="line">      department_id: userinfo.department_id,</span><br><span class="line">      departmentname: userinfo.departmentname,</span><br><span class="line">      roles: [&#123; <span class="attr">id</span>: userinfo.role_id, <span class="attr">rolename</span>: userinfo.rolename &#125;],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果用户的角色roles有值，证明单独设置了角色，所以需要拼接起来</span></span><br><span class="line">    <span class="keyword">if</span> (user.roles.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> _user = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(user));</span><br><span class="line">      userObj.roles = [...userObj.roles, ..._user.roles];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口请求结果：</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"department_id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"departmentname"</span>: <span class="string">"销售部"</span>,</span><br><span class="line">        <span class="string">"roles"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">"rolename"</span>: <span class="string">"销售部员工"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"id"</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="string">"rolename"</span>: <span class="string">"admin"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>结合possport + jwt 做用户登陆授权验证</strong></p>
<blockquote>
<p>在验证账户密码通过后，possport 返回用户，然后根据用户id获取用户信息，存储token，用于路由守卫，还可以使用redis存储，以作他用。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> login(user: any): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> userResult = <span class="keyword">await</span> <span class="keyword">this</span>.userService.getUserinfoByUid(id);</span><br><span class="line">    <span class="keyword">const</span> access_token = <span class="keyword">this</span>.jwtService.sign(userResult);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.redisService.set(<span class="string">`user-token-<span class="subst">$&#123;id&#125;</span>`</span>, access_token, <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; access_token &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"access_token"</span>: <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiZGVwYXJ0bWVudF9pZCI6MSwiZGVwYXJ0bWVudG5hbWUiOiLplIDllK7pg6giLCJyb2xlcyI6W3siaWQiOjEsInJvbGVuYW1lIjoi6ZSA5ZSu6YOo5ZGY5belIn0seyJpZCI6NSwicm9sZW5hbWUiOiJhZG1pbiJ9XSwiaWF0IjoxNjIxNjA1Nzg5LCJleHAiOjE2MjE2OTIxODl9.VIp0MdzSPM13eq1Bn8bB9Iu_SLKy4yoMU2N4uwgWDls"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="后端的权限访问"><a href="#后端的权限访问" class="headerlink" title="后端的权限访问"></a><strong>后端的权限访问</strong></h3><blockquote>
<p>使用守卫，装饰器，结合token，验证访问权限</p>
</blockquote>
<p><strong>逻辑：</strong></p>
<ul>
<li>第一步：在<code>controller</code>使用自定义守卫装饰接口路径，在请求该接口路径时，全部进入守卫逻辑</li>
<li>第二步：使用自定义装饰器装饰特定接口，传递角色，自定义守卫会使用反射器获取该值，以判断该用户是否有权限</li>
</ul>
<p>如下：<code>findOne</code>接口使用了自定义装饰器装饰接口，意思是只能<code>admin</code>来访问</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Body,</span><br><span class="line">  Patch,</span><br><span class="line">  Post,</span><br><span class="line">  Param,</span><br><span class="line">  Delete,</span><br><span class="line">  UseGuards,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-user.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UpdateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/update-user.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'../../common/guard/auth.guard'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Roles &#125; <span class="keyword">from</span> <span class="string">'../../common/decorator/role.decorator'</span>;</span><br><span class="line"></span><br><span class="line">@UseGuards(AuthGuard)   <span class="comment">// 自定义守卫</span></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Get()</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">const</span> [data, count] = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findAll();</span><br><span class="line">    <span class="keyword">return</span> &#123; count, data &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  @Roles(<span class="string">'admin'</span>)  <span class="comment">// 自定义装饰器</span></span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>装饰器</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; SetMetadata &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMetadata作用：将获取到的值，设置到元数据中，然后守卫通过反射器才能获取到值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Roles = <span class="function">(<span class="params">...args: string[]</span>) =&gt;</span> SetMetadata(<span class="string">'roles'</span>, args);</span><br></pre></td></tr></table></figure>
<p><strong>自定义守卫</strong></p>
<blockquote>
<p>返回<code>true</code>则有访问权限，返回<code>false</code>则直接报<code>403</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CanActivate, ExecutionContext, Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>; <span class="comment">// 反射器，作用与自定义装饰器桥接</span></span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    private readonly reflector: Reflector,</span><br><span class="line">    private readonly jwtService: JwtService,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 白名单数组</span></span><br><span class="line">  private whiteUrlList: string[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证该次请求是否为白名单内的路由</span></span><br><span class="line">  private isWhiteUrl(urlList: string[], <span class="attr">url</span>: string): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (urlList.includes(url)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  canActivate(context: ExecutionContext): boolean &#123;</span><br><span class="line">    <span class="comment">// 获取请求对象</span></span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证是否是白名单内的路由</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isWhiteUrl(<span class="keyword">this</span>.whiteUrlList, request.url)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取请求头中的token字段，解析获取存储在token的用户信息</span></span><br><span class="line">    <span class="keyword">const</span> token = context.switchToRpc().getData().headers.token;</span><br><span class="line">    <span class="keyword">const</span> user: any = <span class="keyword">this</span>.jwtService.decode(token);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'token获取失败，请传递token或书写正确'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用反射器，配合装饰器使用，获取装饰器传递过来的数据</span></span><br><span class="line">    <span class="keyword">const</span> authRoles = <span class="keyword">this</span>.reflector.get&lt;string[]&gt;(</span><br><span class="line">      <span class="string">'roles'</span>,</span><br><span class="line">      context.getHandler(),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有使用roles装饰，就获取不到值，就不鉴权，等于白名单</span></span><br><span class="line">    <span class="keyword">if</span> (!authRoles) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果用户的所属角色与装饰器传递过来的值匹配则通过，否则不通过</span></span><br><span class="line">    <span class="keyword">const</span> userRoles = user.roles;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; userRoles.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (authRoles.includes(userRoles[i].rolename)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>简单测试</strong></p>
<blockquote>
<p>两个用户，分别对应不同的角色，分别请求user的findOne接口<br>用户1：销售部员工和admin<br>用户2：人事部员工</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用户1：销售部员工和admin</span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: 200,</span><br><span class="line">    &quot;message&quot;: &quot;请求成功&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;user_id&quot;: 1,</span><br><span class="line">        &quot;username&quot;: &quot;admin&quot;,</span><br><span class="line">        &quot;department_id&quot;: 1,</span><br><span class="line">        &quot;departmentname&quot;: &quot;销售部&quot;,</span><br><span class="line">        &quot;roles&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;id&quot;: 1,</span><br><span class="line">                &quot;rolename&quot;: &quot;销售部员工&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;id&quot;: 5,</span><br><span class="line">                &quot;rolename&quot;: &quot;admin&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">用户2：人事部员工</span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: 200,</span><br><span class="line">    &quot;message&quot;: &quot;请求成功&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;user_id&quot;: 2,</span><br><span class="line">        &quot;username&quot;: &quot;admin2&quot;,</span><br><span class="line">        &quot;department_id&quot;: 2,</span><br><span class="line">        &quot;departmentname&quot;: &quot;人事部&quot;,</span><br><span class="line">        &quot;roles&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;id&quot;: 3,</span><br><span class="line">                &quot;rolename&quot;: &quot;人事部员工&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">不出意外的话：2号用户的请求结果</span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: 403,</span><br><span class="line">    &quot;message&quot;: &quot;Forbidden resource&quot;,</span><br><span class="line">    &quot;error&quot;: &quot;Forbidden&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/user/1&quot;,</span><br><span class="line">    &quot;timestamp&quot;: &quot;2021-05-21T14:44:04.954Z&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>前端的权限访问则是通过权限表url和type来处理</p>
</blockquote>
<h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>nest如何开启定时任务？</p>
<p><strong>定时任务场景</strong></p>
<blockquote>
<p>每天定时更新，定时发送邮件</p>
</blockquote>
<p>没有controller，因为定时任务是自动完成的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add @nestjs/schedule</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/tasks/task.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TasksService &#125; <span class="keyword">from</span> <span class="string">'./tasks.service'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  providers: [TasksService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在这里编写你的定时任务</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/tasks/task.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Cron, Interval, Timeout &#125; <span class="keyword">from</span> <span class="string">'@nestjs/schedule'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksService</span> </span>&#123;</span><br><span class="line">  private readonly logger = <span class="keyword">new</span> Logger(TasksService.name);</span><br><span class="line"></span><br><span class="line">  @Cron(<span class="string">'45 * * * * *'</span>)  每隔<span class="number">45</span>秒执行一次</span><br><span class="line">  handleCron() &#123;</span><br><span class="line">    <span class="keyword">this</span>.logger.debug(<span class="string">'Called when the second is 45'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Interval(<span class="number">10000</span>)  每隔<span class="number">10</span>秒执行一次</span><br><span class="line">  handleInterval() &#123;</span><br><span class="line">    <span class="keyword">this</span>.logger.debug(<span class="string">'Called every 10 seconds'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Timeout(<span class="number">5000</span>)  <span class="number">5</span>秒只执行一次</span><br><span class="line">  handleTimeout() &#123;</span><br><span class="line">    <span class="keyword">this</span>.logger.debug(<span class="string">'Called once after 5 seconds'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义定时时间</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">* * * * * * 分别对应的意思：</span><br><span class="line">第<span class="number">1</span>个星：秒</span><br><span class="line">第<span class="number">2</span>个星：分钟</span><br><span class="line">第<span class="number">3</span>个星：小时</span><br><span class="line">第<span class="number">4</span>个星：一个月中的第几天</span><br><span class="line">第<span class="number">5</span>个星：月</span><br><span class="line">第<span class="number">6</span>个星：一个星期中的第几天</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line"><span class="number">45</span> * * * * *：每隔<span class="number">45</span>秒执行一次</span><br></pre></td></tr></table></figure>
<p><strong>挂载-使用</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; TasksModule &#125; <span class="keyword">from</span> <span class="string">'./tasks/task.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ScheduleModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/schedule'</span>;</span><br><span class="line"></span><br><span class="line">imports: [</span><br><span class="line">    ConfigModule.load(path.resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line">    ScheduleModule.forRoot(),</span><br><span class="line">    TasksModule,</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>
<h2 id="接入Swagger接口文档"><a href="#接入Swagger接口文档" class="headerlink" title="接入Swagger接口文档"></a>接入Swagger接口文档</h2><ul>
<li>优点：不用写接口文档，在线生成，自动生成，可操作数据库，完美配合<code>dto</code></li>
<li>缺点：多一些代码，显得有点乱，习惯就好</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add @nestjs/swagger swagger-ui-express -D</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; SwaggerModule, DocumentBuilder &#125; <span class="keyword">from</span> <span class="string">'@nestjs/swagger'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建实例</span></span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建接口文档服务</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> DocumentBuilder()</span><br><span class="line">    .addBearerAuth() <span class="comment">// token认证，输入token才可以访问文档</span></span><br><span class="line">    .setTitle(<span class="string">'接口文档'</span>)</span><br><span class="line">    .setDescription(<span class="string">'接口文档介绍'</span>) <span class="comment">// 文档介绍</span></span><br><span class="line">    .addServer(<span class="string">'http://localhost:9000'</span>, <span class="string">'开发环境'</span>)</span><br><span class="line">    .addServer(<span class="string">'https://test.com/release'</span>, <span class="string">'正式环境'</span>)</span><br><span class="line">    .setVersion(<span class="string">'1.0.0'</span>) <span class="comment">// 文档版本</span></span><br><span class="line">    .setContact(<span class="string">'poetry'</span>, <span class="string">''</span>, <span class="string">'test@qq.com'</span>)</span><br><span class="line">    .build();</span><br><span class="line">  <span class="comment">// 为了创建完整的文档（具有定义的HTTP路由），我们使用类的createDocument()方法SwaggerModule。此方法带有两个参数，分别是应用程序实例和基本Swagger选项。</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">document</span> = SwaggerModule.createDocument(app, options, &#123;</span><br><span class="line">    extraModels: [], <span class="comment">// 这里导入模型</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 启动swagger</span></span><br><span class="line">  SwaggerModule.setup(<span class="string">'api-docs'</span>, app, <span class="built_in">document</span>); <span class="comment">// 访问路径 http://localhost:9000/api-docs</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 启动端口</span></span><br><span class="line">  <span class="keyword">const</span> PORT = process.env.PORT || <span class="number">9000</span>;</span><br><span class="line">  <span class="keyword">await</span> app.listen(PORT, () =&gt;</span><br><span class="line">    Logger.log(<span class="string">`服务已经启动 http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p><strong>swagger装饰器</strong></p>
<p><a href="https://swagger.io/" target="_blank" rel="noopener">https://swagger.io/</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@ApiTags(<span class="string">'user'</span>)   <span class="comment">// 设置模块接口的分类，不设置默认分配到default</span></span><br><span class="line">@ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'标题'</span>, <span class="attr">description</span>: <span class="string">'详细描述'</span>&#125;)  <span class="comment">// 单个接口描述</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 传参</span></span><br><span class="line">@ApiQuery(&#123; <span class="attr">name</span>: <span class="string">'limit'</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;)    <span class="comment">// query参数</span></span><br><span class="line">@ApiQuery(&#123; <span class="attr">name</span>: <span class="string">'role'</span>, <span class="attr">enum</span>: UserRole &#125;)    <span class="comment">// query参数</span></span><br><span class="line">@ApiParam(&#123; <span class="attr">name</span>: <span class="string">'id'</span> &#125;)      <span class="comment">// parma参数</span></span><br><span class="line">@ApiBody(&#123; <span class="attr">type</span>: UserCreateDTO, <span class="attr">description</span>: <span class="string">'输入用户名和密码'</span> &#125;)   <span class="comment">// 请求体</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应</span></span><br><span class="line">@ApiResponse(&#123;</span><br><span class="line">    status: <span class="number">200</span>,</span><br><span class="line">    description: <span class="string">'成功返回200，失败返回400'</span>,</span><br><span class="line">    type: UserCreateDTO,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证</span></span><br><span class="line">@ApiProperty(&#123; <span class="attr">example</span>: <span class="string">'Kitty'</span>, <span class="attr">description</span>: <span class="string">'The name of the Cat'</span> &#125;)</span><br><span class="line">name: string;</span><br></pre></td></tr></table></figure>
<p>在<code>controller</code>引入<code>@nestjs/swagger</code>， 并配置<code>@ApiBody()</code>和 <code>@ApiParam()</code>不写也是可以的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">user.controller.ts</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  Patch,</span><br><span class="line">  Query,</span><br><span class="line">  Param,</span><br><span class="line">  Delete,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ApiOperation,</span><br><span class="line">  ApiTags,</span><br><span class="line">  ApiQuery,</span><br><span class="line">  ApiBody,</span><br><span class="line">  ApiResponse,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/swagger'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-user.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UpdateUserDto &#125; <span class="keyword">from</span> <span class="string">'./dto/update-user.dto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line">@ApiTags(<span class="string">'user'</span>)  <span class="comment">// 设置分类</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Post()</span><br><span class="line">  @ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'创建用户'</span>, <span class="attr">description</span>: <span class="string">'创建用户'</span> &#125;)  <span class="comment">// 该接口</span></span><br><span class="line">  @HttpCode(HttpStatus.OK)</span><br><span class="line">  <span class="keyword">async</span> create(@Body() user: CreateUserDto) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get()</span><br><span class="line">  @ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'查找全部用户'</span>, <span class="attr">description</span>: <span class="string">'创建用户'</span> &#125;)</span><br><span class="line">  @ApiQuery(&#123; <span class="attr">name</span>: <span class="string">'limit'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;)  请求参数</span><br><span class="line">  @ApiQuery(&#123; <span class="attr">name</span>: <span class="string">'offset'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;) 请求参数</span><br><span class="line">  <span class="keyword">async</span> findAll(@Query() query) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(query);</span><br><span class="line">    <span class="keyword">const</span> [data, count] = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findAll(query);</span><br><span class="line">    <span class="keyword">return</span> &#123; count, data &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  @ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'根据ID查找用户'</span> &#125;)</span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Patch(<span class="string">':id'</span>)</span><br><span class="line">  @ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'更新用户'</span> &#125;)</span><br><span class="line">  @ApiBody(&#123; <span class="attr">type</span>: UpdateUserDto, <span class="attr">description</span>: <span class="string">'参数可选'</span> &#125;)  请求体</span><br><span class="line">  @ApiResponse(&#123;   响应示例</span><br><span class="line">    status: <span class="number">200</span>,</span><br><span class="line">    description: <span class="string">'成功返回200，失败返回400'</span>,</span><br><span class="line">    type: UpdateUserDto,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">async</span> update(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @Body() user: UpdateUserDto,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.update(id, user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  @ApiOperation(&#123; <span class="attr">summary</span>: <span class="string">'删除用户'</span> &#125;)</span><br><span class="line">  <span class="keyword">async</span> remove(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.remove(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编写dto，引入@nestjs/swagger</strong></p>
<p>创建</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, MinLength, MaxLength &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApiProperty &#125; <span class="keyword">from</span> <span class="string">'@nestjs/swagger'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateUserDto</span> </span>&#123;</span><br><span class="line">  @ApiProperty(&#123; <span class="attr">example</span>: <span class="string">'kitty'</span>, <span class="attr">description</span>: <span class="string">'用户名'</span> &#125;)  添加这里即可</span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'用户名不能为空'</span> &#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123; <span class="attr">example</span>: <span class="string">'12345678'</span>, <span class="attr">description</span>: <span class="string">'密码'</span> &#125;)</span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'密码不能为空'</span> &#125;)</span><br><span class="line">  @MinLength(<span class="number">6</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能小于6位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @MaxLength(<span class="number">20</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能超过20位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  IsEnum,</span><br><span class="line">  MinLength,</span><br><span class="line">  MaxLength,</span><br><span class="line">  IsOptional,</span><br><span class="line">  ValidateIf,</span><br><span class="line">  IsEmail,</span><br><span class="line">  IsMobilePhone,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApiProperty &#125; <span class="keyword">from</span> <span class="string">'@nestjs/swagger'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Type &#125; <span class="keyword">from</span> <span class="string">'class-transformer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateUserDto</span> </span>&#123;</span><br><span class="line">  @ApiProperty(&#123; <span class="attr">description</span>: <span class="string">'用户名'</span>, <span class="attr">example</span>: <span class="string">'kitty'</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;)  不是必选的</span><br><span class="line">  @IsOptional()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123; <span class="attr">description</span>: <span class="string">'密码'</span>, <span class="attr">example</span>: <span class="string">'12345678'</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  @IsOptional()</span><br><span class="line">  @MinLength(<span class="number">6</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能小于6位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @MaxLength(<span class="number">20</span>, &#123;</span><br><span class="line">    message: <span class="string">'密码长度不能超过20位'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123;</span><br><span class="line">    description: <span class="string">'邮箱'</span>,</span><br><span class="line">    example: <span class="string">'llovenest@163.com'</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEmail(&#123;&#125;, &#123; <span class="attr">message</span>: <span class="string">'邮箱格式错误'</span> &#125;)</span><br><span class="line">  @ValidateIf(<span class="function">(<span class="params">o</span>) =&gt;</span> o.username === <span class="string">'admin'</span>)</span><br><span class="line">  email: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123;</span><br><span class="line">    description: <span class="string">'手机号码'</span>,</span><br><span class="line">    example: <span class="string">'13866668888'</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsMobilePhone(<span class="string">'zh-CN'</span>, &#123;&#125;, &#123; <span class="attr">message</span>: <span class="string">'手机号码格式错误'</span> &#125;)</span><br><span class="line">  mobile: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123;</span><br><span class="line">    description: <span class="string">'性别'</span>,</span><br><span class="line">    example: <span class="string">'female'</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">    enum: [<span class="string">'male'</span>, <span class="string">'female'</span>],</span><br><span class="line">  &#125;)</span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEnum([<span class="string">'male'</span>, <span class="string">'female'</span>], &#123;</span><br><span class="line">    message: <span class="string">'gender只能传入字符串male或female'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  gender: string;</span><br><span class="line"></span><br><span class="line">  @ApiProperty(&#123;</span><br><span class="line">    description: <span class="string">'状态'</span>,</span><br><span class="line">    example: <span class="number">1</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">    enum: [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">  &#125;)</span><br><span class="line">  @IsOptional()</span><br><span class="line">  @IsEnum(</span><br><span class="line">    &#123; 禁用: <span class="number">0</span>, 可用: <span class="number">1</span> &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      message: <span class="string">'status只能传入数字0或1'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">  @Type(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Number</span>)</span><br><span class="line">  status: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开：localhost:3000/api-docs，开始测试接口</p>
<p><img src="https://s.poetries.work/uploads/2022/05/dd04126877af210f.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/05/98f40271e2f2ed11.png" alt></p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><h2 id="nest连接Mongodb"><a href="#nest连接Mongodb" class="headerlink" title="nest连接Mongodb"></a>nest连接Mongodb</h2><p>mac中，直接使用<code>brew install mongodb-community</code>安装MongoDB，然后启动服务<code>brew services start mongodb-community</code> 查看服务已经启动<code>ps aux | grep mongo</code></p>
<blockquote>
<p>Nestjs中操作Mongodb数据库可以使用Nodejs封装的DB库，也可以使用Mongoose。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://docs.nestjs.com/techniques/mongodb</span></span><br><span class="line"></span><br><span class="line">npm install --save @nestjs/mongoose mongoose</span><br><span class="line">npm install --save-dev @types/mongoose</span><br></pre></td></tr></table></figure>
<p><strong>在app.module.ts中配置数据库连接</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; ConfigModule, ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MongooseModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/mongoose'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MongodbModule &#125; <span class="keyword">from</span> <span class="string">'../examples/mongodb/mongodb.module'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// 加载配置文件目录</span></span><br><span class="line">    ConfigModule.load(resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mongodb</span></span><br><span class="line">    MongooseModule.forRootAsync(&#123;</span><br><span class="line">      useFactory: <span class="keyword">async</span> (configService: ConfigService) =&gt;</span><br><span class="line">        configService.get(<span class="string">'mongodb'</span>),</span><br><span class="line">      inject: [ConfigService],</span><br><span class="line">    &#125;),</span><br><span class="line">    MongodbModule,</span><br><span class="line">  ],</span><br><span class="line">  controllers: [],</span><br><span class="line">  providers: [],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mongodb配置</span></span><br><span class="line"><span class="comment">// src/config/mongodb.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  uri: <span class="string">'mongodb://localhost:27017/nest'</span>, <span class="comment">// 指定nest数据库</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>配置Schema</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// article.schema</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mongoose <span class="keyword">from</span> <span class="string">'mongoose'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ArticleSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  title: <span class="built_in">String</span>,</span><br><span class="line">  content:<span class="built_in">String</span>,</span><br><span class="line">  author: <span class="built_in">String</span>,</span><br><span class="line">  status: <span class="built_in">Number</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>在控制器对应的Module中配置Model</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mongodb.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MongodbService &#125; <span class="keyword">from</span> <span class="string">'./mongodb.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MongodbController &#125; <span class="keyword">from</span> <span class="string">'./mongodb.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ArticleSchema &#125; <span class="keyword">from</span> <span class="string">'./schemas/article.schema'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MongooseModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/mongoose'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    MongooseModule.forFeature([</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">'Article'</span>, <span class="comment">// schema名称对应</span></span><br><span class="line">        schema: ArticleSchema, <span class="comment">// 引入的schema</span></span><br><span class="line">        collection: <span class="string">'article'</span>, <span class="comment">// 数据库名称</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ]),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [MongodbController],</span><br><span class="line">  providers: [MongodbService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MongodbModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在服务里面使用@InjectModel 获取数据库Model实现操作数据库</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mongodb.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectModel &#125; <span class="keyword">from</span> <span class="string">'@nestjs/mongoose'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MongodbService</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注入模型</span></span><br><span class="line">  <span class="keyword">constructor</span>(@InjectModel('Article') private readonly articleModel) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.articleModel.find().exec();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findById(id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.articleModel.findById(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(body) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.articleModel.create(body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> update(body) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, ...params &#125; = body;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.articleModel.findByIdAndUpdate(id, params);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">delete</span>(id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.articleModel.findByIdAndDelete(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>浏览器测试 <a href="http://localhost:9000/api/mongodb/list" target="_blank" rel="noopener">http://localhost:9000/api/mongodb/list</a></p>
<p><img src="https://s.poetries.work/uploads/2022/05/e14c1f5173139807.png" alt></p>
<h2 id="typeORM操作Mysql数据库"><a href="#typeORM操作Mysql数据库" class="headerlink" title="typeORM操作Mysql数据库"></a>typeORM操作Mysql数据库</h2><p>mac中，直接使用<code>brew install mysql</code>安装mysql，然后启动服务<code>brew services start mysql</code> 查看服务已经启动<code>ps aux | grep mysql</code></p>
<p>Nest 操作Mysql官方文档：<a href="https://docs.nestjs.com/techniques/database" target="_blank" rel="noopener">https://docs.nestjs.com/techniques/database</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install --save @nestjs/typeorm typeorm mysql</span><br></pre></td></tr></table></figure>
<p><strong>配置数据库连接地址</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/config/typeorm.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; MYSQL_HOST, MYSQL_PORT, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE &#125; =</span><br><span class="line">  process.env;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  type: <span class="string">'mysql'</span>,</span><br><span class="line">  host: MYSQL_HOST,</span><br><span class="line">  port: MYSQL_PORT,</span><br><span class="line">  username: MYSQL_USER,</span><br><span class="line">  password: MYSQL_PASSWORD,</span><br><span class="line">  database: MYSQL_DATABASE,</span><br><span class="line">  synchronize: process.env.NODE_ENV !== <span class="string">'production'</span>, <span class="comment">// 生产环境不要开启</span></span><br><span class="line">  autoLoadEntities: <span class="literal">true</span>, <span class="comment">// 如果为true,将自动加载实体(默认：false)</span></span><br><span class="line">  keepConnectionAlive: <span class="literal">true</span>, <span class="comment">// 如果为true，在应用程序关闭后连接不会关闭（默认：false)</span></span><br><span class="line">  retryDelay: <span class="number">3000</span>, <span class="comment">// 两次重试连接的间隔(ms)（默认：3000）</span></span><br><span class="line">  retryAttempts: <span class="number">10</span>, <span class="comment">// 重试连接数据库的次数（默认：10）</span></span><br><span class="line">  dateStrings: <span class="string">'DATETIME'</span>, <span class="comment">// 转化为时间</span></span><br><span class="line">  timezone: <span class="string">'+0800'</span>, <span class="comment">// +HHMM -HHMM</span></span><br><span class="line">  <span class="comment">// 自动需要导入模型</span></span><br><span class="line">  entities: [<span class="string">'dist/**/*.entity&#123;.ts,.js&#125;'</span>],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> config;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.module.ts中配置</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve, join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigModule, ConfigService &#125; <span class="keyword">from</span> <span class="string">'nestjs-config'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// 加载配置文件目录</span></span><br><span class="line">    ConfigModule.load(resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接mysql数据库</span></span><br><span class="line">    TypeOrmModule.forRootAsync(&#123;</span><br><span class="line">      useFactory: <span class="function">(<span class="params">config: ConfigService</span>) =&gt;</span> config.get(<span class="string">'typeorm'</span>),</span><br><span class="line">      inject: [ConfigService],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [],</span><br><span class="line">  providers: [],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置实体entity</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// photo.entity.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  ManyToMany,</span><br><span class="line">  OneToMany,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsEntity &#125; <span class="keyword">from</span> <span class="string">'./post.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(<span class="string">'photo'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PhotoEntity</span> </span>&#123;</span><br><span class="line">  <span class="comment">// @PrimaryGeneratedColumn()</span></span><br><span class="line">  <span class="comment">// id: number; // 标记为主列，值自动生成</span></span><br><span class="line">  @PrimaryGeneratedColumn(<span class="string">'uuid'</span>)</span><br><span class="line">  id: string; <span class="comment">// 该值将使用uuid自动生成</span></span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">length</span>: <span class="number">50</span> &#125;)</span><br><span class="line">  url: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 多对一关系，多个图片对应一篇文章</span></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> PostsEntity, (post) =&gt; post.photos)</span><br><span class="line">  posts: PostsEntity;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, OneToMany, PrimaryGeneratedColumn &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhotoEntity &#125; <span class="keyword">from</span> <span class="string">'./photo.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type UserRoleType = <span class="string">'admin'</span> | <span class="string">'editor'</span> | <span class="string">'ghost'</span>;</span><br><span class="line"><span class="keyword">export</span> type postStatus = <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mysql的列类型: type</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * int, tinyint, smallint, mediumint, bigint, float, double, dec, decimal,</span></span><br><span class="line"><span class="comment"> * numeric, date, datetime, timestamp, time, year, char, varchar, nvarchar,</span></span><br><span class="line"><span class="comment"> * text, tinytext, mediumtext, blob, longtext, tinyblob, mediumblob, longblob, enum,</span></span><br><span class="line"><span class="comment"> * json, binary, geometry, point, linestring, polygon, multipoint, multilinestring,</span></span><br><span class="line"><span class="comment"> * multipolygon, geometrycollection</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ColumnOptions中可用选项列表：</span></span><br><span class="line"><span class="comment"> * length: number - 列类型的长度。 例如，如果要创建varchar（150）类型，请指定列类型和长度选项。</span></span><br><span class="line"><span class="comment">  width: number - 列类型的显示范围。 仅用于MySQL integer types(opens new window)</span></span><br><span class="line"><span class="comment">  onUpdate: string - ON UPDATE触发器。 仅用于 MySQL (opens new window).</span></span><br><span class="line"><span class="comment">  nullable: boolean - 在数据库中使列NULL或NOT NULL。 默认情况下，列是nullable：false。</span></span><br><span class="line"><span class="comment">  update: boolean - 指示"save"操作是否更新列值。如果为false，则只能在第一次插入对象时编写该值。 默认值为"true"。</span></span><br><span class="line"><span class="comment">  select: boolean - 定义在进行查询时是否默认隐藏此列。 设置为false时，列数据不会显示标准查询。 默认情况下，列是select：true</span></span><br><span class="line"><span class="comment">  default: string - 添加数据库级列的DEFAULT值。</span></span><br><span class="line"><span class="comment">  primary: boolean - 将列标记为主要列。 使用方式和@ PrimaryColumn相同。</span></span><br><span class="line"><span class="comment">  unique: boolean - 将列标记为唯一列（创建唯一约束）。</span></span><br><span class="line"><span class="comment">  comment: string - 数据库列备注，并非所有数据库类型都支持。</span></span><br><span class="line"><span class="comment">  precision: number - 十进制（精确数字）列的精度（仅适用于十进制列），这是为值存储的最大位数。仅用于某些列类型。</span></span><br><span class="line"><span class="comment">  scale: number - 十进制（精确数字）列的比例（仅适用于十进制列），表示小数点右侧的位数，且不得大于精度。 仅用于某些列类型。</span></span><br><span class="line"><span class="comment">  zerofill: boolean - 将ZEROFILL属性设置为数字列。 仅在 MySQL 中使用。 如果是true，MySQL 会自动将UNSIGNED属性添加到此列。</span></span><br><span class="line"><span class="comment">  unsigned: boolean - 将UNSIGNED属性设置为数字列。 仅在 MySQL 中使用。</span></span><br><span class="line"><span class="comment">  charset: string - 定义列字符集。 并非所有数据库类型都支持。</span></span><br><span class="line"><span class="comment">  collation: string - 定义列排序规则。</span></span><br><span class="line"><span class="comment">  enum: string[]|AnyEnum - 在enum列类型中使用，以指定允许的枚举值列表。 你也可以指定数组或指定枚举类。</span></span><br><span class="line"><span class="comment">  asExpression: string - 生成的列表达式。 仅在MySQL (opens new window)中使用。</span></span><br><span class="line"><span class="comment">  generatedType: "VIRTUAL"|"STORED" - 生成的列类型。 仅在MySQL (opens new window)中使用。</span></span><br><span class="line"><span class="comment">  hstoreType: "object"|"string" -返回HSTORE列类型。 以字符串或对象的形式返回值。 仅在Postgres中使用。</span></span><br><span class="line"><span class="comment">  array: boolean - 用于可以是数组的 postgres 列类型（例如 int []）</span></span><br><span class="line"><span class="comment">  transformer: &#123; from(value: DatabaseType): EntityType, to(value: EntityType): DatabaseType &#125; - 用于将任意类型EntityType的属性编组为数据库支持的类型DatabaseType。</span></span><br><span class="line"><span class="comment">  注意：大多数列选项都是特定于 RDBMS 的，并且在MongoDB中不可用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">@Entity(<span class="string">'posts'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsEntity</span> </span>&#123;</span><br><span class="line">  <span class="comment">// @PrimaryGeneratedColumn()</span></span><br><span class="line">  <span class="comment">// id: number; // 标记为主列，值自动生成</span></span><br><span class="line">  @PrimaryGeneratedColumn(<span class="string">'uuid'</span>)</span><br><span class="line">  id: string; <span class="comment">// 该值将使用uuid自动生成</span></span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">length</span>: <span class="number">50</span> &#125;)</span><br><span class="line">  title: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">length</span>: <span class="number">18</span> &#125;)</span><br><span class="line">  author: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'longtext'</span>, <span class="attr">default</span>: <span class="literal">null</span> &#125;)</span><br><span class="line">  content: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">default</span>: <span class="literal">null</span> &#125;)</span><br><span class="line">  cover_url: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">default</span>: <span class="number">0</span> &#125;)</span><br><span class="line">  type: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'text'</span>, <span class="attr">default</span>: <span class="literal">null</span> &#125;)</span><br><span class="line">  remark: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'enum'</span>,</span><br><span class="line">    enum: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    <span class="keyword">default</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  status: postStatus;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'timestamp'</span>, <span class="attr">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">'CURRENT_TIMESTAMP'</span> &#125;)</span><br><span class="line">  create_time: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">'CURRENT_TIMESTAMP'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  update_time: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'enum'</span>,</span><br><span class="line">    enum: [<span class="string">'admin'</span>, <span class="string">'editor'</span>, <span class="string">'ghost'</span>],</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'ghost'</span>,</span><br><span class="line">    select: <span class="literal">false</span>, <span class="comment">// 定义在进行查询时是否默认隐藏此列</span></span><br><span class="line">  &#125;)</span><br><span class="line">  role: UserRoleType;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一对多关系，一篇文章对应多个图片</span></span><br><span class="line">  <span class="comment">// 在service中查询使用 .find(&#123;relations: ['photos]&#125;) 查询文章对应的图片</span></span><br><span class="line">  @OneToMany(<span class="function"><span class="params">()</span> =&gt;</span> PhotoEntity, (photo) =&gt; photo.posts)</span><br><span class="line">  photos: [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>参数校验</strong></p>
<p>Nest 与 <a href="https://github.com/pleerock/class-validator" target="_blank" rel="noopener">class-validator</a> 配合得很好。这个优秀的库允许您使用基于装饰器的验证。装饰器的功能非常强大，尤其是与 Nest 的 Pipe 功能相结合使用时，因为我们可以通过访问 <code>metatype</code> 信息做很多事情，在开始之前需要安装一些依赖。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i --save class-validator class-transformer</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// posts.dto.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; ApiProperty, ApiPropertyOptional &#125; <span class="keyword">from</span> <span class="string">'@nestjs/swagger'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IsNotEmpty, IsNumber, IsString &#125; <span class="keyword">from</span> <span class="string">'class-validator'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CreatePostDto</span> </span>&#123;</span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'文章标题必填'</span> &#125;)</span><br><span class="line">  readonly title: string;</span><br><span class="line"></span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'缺少作者信息'</span> &#125;)</span><br><span class="line">  readonly author: string;</span><br><span class="line"></span><br><span class="line">  readonly content: string;</span><br><span class="line"></span><br><span class="line">  readonly cover_url: string;</span><br><span class="line"></span><br><span class="line">  @IsNotEmpty(&#123; <span class="attr">message</span>: <span class="string">'缺少文章类型'</span> &#125;)</span><br><span class="line">  readonly type: number;</span><br><span class="line"></span><br><span class="line">  readonly remark: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在控制器对应的Module中配置Model</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeOrmModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsService &#125; <span class="keyword">from</span> <span class="string">'./posts.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsController &#125; <span class="keyword">from</span> <span class="string">'./posts.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/post.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [TypeOrmModule.forFeature([PostsEntity])],</span><br><span class="line">  controllers: [PostsController],</span><br><span class="line">  providers: [PostsService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在服务里面使用@InjectRepository获取数据库Model实现操作数据库</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// posts.services.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; HttpException, HttpStatus, Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, Not, Between, Equal, Like, In &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dayjs <span class="keyword">from</span> <span class="string">'dayjs'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreatePostDto &#125; <span class="keyword">from</span> <span class="string">'./dto/create-post.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UpdatePostDto &#125; <span class="keyword">from</span> <span class="string">'./dto/update-post.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/post.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PostsRo &#125; <span class="keyword">from</span> <span class="string">'./interfaces/posts.interface'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostsService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(PostsEntity)</span><br><span class="line">    private readonly postsRepository: Repository&lt;PostsEntity&gt;,</span><br><span class="line">  ) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(post: CreatePostDto) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; title &#125; = post;</span><br><span class="line">    <span class="keyword">const</span> doc = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; title &#125; &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'doc'</span>, doc);</span><br><span class="line">    <span class="keyword">if</span> (doc) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">'文章标题已存在'</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.save(post),</span><br><span class="line">      message: <span class="string">'创建成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分页查询列表</span></span><br><span class="line">  <span class="keyword">async</span> findAll(query = &#123;&#125; <span class="keyword">as</span> any) &#123;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line prefer-const</span></span><br><span class="line">    <span class="keyword">let</span> &#123; pageSize, pageNum, orderBy, sort, ...params &#125; = query;</span><br><span class="line">    orderBy = query.orderBy || <span class="string">'create_time'</span>;</span><br><span class="line">    sort = query.sort || <span class="string">'DESC'</span>;</span><br><span class="line">    pageSize = <span class="built_in">Number</span>(query.pageSize || <span class="number">10</span>);</span><br><span class="line">    pageNum = <span class="built_in">Number</span>(query.pageNum || <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'query'</span>, query);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> queryParams = &#123;&#125; <span class="keyword">as</span> any;</span><br><span class="line">    <span class="built_in">Object</span>.keys(params).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (params[key]) &#123;</span><br><span class="line">        queryParams[key] = Like(<span class="string">`%<span class="subst">$&#123;params[key]&#125;</span>%`</span>); <span class="comment">// 所有字段支持模糊查询、%%之间不能有空格</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> qb = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.createQueryBuilder(<span class="string">'post'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// qb.where(&#123; status: In([2, 3]) &#125;);</span></span><br><span class="line">    qb.where(queryParams);</span><br><span class="line">    <span class="comment">// qb.select(['post.title', 'post.content']); // 查询部分字段返回</span></span><br><span class="line">    qb.orderBy(<span class="string">`post.<span class="subst">$&#123;orderBy&#125;</span>`</span>, sort);</span><br><span class="line">    qb.skip(pageSize * (pageNum - <span class="number">1</span>));</span><br><span class="line">    qb.take(pageSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list: <span class="keyword">await</span> qb.getMany(),</span><br><span class="line">      totalNum: <span class="keyword">await</span> qb.getCount(), <span class="comment">// 按条件查询的数量</span></span><br><span class="line">      total: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.count(), <span class="comment">// 总的数量</span></span><br><span class="line">      pageSize,</span><br><span class="line">      pageNum,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据ID查询详情</span></span><br><span class="line">  <span class="keyword">async</span> findById(id: string): <span class="built_in">Promise</span>&lt;PostsEntity&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新</span></span><br><span class="line">  <span class="keyword">async</span> update(id: string, <span class="attr">updatePostDto</span>: UpdatePostDto) &#123;</span><br><span class="line">    <span class="keyword">const</span> existRecord = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!existRecord) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">`id为<span class="subst">$&#123;id&#125;</span>的文章不存在`</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// updatePostDto覆盖existRecord 合并，可以更新单个字段</span></span><br><span class="line">    <span class="keyword">const</span> updatePost = <span class="keyword">this</span>.postsRepository.merge(existRecord, &#123;</span><br><span class="line">      ...updatePostDto,</span><br><span class="line">      update_time: dayjs().format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.save(updatePost),</span><br><span class="line">      message: <span class="string">'更新成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除</span></span><br><span class="line">  <span class="keyword">async</span> remove(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> existPost = <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.findOne(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!existPost) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">`文章ID <span class="subst">$&#123;id&#125;</span> 不存在`</span>, HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.postsRepository.remove(existPost);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data: &#123; id &#125;,</span><br><span class="line">      message: <span class="string">'删除成功'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nest统一处理数据库操作的查询结果"><a href="#nest统一处理数据库操作的查询结果" class="headerlink" title="nest统一处理数据库操作的查询结果"></a>nest统一处理数据库操作的查询结果</h2><blockquote>
<p>操作数据库时，如何做异常处异常？ 比如id不存在，用户名已经存在？如何统一处理请求失败和请求成功？</p>
</blockquote>
<p><strong>处理方式</strong>：</p>
<ul>
<li>在nest中，一般是在<strong>service</strong>中处理异常，如果有异常，直接抛出错误，由<strong>过滤器</strong>捕获，统一格式返回，如果成功，service把结果返回，controller直接return结果即可，由<strong>拦截器</strong>捕获，统一格式返回</li>
<li>失败：过滤器统一处理</li>
<li>成功：拦截器统一处理</li>
<li>当然你也可以在<code>controller</code>处理</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.controller.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line">  @Post()</span><br><span class="line">  @HttpCode(HttpStatus.OK) <span class="comment">//创建成功返回的是201状态码，这里重置为200，需要用到的可以使用HttpCode设置</span></span><br><span class="line">  <span class="keyword">async</span> create(@Body() user) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>) id: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(user) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; username &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; username &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;  <span class="comment">//如果用户名已经存在，抛出错误</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        &#123; <span class="attr">message</span>: <span class="string">'请求失败'</span>, <span class="attr">error</span>: <span class="string">'用户名已存在'</span> &#125;,</span><br><span class="line">        HttpStatus.BAD_REQUEST,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.save(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findOne(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span> (!result) &#123; <span class="comment">//如果用户id不存在，抛出错误</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        &#123; <span class="attr">message</span>: <span class="string">'请求失败'</span>, <span class="attr">error</span>: <span class="string">'用户id不存在'</span> &#125;,</span><br><span class="line">        HttpStatus.BAD_REQUEST,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以将<code>HttpException</code>再简单封装一下，或者使用继承，这样代码更简洁一些</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ToolsService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> fail(error, status = HttpStatus.BAD_REQUEST) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">      &#123;</span><br><span class="line">        message: <span class="string">'请求失败'</span>,</span><br><span class="line">        error: error,</span><br><span class="line">      &#125;,</span><br><span class="line">      status,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>简洁代码</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, HttpException, HttpStatus &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(user) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; username &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; username &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result) ToolsService.fail(<span class="string">'用户名已存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.save(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findOne(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span> (!result) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>全局使用filter过滤器</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/common/filters/http-execption.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ArgumentsHost,</span><br><span class="line">  Catch,</span><br><span class="line">  ExceptionFilter,</span><br><span class="line">  HttpException,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Catch()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpExceptionFilter</span> <span class="title">implements</span> <span class="title">ExceptionFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">catch</span>(exception: HttpException, <span class="attr">host</span>: ArgumentsHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.switchToHttp();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.getResponse();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = exception.getStatus();</span><br><span class="line">    <span class="keyword">const</span> exceptionRes: any = exception.getResponse();</span><br><span class="line">    <span class="keyword">const</span> &#123; error, message &#125; = exceptionRes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> msgLog = &#123;</span><br><span class="line">      status,</span><br><span class="line">      message,</span><br><span class="line">      error,</span><br><span class="line">      path: request.url,</span><br><span class="line">      timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    response.status(status).json(msgLog);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>全局使用interceptor拦截器</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/common/inteptors/transform.interceptor.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  CallHandler,</span><br><span class="line">  ExecutionContext,</span><br><span class="line">  Injectable,</span><br><span class="line">  NestInterceptor,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'rxjs/operators'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">  intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">      map(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          status: <span class="number">200</span>,</span><br><span class="line">          message: <span class="string">'请求成功'</span>,</span><br><span class="line">          data: data,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; HttpExceptionFilter &#125; <span class="keyword">from</span> <span class="string">'./common/filters/http-exception.filter'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TransformInterceptor &#125; <span class="keyword">from</span> <span class="string">'./common/interceptors/transform.interceptor'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建实例</span></span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  <span class="comment">// 全局过滤器</span></span><br><span class="line">  app.useGlobalFilters(<span class="keyword">new</span> HttpExceptionFilter());</span><br><span class="line">  <span class="comment">// 全局拦截器</span></span><br><span class="line">  app.useGlobalInterceptors(<span class="keyword">new</span> TransformInterceptor());</span><br><span class="line">  <span class="comment">// 启动端口</span></span><br><span class="line">  <span class="keyword">const</span> PORT = process.env.PORT || <span class="number">9000</span>;</span><br><span class="line">  <span class="keyword">await</span> app.listen(PORT, () =&gt;</span><br><span class="line">    Logger.log(<span class="string">`服务已经启动 http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
<p>失败</p>
<p><img src="https://s.poetries.work/uploads/2022/05/fe6da80fe7b316ce.png" alt></p>
<p>成功</p>
<p><img src="https://s.poetries.work/uploads/2022/05/e0c55c5a0e22af66.png" alt></p>
<h2 id="数据库实体设计与操作"><a href="#数据库实体设计与操作" class="headerlink" title="数据库实体设计与操作"></a>数据库实体设计与操作</h2><blockquote>
<p>typeorm的数据库实体如何编写？<br>数据库实体的监听装饰器如何使用？</p>
</blockquote>
<h3 id="实体设计"><a href="#实体设计" class="headerlink" title="实体设计"></a>实体设计</h3><p>简单例子：下面讲解</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn&#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    @PrimaryGeneratedColumn()</span><br><span class="line">    id: number;         <span class="comment">// 默认是int(11)类型</span></span><br><span class="line"></span><br><span class="line">    @Column()</span><br><span class="line">    username: string;   <span class="comment">// 默认是varchar(255)类型</span></span><br><span class="line"></span><br><span class="line">    @Column()</span><br><span class="line">    password: string;</span><br><span class="line">   </span><br><span class="line">    @Column()</span><br><span class="line">    status: boolean;</span><br><span class="line">   </span><br><span class="line">    @CreateDateColumn()</span><br><span class="line">    created_at:date;</span><br><span class="line">       </span><br><span class="line">    @UpdateDateColumn()</span><br><span class="line">    updated_at:date;</span><br><span class="line"></span><br><span class="line">	@DeleteDateColumn()</span><br><span class="line">    deleted_at:date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>装饰器说明</strong></p>
<ul>
<li><code>Entity</code>    实体声明，程序运行时，自动创建的数据库表，<code>@Entity({ name: &#39;users&#39; })</code>， <code>name</code>则是给该表命名，否则自动命名</li>
<li><code>PrimaryColumn</code>   设置主键，没有自增</li>
<li><code>PrimaryGeneratedColumn</code>    设置主键和自增，一般是<code>id</code></li>
<li><code>Column</code>   设置数据库列字段，在下面说明</li>
<li><code>CreateDateColumn</code>          创建时间，自动填写</li>
<li><code>UpdateDateColumn</code>          更新时间，自动填写</li>
<li><code>DeleteDateColumn</code>          删除时间，自动填写</li>
</ul>
<p><strong>列字段参数</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 写法：</span></span><br><span class="line">@Column(<span class="string">"int"</span>)</span><br><span class="line">@Column(<span class="string">"varchar"</span>, &#123; <span class="attr">length</span>: <span class="number">200</span> &#125;)</span><br><span class="line">@Column(&#123; <span class="attr">type</span>: <span class="string">"int"</span>, <span class="attr">length</span>: <span class="number">200</span> &#125;)  <span class="comment">// 一般采用这种</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 常用选项参数：</span></span><br><span class="line">@Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,   <span class="comment">//  列的数据类型，参考mysql</span></span><br><span class="line">    name: <span class="string">'password'</span>,   <span class="comment">// 数据库表中的列名，string，如果和装饰的字段是一样的可以不指定</span></span><br><span class="line">    length: <span class="number">30</span>,         <span class="comment">// 列类型的长度，number</span></span><br><span class="line">    nullable: <span class="literal">false</span>,    <span class="comment">// 是否允许为空，boolean，默认值是false</span></span><br><span class="line">    select：<span class="literal">false</span>,      <span class="comment">// 查询数据库时是否显示该字段，boolean，默认值是true，密码一般使用false</span></span><br><span class="line">    comment: <span class="string">'密码'</span>     <span class="comment">// 数据库注释，stirng</span></span><br><span class="line">&#125;)</span><br><span class="line">password:string;</span><br><span class="line"></span><br><span class="line">@Column(&#123;</span><br><span class="line">    type:<span class="string">'varchar'</span>,  </span><br><span class="line">    unique: <span class="literal">true</span>,      <span class="comment">// 将列标记为唯一列，唯一约束，比如账号不能有相同的</span></span><br><span class="line">&#125;)</span><br><span class="line">username:string;</span><br><span class="line"></span><br><span class="line">@Column(&#123;</span><br><span class="line">    type:<span class="string">'tinyint'</span>,  </span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">1</span>,  <span class="comment">// 默认值，创建时自动填写的值</span></span><br><span class="line">    comment: <span class="string">'0：禁用，1：可用'</span></span><br><span class="line">&#125;)</span><br><span class="line">status:number;</span><br><span class="line"></span><br><span class="line">@Column(&#123;</span><br><span class="line">    type: <span class="string">'enum'</span>,</span><br><span class="line">    enum: [<span class="string">'male'</span>, <span class="string">'female'</span>],   <span class="comment">// 枚举类型，只能是数组中的值</span></span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'male'</span>   默认值          </span><br><span class="line">&#125;)</span><br><span class="line">gender:string;</span><br></pre></td></tr></table></figure>
<p><strong>完整例子</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  CreateDateColumn,</span><br><span class="line">  UpdateDateColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">30</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    unique: <span class="literal">true</span>, </span><br><span class="line">  &#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    name: <span class="string">'password'</span>, </span><br><span class="line">    length: <span class="number">100</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>, </span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    comment: <span class="string">'密码'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">11</span>,</span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    nullable: <span class="literal">true</span>,</span><br><span class="line">    comment: <span class="string">'手机号码'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  mobile: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">50</span>,</span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    nullable: <span class="literal">true</span>,</span><br><span class="line">    comment: <span class="string">'邮箱'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  email: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'enum'</span>,</span><br><span class="line">    enum: [<span class="string">'male'</span>, <span class="string">'female'</span>], </span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'male'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  gender: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'tinyint'</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">1</span>,</span><br><span class="line">    comment: <span class="string">'0：禁用，1：可用'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  status: number;</span><br><span class="line"></span><br><span class="line">  @CreateDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    name: <span class="string">'created_at'</span>,</span><br><span class="line">    comment: <span class="string">'创建时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  createdAt: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @UpdateDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    name: <span class="string">'updated_at'</span>,</span><br><span class="line">    comment: <span class="string">'更新时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  updatedAt: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @DeleteDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">true</span>,</span><br><span class="line">    name: <span class="string">'deleted_at'</span>,</span><br><span class="line">    comment: <span class="string">'删除时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  deletedAt: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/05/648cf1e9823e51c1.png" alt></p>
<h3 id="抽离部分重复的字段：使用继承"><a href="#抽离部分重复的字段：使用继承" class="headerlink" title="抽离部分重复的字段：使用继承"></a><strong>抽离部分重复的字段：使用继承</strong></h3><blockquote>
<p><code>baseEntity</code>：将id，创建时间，更新时间，删除时间抽离成<code>BaseEntity</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  CreateDateColumn,</span><br><span class="line">  UpdateDateColumn,</span><br><span class="line">  DeleteDateColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"></span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @CreateDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    name: <span class="string">'created_at'</span>,</span><br><span class="line">    comment: <span class="string">'创建时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  createdAt: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @UpdateDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    name: <span class="string">'updated_at'</span>,</span><br><span class="line">    comment: <span class="string">'更新时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  updatedAt: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  @DeleteDateColumn(&#123;</span><br><span class="line">    type: <span class="string">'timestamp'</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    name: <span class="string">'deleted_at'</span>,</span><br><span class="line">    comment: <span class="string">'删除时间'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  deletedAt: <span class="built_in">Date</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>users</code>表继承自<code>baseEntity</code>，就不需要写创建时间，修改时间，自增<code>ID</code>等重复字段了。其他的表也可以继承自<code>baseEntity</code>，减少重复代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Column,Entity &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BaseEntity &#125; <span class="keyword">from</span> <span class="string">'./user.baseEntity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;  <span class="comment">// 继承</span></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">30</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    unique: <span class="literal">true</span>, </span><br><span class="line">  &#125;)</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    name: <span class="string">'password'</span>, </span><br><span class="line">    length: <span class="number">100</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>, </span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    comment: <span class="string">'密码'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">11</span>,</span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    nullable: <span class="literal">true</span>,</span><br><span class="line">    comment: <span class="string">'手机号码'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  mobile: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'varchar'</span>,</span><br><span class="line">    length: <span class="number">50</span>,</span><br><span class="line">    select: <span class="literal">false</span>,</span><br><span class="line">    nullable: <span class="literal">true</span>,</span><br><span class="line">    comment: <span class="string">'邮箱'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  email: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'enum'</span>,</span><br><span class="line">    enum: [<span class="string">'male'</span>, <span class="string">'female'</span>], </span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'male'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  gender: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'tinyint'</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">1</span>,</span><br><span class="line">    comment: <span class="string">'0：禁用，1：可用'</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  status: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实体监听装饰器"><a href="#实体监听装饰器" class="headerlink" title="实体监听装饰器"></a><strong>实体监听装饰器</strong></h3><ul>
<li>其实是typeorm在操作数据库时的生命周期，可以更方便的操作数据</li>
<li>查找后：<code>@AfterLoad</code></li>
<li>插入前：<code>@BeforeInsert</code></li>
<li>插入后：<code>@AfterInsert</code></li>
<li>更新前：<code>@BeforeUpdate</code></li>
<li>更新后：<code>@AfterUpdate</code></li>
<li>删除前：<code>@BeforeRemove</code></li>
</ul>
<blockquote>
<p><code>AfterLoad</code>例子：其他的装饰器是一样的用法</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  AfterLoad,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查找后，如果age小于20，让age = 20</span></span><br><span class="line">  @AfterLoad()    <span class="comment">// 装饰器固定写</span></span><br><span class="line">  load() &#123;        <span class="comment">// 函数名字随你定义</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'this'</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.age &lt; <span class="number">20</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.age = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @Column(&#123;</span><br><span class="line">    type: <span class="string">'tinyint'</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">18</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  age: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用生命周期前是18，查找后就变成了20</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"age"</span>: <span class="number">20</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="typeorm增删改查操作"><a href="#typeorm增删改查操作" class="headerlink" title="typeorm增删改查操作"></a>typeorm增删改查操作</h2><blockquote>
<p>访问数据库的方式有哪些？<br>typeorm增删改查操作的方式有哪些？</p>
</blockquote>
<h3 id="多种访问数据库的方式"><a href="#多种访问数据库的方式" class="headerlink" title="多种访问数据库的方式"></a><strong>多种访问数据库的方式</strong></h3><p>第一种：<code>Connection</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    private readonly connection: Connection,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> test() &#123;</span><br><span class="line">    <span class="comment">// 使用封装好方法：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.connection</span><br><span class="line">      .getRepository(UsersEntity)</span><br><span class="line">      .findOne(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用createQueryBuilder：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.connection</span><br><span class="line">      .createQueryBuilder()</span><br><span class="line">      .select(<span class="string">'user'</span>)</span><br><span class="line">      .from(UsersEntity, <span class="string">'user'</span>)</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种：<code>Repository</code>，需要<code>@nestjs/typeorm</code>的<code>InjectRepository</code>来注入实体</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">  	@InjectRepository(UsersEntity)  注入实体</span><br><span class="line">	private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> test() &#123;</span><br><span class="line">  	<span class="comment">// 使用封装好方法：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.find(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用createQueryBuilder：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">      .createQueryBuilder(<span class="string">'user'</span>)</span><br><span class="line">      .where(<span class="string">'id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三种：<code>getConnection()</code>：语法糖，是<code>Connection</code>类型</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getConnection &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> test() &#123;</span><br><span class="line">  	<span class="comment">// 使用封装好方法：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> getConnection()</span><br><span class="line">      .getRepository(UsersEntity)</span><br><span class="line">      .find(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用createQueryBuilder：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> getConnection()</span><br><span class="line">      .createQueryBuilder()</span><br><span class="line">      .select(<span class="string">'user'</span>)</span><br><span class="line">      .from(UsersEntity, <span class="string">'user'</span>)</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第四种：<code>getRepository</code>：语法糖</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getRepository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> test() &#123;</span><br><span class="line">  <span class="comment">// 使用封装好方法：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> getRepository(UsersEntity).find(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用createQueryBuilder：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> getRepository(UsersEntity)</span><br><span class="line">      .createQueryBuilder(<span class="string">'user'</span>)</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第五种：<code>getManager</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> test() &#123;</span><br><span class="line">  <span class="comment">// 使用封装好方法：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> getManager().find(UsersEntity, &#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用createQueryBuilder：</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">await</span> getManager()</span><br><span class="line">      .createQueryBuilder(UsersEntity, <span class="string">'user'</span>)</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>简单总结</strong></p>
<p>使用的方式太多，建议使用：<code>2，4</code>，比较方便</p>
<p><strong>Connection核心类：</strong></p>
<ul>
<li><code>connection</code>                           等于<code>getConnection</code></li>
<li><code>connection.manager</code>                   等于<code>getManager</code>， 等于<code>getConnection.manager</code></li>
<li><code>connection.getRepository</code>             等于<code>getRepository</code>， 等于<code>getManager.getRepository</code></li>
<li><code>connection.createQueryBuilder</code>        使用<code>QueryBuilder</code></li>
<li><code>connection.createQueryRunner</code>         开启事务</li>
</ul>
<ol>
<li><code>EntityManager</code> 和 <code>Repository</code>都封装了操作数据的方法，注意：两者的使用方式是不一样的，（实在不明白搞这么多方法做什么，学得头大）<br><code>getManager</code>是<code>EntityManager</code>的类型，<code>getRepository</code>是<code>Repository</code>的类型</li>
<li>都可以使用<code>createQueryBuilder</code>，但使用的方式略有不同</li>
</ol>
<h3 id="增删改查的三种方式"><a href="#增删改查的三种方式" class="headerlink" title="增删改查的三种方式"></a><strong>增删改查的三种方式</strong></h3><ul>
<li>第一种：使用sql语句，适用于sql语句熟练的同学</li>
<li>第二种：<code>typeorm</code>封装好的方法，增删改 + 简单查询</li>
<li>第三种：<code>QueryBuilder</code>查询生成器，适用于关系查询，多表查询，复杂查询</li>
<li>其实底层最终都会生成<code>sql</code>语句，只是封装了几种方式而已，方便人们使用。</li>
</ul>
<p><strong>第一种：sql语句</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.query(<span class="string">'select * from users'</span>);  <span class="comment">// 在query中填写sql语句</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第二种：typeorm封装好的api方法</strong></p>
<p>这里使用第二种访问数据库的方式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findAndCount();  <span class="comment">// 封装好的方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>api方法</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">增</span><br><span class="line">save(user)            创建：返回该数据的所有字段</span><br><span class="line">insert(user)          快速插入一条数据，插入成功：返回插入实体，与save方法不同的是，它不执行级联、关系和其他操作。</span><br><span class="line">删</span><br><span class="line">remove(user)          删除：返回该数据的可见字段</span><br><span class="line">softRemove(user);     拉黑：返回该数据的可见字段，该删除实体必须拥有@DeleteDateColumn()字段，被拉黑的用户还存在数据库中，但无法被find查找到，会在@DeleteDateColumn()字段中添加删除时间，可使用recover恢复</span><br><span class="line">改</span><br><span class="line">update(id, user)      更新：返回更新实体，不是该数据的字段</span><br><span class="line">恢复</span><br><span class="line">recover(&#123; id &#125;)       恢复：返回id，将被softRemove删除（拉黑）的用户恢复，恢复成功后可以被find查找到</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查找全部</span><br><span class="line">find()</span><br><span class="line">find(&#123;<span class="attr">id</span>:<span class="number">9</span>&#125;)                   条件查找，写法一，找不到返回空对象</span><br><span class="line">find(&#123;<span class="attr">where</span>:&#123;<span class="attr">id</span>:<span class="number">10</span>&#125;&#125;)          条件查找，写法二，找不到返回空对象</span><br><span class="line">findAndCount()                 返回数据和总的条数</span><br><span class="line"></span><br><span class="line">查找一个</span><br><span class="line">findOne(id);                       根据ID查找，找不到返回<span class="literal">undefined</span></span><br><span class="line">findOne(&#123; <span class="attr">where</span>: &#123; username &#125; &#125;);  条件查找，找不到返回<span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">根据ID查找一个或多个</span><br><span class="line">findByIds([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);            查找n个，全部查找不到返回空数组，找到就返回找到的</span><br><span class="line"></span><br><span class="line">其他</span><br><span class="line">hasId(<span class="keyword">new</span> UsersEntity())       检测实体是否有合成ID，返回布尔值</span><br><span class="line">getId(<span class="keyword">new</span> UsersEntity())       获取实体的合成ID，获取不到返回<span class="literal">undefined</span></span><br><span class="line">create(&#123;<span class="attr">username</span>: <span class="string">'admin12345'</span>, <span class="attr">password</span>: <span class="string">'123456'</span>,&#125;)  创建一个实体，需要调用save保存</span><br><span class="line">count(&#123; <span class="attr">status</span>: <span class="number">1</span> &#125;)           计数，返回数量，无返回<span class="number">0</span></span><br><span class="line">increment(&#123; id &#125;, <span class="string">'age'</span>, <span class="number">2</span>);   增加，给条件为id的数据的age字段增加<span class="number">2</span>，成功返回改变实体</span><br><span class="line">decrement(&#123; id &#125;, <span class="string">'age'</span>, <span class="number">2</span>)    减少，给条件为id的数据的age字段增加<span class="number">2</span>，成功返回改变实体</span><br><span class="line"></span><br><span class="line">谨用</span><br><span class="line">findOneOrFail(id)              找不到直接报<span class="number">500</span>错误，无法使用过滤器拦截错误，不要使用</span><br><span class="line">clear()                        清空该数据表，谨用！！！</span><br></pre></td></tr></table></figure>
<p><strong>find更多参数</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.userRepository.find(&#123;</span><br><span class="line">    select: [<span class="string">"firstName"</span>, <span class="string">"lastName"</span>],             要的字段</span><br><span class="line">    relations: [<span class="string">"photos"</span>, <span class="string">"videos"</span>],               关系查询</span><br><span class="line">    where: &#123;                                       条件查询</span><br><span class="line">        firstName: <span class="string">"Timber"</span>,</span><br><span class="line">        lastName: <span class="string">"Saw"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    where: [&#123; <span class="attr">username</span>: <span class="string">"li"</span> &#125;, &#123; <span class="attr">username</span>: <span class="string">"joy"</span> &#125;],   多个条件or, 等于：where username = <span class="string">'li'</span> or username = <span class="string">'joy'</span></span><br><span class="line">    order: &#123;                                       排序</span><br><span class="line">        name: <span class="string">"ASC"</span>,</span><br><span class="line">        id: <span class="string">"DESC"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    skip: <span class="number">5</span>,                                       偏移量</span><br><span class="line">    take: <span class="number">10</span>,                                      每页条数</span><br><span class="line">    cache: <span class="number">60000</span>                                   启用缓存：<span class="number">1</span>分钟</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>find进阶选项</strong></p>
<p>TypeORM 提供了许多内置运算符，可用于创建更复杂的查询</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Not, Between, In &#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.find(&#123;</span><br><span class="line">    username: Not(<span class="string">'admin'</span>),</span><br><span class="line">&#125;);</span><br><span class="line">将执行以下查询：</span><br><span class="line">SELECT * FROM <span class="string">"users"</span> WHERE <span class="string">"username"</span> != <span class="string">'admin'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.find(&#123;</span><br><span class="line">    likes: Between(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">&#125;);</span><br><span class="line">SELECT * FROM <span class="string">"users"</span> WHERE <span class="string">"likes"</span> BETWEEN <span class="number">1</span> AND <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.find(&#123;</span><br><span class="line">    username: In([<span class="string">'admin'</span>, <span class="string">'admin2'</span>]),</span><br><span class="line">&#125;);</span><br><span class="line">SELECT * FROM <span class="string">"users"</span> WHERE <span class="string">"title"</span> IN (<span class="string">'admin'</span>, <span class="string">'admin2'</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://typeorm.biunav.com/zh/find-options.html#%E8%BF%9B%E9%98%B6%E9%80%89%E9%A1%B9" target="_blank" rel="noopener">更多查看官网</a></p>
<p><strong>第三种</strong>：<code>QueryBuilder</code>查询生成器</p>
<p>使用链式操作</p>
<p><strong>QueryBuilder增，删，改</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 增加</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">  .createQueryBuilder()</span><br><span class="line">  .insert()                       声明插入操作</span><br><span class="line">  .into(UsersEntity)              插入的实体</span><br><span class="line">  .values([                       插入的值，可插入多个</span><br><span class="line">    &#123; <span class="attr">username</span>: <span class="string">'Timber'</span>, <span class="attr">password</span>: <span class="string">'123456'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">username</span>: <span class="string">'Timber2'</span>, <span class="attr">password</span>: <span class="string">'123456'</span> &#125;,</span><br><span class="line">  ])</span><br><span class="line">  .execute();                     执行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">  .createQueryBuilder()</span><br><span class="line">  .update(UsersEntity)</span><br><span class="line">  .set(&#123; <span class="attr">username</span>: <span class="string">'admin22'</span> &#125;)</span><br><span class="line">  .where(<span class="string">'id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">2</span> &#125;)</span><br><span class="line">  .execute();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">  .createQueryBuilder()</span><br><span class="line">  .delete()</span><br><span class="line">  .from(UsersEntity)</span><br><span class="line">  .where(<span class="string">'id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">8</span> &#125;)</span><br><span class="line">  .execute();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理异常：请求成功会返回一个对象， 如果raw.affectedRows != 0 就是成功</span></span><br><span class="line"><span class="string">"raw"</span>: &#123;</span><br><span class="line">      <span class="string">"fieldCount"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">"affectedRows"</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">"insertId"</span>: <span class="number">13</span>,</span><br><span class="line">      <span class="string">"serverStatus"</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">"warningCount"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">"message"</span>: <span class="string">"&amp;Records: 2  Duplicates: 0  Warnings: 0"</span>,</span><br><span class="line">      <span class="string">"protocol41"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">"changedRows"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查询</strong></p>
<p>简单例子</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">    .createQueryBuilder(<span class="string">'user'</span>)                      创建生成器，参数：别名</span><br><span class="line">    .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: id &#125;)              条件</span><br><span class="line">    .innerJoinAndSelect(<span class="string">'user.avatar'</span>, <span class="string">'avatar'</span>)     关系查询</span><br><span class="line">    .addSelect(<span class="string">'user.password'</span>)                      添加显示字段</span><br><span class="line">    .getOne();                                       获取一条数据</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>QueryBuilder查询生成器说明</strong></p>
<p>查询单表</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">访问数据库的方式不同：</span><br><span class="line"></span><br><span class="line">方式一：没有指定实体，需要使用<span class="keyword">from</span>指定实体</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> getConnection()</span><br><span class="line">      .createQueryBuilder()</span><br><span class="line">      .select(<span class="string">'user.username'</span>)             ‘user’：全部字段，‘user.username’：只获取username</span><br><span class="line">      .from(UsersEntity, <span class="string">'user'</span>)           参<span class="number">1</span>：连接的实体， 参<span class="number">2</span>：别名</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line"></span><br><span class="line">方式二：指定实体：默认获取全部字段</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> getConnection()</span><br><span class="line">      .createQueryBuilder(UsersEntity, <span class="string">'user'</span>)   指定实体</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br><span class="line"></span><br><span class="line">方式三： 已经在访问时指定了实体：默认获取全部字段</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">      .createQueryBuilder(<span class="string">'user'</span>)          别名</span><br><span class="line">      .where(<span class="string">'user.id = :id'</span>, &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .getOne();</span><br></pre></td></tr></table></figure>
<p>获取结果</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.getSql();          获取实际执行的sql语句，用于开发时检查问题</span><br><span class="line">.getOne();          获取一条数据（经过typeorm的字段处理）</span><br><span class="line">.getMany();         获取多条数据</span><br><span class="line">.getRawOne();       获取一条原数据（没有经过typeorm的字段处理）</span><br><span class="line">.getRawMany();      获取多条原数据</span><br><span class="line">.stream();          返回流数据</span><br><span class="line"></span><br><span class="line">如：经过typeorm的字段处理，获取到的就是实体设计时的字段</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"gender"</span>: <span class="string">"male"</span>,</span><br><span class="line">        <span class="string">"age"</span>: <span class="number">18</span>,</span><br><span class="line">        <span class="string">"status"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"createdAt"</span>: <span class="string">"2021-04-26T09:58:54.469Z"</span>,</span><br><span class="line">        <span class="string">"updatedAt"</span>: <span class="string">"2021-04-28T14:47:36.000Z"</span>,</span><br><span class="line">        <span class="string">"deletedAt"</span>: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如：没有经过typeorm的字段处理，将数据库的字段原生不动的显示出来</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"user_username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"user_gender"</span>: <span class="string">"male"</span>,</span><br><span class="line">        <span class="string">"user_age"</span>: <span class="number">18</span>,</span><br><span class="line">        <span class="string">"user_status"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"user_created_at"</span>: <span class="string">"2021-04-26T09:58:54.469Z"</span>,</span><br><span class="line">        <span class="string">"user_updated_at"</span>: <span class="string">"2021-04-28T14:47:36.000Z"</span>,</span><br><span class="line">        <span class="string">"user_deleted_at"</span>: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询部分字段</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.select([<span class="string">"user.id"</span>, <span class="string">"user.name"</span>])</span><br><span class="line">实际执行的sql语句：SELECT user.id, user.name FROM users user；</span><br><span class="line"></span><br><span class="line">添加隐藏字段：实体中设置select为<span class="literal">false</span>时，是不显示字段，使用addSelect会将字段显示出来</span><br><span class="line">.addSelect(<span class="string">'user.password'</span>)</span><br></pre></td></tr></table></figure>
<p><code>where</code>条件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.where(<span class="string">"user.name = :name"</span>, &#123; <span class="attr">name</span>: <span class="string">"joy"</span> &#125;)</span><br><span class="line">等于</span><br><span class="line">.where(<span class="string">"user.name = :name"</span>)</span><br><span class="line">.setParameter(<span class="string">"name"</span>, <span class="string">"Timber"</span>)</span><br><span class="line">实际执行的sql语句：SELECT * FROM users user WHERE user.name = <span class="string">'joy'</span></span><br><span class="line"></span><br><span class="line">多个条件</span><br><span class="line">.where(<span class="string">"user.firstName = :firstName"</span>, &#123; <span class="attr">firstName</span>: <span class="string">"Timber"</span> &#125;)</span><br><span class="line">.andWhere(<span class="string">"user.lastName = :lastName"</span>, &#123; <span class="attr">lastName</span>: <span class="string">"Saw"</span> &#125;);</span><br><span class="line">实际执行的sql语句：SELECT * FROM users user WHERE user.firstName = <span class="string">'Timber'</span> AND user.lastName = <span class="string">'Saw'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span></span><br><span class="line">.where(<span class="string">"user.name IN (:...names)"</span>, &#123; <span class="attr">names</span>: [ <span class="string">"Timber"</span>, <span class="string">"Cristal"</span>, <span class="string">"Lina"</span> ] &#125;)</span><br><span class="line">实际执行的sql语句：SELECT * FROM users user WHERE user.name IN (<span class="string">'Timber'</span>, <span class="string">'Cristal'</span>, <span class="string">'Lina'</span>)</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">.where(<span class="string">"user.firstName = :firstName"</span>, &#123; <span class="attr">firstName</span>: <span class="string">"Timber"</span> &#125;)</span><br><span class="line">.orWhere(<span class="string">"user.lastName = :lastName"</span>, &#123; <span class="attr">lastName</span>: <span class="string">"Saw"</span> &#125;);</span><br><span class="line">实际执行的sql语句：SELECT * FROM users user WHERE user.firstName = <span class="string">'Timber'</span> OR user.lastName = <span class="string">'Saw'</span></span><br><span class="line"></span><br><span class="line">子句</span><br><span class="line"><span class="keyword">const</span> posts = <span class="keyword">await</span> connection</span><br><span class="line">  .getRepository(Post)</span><br><span class="line">  .createQueryBuilder(<span class="string">"post"</span>)</span><br><span class="line">  .where(<span class="function"><span class="params">qb</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> subQuery = qb</span><br><span class="line">      .subQuery()</span><br><span class="line">      .select(<span class="string">"user.name"</span>)</span><br><span class="line">      .from(User, <span class="string">"user"</span>)</span><br><span class="line">      .where(<span class="string">"user.registered = :registered"</span>)</span><br><span class="line">      .getQuery();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"post.title IN "</span> + subQuery;</span><br><span class="line">  &#125;)</span><br><span class="line">  .setParameter(<span class="string">"registered"</span>, <span class="literal">true</span>)</span><br><span class="line">  .getMany();</span><br><span class="line">实际执行的sql语句：select * <span class="keyword">from</span> post where post.title <span class="keyword">in</span> (select name <span class="keyword">from</span> user where registered = <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p><code>having</code>筛选</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.having(<span class="string">"user.firstName = :firstName"</span>, &#123; <span class="attr">firstName</span>: <span class="string">"Timber"</span> &#125;)</span><br><span class="line">.andHaving(<span class="string">"user.lastName = :lastName"</span>, &#123; <span class="attr">lastName</span>: <span class="string">"Saw"</span> &#125;);</span><br><span class="line">实际执行的sql语句：SELECT ... FROM users user HAVING user.firstName = <span class="string">'Timber'</span> AND user.lastName = <span class="string">'Saw'</span></span><br></pre></td></tr></table></figure>
<p><code>orderBy</code>排序</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.orderBy(<span class="string">"user.name"</span>, <span class="string">"DESC"</span>)</span><br><span class="line">.addOrderBy(<span class="string">"user.id"</span>, <span class="string">"asc"</span>);</span><br><span class="line">等于</span><br><span class="line">.orderBy(&#123;</span><br><span class="line">  <span class="string">"user.name"</span>: <span class="string">"ASC"</span>,</span><br><span class="line">  <span class="string">"user.id"</span>: <span class="string">"DESC"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">实际执行的sql语句：SELECT * FROM users user order by user.name asc, user.id desc;</span><br></pre></td></tr></table></figure>
<p><code>group</code>分组</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">.groupBy(<span class="string">"user.name"</span>)</span><br><span class="line">.addGroupBy(<span class="string">"user.id"</span>);</span><br></pre></td></tr></table></figure>
<p>关系查询（多表）</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>参：你要加载的关系，<span class="number">2</span>参：可选，你为此表分配的别名，<span class="number">3</span>参：可选，查询条件</span><br><span class="line"></span><br><span class="line">左关联查询</span><br><span class="line">.leftJoinAndSelect(<span class="string">"user.profile"</span>, <span class="string">"profile"</span>)     </span><br><span class="line"></span><br><span class="line">右关联查询</span><br><span class="line">.rightJoinAndSelect(<span class="string">"user.profile"</span>, <span class="string">"profile"</span>)    </span><br><span class="line"></span><br><span class="line">内联查询</span><br><span class="line">.innerJoinAndSelect(<span class="string">"user.photos"</span>, <span class="string">"photo"</span>, <span class="string">"photo.isRemoved = :isRemoved"</span>, &#123; <span class="attr">isRemoved</span>: <span class="literal">false</span> &#125;)         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">	.createQueryBuilder(<span class="string">'user'</span>)</span><br><span class="line">    .leftJoinAndSelect(<span class="string">"user.photos"</span>, <span class="string">"photo"</span>)</span><br><span class="line">    .where(<span class="string">"user.name = :name"</span>, &#123; <span class="attr">name</span>: <span class="string">"joy"</span> &#125;)</span><br><span class="line">  	.andWhere(<span class="string">"photo.isRemoved = :isRemoved"</span>, &#123; <span class="attr">isRemoved</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  	.getOne();</span><br><span class="line"></span><br><span class="line">实际执行的sql语句：</span><br><span class="line">SELECT user.*, photo.* </span><br><span class="line">FROM users user</span><br><span class="line">LEFT JOIN photos photo ON photo.user = user.id</span><br><span class="line">WHERE user.name = <span class="string">'joy'</span> AND photo.isRemoved = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">	.innerJoinAndSelect(<span class="string">"user.photos"</span>, <span class="string">"photo"</span>, <span class="string">"photo.isRemoved = :isRemoved"</span>, &#123; <span class="attr">isRemoved</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    .where(<span class="string">"user.name = :name"</span>, &#123; <span class="attr">name</span>: <span class="string">"Timber"</span> &#125;)</span><br><span class="line">    .getOne();</span><br><span class="line"></span><br><span class="line">实际执行的sql语句：</span><br><span class="line">SELECT user.*, photo.* FROM users user</span><br><span class="line">INNER JOIN photos photo ON photo.user = user.id AND photo.isRemoved = FALSE</span><br><span class="line">WHERE user.name = <span class="string">'Timber'</span>；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">多个关联</span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">  .createQueryBuilder(<span class="string">"user"</span>)</span><br><span class="line">  .leftJoinAndSelect(<span class="string">"user.profile"</span>, <span class="string">"profile"</span>)</span><br><span class="line">  .leftJoinAndSelect(<span class="string">"user.photos"</span>, <span class="string">"photo"</span>)</span><br><span class="line">  .leftJoinAndSelect(<span class="string">"user.videos"</span>, <span class="string">"video"</span>)</span><br><span class="line">  .getOne();</span><br></pre></td></tr></table></figure>
<h2 id="typeorm使用事务的3种方式"><a href="#typeorm使用事务的3种方式" class="headerlink" title="typeorm使用事务的3种方式"></a>typeorm使用事务的3种方式</h2><p><code>typeorm</code>使用事务的方式有哪些？如何使用？</p>
<p><strong>事务</strong></p>
<blockquote>
<ul>
<li>在操作多个表时，或者多个操作时，如果有一个操作失败，所有的操作都失败，要么全部成功，要么全部失</li>
<li><strong>解决问题</strong>：在多表操作时，因为各种异常导致一个成功，一个失败的数据错误。</li>
</ul>
</blockquote>
<blockquote>
<p>例子：银行转账<br>如果用户1向用户2转了100元，但因为各种原因，用户2没有收到，如果没有事务处理，用户1扣除的100元就凭空消失了<br>如果有事务处理，只有用户2收到100元，用户1才会扣除100元，如果没有收到，则不会扣除。</p>
</blockquote>
<p><strong>应用场景</strong></p>
<blockquote>
<p>多表的增，删，改操作</p>
</blockquote>
<p><strong>nest-typrorm事务的使用方式</strong></p>
<ol>
<li>使用装饰器，在<code>controller</code>中编写，传递给<code>service</code>使用</li>
<li>使用<code>getManager</code> 或 <code>getConnection</code>，在<code>service</code>中编写与使用</li>
<li>使用<code>connection</code> 或 <code>getConnection</code>，开启<code>queryRunner</code>，在<code>service</code>中编写与使用</li>
</ol>
<p><strong>方式一：使用装饰器</strong></p>
<p>controller</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  Param,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Transaction, TransactionManager, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;  开启事务第一步：引入</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service-oto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction() 开启事务第二步：装饰接口</span><br><span class="line">  <span class="keyword">async</span> create(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,  开启事务第三步：获取事务管理器</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(id, maneger);  开启事务第四步：传递给service，使用数据库时调用</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service</p>
<ul>
<li>这里处理的是1对1关系：保存头像地址到<code>avatar</code>表，同时关联保存用户的<code>id</code></li>
<li>如果你不会1对1关系，请先去学习对应的知识</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/05/24be5e00069ab400.png" alt></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/avatar.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    @InjectRepository(AvatarEntity)</span><br><span class="line">    private readonly avatarRepository: Repository&lt;AvatarEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = &#123;</span><br><span class="line">      url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>.png`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);                 先查找用户，因为要保存用户的id</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);                              找不到用户抛出异常</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> avatarEntity = <span class="keyword">this</span>.avatarRepository.create(&#123; <span class="attr">url</span>: urlObj.url &#125;);  创建头像地址的实体</span><br><span class="line">    <span class="keyword">const</span> avatarUrl = <span class="keyword">await</span> manager.save(avatarEntity);                      使用事务保存副表</span><br><span class="line">    user.avatar = avatarUrl;                                                 主表和副表建立关系</span><br><span class="line">    <span class="keyword">await</span> manager.save(user);                                                使用事务保存主表</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'新增成功'</span>;                                                        如果过程出错，不会保存</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>方式二：使用getManager 或 getConnection</strong></p>
<p>service</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Connection, Repository, getManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/avatar.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    private readonly connection: Connection,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> test(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = &#123;</span><br><span class="line">      url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>.png`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);                        先查找用户</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);                                 找不到用户抛出异常</span><br><span class="line"></span><br><span class="line">	<span class="comment">//getConnection的方式：await getConnection().transaction(manager=&gt; &#123;&#125;);</span></span><br><span class="line">	<span class="comment">//getManager的方式：</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> getManager().transaction(<span class="keyword">async</span> (manager) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> avatarEntity = manager.create(AvatarEntity, &#123; <span class="attr">url</span>: urlObj.url &#125;);   创建头像地址的实体</span><br><span class="line">      <span class="keyword">const</span> avatarUrl = <span class="keyword">await</span> manager.save(AvatarEntity, avatarEntity);         使用事务保存副表</span><br><span class="line">      user.avatar = avatarUrl;                                                  创建关联</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> manager.save(UsersEntity, user);                             使用事务保存主表，并返回结果</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"请求成功"</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"createdAt"</span>: <span class="string">"2021-04-26T09:58:54.469Z"</span>,</span><br><span class="line">        <span class="string">"updatedAt"</span>: <span class="string">"2021-04-28T14:47:36.000Z"</span>,</span><br><span class="line">        <span class="string">"deletedAt"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"gender"</span>: <span class="string">"male"</span>,</span><br><span class="line">        <span class="string">"age"</span>: <span class="number">18</span>,</span><br><span class="line">        <span class="string">"status"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"avatar"</span>: &#123;</span><br><span class="line">            <span class="string">"url"</span>: <span class="string">"http://www.dmyxs.com/images/1.png"</span>,</span><br><span class="line">            <span class="string">"id"</span>: <span class="number">52</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>方式三：使用 connection 或 getConnection</strong></p>
<p>service</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Connection, Repository, getManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/avatar.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    private readonly connection: Connection,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> test(id: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = &#123;</span><br><span class="line">      url: <span class="string">`http://www.test.com/images/<span class="subst">$&#123;id&#125;</span>.png`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);         先查找用户</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);                 找不到用户抛出异常</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> queryRunner = <span class="keyword">this</span>.connection.createQueryRunner();     获取连接并创建新的queryRunner</span><br><span class="line">    <span class="keyword">await</span> queryRunner.connect();                                 使用我们的新queryRunner建立真正的数据库连</span><br><span class="line">    <span class="keyword">await</span> queryRunner.startTransaction();                        开始事务</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> avatarEntity = <span class="keyword">new</span> AvatarEntity();                     创建实体：要保存的数据</span><br><span class="line">    avatarEntity.url = urlObj.url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> queryRunner.manager                  使用事务保存到副表</span><br><span class="line">        .getRepository(AvatarEntity)</span><br><span class="line">        .save(avatarEntity);</span><br><span class="line"></span><br><span class="line">      user.avatar = result;                                     主表和副表建立连接</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">const</span> userResult = <span class="keyword">await</span> queryRunner.manager              使用事务保存到副表</span><br><span class="line">        .getRepository(UsersEntity)</span><br><span class="line">        .save(user);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> queryRunner.commitTransaction();                   提交事务</span><br><span class="line">      <span class="keyword">return</span> userResult;                                       返回结果</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'创建失败，取消事务'</span>);</span><br><span class="line">      <span class="keyword">await</span> queryRunner.rollbackTransaction();                 出错回滚</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.release();                             释放</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="typeorm-一对一关系设计与增删改查"><a href="#typeorm-一对一关系设计与增删改查" class="headerlink" title="typeorm 一对一关系设计与增删改查"></a>typeorm 一对一关系设计与增删改查</h2><p>实体如何设计一对一关系？如何增删改查？</p>
<p><strong>一对一关系</strong></p>
<blockquote>
<ul>
<li>定义：一对一是一种 A 只包含一个 B ，而 B 只包含一个 A 的关系</li>
<li>其实就是要设计两个表：一张是主表，一张是副表，查找主表时，关联查找副表</li>
<li>有外键的表称之为副表，不带外键的表称之为主表</li>
<li>如：一个账户对应一个用户信息，主表是账户，副表是用户信息</li>
<li>如：一个用户对应一张用户头像图片，主表是用户信息，副表是头像地址</li>
</ul>
</blockquote>
<p><strong>一对一实体设计</strong></p>
<p>主表：</p>
<blockquote>
<ul>
<li>使用<code>@OneToOne()</code> 来建立关系</li>
<li>第一个参数：<code>() =&gt; AvatarEntity</code>， 和谁建立关系？ 和<code>AvatarEntity</code>建立关系</li>
<li>第二个参数：<code>(avatar) =&gt; avatar.user)</code>，和哪个字段联立关系？ <code>avatar</code>就是<code>AvatarEntity</code>的别名，可随便写，和<code>AvatarEntity</code>的<code>userinfo</code>字段建立关系</li>
<li>第三个参数：<code>RelationOptions</code>关系选项</li>
</ul>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  OneToOne,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./avatar.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @OneToOne(<span class="function"><span class="params">()</span> =&gt;</span> AvatarEntity, (avatar) =&gt; avatar.userinfo)</span><br><span class="line">  avatar: AvatarEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>副表</p>
<blockquote>
<p>参数：同主表一样<br>主要：根据<code>@JoinColumn({ name: ‘user_id’ })</code>来分辨副表，<code>name</code>是设置数据库的外键名字，如果不设置是<code>userId</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  Column,</span><br><span class="line">  OneToOne,</span><br><span class="line">  JoinColumn,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'avatar'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AvatarEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  url: string;</span><br><span class="line"></span><br><span class="line">  @OneToOne(<span class="function"><span class="params">()</span> =&gt;</span> UsersEntity, (user) =&gt; user.avatar)</span><br><span class="line">  @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">'userinfo_id'</span> &#125;)</span><br><span class="line">  userinfo: UsersEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>一对一增删改查</strong></p>
<blockquote>
<ul>
<li><strong>注意</strong>：只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一</li>
<li><strong>在这里</strong>：创建，修改，删除都开启了事务</li>
<li><strong>注意</strong>：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）</li>
</ul>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.controller.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  Patch,</span><br><span class="line">  Query,</span><br><span class="line">  Param,</span><br><span class="line">  Delete,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Transaction, TransactionManager, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;  开启事务第一步：引入</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service-oto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Get()</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">const</span> [data, count] = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findAll();</span><br><span class="line">    <span class="keyword">return</span> &#123; count, data &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">':id'</span>)</span><br><span class="line">  @HttpCode(HttpStatus.OK)</span><br><span class="line">  @Transaction() 开启事务第二步：装饰接口</span><br><span class="line">  <span class="keyword">async</span> create(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,  开启事务第三步：获取事务管理器</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(id, maneger);  开启事务第四步：传递给service，使用数据库时调用</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Patch(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> update(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.update(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> remove(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.remove(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user.service.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, Connection, UpdateResult, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/avatar.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    @InjectRepository(AvatarEntity)</span><br><span class="line">    private readonly avatarRepository: Repository&lt;AvatarEntity&gt;,</span><br><span class="line">    private connection: Connection,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  一对一增删改查</span><br><span class="line">  查找全部</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    使用封装好的方式</span><br><span class="line">    <span class="comment">// return await this.usersRepository.findAndCount(&#123; relations: ['avatar'] &#125;);</span></span><br><span class="line"></span><br><span class="line">	使用QueryBuilder的方式</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">      .createQueryBuilder(<span class="string">'UsersEntity'</span>)</span><br><span class="line">      .leftJoinAndSelect(<span class="string">'UsersEntity.avatar'</span>, <span class="string">'AvatarEntity.userinfo'</span>)</span><br><span class="line">      .getManyAndCount();</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id查找一对一</span><br><span class="line">  <span class="keyword">async</span> findOne(id: number) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id, &#123;</span><br><span class="line">      relations: [<span class="string">'avatar'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!result) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id创建一对一</span><br><span class="line">  <span class="keyword">async</span> create(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = &#123;</span><br><span class="line">      url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>.png`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);      先查找用户</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);                  如果没找到，抛出错误，由过滤器捕获错误</span><br><span class="line">    </span><br><span class="line">    创建实体的两种方式：<span class="keyword">new</span> 和 create，<span class="keyword">new</span>的方式方便条件判断</span><br><span class="line">    创建实体方式一：</span><br><span class="line">    <span class="keyword">const</span> avatarEntity = <span class="keyword">this</span>.avatarRepository.create(&#123; <span class="attr">url</span>: urlObj.url &#125;);  创建实体</span><br><span class="line"></span><br><span class="line">	创建实体方式二：</span><br><span class="line">	<span class="comment">//const avatarEntity = new AvatarEntity();</span></span><br><span class="line">	<span class="comment">//avatarEntity.url = urlObj.url;</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">const</span> avatarUrl = <span class="keyword">await</span> manager.save(avatarEntity);          使用事务保存副表</span><br><span class="line">    user.avatar = avatarUrl;                                     主表和副表建立关系</span><br><span class="line">    <span class="keyword">await</span> manager.save(user);                                    使用事务保存主表</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'新增成功'</span>;                                            如果过程出错，不会保存</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id更改一对一</span><br><span class="line">  要更改的副表id，会从前端传递过来</span><br><span class="line">  <span class="keyword">async</span> update(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlObj = &#123;</span><br><span class="line">      id: <span class="number">18</span>,</span><br><span class="line">      url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>-update.jpg`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne( &#123; id &#125; );       先查找用户</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);                      如果没找到id抛出错误，由过滤器捕获错误</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> avatarEntity = <span class="keyword">this</span>.avatarRepository.create(&#123; <span class="attr">url</span>: urlObj.url &#125;);    创建要修改的实体</span><br><span class="line"></span><br><span class="line">	使用事务更新方法：<span class="number">1</span>参：要修改的表，<span class="number">2</span>参：要修改的id， <span class="number">3</span>参：要更新的数据</span><br><span class="line">    <span class="keyword">await</span> manager.update(AvatarEntity, urlObj.id, avatarEntity);   </span><br><span class="line">    <span class="keyword">return</span> <span class="string">'更新成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id删除一对一</span><br><span class="line">  <span class="keyword">async</span> remove(id: number, <span class="attr">manager</span>: EntityManager): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">    只删副表的关联数据</span><br><span class="line">    <span class="keyword">await</span> manager.delete(AvatarEntity, &#123; <span class="attr">user</span>: id &#125;);</span><br><span class="line">    </span><br><span class="line">    如果连主表用户一起删，加下面这行代码</span><br><span class="line">    <span class="comment">//await manager.delete(UsersEntity, id);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'删除成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="typeorm-一对多和多对一关系设计与增删改查"><a href="#typeorm-一对多和多对一关系设计与增删改查" class="headerlink" title="typeorm 一对多和多对一关系设计与增删改查"></a>typeorm 一对多和多对一关系设计与增删改查</h2><p>实体如何设计一对多与多对一关系，如何关联查询</p>
<p><strong>一对多关系，多对一关系</strong></p>
<blockquote>
<p>定义：一对多是一种一个 A 包含多个 B ，而多个B只属于一个 A 的关系<br>其实就是要设计两个表：一张是主表（一对多），一张是副表（多对一），查找主表时，关联查找副表<br>有外键的表称之为副表，不带外键的表称之为主表<br>如：一个用户拥有多个宠物，多个宠物只属于一个用户的（每个宠物只能有一个主人）<br>如：一个用户拥有多张照片，多张照片只属于一个用户的<br>如：一个角色拥有多个用户，多个用户只属于一个角色的（每个用户只能有一个角色）</p>
</blockquote>
<p><strong>一对多和多对一实体设计</strong></p>
<p>一对多</p>
<blockquote>
<p>使用<code>@OneToMany()</code>来建立一对多关系<br>第一个参数：<code>() =&gt; PhotoEntity</code>， 和谁建立关系？ 和<code>PhotoEntity</code>建立关系<br>第二个参数：<code>(user) =&gt; user.photo</code>，和哪个字段联立关系？ <code>user</code>就是<code>PhotoEntity</code>的别名，可随便写，和<code>PhotoEntity</code>的<code>userinfo</code>字段建立关系<br>第三个参数：<code>RelationOptions</code>关系选项</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  OneToOne,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./avatar.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @OneToMany(<span class="function"><span class="params">()</span> =&gt;</span> PhotoEntity, (avatar) =&gt; avatar.userinfo)</span><br><span class="line">  photos: PhotoEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多对一</p>
<blockquote>
<p>使用<code>@ManyToOne()</code>来建立多对一关系，参数如同上</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Entity, PrimaryGeneratedColumn, Column, ManyToOne &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'photo'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PhotoEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  url: string;</span><br><span class="line"></span><br><span class="line">  @ManyToOne(<span class="function"><span class="params">()</span> =&gt;</span> UsersEntity, (user) =&gt; user.photos)</span><br><span class="line">  @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">'userinfo_id'</span> &#125;)</span><br><span class="line">  userinfo: UsersEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>一对多和多对一增删改查</strong></p>
<blockquote>
<p>只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一<br>注意：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）<br>比较复杂的是更新操作</p>
</blockquote>
<p>user.controller.ts</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  Patch,</span><br><span class="line">  Query,</span><br><span class="line">  Param,</span><br><span class="line">  Delete,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Transaction, TransactionManager, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;  开启事务第一步：引入</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service-oto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Get()</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">const</span> [data, count] = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findAll();</span><br><span class="line">    <span class="keyword">return</span> &#123; count, data &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">':id'</span>)</span><br><span class="line">  @HttpCode(HttpStatus.OK)</span><br><span class="line">  @Transaction() 开启事务第二步：装饰接口</span><br><span class="line">  <span class="keyword">async</span> create(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,  开启事务第三步：获取事务管理器</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(id, maneger);  开启事务第四步：传递给service，使用数据库时调用</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Patch(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> update(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.update(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> remove(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.remove(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>user.service.ts</p>
<p><strong>令人头大的地方</strong>：建立关系和查找使用实体，删除使用实体的id，感觉设计得不是很合理，违背人的常识</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PhotoEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/photo.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    @InjectRepository(PhotoEntity)</span><br><span class="line">    private readonly photoRepository: Repository&lt;PhotoEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  一对多增删改查</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="comment">// return await this.usersRepository.findAndCount(&#123; relations: ['photos'] &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">      .createQueryBuilder(<span class="string">'UsersEntity'</span>)</span><br><span class="line">      .leftJoinAndSelect(<span class="string">'UsersEntity.photos'</span>, <span class="string">'PhotoEntity.userinfo'</span>)</span><br><span class="line">      .getManyAndCount();</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id查找一对多</span><br><span class="line">  <span class="keyword">async</span> findOne(id: number) &#123;</span><br><span class="line">    查询一个用户有多少张照片（一对多）</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id, &#123;</span><br><span class="line">      relations: [<span class="string">'photos'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!result) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    查询这张照片属于谁（多对一）</span><br><span class="line">    <span class="comment">// const result = await this.photoRepository.findOne(id, &#123;</span></span><br><span class="line">    <span class="comment">//   relations: ['userinfo'],</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// if (!result) ToolsService.fail('图片id不存在');</span></span><br><span class="line">    <span class="comment">// return result;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id创建一对多</span><br><span class="line">  <span class="keyword">async</span> create(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlList = [</span><br><span class="line">      &#123;</span><br><span class="line">        url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>.png`</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>.jpg`</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">	遍历传递过来的数据</span><br><span class="line">    <span class="keyword">if</span> (urlList.length !== <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; urlList.length; i++) &#123;</span><br><span class="line">	       创建实体的两种方式：<span class="keyword">new</span> 和 create，<span class="keyword">new</span>的方式方便条件判断</span><br><span class="line">	       <span class="comment">// const photo = new PhotoEntity();</span></span><br><span class="line">	       <span class="comment">// photo.url = urlList[i].url;</span></span><br><span class="line">	       <span class="comment">// photo.user = user;</span></span><br><span class="line">	       <span class="comment">// await manager.save(PhotoEntity, photo);</span></span><br><span class="line">	</span><br><span class="line">	       <span class="keyword">const</span> photoEntity = <span class="keyword">this</span>.photoRepository.create(&#123;</span><br><span class="line">	         url: urlList[i].url,</span><br><span class="line">	         userinfo: user,  注意：这里是使用实体建立关系，而不是实体id</span><br><span class="line">	       &#125;);</span><br><span class="line">	       <span class="keyword">await</span> manager.save(photoEntity);</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'新增成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id更改一对多</span><br><span class="line">  示例：删除一张，修改一张(修改的有id)，新增一张</span><br><span class="line">  先使用创建，创建两张photo</span><br><span class="line">  <span class="keyword">async</span> update(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlList = [</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="number">22</span>,</span><br><span class="line">        url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>-update.png`</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        url: <span class="string">`http://www.dmyxs.com/images/<span class="subst">$&#123;id&#125;</span>-create.jpeg`</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line">    </span><br><span class="line">    如果要修改主表，先修改主表用户信息，后修改副表图片信息</span><br><span class="line">    修改主表</span><br><span class="line">    <span class="keyword">const</span> userEntity = <span class="keyword">this</span>.usersRepository.create(&#123;</span><br><span class="line">      id,</span><br><span class="line">      username: <span class="string">'admin7'</span>,</span><br><span class="line">      password: <span class="string">'123456'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> manager.save(userEntity);</span><br><span class="line"></span><br><span class="line">    修改副表</span><br><span class="line">    如果前端附带了图片list</span><br><span class="line">    <span class="keyword">if</span> (urlList.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      查询数据库已经有的图片</span><br><span class="line">      <span class="keyword">const</span> databasePhotos = <span class="keyword">await</span> manager.find(PhotoEntity, &#123; <span class="attr">userinfo</span>: user &#125;);</span><br><span class="line">      </span><br><span class="line">      如果有数据，则进行循环判断，先删除多余的数据</span><br><span class="line">      <span class="keyword">if</span> (databasePhotos.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; databasePhotos.length; i++) &#123;</span><br><span class="line">        </span><br><span class="line">          以用户传递的图片为基准，数据库的图片id是否在用户传递过来的表里，如果不在，就是要删除的数据</span><br><span class="line">          <span class="keyword">const</span> exist = urlList.find(<span class="function">(<span class="params">item</span>) =&gt;</span> item.id === databasePhotos[i].id);</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (!exist) &#123;</span><br><span class="line">            <span class="keyword">await</span> manager.delete(PhotoEntity, &#123; <span class="attr">id</span>: databasePhotos[i].id &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      否则就是新增和更改的数据</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; urlList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> photoEntity = <span class="keyword">new</span> PhotoEntity();</span><br><span class="line">        photoEntity.url = urlList[i].url;</span><br><span class="line">        </span><br><span class="line">        如果有id则是修改操作，因为前端传递的数据是从服务端获取的，会附带id，新增的没有</span><br><span class="line">        <span class="keyword">if</span> (!!urlList[i].id) &#123;</span><br><span class="line">        </span><br><span class="line">          修改则让id关联即可</span><br><span class="line">          photoEntity.id = urlList[i].id;</span><br><span class="line">          <span class="keyword">await</span> manager.save(PhotoEntity, photoEntity);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">          否则是新增操作,关联用户实体</span><br><span class="line">          photoEntity.userinfo = user;</span><br><span class="line">          <span class="keyword">await</span> manager.save(PhotoEntity, photoEntity);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      如果前端把图片全部删除，删除所有关联的图片</span><br><span class="line">      <span class="keyword">await</span> manager.delete(PhotoEntity, &#123; <span class="attr">userinfo</span>: id &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'更新成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id删除一对多</span><br><span class="line">  <span class="keyword">async</span> remove(id: number, <span class="attr">manager</span>: EntityManager): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">    只删副表的关联数据</span><br><span class="line">    <span class="keyword">await</span> manager.delete(PhotoEntity, &#123; <span class="attr">userinfo</span>: id &#125;);</span><br><span class="line">    如果连主表用户一起删，加下面这行代码</span><br><span class="line">    <span class="comment">//await manager.delete(UsersEntity, id);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'删除成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="typeorm-多对多关系设计与增删改查"><a href="#typeorm-多对多关系设计与增删改查" class="headerlink" title="typeorm 多对多关系设计与增删改查"></a>typeorm 多对多关系设计与增删改查</h2><blockquote>
<p>实体如何设计多对多关系？如何增删改查？</p>
</blockquote>
<p><strong>多对多关系</strong></p>
<blockquote>
<p>定义：多对多是一种 A 包含多个 B，而 B 包含多个 A 的关系<br>如：一个粉丝可以关注多个主播，一个主播可以有多个粉丝<br>如：一篇文章属于多个分类，一个分类下有多篇文章<br>比如这篇文章，可以放在nest目录，也可以放在typeorm目录或者mysql目录</p>
</blockquote>
<p><strong>实现方式</strong></p>
<blockquote>
<p>第一种：建立两张表，使用装饰器<code>@ManyToMany</code>建立关系，<code>typeorm</code>会自动生成三张表<br>第二种：手动建立3张表</p>
</blockquote>
<p>这里使用第一种</p>
<h3 id="实体设计-1"><a href="#实体设计-1" class="headerlink" title="实体设计"></a><strong>实体设计</strong></h3><p>这里将设计一个用户（粉丝） 与 明星的 多对多关系</p>
<p>用户（粉丝）可以主动关注明星，让<code>users</code>变为主表，加入<code>@JoinTable()</code></p>
<blockquote>
<p>使用<code>@ManyToMany()</code> 来建立多对多关系<br>第一个参数：<code>() =&gt; StarEntity</code>， 和谁建立关系？ 和<code>StarEntity</code>建立关系<br>第二个参数：<code>(star) =&gt; star.photo</code>，和哪个字段联立关系？ <code>star</code>就是<code>StarEntity</code>的别名，可随便写，和<code>PhotoEntity</code>的<code>followers</code>字段建立关系</p>
</blockquote>
<p>用户（粉丝）表：follows关注/跟随</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Column,</span><br><span class="line">  Entity,</span><br><span class="line">  PrimaryGeneratedColumn,</span><br><span class="line">  ManyToMany,</span><br><span class="line">  JoinTable,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AvatarEntity &#125; <span class="keyword">from</span> <span class="string">'./avatar.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'users'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  username: string;</span><br><span class="line"></span><br><span class="line">  @Column()</span><br><span class="line">  password: string;</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> StarEntity, (star) =&gt; star.followers)</span><br><span class="line">  @JoinTable()</span><br><span class="line">  follows: StarEntity[]; 注意这里是数组类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明星表：followers跟随者</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Entity, PrimaryGeneratedColumn, Column, ManyToMany &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./user.entity'</span>;</span><br><span class="line"></span><br><span class="line">@Entity(&#123; <span class="attr">name</span>: <span class="string">'star'</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">StarEntity</span> </span>&#123;</span><br><span class="line">  @PrimaryGeneratedColumn()</span><br><span class="line">  id: number;</span><br><span class="line"></span><br><span class="line">  @Column(&#123; <span class="attr">type</span>: <span class="string">'varchar'</span> &#125;)</span><br><span class="line">  name: string;</span><br><span class="line"></span><br><span class="line">  @ManyToMany(<span class="function"><span class="params">()</span> =&gt;</span> UsersEntity, (user) =&gt; user.follows)</span><br><span class="line">  followers: UsersEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<blockquote>
<p>程序运行后，将会默认在数据库中生成三张表，users，star，users_follows_star，users_follows_star是中间表，用于记录users和star之间的多对多关系，它是自动生成的。</p>
</blockquote>
<p>为了测试方便，你可以在users表和star表创建一些数据：这些属于单表操作<br><img src="https://s.poetries.work/uploads/2022/05/f9afb65f660699e8.png" alt></p>
<h3 id="多对多增删改查"><a href="#多对多增删改查" class="headerlink" title="多对多增删改查"></a><strong>多对多增删改查</strong></h3><blockquote>
<p>只要涉及两种表操作的，就需要开启事务：同时失败或同时成功，避免数据不统一<br>注意：所有数据应该是由前端传递过来的，这里为了方便，直接硬编码了（写死）</p>
</blockquote>
<p>user.controller.ts</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Post,</span><br><span class="line">  Body,</span><br><span class="line">  Patch,</span><br><span class="line">  Query,</span><br><span class="line">  Param,</span><br><span class="line">  Delete,</span><br><span class="line">  HttpCode,</span><br><span class="line">  HttpStatus,</span><br><span class="line">  ParseIntPipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Transaction, TransactionManager, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;  开启事务第一步：引入</span><br><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">'./user.service-oto'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private readonly userService: UserService) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  @Get()</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="keyword">const</span> [data, count] = <span class="keyword">await</span> <span class="keyword">this</span>.userService.findAll();</span><br><span class="line">    <span class="keyword">return</span> &#123; count, data &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">':id'</span>)</span><br><span class="line">  <span class="keyword">async</span> findOne(@Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.findOne(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">':id'</span>)</span><br><span class="line">  @HttpCode(HttpStatus.OK)</span><br><span class="line">  @Transaction() 开启事务第二步：装饰接口</span><br><span class="line">  <span class="keyword">async</span> create(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,  开启事务第三步：获取事务管理器</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.create(id, maneger);  开启事务第四步：传递给service，使用数据库时调用</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Patch(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> update(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.update(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Delete(<span class="string">':id'</span>)</span><br><span class="line">  @Transaction()</span><br><span class="line">  <span class="keyword">async</span> remove(</span><br><span class="line">    @Param(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: number,</span><br><span class="line">    @TransactionManager() maneger: EntityManager,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.userService.remove(id, maneger);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>user.service.ts</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository, EntityManager &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StarEntity &#125; <span class="keyword">from</span> <span class="string">'./entities/star.entity'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    @InjectRepository(StarEntity)</span><br><span class="line">    private readonly starRepository: Repository&lt;StarEntity&gt;,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  一对多增删改查</span><br><span class="line">  <span class="keyword">async</span> findAll() &#123;</span><br><span class="line">    <span class="comment">// return await this.usersRepository.findAndCount(&#123; relations: ['follows'] &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository</span><br><span class="line">      .createQueryBuilder(<span class="string">'UsersEntity'</span>)</span><br><span class="line">      .leftJoinAndSelect(<span class="string">'UsersEntity.follows'</span>, <span class="string">'StarEntity.followers'</span>)</span><br><span class="line">      .getManyAndCount();</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id查找多对多</span><br><span class="line">  <span class="keyword">async</span> findOne(id: number) &#123;</span><br><span class="line">    查询一个用户关注了哪些明星</span><br><span class="line">    <span class="comment">// const result = await this.usersRepository.findOne(id, &#123;</span></span><br><span class="line">    <span class="comment">//   relations: ['follows'],</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// if (!result) ToolsService.fail('用户id不存在');</span></span><br><span class="line">    <span class="comment">// return result;</span></span><br><span class="line"></span><br><span class="line">    查询一个明星有多少粉丝</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.starRepository.findOne(id, &#123;</span><br><span class="line">      relations: [<span class="string">'followers'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!result) ToolsService.fail(<span class="string">'明星id不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id创建多对多</span><br><span class="line">  粉丝关注明星</span><br><span class="line">  <span class="keyword">async</span> create(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">  	要关注的明星id数组</span><br><span class="line">    <span class="keyword">const</span> willFollow = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (willFollow.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> followList = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; willFollow.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> star = <span class="keyword">await</span> manager.findOne(StarEntity, &#123;</span><br><span class="line">          id: willFollow[i],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!star) ToolsService.fail(<span class="string">'主播id不存在'</span>);</span><br><span class="line">        followList.push(star);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> userEntity = <span class="keyword">new</span> UsersEntity();</span><br><span class="line">      重点：</span><br><span class="line">      不指定id是创建新的用户，还需要填写username和password等必填的字段</span><br><span class="line">      指定id就是更新某些字段：只关注明星，不创建新的用户，同样可用于修改</span><br><span class="line">      userEntity.id = id; </span><br><span class="line">      userEntity.follows = followList; 建立关联，数据表会自动更新</span><br><span class="line">      <span class="keyword">await</span> manager.save(userEntity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'新增成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id更改多对多</span><br><span class="line">  假设：某用户关注了id为[<span class="number">3</span>, <span class="number">4</span>]的明星, 现在修改为只关注[<span class="number">2</span>]</span><br><span class="line">  逻辑和创建一样</span><br><span class="line">  <span class="keyword">async</span> update(id: number, <span class="attr">manager</span>: EntityManager) &#123;</span><br><span class="line">    <span class="keyword">const</span> willFollow = [<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (willFollow.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> followList = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; willFollow.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> listOne = <span class="keyword">await</span> manager.findOne(StarEntity, &#123;</span><br><span class="line">          id: willFollow[i],</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!listOne) ToolsService.fail(<span class="string">'主播id不存在'</span>);</span><br><span class="line">        followList.push(listOne);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> userEntity = <span class="keyword">new</span> UsersEntity();</span><br><span class="line">      userEntity.id = id;</span><br><span class="line">      userEntity.follows = followList;</span><br><span class="line">      <span class="keyword">await</span> manager.save(userEntity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'更新成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  根据主表id删除多对多</span><br><span class="line">  多种删除</span><br><span class="line">  <span class="keyword">async</span> remove(id: number, <span class="attr">manager</span>: EntityManager): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(id, &#123;</span><br><span class="line">      relations: [<span class="string">'follows'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户id不存在'</span>);</span><br><span class="line"></span><br><span class="line">    根据id删除一个：取消关注某个明星，明星id应由前端传递过来，这里写死</span><br><span class="line">    需要获取当前用户的的follows，使用关系查询</span><br><span class="line">    <span class="keyword">const</span> willDeleteId = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (user.follows.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      过滤掉要删除的数据，再重新赋值</span><br><span class="line">      <span class="keyword">const</span> followList = user.follows.filter(<span class="function">(<span class="params">star</span>) =&gt;</span> star.id != willDeleteId);</span><br><span class="line">      <span class="keyword">const</span> userEntity = <span class="keyword">new</span> UsersEntity();</span><br><span class="line">      userEntity.id = id;</span><br><span class="line">      userEntity.follows = followList;</span><br><span class="line">      <span class="keyword">await</span> manager.save(userEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    全部删除关联数据，不删用户</span><br><span class="line">    <span class="comment">// const userEntity = new UsersEntity();</span></span><br><span class="line">    <span class="comment">// userEntity.id = id;</span></span><br><span class="line">    <span class="comment">// userEntity.follows = [];</span></span><br><span class="line">    <span class="comment">// await manager.save(userEntity);</span></span><br><span class="line"></span><br><span class="line">    如果连用户一起删，会将关联数据一起删除</span><br><span class="line">    <span class="comment">// await manager.delete(UsersEntity, id);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'删除成功'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nest连接Redis"><a href="#nest连接Redis" class="headerlink" title="nest连接Redis"></a>nest连接Redis</h2><blockquote>
<p>Redis 字符串数据类型的相关命令用于管理 redis 字符串值</p>
</blockquote>
<ul>
<li>查看所有的key:  <code>keys *</code></li>
<li>普通设置： <code>set key value</code></li>
<li>设置并加过期时间：<code>set key value EX 30</code> 表示30秒后过期</li>
<li>获取数据： <code>get key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
<li>查看类型：<code>type key</code></li>
<li>设置过期时间: <code>expire key  20</code> 表示指定的<code>key5</code>秒后过期</li>
</ul>
<blockquote>
<p>Redis列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）</p>
</blockquote>
<ul>
<li>列表右侧增加值：<code>rpush key value</code></li>
<li>列表左侧增加值：<code>lpush key value</code></li>
<li>右侧删除值：<code>rpop key</code></li>
<li>左侧删除值： <code>lpop key</code></li>
<li>获取数据： <code>lrange key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据: <code>flushall</code></li>
<li>查看类型： <code>type key</code></li>
</ul>
<blockquote>
<p>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。它和列表的最主要区别就是没法增加重复值</p>
</blockquote>
<ul>
<li>给集合增数据：<code>sadd key value</code></li>
<li>删除集合中的一个值：<code>srem key value</code></li>
<li>获取数据：<code>smembers key</code></li>
<li>删除指定数据： <code>del key</code></li>
<li>删除全部数据:  <code>flushall</code></li>
</ul>
<blockquote>
<p>Redis hash 是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
</blockquote>
<ul>
<li>设置值hmset ：<code>hmset zhangsan name &quot;张三&quot; age 20  sex “男”</code></li>
<li>设置值hset ： <code>hset zhangsan name &quot;张三&quot;</code></li>
<li>获取数据：<code>hgetall key</code></li>
<li>删除指定数据：<code>del key</code></li>
<li>删除全部数据:  <code>flushall</code></li>
</ul>
<blockquote>
<p>Redis 发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 发布</span></span><br><span class="line">client.publish(<span class="string">'publish'</span>, <span class="string">'message from publish.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅</span></span><br><span class="line">client.subscribe(<span class="string">'publish'</span>);</span><br><span class="line">client.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel, msg</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'client.on message, channel:'</span>, channel, <span class="string">' message:'</span>, msg);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Nestjs中使用redis</strong></p>
<blockquote>
<p>Nestjs Redis 官方文档：<a href="https://github.com/kyknow/nestjs-redis" target="_blank" rel="noopener">https://github.com/kyknow/nestjs-redis</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install nestjs-redis --save</span><br></pre></td></tr></table></figure>
<p>如果是nest8需要注意该问题：<a href="https://github.com/skunight/nestjs-redis/issues/82" target="_blank" rel="noopener">https://github.com/skunight/nestjs-redis/issues/82</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.modules.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; RedisModule &#125; <span class="keyword">from</span> <span class="string">'nestjs-redis'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RedisTestModule &#125; <span class="keyword">from</span> <span class="string">'../examples/redis-test/redis-test.module'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    <span class="comment">// 加载配置文件目录</span></span><br><span class="line">    ConfigModule.load(resolve(__dirname, <span class="string">'config'</span>, <span class="string">'**/!(*.d).&#123;ts,js&#125;'</span>)),</span><br><span class="line">    <span class="comment">// redis连接</span></span><br><span class="line">    RedisModule.forRootAsync(&#123;</span><br><span class="line">      useFactory: <span class="function">(<span class="params">configService: ConfigService</span>) =&gt;</span> configService.get(<span class="string">'redis'</span>),</span><br><span class="line">      inject: [ConfigService],</span><br><span class="line">    &#125;),</span><br><span class="line">    RedisTestModule,</span><br><span class="line">  ],</span><br><span class="line">  controllers: [],</span><br><span class="line">  providers: [ ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/config/redis.ts 配置</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  port: <span class="number">6379</span>,</span><br><span class="line">  db: <span class="number">0</span>,</span><br><span class="line">  password: <span class="string">''</span>,</span><br><span class="line">  keyPrefix: <span class="string">''</span>,</span><br><span class="line">  onClientReady: <span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">    client.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'-----redis error-----'</span>, err);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>创建一个cache.service.ts 服务 封装操作redis的方法</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/common/cache.service.ts </span></span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RedisService &#125; <span class="keyword">from</span> <span class="string">'nestjs-redis'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheService</span> </span>&#123;</span><br><span class="line">  public client;</span><br><span class="line">  <span class="keyword">constructor</span>(private redisService: RedisService) &#123;</span><br><span class="line">    <span class="keyword">this</span>.getClient();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> getClient() &#123;</span><br><span class="line">    <span class="keyword">this</span>.client = <span class="keyword">await</span> <span class="keyword">this</span>.redisService.getClient();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//设置值的方法</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">set</span>(key: string, value: any, seconds?: number) &#123;</span><br><span class="line">    value = <span class="built_in">JSON</span>.stringify(value);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.client) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.getClient();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!seconds) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.client.set(key, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.client.set(key, value, <span class="string">'EX'</span>, seconds);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取值的方法</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">get</span>(key: string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.client) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.getClient();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.client.get(key);</span><br><span class="line">    <span class="keyword">if</span> (!data) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据key删除redis缓存数据</span></span><br><span class="line">  <span class="keyword">async</span> del(key: string): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.client) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.getClient();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.client.del(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空redis的缓存</span></span><br><span class="line">  <span class="keyword">async</span> flushall(): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.client) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">this</span>.getClient();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.client.flushall();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用redis服务</p>
</blockquote>
<p><strong>redis-test.controller</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CacheService &#125; <span class="keyword">from</span> <span class="string">'src/common/cache/redis.service'</span>;</span><br><span class="line"></span><br><span class="line">@Controller(<span class="string">'redis-test'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTestController</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注入redis服务</span></span><br><span class="line">  <span class="keyword">constructor</span>(private readonly cacheService: CacheService) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'get'</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">get</span>(@Query() query) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.cacheService.get(query.key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Post(<span class="string">'set'</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">set</span>(@Body() body) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; key, ...params &#125; = body <span class="keyword">as</span> any;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.cacheService.set(key, params);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'del'</span>)</span><br><span class="line">  <span class="keyword">async</span> del(@Query() query) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.cacheService.del(query.key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Get(<span class="string">'delAll'</span>)</span><br><span class="line">  <span class="keyword">async</span> delAll() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.cacheService.flushall();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>redis-test.module.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RedisTestService &#125; <span class="keyword">from</span> <span class="string">'./redis-test.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RedisTestController &#125; <span class="keyword">from</span> <span class="string">'./redis-test.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CacheService &#125; <span class="keyword">from</span> <span class="string">'src/common/cache/redis.service'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  controllers: [RedisTestController],</span><br><span class="line">  providers: [RedisTestService, CacheService], <span class="comment">// 注入redis服务</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTestModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>redis-test.service.ts</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTestService</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="集成redis实现单点登录"><a href="#集成redis实现单点登录" class="headerlink" title="集成redis实现单点登录"></a>集成redis实现单点登录</h2><p><strong>在要使用的controller或service中使用redis</strong></p>
<ul>
<li><p>这里以实现<code>token</code>存储在<code>redis</code>为例子，实现<strong>单点登陆</strong></p>
</li>
<li><p>需要在<code>passport</code>的<code>login</code>中，存储<code>token</code>，如果不会<code>passport</code>验证</p>
</li>
</ul>
<p><strong>单点登陆原理</strong></p>
<blockquote>
<ul>
<li><p>一个账户在第一个地方登陆，登陆时，JWT生成token，保存token到redis，同时返回token给前端保存到本地</p>
</li>
<li><p>同一账户在第二个地方登陆，登陆时，JWT生成新的token，保存新的token到redis。（token已经改变）<br>此时，第一个地方登陆的账户在请求时，使用的本地token就会和redis里面的新token不一致（注意：都是有效的token）</p>
</li>
</ul>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; InjectRepository &#125; <span class="keyword">from</span> <span class="string">'@nestjs/typeorm'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; compareSync, hashSync &#125; <span class="keyword">from</span> <span class="string">'bcryptjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UsersEntity &#125; <span class="keyword">from</span> <span class="string">'../user/entities/user.entity'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateUserDto &#125; <span class="keyword">from</span> <span class="string">'../user/dto/create-user.dto'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CacheService &#125; <span class="keyword">from</span> <span class="string">'../../common/db/redis-ceche.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    @InjectRepository(UsersEntity)</span><br><span class="line">    private readonly usersRepository: Repository&lt;UsersEntity&gt;,</span><br><span class="line">    private readonly jwtService: JwtService,</span><br><span class="line">    private readonly redisService: CacheService,</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create(user: CreateUserDto) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; username, password &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> transformPass = hashSync(password);</span><br><span class="line">    user.password = transformPass;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123; username &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result) ToolsService.fail(<span class="string">'用户名已存在'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.insert(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validateUser(userinfo): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; username, password &#125; = userinfo;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersRepository.findOne(&#123;</span><br><span class="line">      where: &#123; username &#125;,</span><br><span class="line">      select: [<span class="string">'username'</span>, <span class="string">'password'</span>, <span class="string">'id'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) ToolsService.fail(<span class="string">'用户名或密码不正确'</span>);</span><br><span class="line">    <span class="comment">//使用bcryptjs验证密码</span></span><br><span class="line">    <span class="keyword">if</span> (!compareSync(password, user.password)) &#123;</span><br><span class="line">      ToolsService.fail(<span class="string">'用户名或密码不正确'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> login(user: any): <span class="built_in">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, username &#125; = user;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123; id, username &#125;;</span><br><span class="line">    <span class="keyword">const</span> access_token = <span class="keyword">this</span>.jwtService.sign(payload);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.redisService.set(<span class="string">`user-token-<span class="subst">$&#123;id&#125;</span>`</span>, access_token, <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);  在这里使用redis</span><br><span class="line">    <span class="keyword">return</span> access_token;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/05/f134cb6419f34607.png" alt></p>
<p><strong>验证token</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Strategy, ExtractJwt, StrategyOptions &#125; <span class="keyword">from</span> <span class="string">'passport-jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">'./constants'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CacheService &#125; <span class="keyword">from</span> <span class="string">'../../common/db/redis-ceche.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request &#125; <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToolsService &#125; <span class="keyword">from</span> <span class="string">'../../utils/tools.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtStrategy</span> <span class="keyword">extends</span> <span class="title">PassportStrategy</span>(<span class="title">Strategy</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private redisService: CacheService) &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      jwtFromRequest: ExtractJwt.fromHeader(<span class="string">'token'</span>), <span class="comment">//使用ExtractJwt.fromHeader从header获取token</span></span><br><span class="line">      ignoreExpiration: <span class="literal">false</span>, <span class="comment">//如果为true，则不验证令牌的过期时间。</span></span><br><span class="line">      secretOrKey: jwtConstants.secret, <span class="comment">//使用密钥解析，可以使用process.env.xxx</span></span><br><span class="line">      passReqToCallback: <span class="literal">true</span>,</span><br><span class="line">    &#125; <span class="keyword">as</span> StrategyOptions);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//token验证, payload是super中已经解析好的token信息</span></span><br><span class="line">  <span class="keyword">async</span> validate(req: Request, <span class="attr">payload</span>: any) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'payload'</span>, payload);</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = payload;</span><br><span class="line">    <span class="keyword">const</span> token = ExtractJwt.fromHeader(<span class="string">'token'</span>)(req);</span><br><span class="line">    <span class="keyword">const</span> cacheToken = <span class="keyword">await</span> <span class="keyword">this</span>.redisService.get(<span class="string">`user-token-<span class="subst">$&#123;id&#125;</span>`</span>);  获取redis的key</span><br><span class="line"></span><br><span class="line">    <span class="comment">//单点登陆验证</span></span><br><span class="line">    <span class="keyword">if</span> (token !== <span class="built_in">JSON</span>.parse(cacheToken)) &#123;</span><br><span class="line">      ToolsService.fail(<span class="string">'您账户已经在另一处登陆，请重新登陆'</span>, <span class="number">401</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">username</span>: payload.username &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><h3 id="Q：nestJS注入其他依赖时为什么还需要导入其module"><a href="#Q：nestJS注入其他依赖时为什么还需要导入其module" class="headerlink" title="Q：nestJS注入其他依赖时为什么还需要导入其module"></a>Q：nestJS注入其他依赖时为什么还需要导入其module</h3><blockquote>
<p>A模块的Service需要调用B模块的service中一个方法，则需要在A的Service导入B的service<br>场景如下：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A.Service</span></span><br><span class="line"><span class="keyword">import</span> &#123; BService &#125; <span class="keyword">from</span> <span class="string">'../B/B.service'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    private readonly _BService: BService,</span><br><span class="line">  ) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我的理解</p>
<ul>
<li>在此处@Injectable装饰器已经将B的Service类实例化了，</li>
<li>已经可以使用B的类方法了。</li>
<li>但为什么还需要在A的module.ts中导入B模块呢？像是这样:</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; BModule &#125; <span class="keyword">from</span> <span class="string">'../B/B.module'</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">  imports: [BModule],</span><br><span class="line">  controllers: [AController],</span><br><span class="line">  providers: [AService],</span><br><span class="line">  exports: [AService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong></p>
<p>为啥”为什么还需要在A的module.ts中导入B模块呢”？</p>
<p>因为 <code>BService</code>的作用域只在 <code>BModule</code>里，所以你要在 <code>AController</code>里直接用，就会报错拿不到实例。</p>
<p>再来说，”有什么办法可以让 <code>BService</code>随处直接用么？”，参考如下手段：</p>
<p>B 的module 声明时，加上<code>@Global</code>，如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module, Global &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BService &#125; <span class="keyword">from</span> <span class="string">'./B.service'</span>;</span><br><span class="line"></span><br><span class="line">@Global()</span><br><span class="line">@Module(&#123;</span><br><span class="line">  providers: [BService],</span><br><span class="line">  exports: [BService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">BModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这样，你就不用在 <code>AModule</code>的声明里引入 <code>BModule</code>了。</p>
<p>关于『你的理解』部分，貌似你把<code>@Inject</code> 和 <code>@Injectable</code> 搞混了，建议再读一读这个部分的文档，多做些练习/尝试，自己感受下每个api的特点。</p>
<p>最后，官网文档里其实有介绍 ，看<code>依赖注入</code>:<a href="https://docs.nestjs.com/modules#dependency-injection" target="_blank" rel="noopener">https://docs.nestjs.com/modules#dependency-injection</a></p>

      </div>
    
  </div>

</article>

<!-- <button class="assist-btn2 circle" id="assist_btn2" title="点亮屏幕" style="left: 27px; top: 152px;">
  <i class="iconfont" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button>
<button class="assist-btn1 circle" id="assist_btn1" title="关闭屏幕亮度" style="left: 27px; top: 152px;">
  <i class="iconfont toc-title" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button> -->


<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>	

<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
  function getCookie(key) {
    if (document.cookie.length > 0) {
      var start = document.cookie.indexOf(key + "=");
      if (start !== -1) {
        start = start + key.length + 1;
        var end = document.cookie.indexOf(";", start);
        if (end === -1) end = document.cookie.length;
        return unescape(document.cookie.substring(start, end));
      }
    }
    return "";
  }
  const feToken = getCookie('fe-token');
  const btw = new BTWPlugin();
  console.log('ft', feToken)
  if(!feToken) {
    btw.init({
      id: "container",
      blogId: "22699-1592137983091-414",
      name: "前端进阶之旅",
      qrcode: "https://poetries1.gitee.io/img-repo/2020/06/qrcode.jpg",
      keyword: "3a3b3c",
    });
  }
</script>

<script type="text/javascript">

// white theme
var body = {color: "#555", background: "#000"};
var a_tag = {color: "#222"};
var header = { background: "#222"};
var logo_line_i = {background: "#222"};
// var post_code = {background: "#eee", color: "#222"};

function switch_theme() {
 $("body").css(body);
 $("a:not('.links-of-author-item a, .site-state-item a, .site-state-posts a, .feed-link a, .motion-element a, .post-tags a, .show-commit-cls a, #donate_board a')").css(a_tag);
 $(".header, .footer").css(header);
 $(".logo-line-before i, .logo-line-after i").css(logo_line_i);
 //$(".post code").css(post_code);
 $("#idhyt-surprise-ball #idhyt-surprise-ball-animation .drag").css(a_tag);
 $(".post-title-link, .posts-expand .post-meta, .post-comments-count, .disqus-comment-count, .post-category a, .post-nav-next a, .post-nav-item a").css(a_tag);
 
 // $("code").css({color: '#c5c8c6', background: '#1d1f21'});
 //$("#assist_btn1").hide(1500);
}

$(function () {
$("#assist_btn2").css("display","none");
 $("#assist_btn1").click(function() {
     switch_theme();
$("div#toc.toc-article").css({
 "background":"#eaeaea",
 "opacity":1
});
$(".toc-article ol").show();
$("#toc.toc-article .toc-title").css("color","#a98602");
$("#assist_btn1").css("display","none");
$("#assist_btn2").css("display","block");
 });
$("#assist_btn2").click(function() {
$("#assist_btn2").css("display","none");
$("#assist_btn1").css("display","block");
$("body").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
     $(".header, .footer").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
$(".toc-article ol").toggle(1000);
 });
});


//背景随机

var Y, O, E, L, B, C, T, z, N, S, A, I;
!function() {
var e = function() {
for (O.clearRect(0, 0, L, B), T = [{
x: 0,
y: .7 * B + C
}, {
x: 0,
y: .7 * B - C
}]; T[1].x < L + C;) t(T[0], T[1])
}, t = function(e, t) {
O.beginPath(), O.moveTo(e.x, e.y), O.lineTo(t.x, t.y);
var n = t.x + (2 * I() - .25) * C,
 r = a(t.y);
O.lineTo(n, r), O.closePath(), N -= S / -50, O.fillStyle = "#" + (127 * A(N) + 128 << 16 | 127 * A(N + S / 3) + 128 << 8 | 127 * A(N + S / 3 * 2) + 128).toString(16), O.fill(), T[0] = T[1], T[1] = {
 x: n,
 y: r
}
}, a = function n(e) {
var t = e + (2 * I() - 1.1) * C;
return t > B || t < 0 ? n(e) : t
};
Y = document.getElementById("evanyou"), O = Y.getContext("2d"), E = window.devicePixelRatio || 1, L = window.innerWidth, B = window.innerHeight, C = 90, z = Math, N = 0, S = 2 * z.PI, A = z.cos, I = z.random, Y.width = L * E, Y.height = B * E, O.scale(E, E), O.globalAlpha = .6, document.onclick = e, document.ontouchstart = e, e()
}()

   
$("#toc-eye").click(function(){
$("#toc.toc-article").toggle(1000);
});

</script>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持poetries</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/weixin.jpg" alt="">
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/zhifubao.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2022/02/16/node-fs-youhua/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2022/06/17/egg-deploy-summary/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/categories/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tags/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '5567a2c4abb858009d96',
  clientSecret: 'b9039ec056cf5c2346b3cdb63308a28c163f91e5',
  repo: 'poetries.github.io',
  owner: 'poetries',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: location.pathname,
  admin: ['poetries'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
 
  
</body>
</html>
