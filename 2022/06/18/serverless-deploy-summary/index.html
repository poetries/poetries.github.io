<!DOCTYPE html>


  <html class="dark page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>serverless部署前后端项目实践 | 前端进阶之旅</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="部署,serverless,">
  

  <meta name="description" content="一、serverless架构介绍及安装serverless Serverless又名无服务器,所谓无服务器并非是说不需要依赖和依靠服务器等资源,而是开发者再也不用过多考虑服务器的问题,可以更专注在产品代码上。 Serverless是一种软件系统架构的思想和方法，它不是软件框架、类库或者工具。它与传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于无状态(Stateless)、 暂存(可能只">
<meta name="keywords" content="部署,serverless">
<meta property="og:type" content="article">
<meta property="og:title" content="serverless部署前后端项目实践">
<meta property="og:url" content="http://blog.poetries.top/2022/06/18/serverless-deploy-summary/index.html">
<meta property="og:site_name" content="前端进阶之旅">
<meta property="og:description" content="一、serverless架构介绍及安装serverless Serverless又名无服务器,所谓无服务器并非是说不需要依赖和依靠服务器等资源,而是开发者再也不用过多考虑服务器的问题,可以更专注在产品代码上。 Serverless是一种软件系统架构的思想和方法，它不是软件框架、类库或者工具。它与传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于无状态(Stateless)、 暂存(可能只">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/f328901c0adb56de.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/bcc852ef2bc8fbd7.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/44fa5d83bc09c564.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/a6ac5a7905e6f81c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/3d5b8a8b53bd5315.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/4f400ccd6d34b420.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/e445b52f9d9a9958.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/1aa3208070a48915.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c50918e799e3068b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/9c63657e6a3dadb2.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c7c5fe6b663fbe4f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/750e45e4a038a162.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/d0ace73fab7e28ba.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/527e0cfb402fa738.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/bb939fc00c99aa5a.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/18c3d872701f1cfc.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/0b0cf6ae03f9277b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/66d614b9bba52dbf.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/d5010c1e04560057.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/9e081856b313fc45.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/a7b44ad3928be60f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/9e2f3c3bc5832035.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/f497c782f6070744.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/99f7dc28e086be60.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/dd99f3d6323b8e15.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/894bd8fb7cee9aa8.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6ea1e2875196d30e.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/535aa49e41c50789.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/e5f68c50a4296d47.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/228c4a131acdb03c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/fbf0b03c839cd73e.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/58b123659a00b194.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/c4c3e330b1a6af68.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/85b3d73ea922f0ea.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/a96ce1c3799f5951.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/ce48d9dd73af824f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/9a0e3dfa25a6ed3d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/e9dd1225bf0d37cd.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/ca238c35541dd8df.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/4ab13bbb74bcdf89.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/8e11d14d715ba443.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/9d3580eef444d80f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6d5fd5ba537850dd.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/1ac3905f67789812.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/715ea0e1c4d12298.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/a3921110151f0ba3.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/f91266106e6e1d78.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/2117adef0814c390.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/d47f6e73f93d5055.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/9ad37b26fbab516d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/14c5cc6d18060612.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/369867cf3dc9a1e1.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/3cdd7bf1c596d876.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/9db881d3d57a0c59.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/7e5abeb49a56f460.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/d10f5ea7b0cac331.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/683f6152002db3a9.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6495e575646c3035.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/740312afd66bc342.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/f5d5c8b90fdf942c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6683161cf18fc51c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/88d1098b222f184b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/b5b0c69b6962434d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/4bb68977c923970f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/b6d50b9d2070559c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/fecba16d7e2071eb.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/08a0618ffe147378.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/e6454fd010815c3f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/50bcc5c01f3af862.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/fd6229e7d654a470.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/53fa2c373a8a69cd.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/c05fcae4ea2a8593.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/c23d3219be7ab860.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/60f6e95248310f40.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/12736ad9dda9b911.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/9a96d63935762fc3.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/c1fe93fe050d5f5c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/15d73875b2f56fd4.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/903af650eb01b169.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/a47a05e9bd8eb7c9.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/68b296819ee39d4f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/1c33faad7da0be9c.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/b1a9175c8c6d1404.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6382481121ebc584.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6ab832e2d0343c64.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6be48886a199d8df.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/dd5fd8c12cb5d46a.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/f4edaeba5e1bd1f2.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/92152ad6865809d8.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/74ac915db74d3dd6.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/34fceabfeb33c9e9.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/4dcbaf2dbb72cef4.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/80ed7651618d4bd1.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/22914c1b39955760.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/84f4b895e0ef3e1a.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/8614efb6787a455f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/4048c87e395ebe98.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/6aa33661c29780c8.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/a226acca0bb48bed.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/3e7f22a3df08fa4b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/f150204a59359b6d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/1063776f916665ad.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/a32767996808f68f.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/ca2c192149944c02.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/fb6f3d7a624a73f6.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/968044649cbdbfee.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/e7285b3cba07f7bf.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c31cd4d7d163bb89.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/1d3382cca02d0f05.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/e848fe3eabb20b49.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/e5dfce33f28ac2f0.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/765e9fdf679b9661.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/794bc6fe87c43f55.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/bc6c668125921773.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/0ec0d7030a1a171a.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/be2ad63b73cd90cb.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/4d25248bad953017.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/280e12f1381ad19b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/3bf2e7588ef4db51.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/88f6da606016085b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/81895e9b9ae7dac9.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/ada2715770b68f92.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/cdc6c87499019a46.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/cfdd4a0e3e82ee18.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/1da43f40efc683d6.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/5a8d14fb5d7417c0.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/396be7b44eb9dd81.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/0fc384f78966e294.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/d959441445eecfb5.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/7c53c0ead5e166f7.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/fa2e097f55e8460b.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/9f4acfb1d41d15ec.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/cbc5cd59595597bc.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c2dc26b03c9b36be.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c0bd93006ea724cd.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/c7ecd5414acc9881.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/565fff50504ea193.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/07/08646a66aeb4c8fb.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/c70fc14a6975b58d.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/bf28a299163edd25.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/73dd2079f12bc9e2.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/2fd1b2033733a2f9.png">
<meta property="og:image" content="https://s.poetries.work/uploads/2022/06/a75c8ba81b1830ac.png">
<meta property="og:updated_time" content="2025-03-30T13:54:29.500Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="serverless部署前后端项目实践">
<meta name="twitter:description" content="一、serverless架构介绍及安装serverless Serverless又名无服务器,所谓无服务器并非是说不需要依赖和依靠服务器等资源,而是开发者再也不用过多考虑服务器的问题,可以更专注在产品代码上。 Serverless是一种软件系统架构的思想和方法，它不是软件框架、类库或者工具。它与传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于无状态(Stateless)、 暂存(可能只">
<meta name="twitter:image" content="https://s.poetries.work/uploads/2022/06/f328901c0adb56de.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">
<link href="/css/other.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5081f3afc8d94338e79d319c8b632b31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  <!-- 聊天系统 -->
  
    
   <link type="text/css" rel="stylesheet" href="/renxi/default.css">
   <style>
      #modal {
        position: static !important;
      }
      .filter {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: #fe5757;
        animation: colorChange 30s ease-in-out infinite;
        animation-fill-mode: both;
        mix-blend-mode: overlay;
      }
  
      @keyframes colorChange {
        0%, 100% {
            opacity: 0;
        }
        50% {
            opacity: .9;
        }
      }
   </style>
</head>
</html>
<body>
  
  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/categories/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tags/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录<i class="iconfont toc-title" style="display:inline-block;color:#87998d;width:20px;height:20px;">&#xf004b;</i></strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、serverless架构介绍及安装serverless"><span class="toc-text">一、serverless架构介绍及安装serverless</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-传统的开发模式与serverless开发模式对比"><span class="toc-text">1.1 传统的开发模式与serverless开发模式对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Serverless-和-ServerFul-架构的区别"><span class="toc-text">1.2 Serverless 和 ServerFul 架构的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#传统的-ServerFul-架构模式"><span class="toc-text">传统的 ServerFul 架构模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-架构模式"><span class="toc-text">Serverless 架构模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-使用serverless的优势"><span class="toc-text">1.3 使用serverless的优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Serverless-组成"><span class="toc-text">1.4 Serverless 组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-Serverless-开发流程"><span class="toc-text">1.5 Serverless 开发流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-为什么要学-Serverless"><span class="toc-text">1.6 为什么要学 Serverless</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7-Serverless-的能力"><span class="toc-text">1.7 Serverless 的能力</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#计算能力"><span class="toc-text">计算能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统运维能力"><span class="toc-text">系统运维能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#业务运维能力"><span class="toc-text">业务运维能力</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-8-serverless厂家"><span class="toc-text">1.8 serverless厂家</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-9-云函数和serverless的区别"><span class="toc-text">1.9 云函数和serverless的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-20-创建serverless的方式"><span class="toc-text">1.20 创建serverless的方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、serverless-脚手架安装、WebIDE中创建、vscode中配置"><span class="toc-text">二、serverless 脚手架安装、WebIDE中创建、vscode中配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-脚手架安装-三分钟部署一个项目"><span class="toc-text">2.1 脚手架安装-三分钟部署一个项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-在vscode中配置插件来开发serverless"><span class="toc-text">2.2 在vscode中配置插件来开发serverless</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-WebIDE创建云函数实践"><span class="toc-text">2.3 WebIDE创建云函数实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、Serverless-Framework部署项目实战"><span class="toc-text">三、Serverless Framework部署项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Serverless-Framework简介及应用场景"><span class="toc-text">3.1 Serverless Framework简介及应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-Framework-应用场景"><span class="toc-text">Serverless Framework 应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-Framework-支持的平台"><span class="toc-text">Serverless Framework 支持的平台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Serverless-Components-支持组件列表"><span class="toc-text">3.2 Serverless Components 支持组件列表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础组件"><span class="toc-text">基础组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高阶组件"><span class="toc-text">高阶组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-sls部署egg项目"><span class="toc-text">3.3 sls部署egg项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#控制台创建部署-模板部署"><span class="toc-text">控制台创建部署-模板部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制台创建部署-自定义部署-推荐"><span class="toc-text">控制台创建部署-自定义部署(推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-组件方式部署-推荐"><span class="toc-text">HTTP 组件方式部署(推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Layer-来减小项目文件大小"><span class="toc-text">使用Layer 来减小项目文件大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用serverless-fromwork的高阶egg组件方式部署-不推荐"><span class="toc-text">使用serverless fromwork的高阶egg组件方式部署(不推荐)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-sls部署nestjs项目"><span class="toc-text">3.4 sls部署nestjs项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#模板部署-–-部署-Nest-js-示例代码"><span class="toc-text">模板部署 – 部署 Nest.js 示例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义模板部署nest-推荐"><span class="toc-text">自定义模板部署nest(推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用http组件-推荐"><span class="toc-text">使用http组件(推荐)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Layer-来减小项目文件大小-1"><span class="toc-text">使用Layer 来减小项目文件大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用serverless-framework的高阶nestjs组件部署-不推荐"><span class="toc-text">使用serverless framework的高阶nestjs组件部署(不推荐)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-sls部署koa项目"><span class="toc-text">3.5 sls部署koa项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#控制台部署"><span class="toc-text">控制台部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义模板部署"><span class="toc-text">自定义模板部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用HTTP组件部署"><span class="toc-text">使用HTTP组件部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、部署静态网站"><span class="toc-text">四、部署静态网站</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-sls部署vue项目"><span class="toc-text">4.1 sls部署vue项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-sls部署react项目"><span class="toc-text">4.2 sls部署react项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-sls部署vuepress项目"><span class="toc-text">4.3 sls部署vuepress项目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、综合实战"><span class="toc-text">五、综合实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络"><span class="toc-text">5.1 Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#云函数接入数据库"><span class="toc-text">云函数接入数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-Serverless-中操作-Mysql"><span class="toc-text">Nodejs Serverless 中操作 Mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-Serverless-中操作-Mongodb"><span class="toc-text">Nodejs Serverless 中操作 Mongodb</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Serverless-BaaS-对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中"><span class="toc-text">5.2 Serverless BaaS 对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#对象云存储-Cos-介绍"><span class="toc-text">对象云存储 Cos 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-操作-Cos"><span class="toc-text">Nodejs 操作 Cos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Express-在-Serverless-中实现图片上传到-Cos-中"><span class="toc-text">Express 在 Serverless 中实现图片上传到 Cos 中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-Serverless、Cos中配置域名访问以及Serverless中配置https访问"><span class="toc-text">5.3 Serverless、Cos中配置域名访问以及Serverless中配置https访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-中配置域名访问"><span class="toc-text">Serverless 中配置域名访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-中配置-https-访问"><span class="toc-text">Serverless 中配置 https 访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cos-中配置域名"><span class="toc-text">Cos 中配置域名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六、QA"><span class="toc-text">六、QA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#scf-bootstrap启动文件与sls-js启动文件区别"><span class="toc-text">scf_bootstrap启动文件与sls.js启动文件区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于serverless-yml写法问题，是更推荐HTTP组件方式吗"><span class="toc-text">关于serverless.yml写法问题，是更推荐HTTP组件方式吗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于配额问题如何处理"><span class="toc-text">关于配额问题如何处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七、官方文档"><span class="toc-text">七、官方文档</span></a></li></ol>
  </div>
  




<div class="content content-post CENTER">
   <!-- canvas 彩带 -->
<canvas id="evanyou" width="1302" height="678" style="position: fixed;width: 100%;height: 100%;top: 0;left:0;z-index:-1;"></canvas>

<div class="qrcode_container">
  <div class="tencent_code">
    <h4>关注作者公众号</h4> 
    <p>和万千小伙伴一起学习</p> 
    <img src="https://interview.poetries.top/qrcode.jpg" alt="公众号：前端进价之旅">
  </div> 
</div>

<article id="post-serverless-deploy-summary" class="article article-type-post" itemprop="blogPost">
  <header class="article-header" style="position:relative;">
    <h1 class="post-title">serverless部署前后端项目实践</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2022.06.18</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Poetry</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/Front-End/">Front-End</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
       
          <span class="post-count">
            <i class="fa fa-file-word-o"></i>&nbsp
            <span>字数统计 14.4k字</span>
          </span>

          <span class="post-count">
            <i class="fa fa-columns"></i>&nbsp
            <span>阅读时长 58分</span>
          </span>
      
      
    </div>

    <i class="iconfont" id="toc-eye" style="display:inline-block;color:#b36619;position:absolute;top:20px;right:-11px;cursor:pointer;
    font-size: 24px;">&#xe61c;</i>

  </header>

  <div class="article-content">
    
      <div id="container">
        <h1 id="一、serverless架构介绍及安装serverless"><a href="#一、serverless架构介绍及安装serverless" class="headerlink" title="一、serverless架构介绍及安装serverless"></a>一、serverless架构介绍及安装serverless</h1><ul>
<li><code>Serverless</code>又名无服务器,所谓无服务器并非是说不需要依赖和依靠服务器等资源,而是开发者再也不用过多考虑服务器的问题,可以更专注在产品代码上。</li>
<li><code>Serverless</code>是一种软件系统架构的思想和方法，它不是软件框架、类库或者工具。它与传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于无状态(<code>Stateless</code>)、 暂存(可能只存在于一次调用的过程中)计算容器内。构建无服务器应用程序意味着开发者可以专注在产品代码上，而无须管理和操作云端或本地的服务器或运行时(运行时通俗的讲 就是运行环境，比如 <code>nodejs</code>环境，<code>java</code> 环境，<code>php</code> 环境)。<code>Serverless</code> 真正做到了部署应用 无需涉及基础设施的建设，自动构建、部署和启动服务。</li>
</ul>
<p><strong>通俗的讲：Serverless 是构建和运行软件时不需要关心服务器的一种架构思想</strong></p>
<p>虚拟主机已经是快被淘汰掉的上一代产物了。云计算涌现出很多改变传统 IT 架构和运维方 式的新技术，比如虚拟机、容器、微服务，无论这些技术应用在哪些场景，降低成本、提升 效率是云服务永恒的主题。<strong>Serverless 的出现真正的解决了降低成本、提升效率的问题</strong>。它真正做到了<code>弹性伸缩</code>、<code>高并发</code>、<code>按需收费</code>、<code>备份容灾</code>、日<code>志监控</code>等。</p>
<h2 id="1-1-传统的开发模式与serverless开发模式对比"><a href="#1-1-传统的开发模式与serverless开发模式对比" class="headerlink" title="1.1 传统的开发模式与serverless开发模式对比"></a>1.1 传统的开发模式与serverless开发模式对比</h2><p>传统的开发模式</p>
<p><img src="https://s.poetries.work/uploads/2022/06/f328901c0adb56de.png" alt></p>
<p>新型的serverless开发模式</p>
<p><img src="https://s.poetries.work/uploads/2022/06/bcc852ef2bc8fbd7.png" alt></p>
<p>Serverless 正在改变未来软件开发的模式和流程</p>
<p><img src="https://s.poetries.work/uploads/2022/07/44fa5d83bc09c564.png" alt></p>
<h2 id="1-2-Serverless-和-ServerFul-架构的区别"><a href="#1-2-Serverless-和-ServerFul-架构的区别" class="headerlink" title="1.2 Serverless 和 ServerFul 架构的区别"></a>1.2 Serverless 和 ServerFul 架构的区别</h2><h3 id="传统的-ServerFul-架构模式"><a href="#传统的-ServerFul-架构模式" class="headerlink" title="传统的 ServerFul 架构模式"></a>传统的 ServerFul 架构模式</h3><p>ServerFul 架构就是 n 台 Server 通过 网络通信 的 方式 协作在一起，也可以说 ServerFul 架构是基于 Server 和 网络通信（分布式计算） 的 软件实现架构 ， Server 可 以是 虚拟机 物理机 ，以及基于硬件实现的云的云服务器</p>
<p><img src="https://s.poetries.work/uploads/2022/07/a6ac5a7905e6f81c.png" alt></p>
<h3 id="Serverless-架构模式"><a href="#Serverless-架构模式" class="headerlink" title="Serverless 架构模式"></a>Serverless 架构模式</h3><p>Serverless 的核心特点就是实现自动弹性伸缩和按量付费</p>
<p><img src="https://s.poetries.work/uploads/2022/07/3d5b8a8b53bd5315.png" alt></p>
<h2 id="1-3-使用serverless的优势"><a href="#1-3-使用serverless的优势" class="headerlink" title="1.3 使用serverless的优势"></a>1.3 使用serverless的优势</h2><ul>
<li><strong>资源分配</strong>: 在 <code>Serverless</code> 架构中，你不用关心应用运行的资源(比如服务配置、磁盘大小)只提供一份代码就行。</li>
<li><strong>计费方式</strong>: 在<code>Serverless</code> 架构中，计费方式按实际使用量计费(比如函数调用次数、运 行时长)，不按传统的执行代码所需的资源计费(比如固定 <code>CPU</code>)。计费粒度也精确到了毫 秒级，而不是传统的小时级别。个别云厂商推出了每个月的免费额度，比如腾讯云提供了每 个月 40 万 GBs 的资源使用额度和 100 万次调用次数的免费额度。中小企业的网站访问量不 是特别大的话完全可以免费使用。</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/06/4f400ccd6d34b420.png" alt></p>
<ul>
<li><strong>弹性伸缩</strong>:<code>Serverless</code> 架构的弹性伸缩更自动化、更精确，可以快速根据业务并发扩容更 多的实例，甚至允许缩容到零实例状态来实现零费用，对用户来说是完全无感知的。而传统 架构对服务器(虚拟机)进行扩容，虚拟机的启动速度也比较慢，需要几分钟甚至更久。</li>
</ul>
<h2 id="1-4-Serverless-组成"><a href="#1-4-Serverless-组成" class="headerlink" title="1.4 Serverless 组成"></a>1.4 Serverless 组成</h2><ul>
<li><strong>广义的 Serverless</strong> 更多是指一种技术理念：Serverless 是构建和运行软件时不需要关心服务 器的一种架构思想。刚开始学 Serverless 你可以把它理解为虚拟主机的升级版本</li>
<li><strong>狭义的 Serverless</strong> 是指现阶段主流的技术实现：狭义的 Serverless 是 <code>FaaS</code>和 <code>BaaS</code> 组成</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/e445b52f9d9a9958.png" alt></p>
<h2 id="1-5-Serverless-开发流程"><a href="#1-5-Serverless-开发流程" class="headerlink" title="1.5 Serverless 开发流程"></a>1.5 Serverless 开发流程</h2><p><img src="https://s.poetries.work/uploads/2022/07/1aa3208070a48915.png" alt></p>
<h2 id="1-6-为什么要学-Serverless"><a href="#1-6-为什么要学-Serverless" class="headerlink" title="1.6 为什么要学 Serverless"></a>1.6 为什么要学 Serverless</h2><p>先看看招聘信息</p>
<p><img src="https://s.poetries.work/uploads/2022/07/c50918e799e3068b.png" alt></p>
<p>看看最近 2 年 Github 的 start 数量和周下载量</p>
<p><img src="https://s.poetries.work/uploads/2022/07/9c63657e6a3dadb2.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/c7c5fe6b663fbe4f.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/750e45e4a038a162.png" alt></p>
<p>目前已经使用了 serverless 的大公司</p>
<p><img src="https://s.poetries.work/uploads/2022/07/d0ace73fab7e28ba.png" alt></p>
<h2 id="1-7-Serverless-的能力"><a href="#1-7-Serverless-的能力" class="headerlink" title="1.7 Serverless 的能力"></a>1.7 Serverless 的能力</h2><h3 id="计算能力"><a href="#计算能力" class="headerlink" title="计算能力"></a>计算能力</h3><ul>
<li>资源按需分配，无需申请资原</li>
<li>Mwm：租户级别强镜离 Docker：进程级别隔离</li>
<li>Mwm+Docker 轻量级资源毫秒级启动</li>
<li>实时扩容，阶梯缩容</li>
<li>按需收费</li>
</ul>
<h3 id="系统运维能力"><a href="#系统运维能力" class="headerlink" title="系统运维能力"></a>系统运维能力</h3><ul>
<li>性能保障：整个链路耗时毫秒级内,并支持 VPC 内网访问</li>
<li>安全保障<ul>
<li>资源对用户不可见,安全由腾讯云提供专业的保障</li>
<li>提供进程级和用户级安全隔离</li>
<li>访问控制管理</li>
</ul>
</li>
<li>自动性护缩容<ul>
<li>根据 CPU 内容网络 IO 自动扩容底层资源</li>
<li>根据请求数自动扩缩容函数实例，业务高峰期扩容，满足业务高并发需求，业务低 峰期缩容，释放资源，降低成本</li>
</ul>
</li>
<li>自愈能力：每一次请求都是一个健康的实例</li>
</ul>
<blockquote>
<p>Serverless 中云函数被第一次调用会执行冷启动，Serverless 中云函数被多次连续调用会 执行热启动</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/527e0cfb402fa738.png" alt></p>
<ul>
<li><strong>冷启动</strong> 是指你在服务器中新开辟一块空间供一个函数实例运行，这个过程有点像你把这 个函数放到虚拟机里去运行，每次运行前都要先启动虚拟机加载这个函数，以前冷启动非常 耗时，但是目前云厂商已经能做到毫秒级别的冷启动，这个过程我们也不需要关心，但是需 要注意的是使用 Seesion 的时候可能会导致 Session 丢失，所以我们的 Seesion 建议保存到数 据库。</li>
<li><strong>热启动</strong> 则是说如果一个云函数被持续触发，那我就先不释放这个云函数实例，下次请求 仍然由之前已经创建了的云函数实例来运行，就好比我们打开虚拟机运行完这个函数之后没 有关闭虚拟机，而是让它待机，等待下一次被重新触发调用运行，这样做的好处就是省去了 给虚拟机「开机」的一个耗时环节，缺点是要一直维持这个虚拟机的激活状态，系统开销会 大一些。</li>
</ul>
<h3 id="业务运维能力"><a href="#业务运维能力" class="headerlink" title="业务运维能力"></a>业务运维能力</h3><ul>
<li>工具建设：vscode 插件、WebIDE、Command Line、云 api、Sdk</li>
<li>版本管理、操作管理等</li>
<li>故障排查</li>
<li>监控报警</li>
<li>容灾处理</li>
</ul>
<h2 id="1-8-serverless厂家"><a href="#1-8-serverless厂家" class="headerlink" title="1.8 serverless厂家"></a>1.8 serverless厂家</h2><ul>
<li><a href="https://aws.amazon.com/cn/lambda/" target="_blank" rel="noopener">亚马逊 AWS Lambda </a></li>
<li><a href="https://cloud.google.com/functions" target="_blank" rel="noopener">谷歌 Google Cloud Functions</a></li>
<li><a href="https://www.azure.cn/" target="_blank" rel="noopener">微软 Microsoft Azure</a></li>
<li><a href="https://www.aliyun.com/product/fc" target="_blank" rel="noopener">阿里云函数计算</a></li>
<li><a href="https://cloud.tencent.com/product/scf" target="_blank" rel="noopener">腾讯云 云函数 SCF(Serverless Cloud Function)</a></li>
<li><a href="https://www.huaweicloud.com/product/functiongraph.html" target="_blank" rel="noopener">华为云 FunctionGraph</a></li>
</ul>
<h2 id="1-9-云函数和serverless的区别"><a href="#1-9-云函数和serverless的区别" class="headerlink" title="1.9 云函数和serverless的区别"></a>1.9 云函数和serverless的区别</h2><blockquote>
<p>通过前面的介绍，我们认识到了云函数和<code>serverless</code>，但是可能会有一个很迷惑云函数和<code>serverless</code>到底有什么区别，他们之间有什么联系，为什么我在创建云函数的时候选择模板方式创建最后创建的是<code>serverless</code>，而不是云函数呢。下面我们将解答云函数和<code>serverless</code>的区别</p>
</blockquote>
<ul>
<li><code>Serverless Framework</code> 是<code>Serverless</code>公司推出的一个开源的<code>Serverless</code> 应用开发框架</li>
<li><code>Serverless Framework</code>是由 <code>Serverless Framework Plugin</code> 和 <code>Serverless Framework Components</code> 组成</li>
<li><code>Serverless Framework Plugin</code> 实际上是一个函数的管理工具，使用这个工具，可以很轻松的 <strong>部署函数、删除函数、触发函数、查看函数信息、查看函数日志、回滚函数、查看函数</strong> 数据等。简单的概括就是<code>serverless</code>其实就<strong>云函数的集合体</strong>，使用<code>serverless</code>后我们创建的云函数不需要手动去创建触发器等操作</li>
</ul>
<p><strong>官方地址</strong></p>
<ul>
<li><a href="https://www.serverless.com/" target="_blank" rel="noopener">serverless官网地址</a></li>
<li><a href="https://cn.serverless.com" target="_blank" rel="noopener">serverless中文官网</a></li>
<li><a href="https://github.com/serverless/serverless" target="_blank" rel="noopener">github地址</a></li>
</ul>
<h2 id="1-20-创建serverless的方式"><a href="#1-20-创建serverless的方式" class="headerlink" title="1.20 创建serverless的方式"></a>1.20 创建serverless的方式</h2><ul>
<li>在腾讯<code>serverless</code>控制面板上创建，然后在<code>vscode</code>中使用插件的方式下载到本地（<strong>注意: </strong> 编辑器上要选择和创建<code>serverless</code>地区相同，才能看到项目，否则是看不到项目代码的）</li>
<li>使用客户端<code>serverless cli</code>命令方式创建，个人也更推荐使用这种方式创建，修改代码，然后部署到后台腾讯云服务上</li>
</ul>
<h1 id="二、serverless-脚手架安装、WebIDE中创建、vscode中配置"><a href="#二、serverless-脚手架安装、WebIDE中创建、vscode中配置" class="headerlink" title="二、serverless 脚手架安装、WebIDE中创建、vscode中配置"></a>二、serverless 脚手架安装、WebIDE中创建、vscode中配置</h1><h2 id="2-1-脚手架安装-三分钟部署一个项目"><a href="#2-1-脚手架安装-三分钟部署一个项目" class="headerlink" title="2.1 脚手架安装-三分钟部署一个项目"></a>2.1 脚手架安装-三分钟部署一个项目</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm i serverless -g</span><br><span class="line"></span><br><span class="line">serverless -v</span><br></pre></td></tr></table></figure>
<p>查看支持的框架部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sls registry</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者输入sls</span></span><br><span class="line">sls</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/bb939fc00c99aa5a.png" alt></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 例如初始化egg项目</span></span><br><span class="line"></span><br><span class="line">serverless init eggjs-starter(可以替换成sls registry已有的模板) --name egg-example</span><br></pre></td></tr></table></figure>
<p>部署 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<h2 id="2-2-在vscode中配置插件来开发serverless"><a href="#2-2-在vscode中配置插件来开发serverless" class="headerlink" title="2.2 在vscode中配置插件来开发serverless"></a>2.2 在vscode中配置插件来开发serverless</h2><p>通过该 VS Code 插件，您可以</p>
<ul>
<li>拉取云端的云函数列表，并触发云函数</li>
<li>在本地快速创建云函数项目</li>
<li>使用模拟的 COS、CMQ、CKafka、API 网关等触发器事件来触发函数运行</li>
<li>上传函数代码到云端，更新函数配置</li>
<li>在云端运行、调试函数代码</li>
</ul>
<p><strong>界面上创建应用</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/06/18c3d872701f1cfc.png" alt></p>
<ul>
<li>在<code>vscode</code>上安装插件</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/06/0b0cf6ae03f9277b.png" alt></p>
<ul>
<li>在<code>vscode</code>安装后插件登录并且拉取应用</li>
</ul>
<blockquote>
<p>密钥地址 <a href="https://console.cloud.tencent.com/cam/capi" target="_blank" rel="noopener">https://console.cloud.tencent.com/cam/capi</a> 填入appID、secretID、secretKey即可拉取云函数到本地</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/66d614b9bba52dbf.png" alt></p>
<ul>
<li>切换地域查看函数</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/d5010c1e04560057.png" alt></p>
<ul>
<li>点击云函数，可以查看函数基本配置信息</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/9e081856b313fc45.png" alt></p>
<ul>
<li>下载函数代码到本地调试，点击下载图标选择要保存的路径</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/a7b44ad3928be60f.png" alt></p>
<ul>
<li>本地修改完代码后，上传函数代码到云端</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/9e2f3c3bc5832035.png" alt><br><img src="https://s.poetries.work/uploads/2022/07/f497c782f6070744.png" alt></p>
<ul>
<li>本地调试云函数</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/99f7dc28e086be60.png" alt></p>
<h2 id="2-3-WebIDE创建云函数实践"><a href="#2-3-WebIDE创建云函数实践" class="headerlink" title="2.3 WebIDE创建云函数实践"></a>2.3 WebIDE创建云函数实践</h2><p><strong>创建一个云函数</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/06/dd99f3d6323b8e15.png" alt></p>
<p><strong>给云函数创建触发器来访问</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/06/894bd8fb7cee9aa8.png" alt></p>
<p>创建了触发器后，就可以通过触发器里面的访问路径来访问云函数</p>
<p><img src="https://s.poetries.work/uploads/2022/06/6ea1e2875196d30e.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/535aa49e41c50789.png" alt></p>
<blockquote>
<p>我们可以在控制台修改代码，然后重新部署云函数，或者开启自动安装依赖等</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/e5f68c50a4296d47.png" alt></p>
<h1 id="三、Serverless-Framework部署项目实战"><a href="#三、Serverless-Framework部署项目实战" class="headerlink" title="三、Serverless Framework部署项目实战"></a>三、Serverless Framework部署项目实战</h1><h2 id="3-1-Serverless-Framework简介及应用场景"><a href="#3-1-Serverless-Framework简介及应用场景" class="headerlink" title="3.1 Serverless Framework简介及应用场景"></a>3.1 Serverless Framework简介及应用场景</h2><ul>
<li>Serverless Framework 是 Serverless 公司推出的一个开源的 Serverless 应用开发框架</li>
<li>Serverless Framework 是 由 Serverless Framework Plugin 和 Serverless Framework Components 组成</li>
<li>Serverless Framework Plugin 实际上是一个函数的管理工具，使用这个工具，可以很轻 松的部署函数、删除函数、触发函数、查看函数信息、查看函数日志、回滚函数、查看函数 数据等</li>
</ul>
<blockquote>
<p>Serverless Framework Components 可以看作是一个组件集，这里面包括了很多的 Components，有基础的 Components，例如 cos、scf、apigateway 等，也有一些拓展的 Components，例如在 cos 上拓展出来的 website，可以直接部署静态网站等，还有一些框 架级的，例如 Koa，Express等</p>
</blockquote>
<ul>
<li>Serverless Framework 官网：<a href="https://www.serverless.com/" target="_blank" rel="noopener">https://www.serverless.com/</a> </li>
<li>Serverless Framework 中文网站：<a href="https://www.serverless.com/cn" target="_blank" rel="noopener">https://www.serverless.com/cn</a> </li>
<li>Github 地址：<a href="https://github.com/serverless/serverless" target="_blank" rel="noopener">https://github.com/serverless/serverless</a></li>
</ul>
<h3 id="Serverless-Framework-应用场景"><a href="#Serverless-Framework-应用场景" class="headerlink" title="Serverless Framework 应用场景"></a>Serverless Framework 应用场景</h3><blockquote>
<p>上面既然介绍了云函数和<code>serverless</code>的区别，现在我们介绍下什么场景下需要使用<code>serverless</code>，而不是使用云函数，其实在实际开发过程中，我们都是使用<code>serverless</code>而不去使用云函数，毕竟云函数的使用场景受限，或者说比较基础。打一个简单的比方，在写<code>js</code>操作<code>dom</code>的时候，你会选择用原生<code>js</code>还是会使用<code>jquery</code>一样的比喻</p>
</blockquote>
<p><strong>基于云函数的命令行开发工具</strong></p>
<blockquote>
<p>通过 <code>Serverless Framework</code>，开发者可以在命令行完成函数的开发、部署、调试。还可以结合前端服务、 API 网关、数据库等其它云上资源，实现全栈应用的快速部署。</p>
</blockquote>
<p><strong>传统应用框架的快速迁移</strong></p>
<blockquote>
<p><code>Serverless Framework</code> 提供了一套通用的框架迁移方案，通过使用 <code>Serverless Framework</code>提供的框架组件(<code>Egg/Koa/Express</code> 等，<a href="https://github.com/serverless" target="_blank" rel="noopener">更多的框架支持可以参考</a>)，原有应用仅需几行代码简单改造， 即可快速迁移到函数平台。同时支持命令行与控制台的开发方式。</p>
</blockquote>
<h3 id="Serverless-Framework-支持的平台"><a href="#Serverless-Framework-支持的平台" class="headerlink" title="Serverless Framework 支持的平台"></a>Serverless Framework 支持的平台</h3><blockquote>
<p><a href="https://github.com/serverless/serverless/tree/master/docs/providers" target="_blank" rel="noopener">https://github.com/serverless/serverless/tree/master/docs/providers</a></p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/228c4a131acdb03c.png" alt></p>
<h2 id="3-2-Serverless-Components-支持组件列表"><a href="#3-2-Serverless-Components-支持组件列表" class="headerlink" title="3.2 Serverless Components 支持组件列表"></a>3.2 Serverless Components 支持组件列表</h2><h3 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h3><ul>
<li><a href="https://github.com/serverless-components/tencent-postgresql/tree/master" target="_blank" rel="noopener">@serverless/tencent-postgresql</a> - 腾讯云 PG DB Serverless 数据库组件</li>
<li><a href="https://github.com/serverless-components/tencent-apigateway" target="_blank" rel="noopener">@serverless/tencent-apigateway</a> - 腾讯云 API 网关组件</li>
<li><a href="https://github.com/serverless-components/tencent-cos" target="_blank" rel="noopener">@serverless/tencent-cos</a> - 腾讯云对象存储组件</li>
<li><a href="https://github.com/serverless-components/tencent-scf/tree/master" target="_blank" rel="noopener">@serverless/tencent-scf</a> - 腾讯云云函数组件</li>
<li><a href="https://github.com/serverless-components/tencent-cdn" target="_blank" rel="noopener">@serverless/tencent-cdn</a> - 腾讯云 CDN 组件</li>
<li><a href="https://github.com/serverless-components/tencent-vpc/tree/master" target="_blank" rel="noopener">@serverless/tencent-vpc</a> - 腾讯云 VPC 私有网络组件</li>
</ul>
<h3 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h3><ul>
<li><a href="https://github.com/serverless-components/tencent-nextjs/tree/master" target="_blank" rel="noopener">@serverless/tencent-nextjs</a> - 快速部署基于 Next.js 框架到腾讯云函数的组件</li>
<li><a href="https://github.com/serverless-components/tencent-nuxtjs/tree/master" target="_blank" rel="noopener">@serverless/tencent-nuxtjs</a> - 快速部署基于 Nuxt.js 框架到腾讯云函数的组件</li>
<li><a href="https://github.com/serverless-components/tencent-express/tree/master" target="_blank" rel="noopener">@serverless/tencent-express</a> - 快速部署基于 Express.js 的后端服务到腾讯云函数的组件</li>
<li><a href="https://github.com/serverless-components/tencent-egg/tree/master" target="_blank" rel="noopener">@serverless/tencent-egg</a> - 快速部署基于 Egg.js 的后端服务到腾讯云函数的组件</li>
<li><a href="https://github.com/serverless-components/tencent-koa/tree/master" target="_blank" rel="noopener">@serverless/tencent-koa</a> - 快速部署基于 Koa.js 的后端服务到腾讯云函数的组件</li>
<li><a href="https://github.com/serverless-components/tencent-flask" target="_blank" rel="noopener">@serverless/tencent-flask</a> - 腾讯云 Python Flask RESTful API 组件</li>
<li><a href="https://github.com/serverless-tencent/tencent-django/tree/master" target="_blank" rel="noopener">@serverless/tencent-django</a> - 腾讯云 Python Django RESTful API 组件</li>
<li><a href="https://github.com/serverless-components/tencent-laravel" target="_blank" rel="noopener">@serverless/tencent-laravel</a> - 腾讯云 PHP Laravel RESTful API 组件</li>
<li><a href="https://github.com/serverless-components/tencent-thinkphp" target="_blank" rel="noopener">@serverless/tencent-thinkphp</a> - 腾讯云 ThinkPHP RESTful API 组件</li>
<li><a href="https://github.com/serverless-components/tencent-website/tree/master" target="_blank" rel="noopener">@serverless/tencent-website</a> - 快速部署静态网站到腾讯云的组件</li>
</ul>
<h2 id="3-3-sls部署egg项目"><a href="#3-3-sls部署egg项目" class="headerlink" title="3.3 sls部署egg项目"></a>3.3 sls部署egg项目</h2><blockquote>
<p>egg 框架中默认已经配置好了静态资源，我们可以直接访问。要注意的是 serverless 服务器 上面只有根目录的 tmp 目录有写入权限，所以需要配置 egg 日志存储的目录。默认创建好 项目以后有如下配置。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">appInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...,</span><br><span class="line">    rundir: <span class="string">'/tmp'</span>,</span><br><span class="line">    logger: &#123;</span><br><span class="line">      dir: <span class="string">'/tmp'</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="控制台创建部署-模板部署"><a href="#控制台创建部署-模板部署" class="headerlink" title="控制台创建部署-模板部署"></a>控制台创建部署-模板部署</h3><ol>
<li>登录控制台 <a href="https://console.cloud.tencent.com/sls" target="_blank" rel="noopener">https://console.cloud.tencent.com/sls</a></li>
<li>单击新建应用，选择Web 应用&gt;Egg 框架，如下图所示：</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/fbf0b03c839cd73e.png" alt></p>
<ol start="3">
<li>单击“下一步”，完成基础配置选择。</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/58b123659a00b194.png" alt></p>
<ol start="4">
<li>上传方式，选择示例代码直接部署，单击完成，即可开始应用的部署。</li>
<li>部署完成后，您可在应用详情页面，查看示例应用的基本信息，并通过 API 网关生成的访问路径 URL 进行访问，查看您部署的 Egg 项目。</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/c4c3e330b1a6af68.png" alt></p>
<h3 id="控制台创建部署-自定义部署-推荐"><a href="#控制台创建部署-自定义部署-推荐" class="headerlink" title="控制台创建部署-自定义部署(推荐)"></a>控制台创建部署-自定义部署(推荐)</h3><blockquote>
<p>如果除了代码部署外，您还需要更多能力或资源创建，如自动创建层托管依赖、一键实现静态资源分离、支持代码仓库直接拉取等，可以通过应用控制台，完成 Web 应用的创建工作</p>
</blockquote>
<p><strong>初始化项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir egg-example &amp;&amp; cd egg-example</span><br><span class="line">npm init egg --type=simple</span><br><span class="line">npm i</span><br></pre></td></tr></table></figure>
<p><strong>部署上云</strong></p>
<blockquote>
<p>接下来执行以下步骤，对本地已创建完成的项目进行简单修改，使其可以通过 Web Function 快速部署，对于 Egg 框架，具体改造说明如下：</p>
</blockquote>
<ul>
<li>修改监听地址与端口为 <code>0.0.0.0:9000</code>。</li>
<li>修改写入路径，serverless 环境下只有 <code>/tmp</code> 目录可读写。</li>
<li>新增 <code>scf_bootstrap</code> 启动文件。</li>
</ul>
<p><strong>1. (可选)配置 scf_bootstrap 启动文件</strong></p>
<p>您也可以在控制台完成该模块配置。</p>
<p><img src="https://s.poetries.work/uploads/2022/06/85b3d73ea922f0ea.png" alt></p>
<blockquote>
<p>在项目根目录下新建 <code>scf_bootstrap</code> 启动文件，在该文件添加如下内容（用于配置环境变量和启动服务，此处仅为示例，具体操作请以您实际业务场景来调整）：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/var/lang/node12/bin/node</span></span><br><span class="line"></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * docker 中 node 路径：/var/lang/node12/bin/node</span></span><br><span class="line"><span class="comment"> * 由于 serverless 函数只有 /tmp 读写权限，所以在启动时需要修改两个环境变量</span></span><br><span class="line"><span class="comment"> * NODE_LOG_DIR 是为了改写 egg-scripts 默认 node 写入路径（~/logs）-&gt; /tmp</span></span><br><span class="line"><span class="comment"> * EGG_APP_CONFIG 是为了修改 egg 应有的默认当前目录 -&gt; /tmp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">process.env.EGG_SERVER_ENV = <span class="string">'prod'</span>;</span><br><span class="line">process.env.NODE_ENV = <span class="string">'production'</span>;</span><br><span class="line">process.env.NODE_LOG_DIR = <span class="string">'/tmp'</span>;</span><br><span class="line">process.env.EGG_APP_CONFIG = <span class="string">'&#123;"rundir":"/tmp","logger":&#123;"dir":"/tmp"&#125;&#125;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Application &#125; = <span class="built_in">require</span>(<span class="string">'egg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果通过层部署 node_modules 就需要修改 eggPath</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Application.prototype, <span class="built_in">Symbol</span>.for(<span class="string">'egg#eggPath'</span>), &#123;</span><br><span class="line">  value: <span class="string">'/opt'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Application(&#123;</span><br><span class="line">  mode: <span class="string">'single'</span>,</span><br><span class="line">  env: <span class="string">'prod'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">9000</span>, <span class="string">'0.0.0.0'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server start on http://0.0.0.0:9000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建完成后，还需执行以下命令修改文件可执行权限，默认需要 777 或 755 权限才可正常启动。示例如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 777 scf_bootstrap</span><br></pre></td></tr></table></figure>
<p><strong>2. 控制台上传</strong></p>
<blockquote>
<p>您可以在控制台完成启动文件 scf_bootstrap 内容配置，配置完成后，控制台将为您自动生成 启动文件，和项目代码一起打包部署</p>
</blockquote>
<p>启动文件以项目内文件为准，如果您的项目里已经包含 <code>scf_bootstrap</code> 文件，将不会覆盖该内容。</p>
<p><img src="https://s.poetries.work/uploads/2022/06/a96ce1c3799f5951.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/ce48d9dd73af824f.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/9a0e3dfa25a6ed3d.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/06/e9dd1225bf0d37cd.png" alt></p>
<p>查看函数，修改代码查看日志等</p>
<p><img src="https://s.poetries.work/uploads/2022/06/ca238c35541dd8df.png" alt></p>
<p><strong>高级配置管理</strong></p>
<blockquote>
<p>您可在“高级配置”里进行更多应用管理操作，如创建层、绑定自定义域名、配置环境变量等。</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/4ab13bbb74bcdf89.png" alt></p>
<h3 id="HTTP-组件方式部署-推荐"><a href="#HTTP-组件方式部署-推荐" class="headerlink" title="HTTP 组件方式部署(推荐)"></a>HTTP 组件方式部署(推荐)</h3><blockquote>
<p>目前推荐使用 web 函数，也就是 <code>HTTP 组件</code>，现在所有的serverless web 应用都是基于 <code>component: http</code> 组件的。</p>
</blockquote>
<blockquote>
<p>通过 <code>Serverless Framework</code> 的 <code>HTTP 组件</code>，完成 Web 应用的本地部署</p>
</blockquote>
<p><strong>前提条件</strong></p>
<blockquote>
<p>已开通服务并完成 <a href="https://cloud.tencent.com/document/product/1154/43006" target="_blank" rel="noopener">Serverless Framework 的 权限配置</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 初始化egg项目</span></span><br><span class="line"></span><br><span class="line">serverless init eggjs-starter(可以替换成sls registry已有的模板) --name egg-example</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编写完善配置文件 serverless.yml</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">egg-example-fa63d20e9</span> <span class="comment"># 应用名称</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">http</span> <span class="comment"># http组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">egg-demo</span> <span class="comment"># 实例名称</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  src:</span> <span class="comment"># 部署当前目录下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> <span class="comment"># 当前目录</span></span><br><span class="line"><span class="attr">    exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'node_modules/**'</span> <span class="comment"># 忽略node_modules，在控制台WEBIDE开启安装依赖</span></span><br><span class="line">  <span class="comment"># src: # 在指定存储桶bucket中已经存在了object代码，直接部署</span></span><br><span class="line">  <span class="comment">#   bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line">  <span class="comment">#   object: cos.zip  # bucket key 指定存储桶内的文件</span></span><br><span class="line"><span class="attr">  faas:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行时</span></span><br><span class="line">    <span class="comment"># 支持的框架查看 https://cloud.tencent.com/document/product/1154/59447#framework</span></span><br><span class="line"><span class="attr">    framework:</span> <span class="string">egg</span> <span class="comment"># #选择框架，此处以 egg 为例 </span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">$&#123;name&#125;</span> <span class="comment"># 云函数名称，通过变量形式获取name的值</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，默认 512 MB</span></span><br><span class="line">    <span class="comment"># layers:</span></span><br><span class="line">    <span class="comment">#   - name: layerName #  layer名称</span></span><br><span class="line">    <span class="comment">#     version: 1 #  版本</span></span><br><span class="line"><span class="attr">    environments:</span> <span class="comment">#  配置环境变量，同时也可以直接在 scf 控制台配置 </span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">NODE_ENV</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">production</span></span><br><span class="line">    <span class="comment"># vpc: # 私有网络配置</span></span><br><span class="line">    <span class="comment">#   vpcId: 'vpc-xxx' # 私有网络的Id</span></span><br><span class="line">    <span class="comment">#   subnetId: 'subnet-xxx' # 子网ID</span></span><br><span class="line">    <span class="comment"># tags:</span></span><br><span class="line">    <span class="comment">#   - key: tagKey</span></span><br><span class="line">    <span class="comment">#     value: tagValue</span></span><br><span class="line"><span class="attr">  apigw:</span> <span class="comment"># http 组件会默认帮忙创建一个 API 网关服务</span></span><br><span class="line"><span class="attr">    isDisabled:</span> <span class="literal">false</span> <span class="comment"># 是否禁用自动创建 API 网关功能</span></span><br><span class="line">    <span class="comment"># id: service-xx # api网关服务ID，不填则自动新建网关</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">serverless</span> <span class="comment"># api网关服务名称</span></span><br><span class="line"><span class="attr">    api:</span> <span class="comment"># 创建的 API 相关配置</span></span><br><span class="line"><span class="attr">      cors:</span> <span class="literal">true</span> <span class="comment">#  允许跨域</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">30</span> <span class="comment"># API 超时时间</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">apiName</span> <span class="comment"># API 名称</span></span><br><span class="line"><span class="attr">      qualifier:</span> <span class="string">$DEFAULT</span> <span class="comment"># API 关联的版本</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">test</span></span><br><span class="line">    <span class="comment"># tags:</span></span><br><span class="line">    <span class="comment">#   - key: tagKey</span></span><br><span class="line">    <span class="comment">#     value: tagValue</span></span><br><span class="line">    <span class="comment"># customDomains: # 自定义域名绑定</span></span><br><span class="line">    <span class="comment">#   - domain: abc.com # 待绑定的自定义的域名</span></span><br><span class="line">    <span class="comment">#     certId: abcdefg # 待绑定自定义域名的证书唯一 ID</span></span><br><span class="line">    <span class="comment">#     # 如要设置自定义路径映射，(customMap = true isDefaultMapping = false)必须两者同时出现 其余情况都是默认路径</span></span><br><span class="line">    <span class="comment">#     customMap: true</span></span><br><span class="line">    <span class="comment">#     isDefaultMapping: false</span></span><br><span class="line">    <span class="comment">#     # 自定义路径映射的路径。使用自定义映射时，可一次仅映射一个 path 到一个环境，也可映射多个 path 到多个环境。并且一旦使用自定义映射，原本的默认映射规则不再生效，只有自定义映射路径生效。</span></span><br><span class="line">    <span class="comment">#     pathMap:</span></span><br><span class="line">    <span class="comment">#       - path: /</span></span><br><span class="line">    <span class="comment">#         environment: release</span></span><br><span class="line">    <span class="comment">#     protocols: # 绑定自定义域名的协议类型，默认与服务的前端协议一致。</span></span><br><span class="line">    <span class="comment">#       - http # 支持http协议</span></span><br><span class="line">    <span class="comment">#       - https # 支持https协议</span></span><br><span class="line">    <span class="comment"># app: #  应用授权配置</span></span><br><span class="line">    <span class="comment">#   id: app-xxx</span></span><br><span class="line">    <span class="comment">#   name: app_demo</span></span><br><span class="line">    <span class="comment">#   description: app description</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>全部配置详细查看  <a href="https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md" target="_blank" rel="noopener">https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</a></p>
</blockquote>
<p><strong>部署</strong></p>
<blockquote>
<p>创建完成后，在根目录下执行 <code>sls deploy</code> 进行部署，组件会根据选择的框架类型，自动生成 <code>scf_bootstrap</code> 启动文件进行部署</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/8e11d14d715ba443.png" alt></p>
<p>我们也可以在项目跟目录自己创建启动文件<code>scf_bootstrap</code> ，然后<code>chmod 777 scf_bootstrap</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// scf_bootstrap</span></span><br><span class="line"><span class="meta">#!/var/lang/node12/bin/node</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * docker 中 node 路径：/var/lang/node12/bin/node</span></span><br><span class="line"><span class="comment"> * 由于 serverless 函数只有 /tmp 读写权限，所以在启动时需要修改两个环境变量</span></span><br><span class="line"><span class="comment"> * NODE_LOG_DIR 是为了改写 egg-scripts 默认 node 写入路径（~/logs）-&gt; /tmp</span></span><br><span class="line"><span class="comment"> * EGG_APP_CONFIG 是为了修改 egg 应有的默认当前目录 -&gt; /tmp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">process.env.EGG_SERVER_ENV = <span class="string">'prod'</span>;</span><br><span class="line">process.env.NODE_ENV = <span class="string">'production'</span>;</span><br><span class="line">process.env.NODE_LOG_DIR = <span class="string">'/tmp'</span>;</span><br><span class="line">process.env.EGG_APP_CONFIG = <span class="string">'&#123;"rundir":"/tmp","logger":&#123;"dir":"/tmp"&#125;&#125;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Application &#125; = <span class="built_in">require</span>(<span class="string">'egg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果通过层部署 node_modules 就需要修改 eggPath</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Application.prototype, <span class="built_in">Symbol</span>.for(<span class="string">'egg#eggPath'</span>), &#123;</span><br><span class="line">  value: <span class="string">'/opt'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Application(&#123;</span><br><span class="line">  mode: <span class="string">'single'</span>,</span><br><span class="line">  env: <span class="string">'prod'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">9000</span>, <span class="string">'0.0.0.0'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server start on http://0.0.0.0:9000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 微信扫码即可 </span></span><br><span class="line"><span class="comment"># 微信扫码授权部署有过期时间，如果想要持久授权，请参考账号配置(https://cloud.tencent.com/document/product/1154/45874#account)</span></span><br><span class="line"><span class="comment"># 当前默认支持 CLI 扫描二维码登录，如您希望配置持久的环境变量/密钥信息，也可以本地创建 .env 文件：</span></span><br><span class="line"><span class="comment"># 在 .env 文件中配置腾讯云的 SecretId 和 SecretKey 信息并保存。</span></span><br><span class="line"><span class="comment"># API密钥管理 https://console.cloud.tencent.com/cam/capi</span></span><br><span class="line"><span class="comment"># .env</span></span><br><span class="line"><span class="comment">#TENCENT_SECRET_ID=123</span></span><br><span class="line"><span class="comment">#TENCENT_SECRET_KEY=123</span></span><br><span class="line"></span><br><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：由于启动文件逻辑与用户业务逻辑强关联，默认生成的启动文件可能导致框架无法正常启动，建议您根据实际业务需求，手动配置启动文件，<a href="https://cloud.tencent.com/document/product/1154/59447" target="_blank" rel="noopener">详情参考各框架的部署指引文档</a>。</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/9d3580eef444d80f.png" alt></p>
<blockquote>
<p>如果部署过程遇到问题不好排除，如以下问题：</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/6d5fd5ba537850dd.png" alt></p>
<p>来到控制台创建项目</p>
<p><img src="https://s.poetries.work/uploads/2022/06/1ac3905f67789812.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/715ea0e1c4d12298.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/a3921110151f0ba3.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/f91266106e6e1d78.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/2117adef0814c390.png" alt></p>
<p><strong>在控制台安装依赖包</strong></p>
<blockquote>
<p>我们在<code>sls deploy</code>忽略了<code>node_modules</code>，因此需要在控制台安装依赖</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/d47f6e73f93d5055.png" alt></p>
<p>访问应用</p>
<p><img src="https://s.poetries.work/uploads/2022/06/9ad37b26fbab516d.png" alt></p>
<p>到控制台查看</p>
<p><img src="https://s.poetries.work/uploads/2022/06/14c5cc6d18060612.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/369867cf3dc9a1e1.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/3cdd7bf1c596d876.png" alt></p>
<p>删除应用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls remove</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/9db881d3d57a0c59.png" alt></p>
<h3 id="使用Layer-来减小项目文件大小"><a href="#使用Layer-来减小项目文件大小" class="headerlink" title="使用Layer 来减小项目文件大小"></a>使用Layer 来减小项目文件大小</h3><p>随着项目复杂度的增加，<code>deploy</code> 上传会变慢。所以，让我们再优化一下，在项目根目录创建 <code>layer/serverless.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># layer/serverless.yml</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/51133</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-layer/blob/master/docs/configure.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#应用组织信息（可选）</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">egg-demo</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#组件信息</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">layer</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">egg-demo-layer</span> <span class="comment"># 层名称 必须</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件参数配置，根据每个组件，实现具体的资源信息配置</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr"> name:</span> <span class="string">$&#123;name&#125;</span> <span class="comment"># 名称跟上面一致即可</span></span><br><span class="line"><span class="attr"> region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 地区 必须</span></span><br><span class="line"><span class="attr"> src:</span> <span class="string">../node_modules</span> <span class="comment">#需要上传的目标文件路径 必须 </span></span><br><span class="line">  <span class="comment"># src: # 代码路径。与 object 不能同时存在。</span></span><br><span class="line">  <span class="comment">#   src: ./node_modules</span></span><br><span class="line">  <span class="comment">#   targetDir: /node_modules</span></span><br><span class="line">  <span class="comment">#   exclude:   # 被排除的文件或目录 不包含的文件或路径, 遵守 glob 语法</span></span><br><span class="line">  <span class="comment">#     - .env</span></span><br><span class="line">  <span class="comment">#     - node_modules</span></span><br><span class="line">  <span class="comment"># src:</span></span><br><span class="line">  <span class="comment"># bucket 名称。如果配置了 src，表示部署 src 的代码并压缩成 zip 后上传到 bucket-appid 对应的存储桶中；如果配置了 object，表示获取 bucket-appid 对应存储桶中 object 对应的代码进行部署。</span></span><br><span class="line">  <span class="comment">#   bucket: layers</span></span><br><span class="line">  <span class="comment">#   object: sls-layer-test-1584524206.zip # 部署的代码在存储桶中的路径。</span></span><br><span class="line">  <span class="comment">#   exclude:   # 被排除的文件或目录</span></span><br><span class="line">  <span class="comment">#     - .env</span></span><br><span class="line">  <span class="comment">#     - node_modules</span></span><br><span class="line"><span class="attr"> runtimes:</span> <span class="comment"># 层支持的运行环境</span></span><br><span class="line"><span class="bullet">   -</span> <span class="string">Nodejs12.16</span> </span><br><span class="line"><span class="attr"> description:</span> <span class="string">layer</span> <span class="string">description</span> <span class="comment"># 否 描述</span></span><br></pre></td></tr></table></figure>
<p>创建后可见层对应信息</p>
<p><img src="https://s.poetries.work/uploads/2022/06/7e5abeb49a56f460.png" alt></p>
<p>我们也可以在控制台新建层绑定到对应的函数即可</p>
<p><img src="https://s.poetries.work/uploads/2022/06/d10f5ea7b0cac331.png" alt></p>
<p>控制台上传层有大小限制</p>
<p><img src="https://s.poetries.work/uploads/2022/06/683f6152002db3a9.png" alt></p>
<p>文件夹支持250M</p>
<p><img src="https://s.poetries.work/uploads/2022/06/6495e575646c3035.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/06/740312afd66bc342.png" alt></p>
<p><strong>修改以上项目下的serverless.yml加入层配置</strong></p>
<p>回到项目根目录，调整一下根目录的 <code>serverless.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编写完善配置文件 serverless.yml</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">egg-example-fa63d20e9</span> <span class="comment"># 应用名称</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">http</span> <span class="comment"># http组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">egg-demo</span> <span class="comment"># 实例名称</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  src:</span> <span class="comment"># 部署当前目录下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> <span class="comment"># 当前目录</span></span><br><span class="line"><span class="attr">    exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"node_modules/**"</span> <span class="comment"># deploy 时排除 node_modules [需要注意] 使用layer的node_modules</span></span><br><span class="line"><span class="attr">  faas:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行时</span></span><br><span class="line">    <span class="comment"># 支持的框架查看 https://cloud.tencent.com/document/product/1154/59447#framework</span></span><br><span class="line"><span class="attr">    framework:</span> <span class="string">egg</span> <span class="comment"># #选择框架，此处以 egg 为例 </span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">$&#123;name&#125;</span> <span class="comment"># 云函数名称，通过变量形式获取name的值</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，默认 512 MB</span></span><br><span class="line">    <span class="comment"># 加入层配置 引用格式请参考 变量引用说明 https://github.com/AprilJC/Serverless-Framework-Docs/blob/main/docs/%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8.md#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E8%AF%B4%E6%98%8E</span></span><br><span class="line"><span class="attr">    layers:</span> </span><br><span class="line"><span class="attr">      - name:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.name&#125;</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">        version:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.version&#125;</span> <span class="comment"># 配置对应的 layer 版本</span></span><br><span class="line"><span class="attr">    environments:</span> <span class="comment">#  配置环境变量，同时也可以直接在 scf 控制台配置 </span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">NODE_ENV</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="comment"># 标签</span></span><br><span class="line"><span class="attr">      - key:</span> <span class="string">tagKey</span></span><br><span class="line"><span class="attr">        value:</span> <span class="string">tagValue</span></span><br><span class="line"><span class="attr">  apigw:</span> <span class="comment"># http 组件会默认帮忙创建一个 API 网关服务</span></span><br><span class="line"><span class="attr">    isDisabled:</span> <span class="literal">false</span> <span class="comment"># 是否禁用自动创建 API 网关功能</span></span><br><span class="line">    <span class="comment"># id: service-xxx # api网关服务ID，不填则自动新建网关</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">serverless</span> <span class="comment"># api网关服务名称</span></span><br><span class="line"><span class="attr">    api:</span> <span class="comment"># 创建的 API 相关配置</span></span><br><span class="line"><span class="attr">      cors:</span> <span class="literal">true</span> <span class="comment">#  允许跨域</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">30</span> <span class="comment"># API 超时时间</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">apiName</span> <span class="comment"># API 名称</span></span><br><span class="line"><span class="attr">      qualifier:</span> <span class="string">$DEFAULT</span> <span class="comment"># API 关联的版本</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>
<p>排除<code>node_modules</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">node_modules/**</span> <span class="comment"># deploy 时排除 node_modules [需要注意] 使用layer的node_modules</span></span><br></pre></td></tr></table></figure>
<p>配置层</p>
<blockquote>
<p>引用格式请参考 变量引用说明 <a href="https://github.com/AprilJC/Serverless-Framework-Docs/blob/main/docs/%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8.md#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">https://github.com/AprilJC/Serverless-Framework-Docs/blob/main/docs/%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8.md#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E8%AF%B4%E6%98%8E</a></p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">layers:</span> </span><br><span class="line"><span class="attr">    - name:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.name&#125;</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">    version:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.version&#125;</span> <span class="comment"># 配置对应的 layer 版本</span></span><br></pre></td></tr></table></figure>
<p>通过配置层layer，代码和<code>node_modules</code>分离，<code>sls deploy</code>更快</p>
<blockquote>
<p>接着执行命令 <code>sls deploy --target=./layer</code>部署层，然后再次部署<code>sls deploy</code>看看速度应该更快了</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/f5d5c8b90fdf942c.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/6683161cf18fc51c.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/88d1098b222f184b.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/b5b0c69b6962434d.png" alt></p>
<p>每次<code>node_modules</code>改变都需要 </p>
<ul>
<li>执行 <code>sls deploy --target=./layer</code> 部署层， 更新 <code>node_modules</code> 层</li>
<li>执行 <code>sls deploy</code> 重新部署</li>
</ul>
<p><strong>layer 的加载与访问</strong></p>
<blockquote>
<p>layer 会在函数运行时，将内容解压到 <code>/opt</code> 目录下，如果存在多个 <code>layer</code>，那么会按时间循序进行解压。如果需要访问 <code>layer</code> 内的文件，可以直接通过 <code>/opt/xxx</code> 访问。如果是访问 <code>node_module</code> 则可以直接 <code>import</code>，因为 <code>scf</code> 的 <code>NODE_PATH</code> 环境变量默认已包含 <code>/opt/node_modules</code> 路径。</p>
</blockquote>
<h3 id="使用serverless-fromwork的高阶egg组件方式部署-不推荐"><a href="#使用serverless-fromwork的高阶egg组件方式部署-不推荐" class="headerlink" title="使用serverless fromwork的高阶egg组件方式部署(不推荐)"></a>使用serverless fromwork的高阶egg组件方式部署(不推荐)</h3><blockquote>
<p>目前推荐使用 web 函数，也就是 <code>HTTP 组件</code>，现在所有的serverless web 应用都是基于 <code>component: http</code> 组件的。</p>
</blockquote>
<ol>
<li>在项目根目录下创建 <code>serverless.yml</code>文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i serverless -g</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-egg/blob/master/docs/configure.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># serverless.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">component:</span> <span class="string">egg</span> <span class="comment"># (必选) 组件名称，在该实例中为egg</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">egg-demo</span> <span class="comment"># 必选) 组件实例名称.</span></span><br><span class="line"><span class="comment"># org: orgDemo # (可选) 用于记录组织信息，默认值为您的腾讯云账户 appid，必须为字符串</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">egg-demo</span> <span class="comment"># (可选) 用于记录组织信息. 默认与name相同，必须为字符串</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span> <span class="comment"># (可选) 用于区分环境信息，默认值是 dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  functionName:</span> <span class="string">egg-demo</span> <span class="comment"># 云函数名称</span></span><br><span class="line">  <span class="comment"># serviceName: egg-demo # api网关服务名称</span></span><br><span class="line"><span class="attr">  runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行环境</span></span><br><span class="line">  <span class="comment"># serviceId: service-np1uloxw # api网关服务ID</span></span><br><span class="line">  <span class="comment"># entryFile: sls.js # 自定义 server 的入口文件名，默认为 sls.js，如果不想修改文件名为 sls.js 可以自定义</span></span><br><span class="line">  <span class="comment"># src: ./ # 第一种为string时，会打包src对应目录下的代码上传到默认cos上。</span></span><br><span class="line"><span class="attr">  src:</span>  <span class="comment"># 第二种，部署src下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span>  <span class="comment"># 本地需要打包的文件目录</span></span><br><span class="line">    <span class="comment"># bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line"><span class="attr">    exclude:</span>   <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"node_modules/**"</span></span><br><span class="line">  <span class="comment"># src: # 第三种，在指定存储桶bucket中已经存在了object代码，直接部署</span></span><br><span class="line">  <span class="comment">#   bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line">  <span class="comment">#   object: cos.zip  # bucket key 指定存储桶内的文件</span></span><br><span class="line">  <span class="comment"># layers: </span></span><br><span class="line">  <span class="comment">#   - name: $&#123;output:$&#123;stage&#125;:$&#123;app&#125;:egg-demo-layer.name&#125; # 配置对应的 layer</span></span><br><span class="line">  <span class="comment">#     version: $&#123;output:$&#123;stage&#125;:$&#123;app&#125;:egg-demo-layer.version&#125; # 配置对应的 layer 版本</span></span><br><span class="line"><span class="attr">  functionConf:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    eip:</span> <span class="literal">false</span> <span class="comment"># 是否固定出口IP</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，单位MB</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="comment">#  环境变量</span></span><br><span class="line"><span class="attr">      variables:</span> <span class="comment">#  环境变量数组</span></span><br><span class="line"><span class="attr">        NODE_ENV:</span> <span class="string">production</span></span><br><span class="line">    <span class="comment"># vpcConfig: # 私有网络配置</span></span><br><span class="line">      <span class="comment"># vpcId: '' # 私有网络的Id</span></span><br><span class="line">      <span class="comment"># subnetId: '' # 子网ID</span></span><br><span class="line"><span class="attr">  apigatewayConf:</span> <span class="comment">#  api网关配置</span></span><br><span class="line"><span class="attr">    isDisabled:</span> <span class="literal">false</span> <span class="comment"># 是否禁用自动创建 API 网关功能</span></span><br><span class="line"><span class="attr">    enableCORS:</span> <span class="literal">true</span> <span class="comment">#  允许跨域</span></span><br><span class="line">    <span class="comment"># customDomains: # 自定义域名绑定</span></span><br><span class="line">    <span class="comment">#   - domain: abc.com # 待绑定的自定义的域名</span></span><br><span class="line">    <span class="comment">#     certificateId: abcdefg # 待绑定自定义域名的证书唯一 ID</span></span><br><span class="line">    <span class="comment">#     # 如要设置自定义路径映射，请设置为 false</span></span><br><span class="line">    <span class="comment">#     isDefaultMapping: false</span></span><br><span class="line">    <span class="comment">#     # 自定义路径映射的路径。使用自定义映射时，可一次仅映射一个 path 到一个环境，也可映射多个 path 到多个环境。并且一旦使用自定义映射，原本的默认映射规则不再生效，只有自定义映射路径生效。</span></span><br><span class="line">    <span class="comment">#     pathMappingSet:</span></span><br><span class="line">    <span class="comment">#       - path: /</span></span><br><span class="line">    <span class="comment">#         environment: release</span></span><br><span class="line">    <span class="comment">#     protocols: # 绑定自定义域名的协议类型，默认与服务的前端协议一致。</span></span><br><span class="line">    <span class="comment">#       - http # 支持http协议</span></span><br><span class="line">    <span class="comment">#       - https # 支持https协议</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">release</span> <span class="comment"># 网关环境</span></span><br><span class="line"><span class="attr">    serviceTimeout:</span> <span class="number">60</span> <span class="comment"># 网关超时</span></span><br><span class="line">    <span class="comment"># usagePlan: #  用户使用计划</span></span><br><span class="line">    <span class="comment">#   usagePlanId: 1111</span></span><br><span class="line">    <span class="comment">#   usagePlanName: slscmp</span></span><br><span class="line">    <span class="comment">#   usagePlanDesc: sls create</span></span><br><span class="line">    <span class="comment">#   maxRequestNum: 1000</span></span><br><span class="line">    <span class="comment"># auth: #  密钥</span></span><br><span class="line">    <span class="comment">#   secretName: secret</span></span><br><span class="line">    <span class="comment">#   secretIds:</span></span><br><span class="line">    <span class="comment">#     - xxx</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将代码推送到云端</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls deploy # sls deploy --debug可以查看日志</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>扫描登录部署会在项目下创建一个<code>.env</code>的<code>serverless</code>的登录信息</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/4bb68977c923970f.png" alt></p>
<ol start="4">
<li>部署成功，打开地址访问，此时会报错，我们没有把node_modules一起上传</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/b6d50b9d2070559c.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/fecba16d7e2071eb.png" alt></p>
<p>浏览器打开提示缺少模块</p>
<p><img src="https://s.poetries.work/uploads/2022/06/08a0618ffe147378.png" alt></p>
<p>我们在控制台上点击</p>
<p><img src="https://s.poetries.work/uploads/2022/06/e6454fd010815c3f.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/50bcc5c01f3af862.png" alt></p>
<p>打开自动安装依赖后重新部署即可看到<code>node_modules</code>，这时再次访问浏览器地址</p>
<p><img src="https://s.poetries.work/uploads/2022/06/fd6229e7d654a470.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/53fa2c373a8a69cd.png" alt></p>
<h2 id="3-4-sls部署nestjs项目"><a href="#3-4-sls部署nestjs项目" class="headerlink" title="3.4 sls部署nestjs项目"></a>3.4 sls部署nestjs项目</h2><h3 id="模板部署-–-部署-Nest-js-示例代码"><a href="#模板部署-–-部署-Nest-js-示例代码" class="headerlink" title="模板部署 – 部署 Nest.js 示例代码"></a>模板部署 – 部署 Nest.js 示例代码</h3><ol>
<li>登录 <a href="https://console.cloud.tencent.com/sls" target="_blank" rel="noopener">Serverless 应用控制台</a>。</li>
<li>单击新建应用，选择Web 应用&gt;Nest.js 框架，如下图所示：</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/c05fcae4ea2a8593.png" alt></p>
<ol start="3">
<li>单击“下一步”，完成基础配置选择</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/c23d3219be7ab860.png" alt></p>
<ul>
<li>上传方式，选择示例代码直接部署，单击完成，即可开始应用的部署。</li>
<li>部署完成后，您可在应用详情页面，查看示例应用的基本信息，并通过 API 网关生成的访问路径 URL 进行访问，查看您部署的 Nest.js 项目</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/06/60f6e95248310f40.png" alt></p>
<h3 id="自定义模板部署nest-推荐"><a href="#自定义模板部署nest-推荐" class="headerlink" title="自定义模板部署nest(推荐)"></a>自定义模板部署nest(推荐)</h3><p><strong>初始化您的 Nest.js 项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br><span class="line">nest new nest-app</span><br></pre></td></tr></table></figure>
<p>在根目录下，执行以下命令在本地直接启动服务。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd nest-app &amp;&amp; npm run start</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问 <a href="http://localhost:3000，即可在本地完成" target="_blank" rel="noopener">http://localhost:3000，即可在本地完成</a> Nest.js 示例项目的访问。</p>
<p><strong>部署上云</strong></p>
<p>接下来执行以下步骤，对已初始化的项目进行简单修改，使其可以通过 Web Function 快速部署，此处项目改造通常分为以下两步：</p>
<ul>
<li>新增 <code>scf_bootstrap</code> 启动文件。</li>
<li>修改监听地址与端口为 <code>0.0.0.0:9000</code>。</li>
</ul>
<ol>
<li>修改启动文件<code>main.ts</code>，监听端口改为<code>9000</code>:</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/12736ad9dda9b911.png" alt></p>
<ol start="2">
<li>在项目根目录下新建 <code>scf_bootstrap</code> 启动文件，在该文件添加如下内容（用于启动服务）：</li>
</ol>
<p>您也可以在控制台完成该模块配置。</p>
<p><img src="https://s.poetries.work/uploads/2022/06/9a96d63935762fc3.png" alt></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># scf_bootstrap</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SERVERLESS=1 /var/lang/node12/bin/node ./dist/main.js</span><br></pre></td></tr></table></figure>
<p>新建完成后，还需执行以下命令修改文件可执行权限，默认需要 777 或 755 权限才可正常启动。示例如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 777 scf_bootstrap</span><br></pre></td></tr></table></figure>
<p>本地配置完成后，执行启动文件，确保您的服务可以本地正常启动，接下来，登录 Serverless 应用控制台，选择Web 应用&gt;Nest.js 框架，上传方式可以选择本地上传或代码仓库拉取</p>
<blockquote>
<p>注意：启动文件以项目内文件为准，如果您的项目里已经包含 scf_bootstrap 文件，将不会覆盖该内容。</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/c1fe93fe050d5f5c.png" alt></p>
<h3 id="使用http组件-推荐"><a href="#使用http组件-推荐" class="headerlink" title="使用http组件(推荐)"></a>使用http组件(推荐)</h3><blockquote>
<p>目前推荐使用 web 函数，也就是 <code>HTTP 组件</code>，现在所有的serverless web 应用都是基于 <code>component: http</code> 组件的。</p>
</blockquote>
<blockquote>
<p>详情查看：<a href="https://github.com/serverless-components/tencent-http" target="_blank" rel="noopener">https://github.com/serverless-components/tencent-http</a> </p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编写完善配置文件 serverless.yml</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">nest-app</span> <span class="comment"># 应用名称</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">http</span> <span class="comment"># http组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nest-demo</span> <span class="comment"># 实例名称</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  src:</span> <span class="comment"># 部署当前目录下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> <span class="comment"># 当前目录</span></span><br><span class="line"><span class="attr">    exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'node_modules/**'</span> <span class="comment"># 忽略node_modules，在控制台安装</span></span><br><span class="line">  <span class="comment"># src: # 在指定存储桶bucket中已经存在了object代码，直接部署</span></span><br><span class="line">  <span class="comment">#   bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line">  <span class="comment">#   object: cos.zip  # bucket key 指定存储桶内的文件</span></span><br><span class="line"><span class="attr">  faas:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行时</span></span><br><span class="line">    <span class="comment"># 支持的框架查看 https://cloud.tencent.com/document/product/1154/59447#framework</span></span><br><span class="line"><span class="attr">    framework:</span> <span class="string">nestjs</span> <span class="comment"># #选择框架，此处以 egg 为例 </span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">$&#123;name&#125;</span> <span class="comment"># 云函数名称，通过变量形式获取name的值</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，默认 512 MB</span></span><br><span class="line">    <span class="comment"># layers:</span></span><br><span class="line">    <span class="comment">#   - name: layerName #  layer名称</span></span><br><span class="line">    <span class="comment">#     version: 1 #  版本</span></span><br><span class="line"><span class="attr">    environments:</span> <span class="comment">#  配置环境变量，同时也可以直接在 scf 控制台配置 </span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">NODE_ENV</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">production</span></span><br><span class="line">    <span class="comment"># vpc: # 私有网络配置</span></span><br><span class="line">    <span class="comment">#   vpcId: 'vpc-xxx' # 私有网络的Id</span></span><br><span class="line">    <span class="comment">#   subnetId: 'subnet-xxx' # 子网ID</span></span><br><span class="line">    <span class="comment"># tags:</span></span><br><span class="line">    <span class="comment">#   - key: tagKey</span></span><br><span class="line">    <span class="comment">#     value: tagValue</span></span><br><span class="line"><span class="attr">  apigw:</span> <span class="comment"># http 组件会默认帮忙创建一个 API 网关服务</span></span><br><span class="line"><span class="attr">    isDisabled:</span> <span class="literal">false</span> <span class="comment"># 是否禁用自动创建 API 网关功能</span></span><br><span class="line">    <span class="comment"># id: service-xx # api网关服务ID，不填则自动新建网关</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">serverless</span> <span class="comment"># api网关服务名称</span></span><br><span class="line"><span class="attr">    api:</span> <span class="comment"># 创建的 API 相关配置</span></span><br><span class="line"><span class="attr">      cors:</span> <span class="literal">true</span> <span class="comment">#  允许跨域</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">30</span> <span class="comment"># API 超时时间</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">apiName</span> <span class="comment"># API 名称</span></span><br><span class="line"><span class="attr">      qualifier:</span> <span class="string">$DEFAULT</span> <span class="comment"># API 关联的版本</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">test</span></span><br><span class="line">    <span class="comment"># tags:</span></span><br><span class="line">    <span class="comment">#   - key: tagKey</span></span><br><span class="line">    <span class="comment">#     value: tagValue</span></span><br><span class="line">    <span class="comment"># customDomains: # 自定义域名绑定</span></span><br><span class="line">    <span class="comment">#   - domain: abc.com # 待绑定的自定义的域名</span></span><br><span class="line">    <span class="comment">#     certId: abcdefg # 待绑定自定义域名的证书唯一 ID</span></span><br><span class="line">    <span class="comment">#     # 如要设置自定义路径映射，(customMap = true isDefaultMapping = false)必须两者同时出现 其余情况都是默认路径</span></span><br><span class="line">    <span class="comment">#     customMap: true</span></span><br><span class="line">    <span class="comment">#     isDefaultMapping: false</span></span><br><span class="line">    <span class="comment">#     # 自定义路径映射的路径。使用自定义映射时，可一次仅映射一个 path 到一个环境，也可映射多个 path 到多个环境。并且一旦使用自定义映射，原本的默认映射规则不再生效，只有自定义映射路径生效。</span></span><br><span class="line">    <span class="comment">#     pathMap:</span></span><br><span class="line">    <span class="comment">#       - path: /</span></span><br><span class="line">    <span class="comment">#         environment: release</span></span><br><span class="line">    <span class="comment">#     protocols: # 绑定自定义域名的协议类型，默认与服务的前端协议一致。</span></span><br><span class="line">    <span class="comment">#       - http # 支持http协议</span></span><br><span class="line">    <span class="comment">#       - https # 支持https协议</span></span><br><span class="line">    <span class="comment"># app: #  应用授权配置</span></span><br><span class="line">    <span class="comment">#   id: app-xxx</span></span><br><span class="line">    <span class="comment">#   name: app_demo</span></span><br><span class="line">    <span class="comment">#   description: app description</span></span><br></pre></td></tr></table></figure>
<p>在项目根目录下新建 <code>scf_bootstrap</code> 启动文件，在该文件添加如下内容（用于启动服务）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SERVERLESS=1 /var/lang/node12/bin/node ./dist/main.js</span><br></pre></td></tr></table></figure>
<p>忽略<code>node_modules</code>文件上传</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># serverless.yml</span></span><br><span class="line"><span class="attr">exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">node_modules/**</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>sls deploy</code> （<code>sls deploy --debug</code> 查看部署日志）</p>
<p><img src="https://s.poetries.work/uploads/2022/06/15d73875b2f56fd4.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/903af650eb01b169.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/a47a05e9bd8eb7c9.png" alt></p>
<p><strong>查看部署信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls info</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/68b296819ee39d4f.png" alt></p>
<p><strong>实时开发并上传</strong></p>
<blockquote>
<p>每次改动文件，都实时部署</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls dev</span><br></pre></td></tr></table></figure>
<p><strong>删除部署项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls remove</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/1c33faad7da0be9c.png" alt></p>
<h3 id="使用Layer-来减小项目文件大小-1"><a href="#使用Layer-来减小项目文件大小-1" class="headerlink" title="使用Layer 来减小项目文件大小"></a>使用Layer 来减小项目文件大小</h3><p>随着项目复杂度的增加，<code>deploy</code> 上传会变慢。所以，让我们再优化一下，在项目根目录创建 <code>layer/serverless.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># layer/serverless.yml</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/51133</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-layer/blob/master/docs/configure.md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">nestjs-demo</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">layer</span> <span class="comment"># 组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nestjs-demo-layer</span> <span class="comment"># 层名称 必须</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件参数配置，根据每个组件，实现具体的资源信息配置</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nestjs-demo-layer</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">../node_modules</span></span><br><span class="line"><span class="attr">    targetDir:</span> <span class="string">/node_modules</span></span><br><span class="line"><span class="attr">  runtimes:</span> <span class="comment"># 层支持的运行环境</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">Nodejs12.16</span></span><br><span class="line"><span class="attr">  description:</span> <span class="string">layer</span> <span class="string">description</span> <span class="comment"># 否 描述</span></span><br></pre></td></tr></table></figure>
<p><strong>修改以上项目下的serverless.yml加入层配置</strong></p>
<p>回到项目根目录，调整一下根目录的 <code>serverless.yml</code>下的<code>layers</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编写完善配置文件 serverless.yml</span></span><br><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">nestjs-demo</span> <span class="comment"># 应用名称</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">http</span> <span class="comment"># http组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">http-nestjs</span> <span class="comment"># 实例名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  src:</span> <span class="comment"># 部署当前目录下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    dist:</span> <span class="string">./</span> <span class="comment"># build后的包</span></span><br><span class="line"><span class="attr">    hook:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="comment"># 先构建在上传</span></span><br><span class="line"><span class="attr">    exclude:</span> <span class="comment"># 排除的文件</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules/**</span> <span class="comment"># deploy 时排除 node_modules [需要注意] 使用layer的node_modules</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> <span class="comment"># 当前目录</span></span><br><span class="line"><span class="attr">  faas:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行时</span></span><br><span class="line"><span class="attr">    framework:</span> <span class="string">nestjs</span> <span class="comment"># #选择框架，此处以 nestjs 为例 </span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">'$&#123;name&#125;'</span> <span class="comment"># 云函数名称，通过变量形式获取name的值</span></span><br><span class="line"><span class="attr">    eip:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，默认 512 MB</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    environments:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    layers:</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:nestjs-demo-layer.name&#125;</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">        version:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:nestjs-demo-layer.version&#125;</span> <span class="comment"># 配置对应的 layer 版本</span></span><br><span class="line"><span class="attr">  apigw:</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">    customDomains:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  isAutoCiDeploy:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>排除<code>node_modules</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">exclude:</span> <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">node_modules/**</span> <span class="comment"># deploy 时排除 node_modules [需要注意] 使用layer的node_modules</span></span><br></pre></td></tr></table></figure>
<p>配置层</p>
<blockquote>
<p>引用格式请参考 变量引用说明 <a href="https://github.com/AprilJC/Serverless-Framework-Docs/blob/main/docs/%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8.md#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">https://github.com/AprilJC/Serverless-Framework-Docs/blob/main/docs/%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8.md#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8%E8%AF%B4%E6%98%8E</a></p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">layers:</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:nestjs-demo-layer.name&#125;</span> <span class="comment"># 配置对应的 layer</span></span><br><span class="line"><span class="attr">    version:</span> <span class="string">$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:nestjs-demo-layer.version&#125;</span> <span class="comment"># 配置对应的 layer 版本</span></span><br></pre></td></tr></table></figure>
<p>通过配置层layer，代码和<code>node_modules</code>分离，<code>sls deploy</code>更快</p>
<blockquote>
<p>接着执行命令 <code>sls deploy --target=./layer</code>部署层，然后再次部署<code>sls deploy</code>看看速度应该更快了</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/b1a9175c8c6d1404.png" alt></p>
<p>每次<code>node_modules</code>改变都需要 </p>
<ul>
<li>执行 <code>sls deploy --target=./layer</code> 先部署层， 更新 <code>node_modules</code> 层</li>
<li>执行 <code>sls deploy</code> 重新部署</li>
</ul>
<p><strong>layer 的加载与访问</strong></p>
<blockquote>
<p>layer 会在函数运行时，将内容解压到 <code>/opt</code> 目录下，如果存在多个 <code>layer</code>，那么会按时间循序进行解压。如果需要访问 <code>layer</code> 内的文件，可以直接通过 <code>/opt/xxx</code> 访问。如果是访问 <code>node_module</code> 则可以直接 <code>import</code>，因为 <code>scf</code> 的 <code>NODE_PATH</code> 环境变量默认已包含 <code>/opt/node_modules</code> 路径。</p>
</blockquote>
<h3 id="使用serverless-framework的高阶nestjs组件部署-不推荐"><a href="#使用serverless-framework的高阶nestjs组件部署-不推荐" class="headerlink" title="使用serverless framework的高阶nestjs组件部署(不推荐)"></a>使用serverless framework的高阶nestjs组件部署(不推荐)</h3><blockquote>
<p>目前推荐使用 web 函数，也就是 <code>HTTP 组件</code>，现在所有的serverless web 应用都是基于 <code>component: http</code> 组件的。</p>
</blockquote>
<p><strong>初始化项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br><span class="line">nest new nest-app</span><br></pre></td></tr></table></figure>
<p>在根目录下，执行以下命令在本地直接启动服务。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd nest-app &amp;&amp; npm run start</span><br></pre></td></tr></table></figure>
<p><strong>编写项目根目录下serverless.yml文件</strong></p>
<p><strong>全部配置详情</strong></p>
<blockquote>
<p><a href="https://github.com/serverless-components/tencent-nestjs/blob/master/docs/configure.md" target="_blank" rel="noopener">https://github.com/serverless-components/tencent-nestjs/blob/master/docs/configure.md</a></p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># serverless.yml</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">nestjs</span> <span class="comment"># (必选) 组件名称，在该实例中为nestjs</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nest-demo</span> <span class="comment"># 必选) 组件实例名称.</span></span><br><span class="line"><span class="comment"># org: orgDemo # (可选) 用于记录组织信息，默认值为您的腾讯云账户 appid，必须为字符串</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">app-nest-demo</span> <span class="comment"># (可选) 用于记录组织信息. 默认与name相同，必须为字符串</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span> <span class="comment"># (可选) 用于区分环境信息，默认值是 dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span> <span class="comment"># 云函数所在区域</span></span><br><span class="line"><span class="attr">  functionName:</span> <span class="string">nest-demo</span> <span class="comment"># 云函数名称</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">nest-demo</span> <span class="comment"># api网关服务名称</span></span><br><span class="line"><span class="attr">  runtime:</span> <span class="string">Nodejs12.16</span> <span class="comment"># 运行环境</span></span><br><span class="line">  <span class="comment"># serviceId: service-jfdasew2112 # api网关服务ID 不填默认创建</span></span><br><span class="line">  <span class="comment"># entryFile: sls.js # 自定义 server 的入口文件名，默认为 sls.js，如果不想修改文件名为 sls.js 可以自定义</span></span><br><span class="line">  <span class="comment"># src: ./ # 第一种为string时，会打包src对应目录下的代码上传到默认cos上。</span></span><br><span class="line"><span class="attr">  src:</span>  <span class="comment"># 第二种，部署src下的文件代码，并打包成zip上传到bucket上</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span>  <span class="comment"># 本地需要打包的文件目录</span></span><br><span class="line">    <span class="comment"># bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line"><span class="attr">    exclude:</span>   <span class="comment"># 被排除的文件或目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line">      <span class="comment">#- "node_modules/**"</span></span><br><span class="line">  <span class="comment"># src: # 第三种，在指定存储桶bucket中已经存在了object代码，直接部署</span></span><br><span class="line">  <span class="comment">#   bucket: bucket01 # bucket name，当前会默认在bucket name后增加 appid 后缀, 本例中为 bucket01-appid</span></span><br><span class="line">  <span class="comment">#   object: cos.zip  # bucket key 指定存储桶内的文件</span></span><br><span class="line">  <span class="comment"># layers: </span></span><br><span class="line">    <span class="comment">#   - name: $&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.name&#125; # 配置对应的 layer</span></span><br><span class="line">    <span class="comment">#     version: $&#123;output:$&#123;stage&#125;:$&#123;app&#125;:$&#123;name&#125;-layer.version&#125; # 配置对应的 layer 版本</span></span><br><span class="line"><span class="attr">  functionConf:</span> <span class="comment"># 函数配置相关</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span> <span class="comment"># 超时时间，单位秒</span></span><br><span class="line"><span class="attr">    eip:</span> <span class="literal">false</span> <span class="comment"># 是否固定出口IP</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span> <span class="comment"># 内存大小，单位MB</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="comment">#  环境变量</span></span><br><span class="line"><span class="attr">      variables:</span> <span class="comment">#  环境变量数组</span></span><br><span class="line"><span class="attr">        NODE_ENV:</span> <span class="string">production</span></span><br><span class="line">    <span class="comment"># vpcConfig: # 私有网络配置</span></span><br><span class="line">      <span class="comment"># vpcId: '' # 私有网络的Id</span></span><br><span class="line">      <span class="comment"># subnetId: '' # 子网ID</span></span><br><span class="line"><span class="attr">  apigatewayConf:</span> <span class="comment">#  api网关配置</span></span><br><span class="line"><span class="attr">    isDisabled:</span> <span class="literal">false</span> <span class="comment"># 是否禁用自动创建 API 网关功能</span></span><br><span class="line"><span class="attr">    enableCORS:</span> <span class="literal">true</span> <span class="comment">#  允许跨域</span></span><br><span class="line">    <span class="comment"># customDomains: # 自定义域名绑定</span></span><br><span class="line">    <span class="comment">#   - domain: abc.com # 待绑定的自定义的域名</span></span><br><span class="line">    <span class="comment">#     certificateId: abcdefg # 待绑定自定义域名的证书唯一 ID</span></span><br><span class="line">    <span class="comment">#     # 如要设置自定义路径映射，请设置为 false</span></span><br><span class="line">    <span class="comment">#     isDefaultMapping: false</span></span><br><span class="line">    <span class="comment">#     # 自定义路径映射的路径。使用自定义映射时，可一次仅映射一个 path 到一个环境，也可映射多个 path 到多个环境。并且一旦使用自定义映射，原本的默认映射规则不再生效，只有自定义映射路径生效。</span></span><br><span class="line">    <span class="comment">#     pathMappingSet:</span></span><br><span class="line">    <span class="comment">#       - path: /</span></span><br><span class="line">    <span class="comment">#         environment: release</span></span><br><span class="line">    <span class="comment">#     protocols: # 绑定自定义域名的协议类型，默认与服务的前端协议一致。</span></span><br><span class="line">    <span class="comment">#       - http # 支持http协议</span></span><br><span class="line">    <span class="comment">#       - https # 支持https协议</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">test</span> <span class="comment"># 网关环境</span></span><br><span class="line"><span class="attr">    serviceTimeout:</span> <span class="number">60</span> <span class="comment"># 网关超时</span></span><br><span class="line">    <span class="comment"># usagePlan: #  用户使用计划</span></span><br><span class="line">    <span class="comment">#   usagePlanId: 1111</span></span><br><span class="line">    <span class="comment">#   usagePlanName: slscmp</span></span><br><span class="line">    <span class="comment">#   usagePlanDesc: sls create</span></span><br><span class="line">    <span class="comment">#   maxRequestNum: 1000</span></span><br><span class="line">    <span class="comment"># auth: #  密钥</span></span><br><span class="line">    <span class="comment">#   secretName: secret</span></span><br><span class="line">    <span class="comment">#   secretIds:</span></span><br><span class="line">    <span class="comment">#     - xxx</span></span><br></pre></td></tr></table></figure>
<h2 id="3-5-sls部署koa项目"><a href="#3-5-sls部署koa项目" class="headerlink" title="3.5 sls部署koa项目"></a>3.5 sls部署koa项目</h2><h3 id="控制台部署"><a href="#控制台部署" class="headerlink" title="控制台部署"></a>控制台部署</h3><ol>
<li>登录 <a href="https://console.cloud.tencent.com/sls" target="_blank" rel="noopener">Serverless 应用控制台</a>。</li>
<li>单击新建应用，选择Web 应用&gt;Koa 框架，如下图所示：</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/6382481121ebc584.png" alt></p>
<ol start="3">
<li>单击“下一步”，完成基础配置选择。</li>
<li>上传方式，选择示例代码直接部署，单击完成，即可开始应用的部署。</li>
<li>部署完成后，您可在应用详情页面，查看示例应用的基本信息，并通过 API 网关生成的访问路径 URL 进行访问，查看您部署的 Koa 项目</li>
</ol>
<p><img src="https://s.poetries.work/uploads/2022/06/6ab832e2d0343c64.png" alt></p>
<h3 id="自定义模板部署"><a href="#自定义模板部署" class="headerlink" title="自定义模板部署"></a>自定义模板部署</h3><p>全局安装 <code>koa-generator</code> 脚手架.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g koa-generator</span><br></pre></td></tr></table></figure>
<p>创建项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 使用ejs引擎</span><br><span class="line">koa2 -e koa-demo</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd koa-demo // 进入项目根目录</span><br><span class="line">npm install // 安装项目依赖</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>
<p><strong>部署上云</strong></p>
<p>接下来执行以下步骤，对已初始化的项目进行简单修改，使其可以通过 Web Function 快速部署，此处项目改造通常分为以下两步：</p>
<ul>
<li>修改监听地址与端口为 <code>0.0.0.0:9000</code>。</li>
</ul>
<p><strong>具体步骤如下：</strong></p>
<p>在 Koa 示例项目中，修改监听端口到 <code>9000</code></p>
<p><img src="https://s.poetries.work/uploads/2022/06/6be48886a199d8df.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/dd5fd8c12cb5d46a.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/f4edaeba5e1bd1f2.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/92152ad6865809d8.png" alt></p>
<h3 id="使用HTTP组件部署"><a href="#使用HTTP组件部署" class="headerlink" title="使用HTTP组件部署"></a>使用HTTP组件部署</h3><p><strong>编写serverless.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 文档 https://github.com/serverless-components/tencent-http/blob/master/docs/configure.md</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/59447</span></span><br><span class="line"><span class="comment"># org: '1258157827'</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">koa-demo</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">http</span> <span class="comment"># http组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">koa-demo</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span></span><br><span class="line"><span class="attr">    exclude:</span> <span class="comment"># 排除文件，在控制台WEBIDE开启自动安装依赖</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  isAutoCiDeploy:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  faas:</span></span><br><span class="line"><span class="attr">    runtime:</span> <span class="string">Nodejs12.16</span></span><br><span class="line"><span class="attr">    eip:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    memorySize:</span> <span class="number">512</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    framework:</span> <span class="string">koa</span> <span class="comment"># koa框架</span></span><br><span class="line"><span class="attr">    environments:</span> <span class="string">[]</span></span><br><span class="line">    <span class="comment"># layers:</span></span><br><span class="line">    <span class="comment">#   - name: '$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:koa-demo-layer.name&#125;'</span></span><br><span class="line">    <span class="comment">#     version: '$&#123;output:$&#123;stage&#125;:$&#123;app&#125;:koa-demo-layer.version&#125;'</span></span><br><span class="line"><span class="attr">  apigw:</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">    customDomains:</span> <span class="string">[]</span></span><br></pre></td></tr></table></figure>
<p><strong>项目根目录新增 scf_bootstrap 启动文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch scf_bootstrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还需执行以下命令修改文件可执行权限，默认需要 777 或 755 权限才可正常启动</span></span><br><span class="line">chmod 777 scf_bootstrap</span><br></pre></td></tr></table></figure>
<blockquote>
<p>scf_bootstrap</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/var/lang/node12/bin/node bin/www <span class="comment"># 修改入口为bin/www，并且修改bin/www下端口为9000</span></span><br></pre></td></tr></table></figure>
<p><strong>部署</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/74ac915db74d3dd6.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/34fceabfeb33c9e9.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/4dcbaf2dbb72cef4.png" alt></p>
<p><strong>查看部署信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls info</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/80ed7651618d4bd1.png" alt></p>
<p><strong>移除</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls remove</span><br></pre></td></tr></table></figure>
<h1 id="四、部署静态网站"><a href="#四、部署静态网站" class="headerlink" title="四、部署静态网站"></a>四、部署静态网站</h1><ul>
<li>全部配置 <a href="https://github.com/serverless-components/tencent-website/blob/master/docs/configure.md" target="_blank" rel="noopener">https://github.com/serverless-components/tencent-website/blob/master/docs/configure.md</a></li>
<li>部署文档 <a href="https://cloud.tencent.com/document/product/1154/39276" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/1154/39276</a></li>
</ul>
<blockquote>
<p>部署的静态资源会存储到COS中</p>
</blockquote>
<h2 id="4-1-sls部署vue项目"><a href="#4-1-sls部署vue项目" class="headerlink" title="4.1 sls部署vue项目"></a>4.1 sls部署vue项目</h2><p><strong>初始化项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vue init webpack vue-demo</span><br></pre></td></tr></table></figure>
<p><strong>编写serverless.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-website/blob/master/docs/configure.md</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/39276</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">website</span> <span class="comment"># (必填) 引用 component 的名称，当前用到的是 tencent-website 组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">vue-demo</span> <span class="comment"># (必填) 该 website 组件创建的实例名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">vue-demo</span> <span class="comment"># (可选) 该 website 应用名称</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span> <span class="comment"># (可选) 用于区分环境信息，默认值是 dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line">    <span class="comment"># 部署项目的目录路径</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> </span><br><span class="line"><span class="attr">    dist:</span> <span class="string">./dist</span> <span class="comment"># build 完成后输出目录，如果配置 hook， 此参数必填</span></span><br><span class="line"><span class="attr">    index:</span> <span class="string">index.html</span> <span class="comment"># 网站主页入口文件</span></span><br><span class="line"><span class="attr">    error:</span> <span class="number">404.</span><span class="string">html</span> <span class="comment"># 网站错误入口文件</span></span><br><span class="line"><span class="attr">    hook:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="comment">#  构建命令,在代码上传之前执行</span></span><br><span class="line">    <span class="comment"># websitePath: ./</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  bucketName:</span> <span class="string">vue-test-demo</span> <span class="comment"># OSS存储桶名称</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">  replace:</span> <span class="literal">false</span> <span class="comment"># 是否覆盖式部署</span></span><br><span class="line"><span class="attr">  ignoreHtmlExt:</span> <span class="literal">false</span> <span class="comment"># 是否是否忽略 html 扩展名，默认 false</span></span><br><span class="line"><span class="attr">  disableErrorStatus:</span> <span class="literal">false</span> <span class="comment"># 是否禁用错误码，默认 false</span></span><br><span class="line"><span class="attr">  autoSetupAcl:</span> <span class="literal">true</span> <span class="comment"># 自动配置 bucket 访问权限为 ”公有读私有写“</span></span><br><span class="line"><span class="attr">  autoSetupPolicy:</span> <span class="literal">false</span> <span class="comment"># 自动配置 bucket 的 Policy 权限为 ”所有用户资源可读“</span></span><br><span class="line">  <span class="comment"># env: # 配置前端环境变量</span></span><br><span class="line">  <span class="comment">#   API_URL: https://api.com</span></span><br><span class="line">  <span class="comment"># hosts:</span></span><br><span class="line">  <span class="comment">#   - host: test.com # 自定义域名</span></span><br><span class="line">  <span class="comment">#     async: false # 是否同步等待 CDN 配置。配置为 false 时，参数 autoRefresh 自动刷新才会生效，如果关联多域名时，为防止超时建议配置为 true。</span></span><br><span class="line">  <span class="comment">#     autoRefresh: true #开启自动 CDN 刷新，用于快速更新和同步加速域名中展示的站点内容</span></span><br></pre></td></tr></table></figure>
<p>执行部署</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果希望查看更多部署过程的信息，可以通过<code>sls deploy --debug</code> 命令查看部署过程中的实时日志信息</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/06/22914c1b39955760.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/84f4b895e0ef3e1a.png" alt></p>
<p><strong>开发调试</strong></p>
<blockquote>
<p>部署了静态网站应用后，可以通过开发调试能力对该项目进行二次开发，从而开发一个生产应用。在本地修改和更新代码后，不需要每次都运行 <code>serverless deploy</code> 命令来反复部署。您可以直接通过 <code>serverless dev</code> 命令对本地代码的改动进行检测和自动上传。</p>
</blockquote>
<ul>
<li>可以通过在 <code>serverless.yml</code> 文件所在的目录下运行 <code>serverless dev</code> 命令开启开发调试能力。</li>
<li><code>serverless dev</code> 同时支持实时输出云端日志，每次部署完毕后，对项目进行访问，即可在命令行中实时输出调用日志，便于查看业务情况和排障。</li>
</ul>
<p><strong>查看状态</strong></p>
<p>在<code>serverless.yml</code>文件所在的目录下，通过如下命令查看部署状态：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">serverless info</span><br></pre></td></tr></table></figure>
<p><strong>移除</strong></p>
<p>在<code>serverless.yml</code>文件所在的目录下，通过以下命令移除部署的静态网站 <code>Website</code> 服务。移除后该组件会对应删除云上部署时所创建的所有相关资源。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ serverless remove</span><br></pre></td></tr></table></figure>
<blockquote>
<p>和部署类似，支持通过 <code>sls remove --debug</code> 命令查看移除过程中的实时日志信息</p>
</blockquote>
<h2 id="4-2-sls部署react项目"><a href="#4-2-sls部署react项目" class="headerlink" title="4.2 sls部署react项目"></a>4.2 sls部署react项目</h2><p><strong>初始化项目</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i create-umi -g</span><br><span class="line">create-umi react-demo</span><br></pre></td></tr></table></figure>
<p><strong>编写serverless.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-website/blob/master/docs/configure.md</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/39276</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">website</span> <span class="comment"># (必填) 引用 component 的名称，当前用到的是 tencent-website 组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">react-demo</span> <span class="comment"># (必填) 该 website 组件创建的实例名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">react-demo</span> <span class="comment"># (可选) 该 website 应用名称</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span> <span class="comment"># (可选) 用于区分环境信息，默认值是 dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line">    <span class="comment"># 执行目录路径</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span> </span><br><span class="line"><span class="attr">    dist:</span> <span class="string">./dist</span> <span class="comment"># 部署目录路劲</span></span><br><span class="line"><span class="attr">    index:</span> <span class="string">index.html</span> <span class="comment"># 网站主页入口文件</span></span><br><span class="line"><span class="attr">    error:</span> <span class="number">404.</span><span class="string">html</span> <span class="comment"># 网站错误入口文件</span></span><br><span class="line"><span class="attr">    hook:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="comment">#  构建命令,在代码上传之前执行</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  bucketName:</span> <span class="string">react-test-demo</span> <span class="comment"># OSS存储桶名称</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">  replace:</span> <span class="literal">false</span> <span class="comment"># 是否覆盖式部署</span></span><br><span class="line"><span class="attr">  ignoreHtmlExt:</span> <span class="literal">false</span> <span class="comment"># 是否是否忽略 html 扩展名，默认 false</span></span><br><span class="line"><span class="attr">  disableErrorStatus:</span> <span class="literal">false</span> <span class="comment"># 是否禁用错误码，默认 false</span></span><br><span class="line"><span class="attr">  autoSetupAcl:</span> <span class="literal">true</span> <span class="comment"># 自动配置 bucket 访问权限为 ”公有读私有写“</span></span><br><span class="line"><span class="attr">  autoSetupPolicy:</span> <span class="literal">false</span> <span class="comment"># 自动配置 bucket 的 Policy 权限为 ”所有用户资源可读“</span></span><br><span class="line">  <span class="comment"># env: # 配置前端环境变量</span></span><br><span class="line">  <span class="comment">#   API_URL: https://api.com</span></span><br><span class="line">  <span class="comment"># hosts:</span></span><br><span class="line">  <span class="comment">#   - host: test.com # 自定义域名</span></span><br><span class="line">  <span class="comment">#     async: false # 是否同步等待 CDN 配置。配置为 false 时，参数 autoRefresh 自动刷新才会生效，如果关联多域名时，为防止超时建议配置为 true。</span></span><br><span class="line">  <span class="comment">#     autoRefresh: true #开启自动 CDN 刷新，用于快速更新和同步加速域名中展示的站点内容</span></span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/8614efb6787a455f.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/4048c87e395ebe98.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/6aa33661c29780c8.png" alt></p>
<p>实时监控项目部署</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls dev</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/a226acca0bb48bed.png" alt></p>
<h2 id="4-3-sls部署vuepress项目"><a href="#4-3-sls部署vuepress项目" class="headerlink" title="4.3 sls部署vuepress项目"></a>4.3 sls部署vuepress项目</h2><p><img src="https://s.poetries.work/uploads/2022/06/3e7f22a3df08fa4b.png" alt></p>
<p><strong>编写serverless.yml配置</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/serverless-components/tencent-website/blob/master/docs/configure.md</span></span><br><span class="line"><span class="comment"># https://cloud.tencent.com/document/product/1154/39276</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">website</span> <span class="comment"># (必填) 引用 component 的名称，当前用到的是 tencent-website 组件</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">vuepress-demo</span> <span class="comment"># (必填) 该 website 组件创建的实例名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app:</span> <span class="string">vuepress-demo</span> <span class="comment"># (可选) 该 website 应用名称</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span> <span class="comment"># (可选) 用于区分环境信息，默认值是 dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">.vuepress</span> <span class="comment"># (必填) .vuepress源文件夹路径</span></span><br><span class="line"><span class="attr">    dist:</span> <span class="string">.vuepress/dist</span> <span class="comment"># 部署目录路径</span></span><br><span class="line"><span class="attr">    index:</span> <span class="string">index.html</span> <span class="comment"># 网站主页入口文件</span></span><br><span class="line"><span class="attr">    error:</span> <span class="number">404.</span><span class="string">html</span> <span class="comment"># 网站错误入口文件</span></span><br><span class="line"><span class="attr">    hook:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span> <span class="comment">#  构建命令,在代码上传之前执行</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  bucketName:</span> <span class="string">vuepress-test-demo</span> <span class="comment"># OSS存储桶名称</span></span><br><span class="line"><span class="attr">  protocol:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">  replace:</span> <span class="literal">false</span> <span class="comment"># 是否覆盖式部署</span></span><br><span class="line"><span class="attr">  ignoreHtmlExt:</span> <span class="literal">false</span> <span class="comment"># 是否是否忽略 html 扩展名，默认 false</span></span><br><span class="line"><span class="attr">  disableErrorStatus:</span> <span class="literal">false</span> <span class="comment"># 是否禁用错误码，默认 false</span></span><br><span class="line"><span class="attr">  autoSetupAcl:</span> <span class="literal">true</span> <span class="comment"># 自动配置 bucket 访问权限为 ”公有读私有写“</span></span><br><span class="line"><span class="attr">  autoSetupPolicy:</span> <span class="literal">false</span> <span class="comment"># 自动配置 bucket 的 Policy 权限为 ”所有用户资源可读“</span></span><br><span class="line">  <span class="comment"># hosts:</span></span><br><span class="line">  <span class="comment">#   - host: test.com # 自定义域名</span></span><br><span class="line">  <span class="comment">#     async: false # 是否同步等待 CDN 配置。配置为 false 时，参数 autoRefresh 自动刷新才会生效，如果关联多域名时，为防止超时建议配置为 true。</span></span><br><span class="line">  <span class="comment">#     autoRefresh: true #开启自动 CDN 刷新，用于快速更新和同步加速域名中展示的站点内容</span></span><br></pre></td></tr></table></figure>
<p><strong>执行部署</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<p><img src="https://s.poetries.work/uploads/2022/06/f150204a59359b6d.png" alt></p>
<p><strong>移除</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sls remove</span><br></pre></td></tr></table></figure>
<h1 id="五、综合实战"><a href="#五、综合实战" class="headerlink" title="五、综合实战"></a>五、综合实战</h1><h2 id="5-1-Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络"><a href="#5-1-Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络" class="headerlink" title="5.1 Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络"></a>5.1 Serverless中使用Node操作Mysql、Mongodb数据库、以及配置VPC私有网络</h2><h3 id="云函数接入数据库"><a href="#云函数接入数据库" class="headerlink" title="云函数接入数据库"></a>云函数接入数据库</h3><blockquote>
<p>参考：<a href="https://cloud.tencent.com/document/product/583/51935" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/583/51935</a></p>
</blockquote>
<p><strong>注意</strong>：配置私有网络的服务器需要在同一个地区</p>
<p><img src="https://s.poetries.work/uploads/2022/07/1063776f916665ad.png" alt></p>
<h3 id="Nodejs-Serverless-中操作-Mysql"><a href="#Nodejs-Serverless-中操作-Mysql" class="headerlink" title="Nodejs Serverless 中操作 Mysql"></a>Nodejs Serverless 中操作 Mysql</h3><ul>
<li>准备工作：首先需要购买云数据库、或者自己在服务器上面搭建一个数据库</li>
<li>云函数操作 Mysql</li>
</ul>
<p><strong>购买云数据库mysql</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/07/a32767996808f68f.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/ca2c192149944c02.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/fb6f3d7a624a73f6.png" alt></p>
<p><strong>新建mysql云函数</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/07/968044649cbdbfee.png" alt></p>
<ul>
<li>选择和mysql同一个地域，程序之间通过VPC网络连接</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/e7285b3cba07f7bf.png" alt></p>
<ul>
<li>选择私有网络，和mysql所在网络一致</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/c31cd4d7d163bb89.png" alt><br><img src="https://s.poetries.work/uploads/2022/07/1d3382cca02d0f05.png" alt></p>
<p>如果没有需要新建私有网络，需要和msyql实例同一个地区，选择了新建的私有网络，mysql实例那边网络需要修改一致</p>
<p><img src="https://s.poetries.work/uploads/2022/07/e848fe3eabb20b49.png" alt><br><img src="https://s.poetries.work/uploads/2022/07/e5dfce33f28ac2f0.png" alt></p>
<ul>
<li>登录mysql数据库增加测试数据</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/765e9fdf679b9661.png" alt></p>
<p>新建test数据库</p>
<p><img src="https://s.poetries.work/uploads/2022/07/794bc6fe87c43f55.png" alt></p>
<p>创建user表</p>
<p><img src="https://s.poetries.work/uploads/2022/07/bc6c668125921773.png" alt></p>
<ul>
<li>修改云函数代码，保存部署即可</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/0ec0d7030a1a171a.png" alt></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**************************************************</span></span><br><span class="line"><span class="comment">Node8.9-Mysql</span></span><br><span class="line"><span class="comment">Reference: mysql api---https://www.npmjs.com/package/mysql</span></span><br><span class="line"><span class="comment">Reference: How to access database---https://cloud.tencent.com/document/product/236/3130</span></span><br><span class="line"><span class="comment">Reference: How to connect api gateway with scf---https://cloud.tencent.com/document/product/628/11983</span></span><br><span class="line"><span class="comment">***************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapPromise</span>(<span class="params">connection, sql</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    connection.query(sql, <span class="function"><span class="keyword">function</span>(<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        rej(error)</span><br><span class="line">      &#125;</span><br><span class="line">      res(results)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exports.main_handler = <span class="keyword">async</span> (event, context, callback) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line">  <span class="keyword">const</span> connection = mysql.createConnection(&#123;</span><br><span class="line">    host: <span class="string">'167.16.0.17'</span>, <span class="comment">// The ip address of cloud database instance, 云数据库实例ip地址</span></span><br><span class="line">    user: <span class="string">'root'</span>, <span class="comment">// The name of cloud database, for example, root, 云数据库用户名，如root</span></span><br><span class="line">    password: <span class="string">'xx'</span>, <span class="comment">// Password of cloud database, 云数据库密码</span></span><br><span class="line">    database: <span class="string">'test'</span>, <span class="comment">// Name of the cloud database, 数据库名称</span></span><br><span class="line">    port: <span class="string">"3306"</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  connection.connect();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> querySql = <span class="string">`SELECT * from user`</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> queryResult = <span class="keyword">await</span> wrapPromise(connection, querySql)</span><br><span class="line">  </span><br><span class="line">  connection.end();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> queryResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新部署</p>
<p><img src="https://s.poetries.work/uploads/2022/07/be2ad63b73cd90cb.png" alt></p>
<ul>
<li>创建API网关触发器，在浏览器中访问</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/4d25248bad953017.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/280e12f1381ad19b.png" alt></p>
<p>浏览器中访问查看效果</p>
<p><img src="https://s.poetries.work/uploads/2022/07/3bf2e7588ef4db51.png" alt></p>
<h3 id="Nodejs-Serverless-中操作-Mongodb"><a href="#Nodejs-Serverless-中操作-Mongodb" class="headerlink" title="Nodejs Serverless 中操作 Mongodb"></a>Nodejs Serverless 中操作 Mongodb</h3><ul>
<li>准备工作：首先需要购买云数据库、或者自己在服务器上面搭建一个数据库</li>
<li>云函数操作 Mongodb</li>
</ul>
<p><strong>购买MongoDB数据库</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/07/88f6da606016085b.png" alt><br><img src="https://s.poetries.work/uploads/2022/07/81895e9b9ae7dac9.png" alt></p>
<p><strong>创建云函数</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/07/ada2715770b68f92.png" alt></p>
<ul>
<li>选择地区</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/cdc6c87499019a46.png" alt></p>
<ul>
<li>选择私有网络，和mongodb所在网络一致</li>
</ul>
<p><img src="https://s.poetries.work/uploads/2022/07/cfdd4a0e3e82ee18.png" alt></p>
<ul>
<li>修改云函数代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;promisify&#125; = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line"><span class="keyword">const</span> mongodb = <span class="built_in">require</span>(<span class="string">'mongodb'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mongoClient = mongodb.MongoClient,</span><br><span class="line">    assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> connect = promisify(mongodb.connect)</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL combination</span></span><br><span class="line"><span class="comment">// var url = 'mongodb://mason_mongodb:mason12345@10.10.11.19:27017/admin';</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url=<span class="string">"mongodb://mongouser:password@10.0.0.13:27017,10.0.0.8:27017,10.0.0.11:27017/admin?authSource=admin&amp;replicaSet=cmgo-e23piswf_0"</span></span><br><span class="line"></span><br><span class="line">exports.main_handler = <span class="keyword">async</span> (event, context, callback) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'start main handler'</span>)</span><br><span class="line">    <span class="keyword">const</span> MongoClient = <span class="built_in">require</span>(<span class="string">"mongodb"</span>).MongoClient;</span><br><span class="line">    <span class="keyword">const</span> mc = <span class="keyword">await</span> MongoClient.connect(url,&#123;<span class="attr">useNewUrlParser</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    <span class="keyword">const</span> db = mc.db(<span class="string">'testdb'</span>) </span><br><span class="line">    <span class="keyword">const</span> collection = db.collection(<span class="string">'demoCol'</span>)</span><br><span class="line">    <span class="keyword">await</span> collection.insertOne(&#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">something</span>:<span class="string">'你好 serverless'</span>&#125;)</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">as</span> = <span class="keyword">await</span> collection.find().toArray()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">as</span>)</span><br><span class="line"></span><br><span class="line">    mc.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">as</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建触发器</p>
<p><img src="https://s.poetries.work/uploads/2022/07/1da43f40efc683d6.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/5a8d14fb5d7417c0.png" alt></p>
<h2 id="5-2-Serverless-BaaS-对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中"><a href="#5-2-Serverless-BaaS-对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中" class="headerlink" title="5.2 Serverless BaaS 对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中"></a>5.2 Serverless BaaS 对象云存储Cos介绍、Node操作Cos、实现图片上传到Cos中</h2><h3 id="对象云存储-Cos-介绍"><a href="#对象云存储-Cos-介绍" class="headerlink" title="对象云存储 Cos 介绍"></a>对象云存储 Cos 介绍</h3><p>狭义的 Serverless 是指现阶段主流的技术实现：狭义的 Serverless 是 <code>FaaS</code> 和 <code>BaaS</code> 组成</p>
<p><img src="https://s.poetries.work/uploads/2022/07/396be7b44eb9dd81.png" alt></p>
<blockquote>
<p>对象存储（Cloud Object Storage，COS）是一种存储海量文件的分布式存储服务，具有高扩 展性、低成本、可靠安全等优点。通过控制台、API、SDK 和工具等多样化方式，用户可简 单、快速地接入 COS，进行多格式文件的上传、下载和管理，实现海量数据存储和管理。</p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/0fc384f78966e294.png" alt></p>
<h3 id="Nodejs-操作-Cos"><a href="#Nodejs-操作-Cos" class="headerlink" title="Nodejs 操作 Cos"></a>Nodejs 操作 Cos</h3><blockquote>
<p>参考官方文档：<a href="https://cloud.tencent.com/document/product/436/8629" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/436/8629</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cnpm i cos-nodejs-sdk-v5 --save</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> COS = <span class="built_in">require</span>(<span class="string">'cos-nodejs-sdk-v5'</span>);</span><br><span class="line"><span class="keyword">const</span> fs=<span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置cos的sdk  https://console.cloud.tencent.com/cam/capi</span></span><br><span class="line"><span class="keyword">var</span> cos = <span class="keyword">new</span> COS(&#123;</span><br><span class="line">    SecretId: <span class="string">'xx'</span>,</span><br><span class="line">    SecretKey: <span class="string">'xx'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//上传本地图片到对象云存储里面</span></span><br><span class="line">cos.putObject(&#123;</span><br><span class="line">    Bucket: <span class="string">'express-demo-1251179943'</span>, <span class="comment">/* 必须存储桶名称 */</span></span><br><span class="line">    Region: <span class="string">'ap-guangzhou'</span>,    <span class="comment">/* 必须 区域*/</span></span><br><span class="line">    Key: <span class="string">'a.png'</span>,              <span class="comment">/* 必须   目录/文件的名称  */</span></span><br><span class="line">    StorageClass: <span class="string">'STANDARD'</span>,</span><br><span class="line">    Body: fs.createReadStream(<span class="string">'./a.png'</span>), <span class="comment">// 上传文件对象</span></span><br><span class="line">    onProgress: <span class="function"><span class="keyword">function</span>(<span class="params">progressData</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(progressData));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err || data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Express-在-Serverless-中实现图片上传到-Cos-中"><a href="#Express-在-Serverless-中实现图片上传到-Cos-中" class="headerlink" title="Express 在 Serverless 中实现图片上传到 Cos 中"></a>Express 在 Serverless 中实现图片上传到 Cos 中</h3><p>安装模块 multer <a href="https://github.com/expressjs/multer" target="_blank" rel="noopener">https://github.com/expressjs/multer</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save multer</span><br></pre></td></tr></table></figure>
<p>配置 form 表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- views/index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Serverless Component - Express.js<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/basic.css"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/doUpload"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">      用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      头 像 : <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"face"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置内存存储引擎 (<code>MemoryStorage</code>)，内存存储引擎将文件存储在内存中的 <code>Buffer</code> 对象，它没有任何选项</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> storage = multer.memoryStorage()</span><br><span class="line"><span class="keyword">var</span> upload = multer(&#123; <span class="attr">storage</span>: storage &#125;)</span><br></pre></td></tr></table></figure>
<p>接收文件上传文件到云存储</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">"ejs"</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">var</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>);</span><br><span class="line"><span class="keyword">var</span> tools = <span class="built_in">require</span>(<span class="string">'./services/tools.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置上传</span></span><br><span class="line"><span class="keyword">var</span> storage = multer.memoryStorage();</span><br><span class="line"><span class="keyword">var</span> upload = multer(&#123; <span class="attr">storage</span>: storage &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置中间件</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置模板引擎</span></span><br><span class="line">app.engine(<span class="string">"html"</span>, ejs.__express)</span><br><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"html"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//会对指定类型进行 Base64 编码</span></span><br><span class="line">app.binaryTypes = [<span class="string">'*/*'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态web服务</span></span><br><span class="line">app.use(express.static(<span class="string">"public"</span>));</span><br><span class="line"><span class="comment">// Routes</span></span><br><span class="line">app.get(<span class="string">`/`</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.render(<span class="string">"index"</span>, &#123;</span><br><span class="line">    title: <span class="string">"你好serverless"</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意：https://github.com/serverless-components/tencent-koa/blob/master/docs/upload.md</span></span><br><span class="line">app.post(<span class="string">`/doUpload`</span>, upload.single(<span class="string">"face"</span>), <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.body);</span><br><span class="line">  <span class="built_in">console</span>.log(req.file);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//上传本地图片到对象云存储里面   注意异步</span></span><br><span class="line">  <span class="keyword">let</span> result = <span class="keyword">await</span> tools.uploadCos(req.file.originalname, req.file.buffer)</span><br><span class="line"></span><br><span class="line">  res.send(&#123;</span><br><span class="line">    body: req.body,</span><br><span class="line">    result: result</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Internal Serverless Error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// services/tools.js</span></span><br><span class="line"><span class="keyword">const</span> COS = <span class="built_in">require</span>(<span class="string">'cos-nodejs-sdk-v5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">  uploadCos(filename,source)&#123;</span><br><span class="line">    <span class="keyword">let</span> cos = <span class="keyword">new</span> COS(&#123;</span><br><span class="line">      SecretId: <span class="string">'xx'</span>,</span><br><span class="line">      SecretKey: <span class="string">'xx'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">reslove, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      cos.putObject(&#123;</span><br><span class="line">        Bucket: <span class="string">'test-xx'</span>, <span class="comment">/* 必须 */</span></span><br><span class="line">        Region: <span class="string">'ap-beijing'</span>,    <span class="comment">/* 必须 */</span></span><br><span class="line">        Key: <span class="string">'test/'</span> + filename,              <span class="comment">/* 必须 test为目录名称 */</span></span><br><span class="line">        StorageClass: <span class="string">'STANDARD'</span>,</span><br><span class="line">        Body: source, <span class="comment">// 上传文件对象</span></span><br><span class="line">        onProgress: <span class="function"><span class="keyword">function</span> (<span class="params">progressData</span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(progressData));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(err)&#123;</span><br><span class="line">              reject(err);</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              reslove(data);</span><br><span class="line">          &#125;</span><br><span class="line">        </span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>上传文件需要注意</strong></p>
<blockquote>
<p><a href="https://github.com/serverless-components/tencent-koa/blob/master/docs/upload.md" target="_blank" rel="noopener">https://github.com/serverless-components/tencent-koa/blob/master/docs/upload.md</a></p>
</blockquote>
<p><img src="https://s.poetries.work/uploads/2022/07/d959441445eecfb5.png" alt></p>
<p>修改<code>serverless.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">app:</span> <span class="string">appDemo</span></span><br><span class="line"><span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">koa</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">koaDemo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line">  <span class="comment"># 省略...</span></span><br><span class="line"><span class="attr">  apigatewayConf:</span></span><br><span class="line"><span class="attr">    isBase64Encoded:</span> <span class="literal">true</span> <span class="comment"># 需要加上，否则上传图片到cos预览有问题</span></span><br><span class="line">    <span class="comment"># 省略...</span></span><br><span class="line">  <span class="comment"># 省略...</span></span><br></pre></td></tr></table></figure>
<p><strong>完整serverless.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">app:</span> <span class="string">expressdemo</span></span><br><span class="line"><span class="attr">component:</span> <span class="string">express</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">expressDemo</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line"><span class="attr">  runtime:</span> <span class="string">Nodejs10.15</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-guangzhou</span></span><br><span class="line"><span class="attr">  src:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">./</span></span><br><span class="line"><span class="attr">    exclude:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.git</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules</span></span><br><span class="line"><span class="attr">  apigatewayConf:</span></span><br><span class="line"><span class="attr">    enableCORS:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    isBase64Encoded:</span> <span class="literal">true</span> <span class="comment"># 需要加上，否则上传图片到cos预览有问题</span></span><br><span class="line"><span class="attr">    protocols:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">http</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">release</span></span><br></pre></td></tr></table></figure>
<p>部署，然后在webIDE开启自动安装依赖 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sls deploy</span><br></pre></td></tr></table></figure>
<h2 id="5-3-Serverless、Cos中配置域名访问以及Serverless中配置https访问"><a href="#5-3-Serverless、Cos中配置域名访问以及Serverless中配置https访问" class="headerlink" title="5.3 Serverless、Cos中配置域名访问以及Serverless中配置https访问"></a>5.3 Serverless、Cos中配置域名访问以及Serverless中配置https访问</h2><h3 id="Serverless-中配置域名访问"><a href="#Serverless-中配置域名访问" class="headerlink" title="Serverless 中配置域名访问"></a>Serverless 中配置域名访问</h3><p>找到云函数对应的 api 网关</p>
<p><img src="https://s.poetries.work/uploads/2022/07/7c53c0ead5e166f7.png" alt></p>
<p>编辑 api 网关 点击域名管理</p>
<p><img src="https://s.poetries.work/uploads/2022/07/fa2e097f55e8460b.png" alt></p>
<p>新建域名</p>
<p><img src="https://s.poetries.work/uploads/2022/07/9f4acfb1d41d15ec.png" alt></p>
<p><img src="https://s.poetries.work/uploads/2022/07/cbc5cd59595597bc.png" alt></p>
<p>解析域名</p>
<p><img src="https://s.poetries.work/uploads/2022/07/c2dc26b03c9b36be.png" alt></p>
<h3 id="Serverless-中配置-https-访问"><a href="#Serverless-中配置-https-访问" class="headerlink" title="Serverless 中配置 https 访问"></a>Serverless 中配置 https 访问</h3><p>HTTPS（全称：Hyper Text Transfer Protocol over Secure Socket Layer），是以安全为目标的 HTTP 通道，简单讲是 HTTP 的安全版。 </p>
<p>HTTPS 是在 HTTP 的基础上添加了安全层，从原来的明文传输变成密文传输，当然加密与解 密是需要一些时间代价与开销的，不完全统计有 10 倍的差异。</p>
<blockquote>
<p>在当下的网络环境下可以忽 略不计，已经成为一种必然趋势。 目前微信小程序请求 Api 必须用 https、Ios 请求 api 接口必须用 https</p>
</blockquote>
<p><strong>https 证书类型</strong></p>
<ul>
<li>域名型 https 证书（DVSSL）：信任等级一般，只需验证网站的真实性便可颁发证书保护网站</li>
<li>企业型 https 证书（OVSSL）：信任等级强，须要验证企业的身份，审核严格，安全性更高</li>
<li>增强型 https 证书（EVSSL）：信任等级最高，一般用于银行证券等金融机构，审核严格，安全性最高， 同时可以激活绿色网址栏</li>
</ul>
<p><strong>创建证书</strong></p>
<p><img src="https://s.poetries.work/uploads/2022/07/c0bd93006ea724cd.png" alt></p>
<p>选择证书</p>
<p><img src="https://s.poetries.work/uploads/2022/07/c7ecd5414acc9881.png" alt></p>
<h3 id="Cos-中配置域名"><a href="#Cos-中配置域名" class="headerlink" title="Cos 中配置域名"></a>Cos 中配置域名</h3><p>配置域名</p>
<p><img src="https://s.poetries.work/uploads/2022/07/565fff50504ea193.png" alt></p>
<p>域名解析</p>
<p><img src="https://s.poetries.work/uploads/2022/07/08646a66aeb4c8fb.png" alt></p>
<h1 id="六、QA"><a href="#六、QA" class="headerlink" title="六、QA"></a>六、QA</h1><h2 id="scf-bootstrap启动文件与sls-js启动文件区别"><a href="#scf-bootstrap启动文件与sls-js启动文件区别" class="headerlink" title="scf_bootstrap启动文件与sls.js启动文件区别"></a>scf_bootstrap启动文件与sls.js启动文件区别</h2><p><img src="https://s.poetries.work/uploads/2022/06/c70fc14a6975b58d.png" alt></p>
<ul>
<li><code>scf_bootstrap</code> 文件是针对 <code>web</code> 函数的，</li>
<li><code>sls.js</code> 入口文件是针对事件函数，主要是 <code>serverless</code> 封装了一些开源框架，改造的入口文件。</li>
</ul>
<h2 id="关于serverless-yml写法问题，是更推荐HTTP组件方式吗"><a href="#关于serverless-yml写法问题，是更推荐HTTP组件方式吗" class="headerlink" title="关于serverless.yml写法问题，是更推荐HTTP组件方式吗"></a>关于serverless.yml写法问题，是更推荐HTTP组件方式吗</h2><p><img src="https://s.poetries.work/uploads/2022/06/bf28a299163edd25.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/73dd2079f12bc9e2.png" alt><br><img src="https://s.poetries.work/uploads/2022/06/2fd1b2033733a2f9.png" alt></p>
<blockquote>
<p>目前推荐使用 web 函数，也就是 <code>HTTP 组件</code>，现在所有的serverless web 应用都是基于 <code>component: http</code> 组件的。</p>
</blockquote>
<h2 id="关于配额问题如何处理"><a href="#关于配额问题如何处理" class="headerlink" title="关于配额问题如何处理"></a>关于配额问题如何处理</h2><p>云函数 scf 针对每个用户帐号，均有一定的配额限制：</p>
<p><img src="https://s.poetries.work/uploads/2022/06/a75c8ba81b1830ac.png" alt></p>
<blockquote>
<p>其中需要重点关注的就是单个函数代码体积 <code>500mb</code> 的上限。在实际操作中，云函数虽然提供了 <code>500mb</code>。但也存在着一个 <code>deploy</code> 解压上限。</p>
</blockquote>
<p><strong>关于绕过配额问题：</strong></p>
<ul>
<li>如果超的不多，那么使用 <code>npm install --production</code> 就能解决问题</li>
<li>如果超的太多，那就通过挂载 <code>cfs</code> 文件系统来进行规避（<a href="https://zhuanlan.zhihu.com/p/218803108?utm_source=wechat_session" target="_blank" rel="noopener">参考文章</a>）</li>
</ul>
<h1 id="七、官方文档"><a href="#七、官方文档" class="headerlink" title="七、官方文档"></a>七、官方文档</h1><ul>
<li><a href="https://cloud.tencent.com/document/product/1154/59447" target="_blank" rel="noopener">serverless官方应用中心文档</a></li>
<li><a href="https://cn.serverless.com/framework/docs" target="_blank" rel="noopener">serverless帮助文档</a></li>
<li><a href="https://github.com/serverless-components" target="_blank" rel="noopener">Serverless Components Github主页</a></li>
<li><a href="https://github.com/serverless-components/tencent-framework-components" target="_blank" rel="noopener">serverless-components/tencent-framework-components</a></li>
<li><a href="https://github.com/serverless-components/tencent-nestjs" target="_blank" rel="noopener">serverless-components/tencent-nestjs</a></li>
<li><a href="https://github.com/serverless-components/tencent-egg" target="_blank" rel="noopener">serverless-components/tencent-egg</a></li>
<li><a href="https://github.com/serverless-components/tencent-http" target="_blank" rel="noopener">serverless-components/tencent-http</a></li>
<li><a href="https://github.com/serverless/serverless-tencent/issues" target="_blank" rel="noopener">serverless 官方bug提交</a></li>
<li><a href="https://github.com/serverless/serverless-tencent/discussions" target="_blank" rel="noopener">serverless 官方社区文档</a></li>
</ul>

      </div>
    
  </div>

</article>

<!-- <button class="assist-btn2 circle" id="assist_btn2" title="点亮屏幕" style="left: 27px; top: 152px;">
  <i class="iconfont" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button>
<button class="assist-btn1 circle" id="assist_btn1" title="关闭屏幕亮度" style="left: 27px; top: 152px;">
  <i class="iconfont toc-title" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button> -->


<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>	

<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
  function getCookie(key) {
    if (document.cookie.length > 0) {
      var start = document.cookie.indexOf(key + "=");
      if (start !== -1) {
        start = start + key.length + 1;
        var end = document.cookie.indexOf(";", start);
        if (end === -1) end = document.cookie.length;
        return unescape(document.cookie.substring(start, end));
      }
    }
    return "";
  }
  const feToken = getCookie('fe-token');
  const btw = new BTWPlugin();
  console.log('ft', feToken)
  if(!feToken) {
    btw.init({
      id: "container",
      blogId: "22699-1592137983091-414",
      name: "前端进阶之旅",
      qrcode: "https://poetries1.gitee.io/img-repo/2020/06/qrcode.jpg",
      keyword: "3a3b3c",
    });
  }
</script>

<script type="text/javascript">

// white theme
var body = {color: "#555", background: "#000"};
var a_tag = {color: "#222"};
var header = { background: "#222"};
var logo_line_i = {background: "#222"};
// var post_code = {background: "#eee", color: "#222"};

function switch_theme() {
 $("body").css(body);
 $("a:not('.links-of-author-item a, .site-state-item a, .site-state-posts a, .feed-link a, .motion-element a, .post-tags a, .show-commit-cls a, #donate_board a')").css(a_tag);
 $(".header, .footer").css(header);
 $(".logo-line-before i, .logo-line-after i").css(logo_line_i);
 //$(".post code").css(post_code);
 $("#idhyt-surprise-ball #idhyt-surprise-ball-animation .drag").css(a_tag);
 $(".post-title-link, .posts-expand .post-meta, .post-comments-count, .disqus-comment-count, .post-category a, .post-nav-next a, .post-nav-item a").css(a_tag);
 
 // $("code").css({color: '#c5c8c6', background: '#1d1f21'});
 //$("#assist_btn1").hide(1500);
}

$(function () {
$("#assist_btn2").css("display","none");
 $("#assist_btn1").click(function() {
     switch_theme();
$("div#toc.toc-article").css({
 "background":"#eaeaea",
 "opacity":1
});
$(".toc-article ol").show();
$("#toc.toc-article .toc-title").css("color","#a98602");
$("#assist_btn1").css("display","none");
$("#assist_btn2").css("display","block");
 });
$("#assist_btn2").click(function() {
$("#assist_btn2").css("display","none");
$("#assist_btn1").css("display","block");
$("body").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
     $(".header, .footer").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
$(".toc-article ol").toggle(1000);
 });
});


//背景随机

var Y, O, E, L, B, C, T, z, N, S, A, I;
!function() {
var e = function() {
for (O.clearRect(0, 0, L, B), T = [{
x: 0,
y: .7 * B + C
}, {
x: 0,
y: .7 * B - C
}]; T[1].x < L + C;) t(T[0], T[1])
}, t = function(e, t) {
O.beginPath(), O.moveTo(e.x, e.y), O.lineTo(t.x, t.y);
var n = t.x + (2 * I() - .25) * C,
 r = a(t.y);
O.lineTo(n, r), O.closePath(), N -= S / -50, O.fillStyle = "#" + (127 * A(N) + 128 << 16 | 127 * A(N + S / 3) + 128 << 8 | 127 * A(N + S / 3 * 2) + 128).toString(16), O.fill(), T[0] = T[1], T[1] = {
 x: n,
 y: r
}
}, a = function n(e) {
var t = e + (2 * I() - 1.1) * C;
return t > B || t < 0 ? n(e) : t
};
Y = document.getElementById("evanyou"), O = Y.getContext("2d"), E = window.devicePixelRatio || 1, L = window.innerWidth, B = window.innerHeight, C = 90, z = Math, N = 0, S = 2 * z.PI, A = z.cos, I = z.random, Y.width = L * E, Y.height = B * E, O.scale(E, E), O.globalAlpha = .6, document.onclick = e, document.ontouchstart = e, e()
}()

   
$("#toc-eye").click(function(){
$("#toc.toc-article").toggle(1000);
});

</script>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持poetries</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/weixin.jpg" alt="">
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/zhifubao.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2022/06/17/nest-deploy-summary/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2022/06/19/wxcloud-intro/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/categories/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tags/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '5567a2c4abb858009d96',
  clientSecret: 'b9039ec056cf5c2346b3cdb63308a28c163f91e5',
  repo: 'poetries.github.io',
  owner: 'poetries',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: location.pathname,
  admin: ['poetries'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
 
  
</body>
</html>
