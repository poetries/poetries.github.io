<!DOCTYPE html>


  <html class="dark page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>微前端实战总结篇 | 前端进阶之旅</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="微前端,">
  

  <meta name="description" content="微前端现有的落地方案可以分为三类，自组织模式、基座模式以及模块加载模式。 一、为什么需要微前端?这里我们通过3W(what,why,how)的方式来讲解什么是微前端： 1.What?什么是微前端? 微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。  微前端的核心在于拆, 拆完后再合!  2.Why?为什么去使用他? 不同团队间开发同一个应用技术栈不同怎么破？ 希">
<meta name="keywords" content="微前端">
<meta property="og:type" content="article">
<meta property="og:title" content="微前端实战总结篇">
<meta property="og:url" content="http://blog.poetries.top/2021/07/31/micro-fe-summary/index.html">
<meta property="og:site_name" content="前端进阶之旅">
<meta property="og:description" content="微前端现有的落地方案可以分为三类，自组织模式、基座模式以及模块加载模式。 一、为什么需要微前端?这里我们通过3W(what,why,how)的方式来讲解什么是微前端： 1.What?什么是微前端? 微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。  微前端的核心在于拆, 拆完后再合!  2.Why?为什么去使用他? 不同团队间开发同一个应用技术栈不同怎么破？ 希">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210710171426.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731160243.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731154621.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731155249.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731114005.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731155355.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731205952.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731160312.png">
<meta property="og:image" content="https://blog.poetries.top/img/static/images/20210731155716.png">
<meta property="og:updated_time" content="2025-03-30T13:54:29.486Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微前端实战总结篇">
<meta name="twitter:description" content="微前端现有的落地方案可以分为三类，自组织模式、基座模式以及模块加载模式。 一、为什么需要微前端?这里我们通过3W(what,why,how)的方式来讲解什么是微前端： 1.What?什么是微前端? 微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。  微前端的核心在于拆, 拆完后再合!  2.Why?为什么去使用他? 不同团队间开发同一个应用技术栈不同怎么破？ 希">
<meta name="twitter:image" content="https://blog.poetries.top/img/static/images/20210710171426.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">
<link href="/css/other.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5081f3afc8d94338e79d319c8b632b31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  <!-- 聊天系统 -->
  
    
   <link type="text/css" rel="stylesheet" href="/renxi/default.css">
   <style>
      #modal {
        position: static !important;
      }
      .filter {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: #fe5757;
        animation: colorChange 30s ease-in-out infinite;
        animation-fill-mode: both;
        mix-blend-mode: overlay;
      }
  
      @keyframes colorChange {
        0%, 100% {
            opacity: 0;
        }
        50% {
            opacity: .9;
        }
      }
   </style>
</head>
</html>
<body>
  
  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/categories/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tags/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录<i class="iconfont toc-title" style="display:inline-block;color:#87998d;width:20px;height:20px;">&#xf004b;</i></strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、为什么需要微前端"><span class="toc-text">一、为什么需要微前端?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-What-什么是微前端"><span class="toc-text">1.What?什么是微前端?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Why-为什么去使用他"><span class="toc-text">2.Why?为什么去使用他?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-How-怎样落地微前端"><span class="toc-text">3.How?怎样落地微前端?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、SingleSpa实战"><span class="toc-text">二、SingleSpa实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-构建子应用"><span class="toc-text">1.构建子应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-配置库打包"><span class="toc-text">2.配置库打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-主应用搭建"><span class="toc-text">3.主应用搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-动态设置子应用publicPath"><span class="toc-text">4.动态设置子应用publicPath</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、qiankun实战"><span class="toc-text">三、qiankun实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-主应用编写"><span class="toc-text">1.主应用编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-子Vue应用"><span class="toc-text">2.子Vue应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-子React应用"><span class="toc-text">3.子React应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、飞冰微前端实战"><span class="toc-text">四、飞冰微前端实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-react主应用编写"><span class="toc-text">4.1 react主应用编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-vue子应用接入"><span class="toc-text">4.2 vue子应用接入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-react子应用接入"><span class="toc-text">4.3 react子应用接入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、CSS隔离方案"><span class="toc-text">五、CSS隔离方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#子应用之间样式隔离："><span class="toc-text">子应用之间样式隔离：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主应用和子应用之间的样式隔离："><span class="toc-text">主应用和子应用之间的样式隔离：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、JS沙箱机制"><span class="toc-text">六、JS沙箱机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-快照沙箱"><span class="toc-text">1.快照沙箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Proxy-代理沙箱"><span class="toc-text">2.Proxy 代理沙箱</span></a></li></ol></li></ol>
  </div>
  




<div class="content content-post CENTER">
   <!-- canvas 彩带 -->
<canvas id="evanyou" width="1302" height="678" style="position: fixed;width: 100%;height: 100%;top: 0;left:0;z-index:-1;"></canvas>

<div class="qrcode_container">
  <div class="tencent_code">
    <h4>关注作者公众号</h4> 
    <p>和万千小伙伴一起学习</p> 
    <img src="https://interview.poetries.top/qrcode.jpg" alt="公众号：前端进价之旅">
  </div> 
</div>

<article id="post-micro-fe-summary" class="article article-type-post" itemprop="blogPost">
  <header class="article-header" style="position:relative;">
    <h1 class="post-title">微前端实战总结篇</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2021.07.31</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Poetry</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/Front-End/">Front-End</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
       
          <span class="post-count">
            <i class="fa fa-file-word-o"></i>&nbsp
            <span>字数统计 3.8k字</span>
          </span>

          <span class="post-count">
            <i class="fa fa-columns"></i>&nbsp
            <span>阅读时长 18分</span>
          </span>
      
      
    </div>

    <i class="iconfont" id="toc-eye" style="display:inline-block;color:#b36619;position:absolute;top:20px;right:-11px;cursor:pointer;
    font-size: 24px;">&#xe61c;</i>

  </header>

  <div class="article-content">
    
      <div id="container">
        <p><img src="https://blog.poetries.top/img/static/images/20210710171426.png" alt></p>
<p>微前端现有的落地方案可以分为三类，自组织模式、基座模式以及模块加载模式。</p>
<h2 id="一、为什么需要微前端"><a href="#一、为什么需要微前端" class="headerlink" title="一、为什么需要微前端?"></a>一、为什么需要微前端?</h2><p>这里我们通过3W(what,why,how)的方式来讲解什么是微前端：</p>
<h3 id="1-What-什么是微前端"><a href="#1-What-什么是微前端" class="headerlink" title="1.What?什么是微前端?"></a>1.What?什么是微前端?</h3><p><img src="https://blog.poetries.top/img/static/images/20210731160243.png" alt></p>
<p>微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。</p>
<blockquote>
<p>微前端的核心在于拆, 拆完后再合!</p>
</blockquote>
<h3 id="2-Why-为什么去使用他"><a href="#2-Why-为什么去使用他" class="headerlink" title="2.Why?为什么去使用他?"></a>2.Why?为什么去使用他?</h3><ul>
<li>不同团队间开发同一个应用技术栈不同怎么破？</li>
<li>希望每个团队都可以独立开发，独立部署怎么破？</li>
<li>项目中还需要老的应用代码怎么破？</li>
</ul>
<blockquote>
<p>我们是不是可以将一个应用划分成若干个子应用，再将子应用打包成一个个的lib呢？当路径切换时加载不同的子应用，这样每个子应用都是独立的，技术栈也就不用再做限制了！从而解决了前端协同开发的问题。</p>
</blockquote>
<h3 id="3-How-怎样落地微前端"><a href="#3-How-怎样落地微前端" class="headerlink" title="3.How?怎样落地微前端?"></a>3.How?怎样落地微前端?</h3><p><img src="https://blog.poetries.top/img/static/images/20210731154621.png" alt></p>
<ul>
<li>2018年 <code>Single-SPA</code>诞生了， <code>single-spa</code>是一个用于前端微服务化的JavaScript前端解决方案  (本身没有处理样式隔离、js执行隔离)  实现了路由劫持和应用加载；</li>
<li>2019年 qiankun基于Single-SPA, 提供了更加开箱即用的 API  (<code>single-spa + sandbox + import-html-entry</code>)，它 做到了技术栈无关，并且接入简单(有多简单呢，像iframe一样简单)</li>
</ul>
<blockquote>
<p>总结：子应用可以独立构建，运行时动态加载，主子应用完全解耦，并且技术栈无关，靠的是协议接入(这里提前强调一下：子应用必须导出 <code>bootstrap、mount、unmount</code>三个方法)。</p>
</blockquote>
<p>这里先回答一下大家可能会有的疑问：</p>
<p><strong>这不是iframe吗？</strong></p>
<blockquote>
<p>如果使用的是<code>iframe</code>，当iframe中的子应用切换路由时用户刷新页面就尴尬了。</p>
</blockquote>
<p><strong>应用间如何通信？</strong></p>
<ul>
<li>基于URL来进行数据传递，但是这种传递消息的方式能力较弱</li>
<li>基于CustomEvent实现通信；</li>
<li><ul>
<li>基于props主子应用间通信；</li>
</ul>
</li>
<li>使用全局变量、Redux进行通信</li>
</ul>
<p><strong>如何处理公共依赖？</strong></p>
<ul>
<li>CDN - <code>externals</code></li>
<li>webpack<code>联邦模块</code></li>
</ul>
<h2 id="二、SingleSpa实战"><a href="#二、SingleSpa实战" class="headerlink" title="二、SingleSpa实战"></a>二、SingleSpa实战</h2><blockquote>
<p>官网 <a href="https://zh-hans.single-spa.js.org/docs/configuration" target="_blank" rel="noopener">https://zh-hans.single-spa.js.org/docs/configuration</a></p>
</blockquote>
<h3 id="1-构建子应用"><a href="#1-构建子应用" class="headerlink" title="1.构建子应用"></a>1.构建子应用</h3><blockquote>
<p>首先创建一个vue子应用，并通过<code>single-spa-vue</code>来导出必要的生命周期：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vue create spa-vue  </span><br><span class="line">npm install single-spa-vue</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> singleSpaVue <span class="keyword">from</span> <span class="string">'single-spa-vue'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> appOptions = &#123;</span><br><span class="line">   el: <span class="string">'#vue'</span>,</span><br><span class="line">   router,</span><br><span class="line">   render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在非子应用中正常挂载应用</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.singleSpaNavigate)&#123;</span><br><span class="line"> <span class="keyword">delete</span> appOptions.el;</span><br><span class="line"> <span class="keyword">new</span> Vue(appOptions).$mount(<span class="string">'#app'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vueLifeCycle = singleSpaVue(&#123;</span><br><span class="line">   Vue,</span><br><span class="line">   appOptions</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用必须导出以下生命周期：bootstrap、mount、unmount</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> bootstrap = vueLifeCycle.bootstrap;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mount = vueLifeCycle.mount;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> unmount = vueLifeCycle.unmount;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> vueLifeCycle;</span><br></pre></td></tr></table></figure>
<p><strong>配置子路由基础路径</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  mode: <span class="string">'history'</span>,</span><br><span class="line">  base: <span class="string">'/vue'</span>,   <span class="comment">//改变路径配置</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.poetries.top/img/static/images/20210731155249.png" alt></p>
<h3 id="2-配置库打包"><a href="#2-配置库打包" class="headerlink" title="2.配置库打包"></a>2.配置库打包</h3><blockquote>
<p>将子模块打包成类库</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//vue.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    configureWebpack: &#123;</span><br><span class="line">    <span class="comment">// 把属性挂载到window上方便父应用调用 window.singleVue.bootstrap/mount/unmount</span></span><br><span class="line">        output: &#123;</span><br><span class="line">            library: <span class="string">'singleVue'</span>,</span><br><span class="line">            libraryTarget: <span class="string">'umd'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        devServer:&#123;</span><br><span class="line">            port:<span class="number">10000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.poetries.top/img/static/images/20210731114005.png" alt></p>
<h3 id="3-主应用搭建"><a href="#3-主应用搭建" class="headerlink" title="3.主应用搭建"></a>3.主应用搭建</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div id=&quot;nav&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/vue&quot;&gt;vue项目router-link&gt; </span><br><span class="line">    &lt;div id=&quot;vue&quot;&gt;div&gt;</span><br><span class="line">div&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将子应用挂载到<code>id=&quot;vue&quot;</code>标签中</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="keyword">import</span> &#123;registerApplication,start&#125; <span class="keyword">from</span> <span class="string">'single-spa'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">    script.src = url </span><br><span class="line">    script.onload = resolve</span><br><span class="line">    script.onerror = reject</span><br><span class="line">    <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册应用</span></span><br><span class="line">registerApplication(<span class="string">'myVueApp'</span>,</span><br><span class="line">  <span class="keyword">async</span> ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.info(<span class="string">'load'</span>)</span><br><span class="line">    <span class="comment">// singlespa问题 </span></span><br><span class="line">    <span class="comment">// 加载文件需要自己构建script标签 但是不知道应用有多少个文件</span></span><br><span class="line">    <span class="comment">// 样式不隔离</span></span><br><span class="line">    <span class="comment">// 全局对象没有js沙箱的机制 比如加载不同的应用 每个应用都用同一个环境</span></span><br><span class="line">    <span class="comment">// 先加载公共的</span></span><br><span class="line">    <span class="keyword">await</span> loadScript(<span class="string">'http://localhost:10000/js/chunk-vendors.js'</span>)</span><br><span class="line">    <span class="keyword">await</span> loadScript(<span class="string">'http://localhost:10000/js/app.js'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.singleVue <span class="comment">// bootstrap mount unmount</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 用户切换到/vue下 我们需要加载刚才定义的子应用</span></span><br><span class="line">  location=&gt;location.pathname.startsWith(<span class="string">'/vue'</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  router,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.poetries.top/img/static/images/20210731155355.png" alt></p>
<h3 id="4-动态设置子应用publicPath"><a href="#4-动态设置子应用publicPath" class="headerlink" title="4.动态设置子应用publicPath"></a>4.动态设置子应用publicPath</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.singleSpaNavigate)&#123;</span><br><span class="line">  __webpack_public_path__ = <span class="string">'http://localhost:10000/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、qiankun实战"><a href="#三、qiankun实战" class="headerlink" title="三、qiankun实战"></a>三、qiankun实战</h2><blockquote>
<p><code>qiankun</code>是目前比较完善的一个微前端解决方案，它已在蚂蚁内部经受过足够大量的项目考验及打磨，十分健壮。这里附上官网。</p>
</blockquote>
<blockquote>
<p><a href="https://qiankun.umijs.org/zh/guide" target="_blank" rel="noopener">https://qiankun.umijs.org/zh/guide</a></p>
</blockquote>
<h3 id="1-主应用编写"><a href="#1-主应用编写" class="headerlink" title="1.主应用编写"></a>1.主应用编写</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--注意这里不要写app 否则跟子应用的加载冲突</span></span><br><span class="line"><span class="comment">  &lt;div id="app"&gt;--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-menu</span> <span class="attr">:router</span>=<span class="string">"true"</span> <span class="attr">mode</span>=<span class="string">"horizontal"</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 基座中可以放自己的路由 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 引用其他子应用 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/vue"</span>&gt;</span>vue应用<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/react"</span>&gt;</span>react应用<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-menu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 其他子应用的挂载节点 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"vue"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注册子应用</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps,start &#125; <span class="keyword">from</span> <span class="string">'qiankun'</span></span><br><span class="line"><span class="comment">// 基座写法</span></span><br><span class="line"><span class="keyword">const</span> apps = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'vueApp'</span>, <span class="comment">// 名字</span></span><br><span class="line">    <span class="comment">// 默认会加载这个HTML，解析里面的js动态执行 （子应用必须支持跨域）</span></span><br><span class="line">    entry: <span class="string">'//localhost:10000'</span>,  </span><br><span class="line">    container: <span class="string">'#vue'</span>, <span class="comment">// 容器</span></span><br><span class="line">    activeRule: <span class="string">'/vue'</span>, <span class="comment">// 激活的路径 访问/vue把应用挂载到#vue上</span></span><br><span class="line">    props: &#123; <span class="comment">// 传递属性给子应用接收</span></span><br><span class="line">      a: <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'reactApp'</span>,</span><br><span class="line">    <span class="comment">// 默认会加载这个HTML，解析里面的js动态执行 （子应用必须支持跨域）</span></span><br><span class="line">    entry: <span class="string">'//localhost:20000'</span>,  </span><br><span class="line">    container: <span class="string">'#react'</span>,</span><br><span class="line">    activeRule: <span class="string">'/react'</span> <span class="comment">// 访问/react把应用挂载到#react上</span></span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line">registerMicroApps(apps)</span><br><span class="line"><span class="comment">// 开启</span></span><br><span class="line">start(&#123;</span><br><span class="line">  prefetch: <span class="literal">false</span> <span class="comment">// 取消预加载</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-子Vue应用"><a href="#2-子Vue应用" class="headerlink" title="2.子Vue应用"></a>2.子Vue应用</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  mode: <span class="string">'history'</span>,</span><br><span class="line">  <span class="comment">// base里主应用里面注册的保持一致</span></span><br><span class="line">  base: <span class="string">'/vue'</span>,</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> instance = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  instance = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    router,</span><br><span class="line">    render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">  &#125;).$mount(<span class="string">'#app'</span>) <span class="comment">// 这里是挂载到自己的HTML中 基座会拿到挂载后的HTML 将其插入进去</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 独立运行微应用</span></span><br><span class="line"><span class="comment">// https://qiankun.umijs.org/zh/faq#%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E5%BE%AE%E5%BA%94%E7%94%A8%EF%BC%9F</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.__POWERED_BY_QIANKUN__) &#123;</span><br><span class="line">  render()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果被qiankun使用 会动态注入路径</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.__POWERED_BY_QIANKUN__) &#123;</span><br><span class="line">  <span class="comment">// qiankun 将会在微应用 bootstrap 之前注入一个运行时的 publicPath 变量，你需要做的是在微应用的 entry js 的顶部添加如下代码：</span></span><br><span class="line">  __webpack_public_path__ = <span class="built_in">window</span>.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用的协议 导出供父应用调用 必须导出promise</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">props</span>) </span>&#123;&#125; <span class="comment">// 启动可以不用写 需要导出方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  render()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  instance.$destroy()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里不要忘记子应用的钩子导出。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// vue.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    devServer:&#123;</span><br><span class="line">        port:<span class="number">10000</span>,</span><br><span class="line">        headers:&#123;</span><br><span class="line">            <span class="string">'Access-Control-Allow-Origin'</span>:<span class="string">'*'</span> <span class="comment">//允许访问跨域</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    configureWebpack:&#123;</span><br><span class="line">        <span class="comment">// 打umd包</span></span><br><span class="line">        output:&#123;</span><br><span class="line">            library:<span class="string">'vueApp'</span>,</span><br><span class="line">            libraryTarget:<span class="string">'umd'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-子React应用"><a href="#3-子React应用" class="headerlink" title="3.子React应用"></a>3.子React应用</h3><blockquote>
<p>再起一个子应用，为了表明技术栈无关特性，这里使用了一个<code>React</code>项目：</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">import logo from './logo.svg';</span><br><span class="line">import './App.css';</span><br><span class="line">import &#123;BrowserRouter,Route,Link&#125; from 'react-router-dom'</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    // /react跟主应用配置保持一致</span><br><span class="line">    <span class="tag">&lt;<span class="name">BrowserRouter</span> <span class="attr">basename</span>=<span class="string">"/react"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/"</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/about"</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"/"</span> <span class="attr">exact</span> <span class="attr">render</span>=<span class="string">&#123;()</span>=&gt;</span>(</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">header</span> <span class="attr">className</span>=<span class="string">"App-header"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;logo&#125;</span> <span class="attr">className</span>=<span class="string">"App-logo"</span> <span class="attr">alt</span>=<span class="string">"logo"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">              Edit <span class="tag">&lt;<span class="name">code</span>&gt;</span>src/App.js<span class="tag">&lt;/<span class="name">code</span>&gt;</span> and save to reload.</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">              <span class="attr">className</span>=<span class="string">"App-link"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">href</span>=<span class="string">"https://reactjs.org"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">rel</span>=<span class="string">"noopener noreferrer"</span></span></span><br><span class="line"><span class="tag">            &gt;</span></span><br><span class="line">              Learn React</span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      )&#125; /&gt;</span><br><span class="line">      </span><br><span class="line">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"/about"</span> <span class="attr">exact</span> <span class="attr">render</span>=<span class="string">&#123;()</span>=&gt;</span>(</span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>About Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">      )&#125;&gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default App;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> reportWebVitals <span class="keyword">from</span> <span class="string">'./reportWebVitals'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;React.StrictMode&gt;</span><br><span class="line">      &lt;App /&gt;</span><br><span class="line">    &lt;<span class="regexp">/React.StrictMode&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById('root')</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ If you want to start measuring performance in your app, pass a function</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ to log results (for example: reportWebVitals(console.log))</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ or send to an analytics endpoint. Learn more: https:/</span><span class="regexp">/bit.ly/</span>CRA-vitals</span><br><span class="line">reportWebVitals();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 独立运行</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.__POWERED_BY_QIANKUN__)&#123;</span><br><span class="line">  render()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子应用协议</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  render()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ReactDOM.unmountComponentAtNode(<span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>重写react中的webpack配置文件 (config-overrides.js)</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn add react-app-rewired --save-dev</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改package.json文件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// react-scripts 改成 react-app-rewired</span></span><br><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"react-app-rewired start"</span>,</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"react-app-rewired build"</span>,</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"react-app-rewired test"</span>,</span><br><span class="line">    <span class="string">"eject"</span>: <span class="string">"react-app-rewired eject"</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在根目录新建配置文件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 配置文件重写</span></span><br><span class="line">touch config-overrides.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config-overrides.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  webpack: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 名字和基座配置的一样</span></span><br><span class="line">    config.output.library = <span class="string">'reactApp'</span>;</span><br><span class="line">    config.output.libraryTarget = <span class="string">"umd"</span>;</span><br><span class="line">    config.output.publicPath = <span class="string">'http://localhost:20000/'</span></span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: <span class="function"><span class="keyword">function</span> (<span class="params">configFunction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">proxy, allowedHost</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> config = configFunction(proxy, allowedHost);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置跨域</span></span><br><span class="line">      config.headers = &#123;</span><br><span class="line">        <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">"*"</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> config;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>配置.env文件</strong></p>
<blockquote>
<p>根目录新建<code>.env</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PORT=20000</span><br><span class="line"># socket发送端口</span><br><span class="line">WDS_SOCKET_PORT=20000</span><br></pre></td></tr></table></figure>
<p><strong>React路由配置</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserRouter, Route, Link &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> BASE_NAME = <span class="built_in">window</span>.__POWERED_BY_QIANKUN__ ? <span class="string">"/react"</span> : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;BrowserRouter basename=&#123;BASE_NAME&#125;&gt;&lt;Link to="/"&gt;首页Link&gt;&lt;Link to="/about"&gt;关于Link&gt;&lt;Route path="/" exact render=&#123;() =&gt; &lt;h1&gt;hello homeh1&gt;&#125;&gt;Route&gt;&lt;Route path="/about" render=&#123;() =&gt; &lt;h1&gt;hello abouth1&gt;&#125;&gt;Route&gt;BrowserRouter&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.poetries.top/img/static/images/20210731205952.png" alt></p>
<h2 id="四、飞冰微前端实战"><a href="#四、飞冰微前端实战" class="headerlink" title="四、飞冰微前端实战"></a>四、飞冰微前端实战</h2><blockquote>
<p>官方接入指南 <a href="https://micro-frontends.ice.work/docs/guide" target="_blank" rel="noopener">https://micro-frontends.ice.work/docs/guide</a></p>
</blockquote>
<h3 id="4-1-react主应用编写"><a href="#4-1-react主应用编写" class="headerlink" title="4.1 react主应用编写"></a>4.1 react主应用编写</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$ npm init ice icestark-layout @icedesign/stark-layout-scaffold</span><br><span class="line">$ cd icestark-layout</span><br><span class="line">$ npm install</span><br><span class="line">$ npm start</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/app.jsx中加入</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> appConfig: IAppConfig = &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  icestark: &#123;</span><br><span class="line">    type: <span class="string">'framework'</span>,</span><br><span class="line">    Layout: FrameworkLayout,</span><br><span class="line">    getApps: <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> apps = [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/vue'</span>,</span><br><span class="line">        title: <span class="string">'vue微应用测试'</span>,</span><br><span class="line">        sandbox: <span class="literal">false</span>,</span><br><span class="line">        url: [</span><br><span class="line">          <span class="comment">// 测试环境</span></span><br><span class="line">          <span class="comment">// 请求子应用端口下的服务，子应用的vue.config.js里面 需要配置headers跨域请求头</span></span><br><span class="line">          <span class="string">"http://localhost:3001/js/chunk-vendors.js"</span>,</span><br><span class="line">          <span class="string">"http://localhost:3001/js/app.js"</span>,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/react'</span>,</span><br><span class="line">        title: <span class="string">'react微应用测试'</span>,</span><br><span class="line">        sandbox: <span class="literal">true</span>,</span><br><span class="line">        url: [</span><br><span class="line">          <span class="comment">// 测试环境</span></span><br><span class="line">          <span class="comment">// 请求子应用端口下的服务，子应用的webpackDevServer.config.js里面 需要配置headers跨域请求头</span></span><br><span class="line">          <span class="string">"http://localhost:3000/static/js/bundle.js"</span>,</span><br><span class="line">        ],</span><br><span class="line">      &#125;</span><br><span class="line">    ];</span><br><span class="line">      <span class="keyword">return</span> apps;</span><br><span class="line">    &#125;,</span><br><span class="line">    appRouter: &#123;</span><br><span class="line">      LoadingComponent: PageLoading,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 侧边栏菜单</span></span><br><span class="line"><span class="comment">// src/layouts/menuConfig.ts 改造</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asideMenuConfig = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'vue微应用测试'</span>,</span><br><span class="line">    icon: <span class="string">'set'</span>,</span><br><span class="line">    path: <span class="string">'/vue'</span> </span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'React微应用测试'</span>,</span><br><span class="line">    icon: <span class="string">'set'</span>,</span><br><span class="line">    path: <span class="string">'/react'</span></span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="4-2-vue子应用接入"><a href="#4-2-vue子应用接入" class="headerlink" title="4.2 vue子应用接入"></a>4.2 vue子应用接入</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建一个子应用</span><br><span class="line">vue create vue-child</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 修改vue.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    open: <span class="literal">true</span>, <span class="comment">// 设置浏览器自动打开项目</span></span><br><span class="line">    port: <span class="number">3001</span>, <span class="comment">// 设置端口</span></span><br><span class="line">    <span class="comment">// 支持跨域 方便主应用请求子应用资源</span></span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'Access-Control-Allow-Origin'</span> : <span class="string">'*'</span>,</span><br><span class="line">      <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span>,</span><br><span class="line">      <span class="string">'Access-Control-Allow-Headers'</span>: <span class="string">'X-Requested-With, content-type, Authorization'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  configureWebpack: &#123;</span><br><span class="line">    <span class="comment">// 打包成lib包 umd格式</span></span><br><span class="line">    output: &#123;</span><br><span class="line">      library: <span class="string">'icestark-vue'</span>,</span><br><span class="line">      libraryTarget: <span class="string">'umd'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>src/main.js</code>改造</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  isInIcestark,</span><br><span class="line">  getMountNode,</span><br><span class="line">  registerAppEnter,</span><br><span class="line">  registerAppLeave,</span><br><span class="line">  setLibraryName</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ice/stark-app'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vue = createApp(App)</span><br><span class="line">vue.use(store)</span><br><span class="line">vue.use(router)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：`setLibraryName` 的入参需要与 webpack 工程配置的 output.library 保持一致</span></span><br><span class="line"><span class="comment">//  重要 不加不生效 和 vue.config.js中配置的一样</span></span><br><span class="line">setLibraryName(<span class="string">'icestark-vue'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">&#123; container &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ![](https://blog.poetries.top/img/static/images/20210731130030.png)</span></span><br><span class="line">  <span class="built_in">console</span>.log(container,<span class="string">'container'</span>)</span><br><span class="line">  vue.mount(container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  vue.unmount();</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (!isInIcestark()) &#123;</span><br><span class="line">  vue.mount(<span class="string">'#app'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>router改造</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &#123; getBasename &#125; from &apos;@ice/stark-app&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const router = createRouter(&#123;</span><br><span class="line">  // 重要 在主应用中的基准路由</span><br><span class="line">  base: getBasename(),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">export default router</span><br></pre></td></tr></table></figure>
<h3 id="4-3-react子应用接入"><a href="#4-3-react子应用接入" class="headerlink" title="4.3 react子应用接入"></a>4.3 react子应用接入</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create-react-app react-child</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// src/app.js</span><br><span class="line"></span><br><span class="line">import &#123; isInIcestark, getMountNode, registerAppEnter, registerAppLeave &#125; from &apos;@ice/stark-app&apos;;</span><br><span class="line"></span><br><span class="line">export function mount(props) &#123;</span><br><span class="line">  ReactDOM.render(&lt;App /&gt;, props.container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function unmount(props) &#123;</span><br><span class="line">  ReactDOM.unmountComponentAtNode(props.container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isInIcestark()) &#123;</span><br><span class="line">  ReactDOM.render(&lt;App /&gt;, document.getElementById(&apos;root&apos;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isInIcestark()) &#123;</span><br><span class="line">  registerAppEnter(() =&gt; &#123;</span><br><span class="line">    ReactDOM.render(&lt;App /&gt;, getMountNode());</span><br><span class="line">  &#125;)</span><br><span class="line">  registerAppLeave(() =&gt; &#123;</span><br><span class="line">    ReactDOM.unmountComponentAtNode(getMountNode());</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  ReactDOM.render(&lt;App /&gt;, document.getElementById(&apos;root&apos;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>npm run eject</code>后，改造 <code>config/webpackDevServer.config.js</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">hot: <span class="string">''</span>,</span><br><span class="line">port: <span class="string">''</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持跨域</span></span><br><span class="line">headers: &#123;</span><br><span class="line">  <span class="string">'Access-Control-Allow-Origin'</span> : <span class="string">'*'</span>,</span><br><span class="line">  <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span>,</span><br><span class="line">  <span class="string">'Access-Control-Allow-Headers'</span>: <span class="string">'X-Requested-With, content-type, Authorization'</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="五、CSS隔离方案"><a href="#五、CSS隔离方案" class="headerlink" title="五、CSS隔离方案"></a>五、CSS隔离方案</h2><h3 id="子应用之间样式隔离："><a href="#子应用之间样式隔离：" class="headerlink" title="子应用之间样式隔离："></a>子应用之间样式隔离：</h3><blockquote>
<p><code>Dynamic Stylesheet</code>动态样式表，当应用切换时移除掉老应用样式，再添加新应用样式，保证在一个时间点内只有一个应用的样式表生效</p>
</blockquote>
<h3 id="主应用和子应用之间的样式隔离："><a href="#主应用和子应用之间的样式隔离：" class="headerlink" title="主应用和子应用之间的样式隔离："></a>主应用和子应用之间的样式隔离：</h3><ul>
<li><code>BEM(Block Element Modifier)</code>  约定项目前缀</li>
<li><code>CSS-Modules</code> 打包时生成不冲突的选择器名</li>
<li>Shadow DOM 真正意义上的隔离</li>
<li><code>css-in-js</code></li>
</ul>
<p><img src="https://blog.poetries.top/img/static/images/20210731160312.png" alt></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>shadow dom<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"shadow"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> shadowDOM = <span class="built_in">document</span>.getElementById(<span class="string">'shadow'</span>).attachShadow(&#123;<span class="attr">mode</span>: <span class="string">'closed'</span>&#125;) <span class="comment">// 外界无法访问 </span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> pEle = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>)</span></span><br><span class="line"><span class="javascript">      pEle.innerHTML = <span class="string">'hello shadowDOM'</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> styleEle = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</span></span><br><span class="line"><span class="javascript">      styleEle.textContent = <span class="string">`p&#123;color:red&#125; `</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="comment">// ![](https://blog.poetries.top/img/static/images/20210731135230.png)</span></span></span><br><span class="line">      shadowDOM.appendChild(styleEle)</span><br><span class="line">      shadowDOM.appendChild(pEle)</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="comment">// react vue 里面的弹框等因为挂载到body上 所以用shadowDOM不行 </span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 会挂载到全局污染样式</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//document.body.appendChild(pEle)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>shadow DOM</code> 内部的元素始终不会影响到它的外部元素，可以实现真正意义上的隔离</p>
</blockquote>
<h2 id="六、JS沙箱机制"><a href="#六、JS沙箱机制" class="headerlink" title="六、JS沙箱机制"></a>六、JS沙箱机制</h2><p><img src="https://blog.poetries.top/img/static/images/20210731155716.png" alt></p>
<blockquote>
<p>当运行子应用时应该跑在内部沙箱环境中</p>
</blockquote>
<ul>
<li>快照沙箱，当应用沙箱挂载或卸载时记录快照，在切换时依据快照恢复环境 (无法支持多实例)</li>
<li><code>Proxy</code> 代理沙箱，不影响全局环境</li>
</ul>
<h3 id="1-快照沙箱"><a href="#1-快照沙箱" class="headerlink" title="1.快照沙箱"></a>1.快照沙箱</h3><ol>
<li>激活时将当前window属性进行快照处理</li>
<li>失活时用快照中的内容和当前window属性比对</li>
<li>如果属性发生变化保存到<code>modifyPropsMap</code>中，并用快照还原window属性</li>
<li>再次激活时，再次进行快照，并用上次修改的结果还原window属性</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnapshotSandbox</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxy = <span class="built_in">window</span>; </span><br><span class="line">        <span class="keyword">this</span>.modifyPropsMap = &#123;&#125;; <span class="comment">// 修改了哪些属性</span></span><br><span class="line">        <span class="keyword">this</span>.active();</span><br><span class="line">    &#125;</span><br><span class="line">    active() &#123;</span><br><span class="line">        <span class="keyword">this</span>.windowSnapshot = &#123;&#125;; <span class="comment">// window对象的快照</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">window</span>.hasOwnProperty(prop)) &#123;</span><br><span class="line">                <span class="comment">// 将window上的属性进行拍照</span></span><br><span class="line">                <span class="keyword">this</span>.windowSnapshot[prop] = <span class="built_in">window</span>[prop];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.modifyPropsMap).forEach(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">window</span>[p] = <span class="keyword">this</span>.modifyPropsMap[p];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    inactive() &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> <span class="built_in">window</span>) &#123; <span class="comment">// diff 差异</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">window</span>.hasOwnProperty(prop)) &#123;</span><br><span class="line">                <span class="comment">// 将上次拍照的结果和本次window属性做对比</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">window</span>[prop] !== <span class="keyword">this</span>.windowSnapshot[prop]) &#123;</span><br><span class="line">                    <span class="comment">// 保存修改后的结果</span></span><br><span class="line">                    <span class="keyword">this</span>.modifyPropsMap[prop] = <span class="built_in">window</span>[prop]; </span><br><span class="line">                    <span class="comment">// 还原window</span></span><br><span class="line">                    <span class="built_in">window</span>[prop] = <span class="keyword">this</span>.windowSnapshot[prop]; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> sandbox = <span class="keyword">new</span> SnapshotSandbox();</span><br><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">window</span>.b = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">window</span>.c = <span class="number">3</span></span><br><span class="line">    <span class="built_in">console</span>.log(a,b,c)</span><br><span class="line">    sandbox.inactive();</span><br><span class="line">    <span class="built_in">console</span>.log(a,b,c)</span><br><span class="line">&#125;)(sandbox.proxy);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>快照沙箱只能针对单实例应用场景，如果是多个实例同时挂载的情况则无法解决，这时只能通过Proxy代理沙箱来实现</p>
</blockquote>
<h3 id="2-Proxy-代理沙箱"><a href="#2-Proxy-代理沙箱" class="headerlink" title="2.Proxy 代理沙箱"></a>2.Proxy 代理沙箱</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxySandbox</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">const</span> rawWindow = <span class="built_in">window</span>;</span><br><span class="line">        <span class="keyword">const</span> fakeWindow = &#123;&#125;</span><br><span class="line">        <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(fakeWindow, &#123;</span><br><span class="line">            <span class="keyword">set</span>(target, p, value) &#123;</span><br><span class="line">                target[p] = value;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">get</span>(target, p) &#123;</span><br><span class="line">                <span class="keyword">return</span> target[p] || rawWindow[p];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.proxy = proxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> sandbox1 = <span class="keyword">new</span> ProxySandbox();</span><br><span class="line"><span class="keyword">let</span> sandbox2 = <span class="keyword">new</span> ProxySandbox();</span><br><span class="line"><span class="built_in">window</span>.a = <span class="number">1</span>;</span><br><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.a = <span class="string">'hello'</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.a)</span><br><span class="line">&#125;)(sandbox1.proxy);</span><br><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.a = <span class="string">'world'</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.a)</span><br><span class="line">&#125;)(sandbox2.proxy);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>每个应用都创建一个<code>proxy</code>来代理<code>window</code>对象，好处是每个应用都是相对独立的，不需要直接更改全局的<code>window</code>属性</p>
</blockquote>

      </div>
    
  </div>

</article>

<!-- <button class="assist-btn2 circle" id="assist_btn2" title="点亮屏幕" style="left: 27px; top: 152px;">
  <i class="iconfont" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button>
<button class="assist-btn1 circle" id="assist_btn1" title="关闭屏幕亮度" style="left: 27px; top: 152px;">
  <i class="iconfont toc-title" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button> -->


<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>	

<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
  function getCookie(key) {
    if (document.cookie.length > 0) {
      var start = document.cookie.indexOf(key + "=");
      if (start !== -1) {
        start = start + key.length + 1;
        var end = document.cookie.indexOf(";", start);
        if (end === -1) end = document.cookie.length;
        return unescape(document.cookie.substring(start, end));
      }
    }
    return "";
  }
  const feToken = getCookie('fe-token');
  const btw = new BTWPlugin();
  console.log('ft', feToken)
  if(!feToken) {
    btw.init({
      id: "container",
      blogId: "22699-1592137983091-414",
      name: "前端进阶之旅",
      qrcode: "https://poetries1.gitee.io/img-repo/2020/06/qrcode.jpg",
      keyword: "3a3b3c",
    });
  }
</script>

<script type="text/javascript">

// white theme
var body = {color: "#555", background: "#000"};
var a_tag = {color: "#222"};
var header = { background: "#222"};
var logo_line_i = {background: "#222"};
// var post_code = {background: "#eee", color: "#222"};

function switch_theme() {
 $("body").css(body);
 $("a:not('.links-of-author-item a, .site-state-item a, .site-state-posts a, .feed-link a, .motion-element a, .post-tags a, .show-commit-cls a, #donate_board a')").css(a_tag);
 $(".header, .footer").css(header);
 $(".logo-line-before i, .logo-line-after i").css(logo_line_i);
 //$(".post code").css(post_code);
 $("#idhyt-surprise-ball #idhyt-surprise-ball-animation .drag").css(a_tag);
 $(".post-title-link, .posts-expand .post-meta, .post-comments-count, .disqus-comment-count, .post-category a, .post-nav-next a, .post-nav-item a").css(a_tag);
 
 // $("code").css({color: '#c5c8c6', background: '#1d1f21'});
 //$("#assist_btn1").hide(1500);
}

$(function () {
$("#assist_btn2").css("display","none");
 $("#assist_btn1").click(function() {
     switch_theme();
$("div#toc.toc-article").css({
 "background":"#eaeaea",
 "opacity":1
});
$(".toc-article ol").show();
$("#toc.toc-article .toc-title").css("color","#a98602");
$("#assist_btn1").css("display","none");
$("#assist_btn2").css("display","block");
 });
$("#assist_btn2").click(function() {
$("#assist_btn2").css("display","none");
$("#assist_btn1").css("display","block");
$("body").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
     $(".header, .footer").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
$(".toc-article ol").toggle(1000);
 });
});


//背景随机

var Y, O, E, L, B, C, T, z, N, S, A, I;
!function() {
var e = function() {
for (O.clearRect(0, 0, L, B), T = [{
x: 0,
y: .7 * B + C
}, {
x: 0,
y: .7 * B - C
}]; T[1].x < L + C;) t(T[0], T[1])
}, t = function(e, t) {
O.beginPath(), O.moveTo(e.x, e.y), O.lineTo(t.x, t.y);
var n = t.x + (2 * I() - .25) * C,
 r = a(t.y);
O.lineTo(n, r), O.closePath(), N -= S / -50, O.fillStyle = "#" + (127 * A(N) + 128 << 16 | 127 * A(N + S / 3) + 128 << 8 | 127 * A(N + S / 3 * 2) + 128).toString(16), O.fill(), T[0] = T[1], T[1] = {
 x: n,
 y: r
}
}, a = function n(e) {
var t = e + (2 * I() - 1.1) * C;
return t > B || t < 0 ? n(e) : t
};
Y = document.getElementById("evanyou"), O = Y.getContext("2d"), E = window.devicePixelRatio || 1, L = window.innerWidth, B = window.innerHeight, C = 90, z = Math, N = 0, S = 2 * z.PI, A = z.cos, I = z.random, Y.width = L * E, Y.height = B * E, O.scale(E, E), O.globalAlpha = .6, document.onclick = e, document.ontouchstart = e, e()
}()

   
$("#toc-eye").click(function(){
$("#toc.toc-article").toggle(1000);
});

</script>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持poetries</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/weixin.jpg" alt="">
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/zhifubao.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2021/05/11/fe-monitor-sys/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2021/09/12/serverless-cloud-weapp/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/categories/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tags/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '5567a2c4abb858009d96',
  clientSecret: 'b9039ec056cf5c2346b3cdb63308a28c163f91e5',
  repo: 'poetries.github.io',
  owner: 'poetries',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: location.pathname,
  admin: ['poetries'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
 
  
</body>
</html>
