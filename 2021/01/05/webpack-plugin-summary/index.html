<!DOCTYPE html>


  <html class="dark page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>webpack plugin原理分析与实践 | 前端进阶之旅</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="webpack,插件,">
  

  <meta name="description" content="原理分析 在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果  如何实现一个插件 一个最基础的 Plugin 的代码是这样的：  class BasicPlugin&amp;#123;  // 在构造函数中获取用户给该插件传入的配置  constructor(options)&amp;#123;  &amp;#125;">
<meta name="keywords" content="webpack,插件">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack plugin原理分析与实践">
<meta property="og:url" content="http://blog.poetries.top/2021/01/05/webpack-plugin-summary/index.html">
<meta property="og:site_name" content="前端进阶之旅">
<meta property="og:description" content="原理分析 在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果  如何实现一个插件 一个最基础的 Plugin 的代码是这样的：  class BasicPlugin&amp;#123;  // 在构造函数中获取用户给该插件传入的配置  constructor(options)&amp;#123;  &amp;#125;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://poetries1.gitee.io/img-repo/2021/01/13.png">
<meta property="og:image" content="https://poetries1.gitee.io/img-repo/2021/01/14.png">
<meta property="og:updated_time" content="2025-03-30T13:54:29.510Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpack plugin原理分析与实践">
<meta name="twitter:description" content="原理分析 在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果  如何实现一个插件 一个最基础的 Plugin 的代码是这样的：  class BasicPlugin&amp;#123;  // 在构造函数中获取用户给该插件传入的配置  constructor(options)&amp;#123;  &amp;#125;">
<meta name="twitter:image" content="https://poetries1.gitee.io/img-repo/2021/01/13.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">
<link href="/css/other.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5081f3afc8d94338e79d319c8b632b31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  <!-- 聊天系统 -->
  
    
   <link type="text/css" rel="stylesheet" href="/renxi/default.css">
   <style>
      #modal {
        position: static !important;
      }
      .filter {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: #fe5757;
        animation: colorChange 30s ease-in-out infinite;
        animation-fill-mode: both;
        mix-blend-mode: overlay;
      }
  
      @keyframes colorChange {
        0%, 100% {
            opacity: 0;
        }
        50% {
            opacity: .9;
        }
      }
   </style>
</head>
</html>
<body>
  
  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/categories/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tags/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录<i class="iconfont toc-title" style="display:inline-block;color:#87998d;width:20px;height:20px;">&#xf004b;</i></strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#原理分析"><span class="toc-text">原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#如何实现一个插件"><span class="toc-text">如何实现一个插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiler-和-Compilation"><span class="toc-text">Compiler 和 Compilation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事件流"><span class="toc-text">事件流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用-API"><span class="toc-text">常用 API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#读取输出资源、代码块、模块及其依赖"><span class="toc-text">读取输出资源、代码块、模块及其依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监听文件变化"><span class="toc-text">监听文件变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改输出资源"><span class="toc-text">修改输出资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#判断-Webpack-使用了哪些插件"><span class="toc-text">判断 Webpack 使用了哪些插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实践"><span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在-Webpack-即将退出时再附加一些额外的操作"><span class="toc-text">在 Webpack 即将退出时再附加一些额外的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成各个文件的大小到指定目录文件中"><span class="toc-text">生成各个文件的大小到指定目录文件中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成版权信息"><span class="toc-text">生成版权信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打包zip插件"><span class="toc-text">打包zip插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
  </div>
  




<div class="content content-post CENTER">
   <!-- canvas 彩带 -->
<canvas id="evanyou" width="1302" height="678" style="position: fixed;width: 100%;height: 100%;top: 0;left:0;z-index:-1;"></canvas>

<div class="qrcode_container">
  <div class="tencent_code">
    <h4>关注作者公众号</h4> 
    <p>和万千小伙伴一起学习</p> 
    <img src="https://interview.poetries.top/qrcode.jpg" alt="公众号：前端进价之旅">
  </div> 
</div>

<article id="post-webpack-plugin-summary" class="article article-type-post" itemprop="blogPost">
  <header class="article-header" style="position:relative;">
    <h1 class="post-title">webpack plugin原理分析与实践</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2021.01.05</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Poetry</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/Front-End/">Front-End</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
       
          <span class="post-count">
            <i class="fa fa-file-word-o"></i>&nbsp
            <span>字数统计 3.8k字</span>
          </span>

          <span class="post-count">
            <i class="fa fa-columns"></i>&nbsp
            <span>阅读时长 15分</span>
          </span>
      
      
    </div>

    <i class="iconfont" id="toc-eye" style="display:inline-block;color:#b36619;position:absolute;top:20px;right:-11px;cursor:pointer;
    font-size: 24px;">&#xe61c;</i>

  </header>

  <div class="article-content">
    
      <div id="container">
        <h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><blockquote>
<p>在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果</p>
</blockquote>
<h3 id="如何实现一个插件"><a href="#如何实现一个插件" class="headerlink" title="如何实现一个插件"></a>如何实现一个插件</h3><blockquote>
<p>一个最基础的 Plugin 的代码是这样的：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicPlugin</span></span>&#123;</span><br><span class="line">  <span class="comment">// 在构造函数中获取用户给该插件传入的配置</span></span><br><span class="line">  <span class="keyword">constructor</span>(options)&#123;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span></span><br><span class="line">  apply(compiler)&#123;</span><br><span class="line">    compiler.plugin(<span class="string">'compilation'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">compilation,callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出 Plugin</span></span><br><span class="line"><span class="built_in">module</span>.exports = BasicPlugin;</span><br></pre></td></tr></table></figure>
<p><strong>在使用这个 Plugin 时，相关配置代码如下：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BasicPlugin = <span class="built_in">require</span>(<span class="string">'./BasicPlugin.js'</span>);</span><br><span class="line"><span class="built_in">module</span>.export = &#123;</span><br><span class="line">  plugins:[</span><br><span class="line">    <span class="keyword">new</span> BasicPlugin(options),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Webpack 启动后，在读取配置的过程中会先执行 <code>new BasicPlugin(options)</code> 初始化一个 <code>BasicPlugin</code> 获得其实例。</li>
<li>在初始化 <code>compiler</code> 对象后，再调用 <code>basicPlugin.apply(compiler)</code> 给插件实例传入 <code>compiler</code> 对象。</li>
<li>插件实例在获取到 compiler 对象后，就可以通过 <code>compiler.plugin(事件名称, 回调函数)</code> 监听到 Webpack 广播出来的事件。</li>
<li>并且可以通过 <code>compiler</code>对象去操作 Webpack。</li>
</ul>
<p>通过以上最简单的 Plugin 相信你大概明白了 Plugin 的工作原理，但实际开发中还有很多细节需要注意，下面来详细介绍。</p>
<h3 id="Compiler-和-Compilation"><a href="#Compiler-和-Compilation" class="headerlink" title="Compiler 和 Compilation"></a>Compiler 和 Compilation</h3><blockquote>
<p>在开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack 之间的桥梁。</p>
</blockquote>
<ul>
<li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li>
<li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。</li>
</ul>
<p><strong>Compiler 和 Compilation 的区别在于</strong>：<code>Compiler</code> 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译。</p>
<blockquote>
<p>webpack 的源码compiler钩子函数是借助tapable库实现的</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    Tapable,</span><br><span class="line">    SyncHook,</span><br><span class="line">    SyncBailHook,</span><br><span class="line">    AsyncParallelHook,</span><br><span class="line">    AsyncSeriesHook</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">"tapable"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> <span class="keyword">extends</span> <span class="title">Tapable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(context) &#123;</span><br><span class="line">      <span class="keyword">super</span>();</span><br><span class="line">      <span class="keyword">this</span>.hooks = &#123;</span><br><span class="line">          <span class="comment">/** @type &#123;SyncBailHook&lt;Compilation&gt;&#125; */</span></span><br><span class="line">          shouldEmit: <span class="keyword">new</span> SyncBailHook([<span class="string">"compilation"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Stats&gt;&#125; */</span></span><br><span class="line">          done: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"stats"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;&gt;&#125; */</span></span><br><span class="line">          additionalPass: <span class="keyword">new</span> AsyncSeriesHook([]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compiler&gt;&#125; */</span></span><br><span class="line">          beforeRun: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compiler"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compiler&gt;&#125; */</span></span><br><span class="line">          run: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compiler"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compilation&gt;&#125; */</span></span><br><span class="line">          emit: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;string, Buffer&gt;&#125; */</span></span><br><span class="line">          assetEmitted: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"file"</span>, <span class="string">"content"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compilation&gt;&#125; */</span></span><br><span class="line">          afterEmit: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line"></span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;Compilation, CompilationParams&gt;&#125; */</span></span><br><span class="line">          thisCompilation: <span class="keyword">new</span> SyncHook([<span class="string">"compilation"</span>, <span class="string">"params"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;Compilation, CompilationParams&gt;&#125; */</span></span><br><span class="line">          compilation: <span class="keyword">new</span> SyncHook([<span class="string">"compilation"</span>, <span class="string">"params"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;NormalModuleFactory&gt;&#125; */</span></span><br><span class="line">          normalModuleFactory: <span class="keyword">new</span> SyncHook([<span class="string">"normalModuleFactory"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;ContextModuleFactory&gt;&#125;  */</span></span><br><span class="line">          contextModuleFactory: <span class="keyword">new</span> SyncHook([<span class="string">"contextModulefactory"</span>]),</span><br><span class="line"></span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;CompilationParams&gt;&#125; */</span></span><br><span class="line">          beforeCompile: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"params"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;CompilationParams&gt;&#125; */</span></span><br><span class="line">          compile: <span class="keyword">new</span> SyncHook([<span class="string">"params"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncParallelHook&lt;Compilation&gt;&#125; */</span></span><br><span class="line">          make: <span class="keyword">new</span> AsyncParallelHook([<span class="string">"compilation"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compilation&gt;&#125; */</span></span><br><span class="line">          afterCompile: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compilation"</span>]),</span><br><span class="line"></span><br><span class="line">          <span class="comment">/** @type &#123;AsyncSeriesHook&lt;Compiler&gt;&#125; */</span></span><br><span class="line">          watchRun: <span class="keyword">new</span> AsyncSeriesHook([<span class="string">"compiler"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;Error&gt;&#125; */</span></span><br><span class="line">          failed: <span class="keyword">new</span> SyncHook([<span class="string">"error"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;string, string&gt;&#125; */</span></span><br><span class="line">          invalid: <span class="keyword">new</span> SyncHook([<span class="string">"filename"</span>, <span class="string">"changeTime"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&#125; */</span></span><br><span class="line">          watchClose: <span class="keyword">new</span> SyncHook([]),</span><br><span class="line"></span><br><span class="line">          <span class="comment">/** @type &#123;SyncBailHook&lt;string, string, any[]&gt;&#125; */</span></span><br><span class="line">          infrastructureLog: <span class="keyword">new</span> SyncBailHook([<span class="string">"origin"</span>, <span class="string">"type"</span>, <span class="string">"args"</span>]),</span><br><span class="line"></span><br><span class="line">          <span class="comment">// TODO the following hooks are weirdly located here</span></span><br><span class="line">          <span class="comment">// TODO move them for webpack 5</span></span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&#125; */</span></span><br><span class="line">          environment: <span class="keyword">new</span> SyncHook([]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&#125; */</span></span><br><span class="line">          afterEnvironment: <span class="keyword">new</span> SyncHook([]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;Compiler&gt;&#125; */</span></span><br><span class="line">          afterPlugins: <span class="keyword">new</span> SyncHook([<span class="string">"compiler"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncHook&lt;Compiler&gt;&#125; */</span></span><br><span class="line">          afterResolvers: <span class="keyword">new</span> SyncHook([<span class="string">"compiler"</span>]),</span><br><span class="line">          <span class="comment">/** @type &#123;SyncBailHook&lt;string, Entry&gt;&#125; */</span></span><br><span class="line">          entryOption: <span class="keyword">new</span> SyncBailHook([<span class="string">"context"</span>, <span class="string">"entry"</span>])</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的钩子函数是在<code>webpack</code>解析代码的不同周期执行的</p>
</blockquote>
<ul>
<li>其中同步四种，异步并行两种，异步串行3种。</li>
<li>同步钩子进行同步操作；异步钩子中进行异步操作。</li>
</ul>
<blockquote>
<p><code>compiler</code>和<code>compilation</code>中的钩子都是自称自这9种钩子。钩子的工作机制类似于浏览器的事件监听。</p>
</blockquote>
<ul>
<li>生成的钩子可以注册监听事件，其中同步钩子通过tap方法监听，异步钩子通过tapAsync(+回调函数)和tapPromise(+返回promise)进行监听。</li>
<li>还可以进行拦截，通过intercept方法。</li>
<li>对于监听事件的触发，同步钩子通过call方法; 异步钩子通过callAsync方法和promise</li>
</ul>
<h3 id="事件流"><a href="#事件流" class="headerlink" title="事件流"></a>事件流</h3><ul>
<li>Webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。</li>
<li>这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理</li>
<li>插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</li>
<li>Webpack 通过 Tapable 来组织这条复杂的生产线。</li>
<li>Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。</li>
<li>Webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。</li>
<li>Webpack 的事件流机制应用了观察者模式，和 Node.js 中的 EventEmitter 非常相似。</li>
<li><code>Compiler</code> 和 <code>Compilation</code> 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 广播出事件</span></span><br><span class="line"><span class="comment">* event-name 为事件名称，注意不要和现有的事件重名</span></span><br><span class="line"><span class="comment">* params 为附带的参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">compiler.apply(<span class="string">'event-name'</span>,params);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。</span></span><br><span class="line"><span class="comment">* 同时函数中的 params 参数为广播事件时附带的参数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">compiler.plugin(<span class="string">'event-name'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同理，<code>compilation.apply</code> 和 <code>compilation.plugin</code> 使用方法和上面一致。</p>
</blockquote>
<p>在开发插件时，你可能会不知道该如何下手，因为你不知道该监听哪个事件才能完成任务。</p>
<p><strong>在开发插件时，还需要注意以下两点：</strong></p>
<ul>
<li>只要能拿到 <code>Compiler</code> 或 <code>Compilation</code> 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。</li>
<li>传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件</li>
<li>有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。例如：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'emit'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">compilation, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 支持处理逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理完毕后执行 callback 以通知 Webpack </span></span><br><span class="line">  <span class="comment">// 如果不执行 callback，运行流程将会一直卡在这不往下执行 </span></span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="常用-API"><a href="#常用-API" class="headerlink" title="常用 API"></a>常用 API</h2><blockquote>
<p>插件可以用来修改输出文件、增加输出文件、甚至可以提升 Webpack 性能、等等，总之插件通过调用 Webpack 提供的 API 能完成很多事情。由于 Webpack 提供的 API 非常多，有很多 API 很少用的上，又加上篇幅有限，下面来介绍一些常用的 API。</p>
</blockquote>
<h3 id="读取输出资源、代码块、模块及其依赖"><a href="#读取输出资源、代码块、模块及其依赖" class="headerlink" title="读取输出资源、代码块、模块及其依赖"></a>读取输出资源、代码块、模块及其依赖</h3><p>有些插件可能需要读取 <code>Webpack</code> 的处理结果，例如输出资源、代码块、模块及其依赖，以便做下一步处理。</p>
<blockquote>
<p>在 emit 事件发生时，代表源文件的转换和组装已经完成，在这里可以读取到最终将输出的资源、代码块、模块及其依赖，并且可以修改输出资源的内容。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.plugin(<span class="string">'emit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">compilation, callback</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// compilation.chunks 存放所有代码块，是一个数组</span></span><br><span class="line">      compilation.chunks.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// chunk 代表一个代码块</span></span><br><span class="line">        <span class="comment">// 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块</span></span><br><span class="line">        chunk.forEachModule(<span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// module 代表一个模块</span></span><br><span class="line">          <span class="comment">// module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组</span></span><br><span class="line">          <span class="built_in">module</span>.fileDependencies.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">filepath</span>) </span>&#123;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件</span></span><br><span class="line">        <span class="comment">// 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，</span></span><br><span class="line">        <span class="comment">// 该 Chunk 就会生成 .js 和 .css 两个文件</span></span><br><span class="line">        chunk.files.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">filename</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// compilation.assets 存放当前所有即将输出的资源</span></span><br><span class="line">          <span class="comment">// 调用一个输出资源的 source() 方法能获取到输出资源的内容</span></span><br><span class="line">          <span class="keyword">let</span> source = compilation.assets[filename].source();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。</span></span><br><span class="line">      <span class="comment">// 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。</span></span><br><span class="line">      callback();</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监听文件变化"><a href="#监听文件变化" class="headerlink" title="监听文件变化"></a>监听文件变化</h3><blockquote>
<p>Webpack 会从配置的入口模块出发，依次找出所有的依赖模块，当入口模块或者其依赖的模块发生变化时,就会触发一次新的 Compilation。</p>
</blockquote>
<p>在开发插件时经常需要知道是哪个文件发生变化导致了新的 Compilation，为此可以使用如下代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 当依赖的文件发生变化时会触发 watch-run 事件</span></span><br><span class="line">compiler.plugin(<span class="string">'watch-run'</span>, (watching, callback) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取发生变化的文件列表</span></span><br><span class="line">    <span class="keyword">const</span> changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;</span><br><span class="line">    <span class="comment">// changedFiles 格式为键值对，键为发生变化的文件路径。</span></span><br><span class="line">    <span class="keyword">if</span> (changedFiles[filePath] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="comment">// filePath 对应的文件发生了变化</span></span><br><span class="line">    &#125;</span><br><span class="line">    callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>默认情况下 Webpack 只会监视入口和其依赖的模块是否发生变化，在有些情况下项目可能需要引入新的文件，例如引入一个 HTML 文件。</li>
<li>由于 JavaScript 文件不会去导入 HTML 文件，Webpack 就不会监听 HTML 文件的变化，编辑 HTML 文件时就不会重新触发新的 Compilation。</li>
<li>为了监听 HTML 文件的变化，我们需要把 HTML 文件加入到依赖列表中，为此可以使用如下代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'after-compile'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译</span></span><br><span class="line">    compilation.fileDependencies.push(filePath);</span><br><span class="line">    callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="修改输出资源"><a href="#修改输出资源" class="headerlink" title="修改输出资源"></a>修改输出资源</h3><blockquote>
<p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 emit 事件，因为发生 emit 事件时所有模块的转换和代码块对应的文件已经生成好，需要输出的资源即将输出，因此 emit 事件是修改 Webpack 输出资源的最后时机。</p>
</blockquote>
<p>所有需要输出的资源会存放在 <code>compilation.assets</code> 中，<code>compilation.assets</code> 是一个键值对，<strong>键为需要输出的文件名称，值为文件对应的内容</strong>。</p>
<p><strong>设置 compilation.assets 的代码如下：</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'emit'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 设置名称为 fileName 的输出资源</span></span><br><span class="line">  compilation.assets[fileName] = &#123;</span><br><span class="line">    <span class="comment">// 返回文件内容</span></span><br><span class="line">    source: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span></span><br><span class="line">      <span class="keyword">return</span> fileContent;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 返回文件大小</span></span><br><span class="line">    size: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Buffer.byteLength(fileContent, <span class="string">'utf8'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>读取 <code>compilation.assets</code> 的代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'emit'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 读取名称为 fileName 的输出资源</span></span><br><span class="line">  <span class="keyword">const</span> asset = compilation.assets[fileName];</span><br><span class="line">  <span class="comment">// 获取输出资源的内容</span></span><br><span class="line">  asset.source();</span><br><span class="line">  <span class="comment">// 获取输出资源的文件大小</span></span><br><span class="line">  asset.size();</span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="判断-Webpack-使用了哪些插件"><a href="#判断-Webpack-使用了哪些插件" class="headerlink" title="判断 Webpack 使用了哪些插件"></a>判断 Webpack 使用了哪些插件</h3><blockquote>
<p>在开发一个插件时可能需要根据当前配置是否使用了其它某个插件而做下一步决定，因此需要读取 Webpack 当前的插件配置情况。以判断当前是否使用了 ExtractTextPlugin 为例，可以使用如下代码：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 判断当前配置使用使用了 ExtractTextPlugin，</span></span><br><span class="line"><span class="comment">// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasExtractTextPlugin</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 当前配置所有使用的插件列表</span></span><br><span class="line">  <span class="keyword">const</span> plugins = compiler.options.plugins;</span><br><span class="line">  <span class="comment">// 去 plugins 中寻找有没有 ExtractTextPlugin 的实例</span></span><br><span class="line">  <span class="keyword">return</span> plugins.find(<span class="function"><span class="params">plugin</span>=&gt;</span>plugin.__proto__.constructor === ExtractTextPlugin) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="在-Webpack-即将退出时再附加一些额外的操作"><a href="#在-Webpack-即将退出时再附加一些额外的操作" class="headerlink" title="在 Webpack 即将退出时再附加一些额外的操作"></a>在 Webpack 即将退出时再附加一些额外的操作</h3><ul>
<li>该插件的名称取名叫 EndWebpackPlugin，作用是在 Webpack 即将退出时再附加一些额外的操作，例如在 Webpack 成功编译和输出了文件后执行发布操作把输出的文件上传到服务器。</li>
<li>同时该插件还能区分 Webpack 构建是否执行成功。使用该插件时方法如下</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins:[</span><br><span class="line">    <span class="comment">// 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；</span></span><br><span class="line">    <span class="keyword">new</span> EndWebpackPlugin(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作</span></span><br><span class="line">    &#125;, (err) =&gt; &#123;</span><br><span class="line">      <span class="comment">// Webpack 构建失败，err 是导致错误的原因</span></span><br><span class="line">      <span class="built_in">console</span>.error(err);        </span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>要实现该插件，需要借助两个事件：</strong></p>
<ul>
<li><code>done</code>：在成功构建并且输出了文件后，Webpack 即将退出时发生；</li>
<li><code>failed</code>：在构建出现异常导致构建失败，Webpack 即将退出时发生；</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EndWebpackPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(doneCallback, failCallback) &#123;</span><br><span class="line">    <span class="comment">// 存下在构造函数中传入的回调函数</span></span><br><span class="line">    <span class="keyword">this</span>.doneCallback = doneCallback;</span><br><span class="line">    <span class="keyword">this</span>.failCallback = failCallback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.plugin(<span class="string">'done'</span>, (stats) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 在 done 事件中回调 doneCallback</span></span><br><span class="line">        <span class="keyword">this</span>.doneCallback(stats);</span><br><span class="line">    &#125;);</span><br><span class="line">    compiler.plugin(<span class="string">'failed'</span>, (err) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 在 failed 事件中回调 failCallback</span></span><br><span class="line">        <span class="keyword">this</span>.failCallback(err);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 导出插件 </span></span><br><span class="line"><span class="built_in">module</span>.exports = EndWebpackPlugin;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>找到合适的事件点去完成功能在开发插件时显得尤为重要</p>
</blockquote>
<h3 id="生成各个文件的大小到指定目录文件中"><a href="#生成各个文件的大小到指定目录文件中" class="headerlink" title="生成各个文件的大小到指定目录文件中"></a>生成各个文件的大小到指定目录文件中</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 生成各个文件的大小到指定目录文件中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileListPlugin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">        <span class="keyword">this</span>.options = options</span><br><span class="line">    &#125;</span><br><span class="line">    apply(compiler) &#123;</span><br><span class="line">        compiler.hooks.emit.tap(<span class="string">'fileListPlugin'</span>, (compilation) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> assets = compilation.assets</span><br><span class="line">            <span class="keyword">let</span> content = <span class="string">'In this build:\r\n'</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历所有编译过的资源文件，</span></span><br><span class="line">            <span class="comment">// 对于每个文件名称，都添加一行内容。</span></span><br><span class="line">            <span class="built_in">Object</span>.entries(assets).forEach(<span class="function">(<span class="params">[fileName, fileSize]</span>) =&gt;</span> &#123;</span><br><span class="line">                content += <span class="string">`--<span class="subst">$&#123;fileName&#125;</span> —— <span class="subst">$&#123;<span class="built_in">Math</span>.ceil(fileSize.size() <span class="regexp">/ 1024)&#125;kb\r\n`</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">            &#125;)</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">            console.log('====content====', content)</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">            /</span><span class="regexp">/ 将这个列表作为一个新的文件资源，插入到 webpack 构建中：</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">            assets[this.options.filename] = &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                source() &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                    return content</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                &#125;,</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                size() &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                    return content.length</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">                &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">            &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">        &#125;)</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">&#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">module.exports = FileListPlugin</span></span></span></span><br></pre></td></tr></table></figure>
<p><strong>在vue cli3中使用例子</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// const FileListPlugin = require('./plugins/fileListPlugin.js')</span></span><br><span class="line">configureWebpack: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      plugins: [</span><br><span class="line">        <span class="keyword">new</span> FileListPlugin(&#123;<span class="string">'filename'</span>: path.join(<span class="string">'..'</span>,<span class="string">'filelist.md'</span>)&#125;)</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><img src="https://poetries1.gitee.io/img-repo/2021/01/13.png" alt></p>
<h3 id="生成版权信息"><a href="#生成版权信息" class="headerlink" title="生成版权信息"></a>生成版权信息</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CopyRightWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">      <span class="keyword">this</span>.options = options</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">      compiler.hooks.compile.tap(<span class="string">'webpackCompiler'</span>, () =&gt; &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'compiler'</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      compiler.hooks.emit.tapAsync(<span class="string">'CopyRightWebpackPlugin'</span>, (compilation, cb) =&gt; &#123;</span><br><span class="line">          compilation.assets[<span class="keyword">this</span>.options.filename] = &#123;</span><br><span class="line">              source() &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="string">'copyRight by poetries'</span></span><br><span class="line">              &#125;,</span><br><span class="line">              size() &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="number">25</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          cb()</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = CopyRightWebpackPlugin</span><br></pre></td></tr></table></figure>
<p><strong>在vue cli3中使用例子</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// const CopyRightWebpackPlugin = require('./plugins/copyRightWebpackPlugin.js')</span></span><br><span class="line">configureWebpack: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> CopyRightWebpackPlugin(&#123;<span class="string">'filename'</span>: <span class="string">'copyRight.md'</span>&#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><img src="https://poetries1.gitee.io/img-repo/2021/01/14.png" alt></p>
<h3 id="打包zip插件"><a href="#打包zip插件" class="headerlink" title="打包zip插件"></a>打包zip插件</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> JsZip = <span class="built_in">require</span>(<span class="string">'jszip'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZipPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="comment">// emit是一个异步串行钩子</span></span><br><span class="line">    compiler.hooks.emit.tapPromise(<span class="string">'1'</span>, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> assets = compilation.assets;</span><br><span class="line">      <span class="keyword">const</span> zip = <span class="keyword">new</span> JsZip();</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> filename <span class="keyword">in</span> assets) &#123;</span><br><span class="line">        zip.file(filename, assets[filename].source())</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// nodebuffer是node环境中的二进制形式；blob是浏览器环境</span></span><br><span class="line">      <span class="keyword">return</span> zip.generateAsync(&#123;<span class="attr">type</span>: <span class="string">'nodebuffer'</span>&#125;).then(<span class="function">(<span class="params">content</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.options.filename);</span><br><span class="line">        assets[<span class="keyword">this</span>.options.filename] = &#123;</span><br><span class="line">          source() &#123;<span class="keyword">return</span> content&#125;, </span><br><span class="line">          size() &#123;<span class="keyword">return</span> content.length&#125; <span class="comment">//可以省略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">          resolve(compilation)</span><br><span class="line">        &#125;)   </span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ZipPlugin;</span><br></pre></td></tr></table></figure>
<p>在<code>webpack.config.js</code>中使用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ZipPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/ZipPlugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ZipPlugin(&#123;</span><br><span class="line">      filename: <span class="string">'my.zip'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.webpackjs.com/contribute/writing-a-plugin/" target="_blank" rel="noopener">编写一个插件-webpack官方教程</a></li>
</ul>

      </div>
    
  </div>

</article>

<!-- <button class="assist-btn2 circle" id="assist_btn2" title="点亮屏幕" style="left: 27px; top: 152px;">
  <i class="iconfont" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button>
<button class="assist-btn1 circle" id="assist_btn1" title="关闭屏幕亮度" style="left: 27px; top: 152px;">
  <i class="iconfont toc-title" style="display:inline-block;color:red;width:20px;height:20px;">&#xe61d;</i>
</button> -->


<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>	

<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
  function getCookie(key) {
    if (document.cookie.length > 0) {
      var start = document.cookie.indexOf(key + "=");
      if (start !== -1) {
        start = start + key.length + 1;
        var end = document.cookie.indexOf(";", start);
        if (end === -1) end = document.cookie.length;
        return unescape(document.cookie.substring(start, end));
      }
    }
    return "";
  }
  const feToken = getCookie('fe-token');
  const btw = new BTWPlugin();
  console.log('ft', feToken)
  if(!feToken) {
    btw.init({
      id: "container",
      blogId: "22699-1592137983091-414",
      name: "前端进阶之旅",
      qrcode: "https://poetries1.gitee.io/img-repo/2020/06/qrcode.jpg",
      keyword: "3a3b3c",
    });
  }
</script>

<script type="text/javascript">

// white theme
var body = {color: "#555", background: "#000"};
var a_tag = {color: "#222"};
var header = { background: "#222"};
var logo_line_i = {background: "#222"};
// var post_code = {background: "#eee", color: "#222"};

function switch_theme() {
 $("body").css(body);
 $("a:not('.links-of-author-item a, .site-state-item a, .site-state-posts a, .feed-link a, .motion-element a, .post-tags a, .show-commit-cls a, #donate_board a')").css(a_tag);
 $(".header, .footer").css(header);
 $(".logo-line-before i, .logo-line-after i").css(logo_line_i);
 //$(".post code").css(post_code);
 $("#idhyt-surprise-ball #idhyt-surprise-ball-animation .drag").css(a_tag);
 $(".post-title-link, .posts-expand .post-meta, .post-comments-count, .disqus-comment-count, .post-category a, .post-nav-next a, .post-nav-item a").css(a_tag);
 
 // $("code").css({color: '#c5c8c6', background: '#1d1f21'});
 //$("#assist_btn1").hide(1500);
}

$(function () {
$("#assist_btn2").css("display","none");
 $("#assist_btn1").click(function() {
     switch_theme();
$("div#toc.toc-article").css({
 "background":"#eaeaea",
 "opacity":1
});
$(".toc-article ol").show();
$("#toc.toc-article .toc-title").css("color","#a98602");
$("#assist_btn1").css("display","none");
$("#assist_btn2").css("display","block");
 });
$("#assist_btn2").click(function() {
$("#assist_btn2").css("display","none");
$("#assist_btn1").css("display","block");
$("body").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
     $(".header, .footer").css("background","url(http://www.miaov.com/static/ie/images/news/bg.png)")
$(".toc-article ol").toggle(1000);
 });
});


//背景随机

var Y, O, E, L, B, C, T, z, N, S, A, I;
!function() {
var e = function() {
for (O.clearRect(0, 0, L, B), T = [{
x: 0,
y: .7 * B + C
}, {
x: 0,
y: .7 * B - C
}]; T[1].x < L + C;) t(T[0], T[1])
}, t = function(e, t) {
O.beginPath(), O.moveTo(e.x, e.y), O.lineTo(t.x, t.y);
var n = t.x + (2 * I() - .25) * C,
 r = a(t.y);
O.lineTo(n, r), O.closePath(), N -= S / -50, O.fillStyle = "#" + (127 * A(N) + 128 << 16 | 127 * A(N + S / 3) + 128 << 8 | 127 * A(N + S / 3 * 2) + 128).toString(16), O.fill(), T[0] = T[1], T[1] = {
 x: n,
 y: r
}
}, a = function n(e) {
var t = e + (2 * I() - 1.1) * C;
return t > B || t < 0 ? n(e) : t
};
Y = document.getElementById("evanyou"), O = Y.getContext("2d"), E = window.devicePixelRatio || 1, L = window.innerWidth, B = window.innerHeight, C = 90, z = Math, N = 0, S = 2 * z.PI, A = z.cos, I = z.random, Y.width = L * E, Y.height = B * E, O.scale(E, E), O.globalAlpha = .6, document.onclick = e, document.ontouchstart = e, e()
}()

   
$("#toc-eye").click(function(){
$("#toc.toc-article").toggle(1000);
});

</script>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持poetries</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/weixin.jpg" alt="">
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/zhifubao.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2021/01/03/vscode-plugin/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2021/01/16/js-memory-leak/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/categories/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tags/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '5567a2c4abb858009d96',
  clientSecret: 'b9039ec056cf5c2346b3cdb63308a28c163f91e5',
  repo: 'poetries.github.io',
  owner: 'poetries',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: location.pathname,
  admin: ['poetries'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
 
  
</body>
</html>
